import{M as ur,m as Oe,E as fe,a as is,b as ls,N as vt,n as as,R as cs,P as hr,c as Cn,S as Ce,d as ds,T as Te,F as he,e as Me,D as pn,f as un,k as ps,g as us,h as hs,i as fs,l as ms,o as xs,u as gs,U as bs,p as ys,q as vs,H as js,r as Cs,s as Ss,j as t,t as ws}from"./tiptap-BONCSYqO.js";import{r as x,R as on,t as E}from"./toast-Dj7VaHEs.js";import{c as fr,T as ks,d as Ns,P as zs,e as bt,f as As,g as $n,h as Rs,i as Ts,H as Ms,j as Es,k as hn,l as mr,m as ce,n as se,o as fn,p as Bn,q as xr,r as gr,B as br,s as mn,N as yr,t as Ws,u as Ft,v as Ls,X as st,w as Is,x as Sn,R as Hs,y as Pn,z as _s,D as Ds,F as $s,G as Bs,I as Ps,U as Os,J as On,A as Fs,K as ln,O as It,Q as Us,V as Fn,W as an,Y as cn,Z as Un,_ as Ht,$ as Gn,a0 as Gs}from"./icons-BYA8uHbD.js";import{r as le,u as vr,g as Ks,a as Vs,b as Ys,T as Xs,c as Js,d as qs,e as Qs,f as Zs,h as eo}from"./index-CrJxp5Zg.js";var to=20,jr=(e,n=0)=>{const r=[];return!e.children.length||n>to||Array.from(e.children).forEach(s=>{s.tagName==="SPAN"?r.push(s):s.children.length&&r.push(...jr(s,n+1))}),r},no=e=>{if(!e.children.length)return;const n=jr(e);n&&n.forEach(r=>{var s,o;const i=r.getAttribute("style"),l=(o=(s=r.parentElement)==null?void 0:s.closest("span"))==null?void 0:o.getAttribute("style");r.setAttribute("style",`${l};${i}`)})},Cr=ur.create({name:"textStyle",priority:101,addOptions(){return{HTMLAttributes:{},mergeNestedSpanStyles:!0}},parseHTML(){return[{tag:"span",consuming:!1,getAttrs:e=>e.hasAttribute("style")?(this.options.mergeNestedSpanStyles&&no(e),{}):!1}]},renderHTML({HTMLAttributes:e}){return["span",Oe(this.options.HTMLAttributes,e),0]},addCommands(){return{toggleTextStyle:e=>({commands:n})=>n.toggleMark(this.name,e),removeEmptyTextStyle:()=>({tr:e})=>{const{selection:n}=e;return e.doc.nodesBetween(n.from,n.to,(r,s)=>{if(r.isTextblock)return!0;r.marks.filter(o=>o.type===this.type).some(o=>Object.values(o.attrs).some(i=>!!i))||e.removeMark(s,s+r.nodeSize,this.type)}),!0}}}}),ro=fe.create({name:"backgroundColor",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{backgroundColor:{default:null,parseHTML:e=>{var n;const r=e.getAttribute("style");if(r){const s=r.split(";").map(o=>o.trim()).filter(Boolean);for(let o=s.length-1;o>=0;o-=1){const i=s[o].split(":");if(i.length>=2){const l=i[0].trim().toLowerCase(),a=i.slice(1).join(":").trim();if(l==="background-color")return a.replace(/['"]+/g,"")}}}return(n=e.style.backgroundColor)==null?void 0:n.replace(/['"]+/g,"")},renderHTML:e=>e.backgroundColor?{style:`background-color: ${e.backgroundColor}`}:{}}}}]},addCommands(){return{setBackgroundColor:e=>({chain:n})=>n().setMark("textStyle",{backgroundColor:e}).run(),unsetBackgroundColor:()=>({chain:e})=>e().setMark("textStyle",{backgroundColor:null}).removeEmptyTextStyle().run()}}}),Sr=fe.create({name:"color",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{color:{default:null,parseHTML:e=>{var n;const r=e.getAttribute("style");if(r){const s=r.split(";").map(o=>o.trim()).filter(Boolean);for(let o=s.length-1;o>=0;o-=1){const i=s[o].split(":");if(i.length>=2){const l=i[0].trim().toLowerCase(),a=i.slice(1).join(":").trim();if(l==="color")return a.replace(/['"]+/g,"")}}}return(n=e.style.color)==null?void 0:n.replace(/['"]+/g,"")},renderHTML:e=>e.color?{style:`color: ${e.color}`}:{}}}}]},addCommands(){return{setColor:e=>({chain:n})=>n().setMark("textStyle",{color:e}).run(),unsetColor:()=>({chain:e})=>e().setMark("textStyle",{color:null}).removeEmptyTextStyle().run()}}}),wr=fe.create({name:"fontFamily",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontFamily:{default:null,parseHTML:e=>e.style.fontFamily,renderHTML:e=>e.fontFamily?{style:`font-family: ${e.fontFamily}`}:{}}}}]},addCommands(){return{setFontFamily:e=>({chain:n})=>n().setMark("textStyle",{fontFamily:e}).run(),unsetFontFamily:()=>({chain:e})=>e().setMark("textStyle",{fontFamily:null}).removeEmptyTextStyle().run()}}}),so=fe.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:e=>e.style.fontSize,renderHTML:e=>e.fontSize?{style:`font-size: ${e.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:e=>({chain:n})=>n().setMark("textStyle",{fontSize:e}).run(),unsetFontSize:()=>({chain:e})=>e().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),oo=fe.create({name:"lineHeight",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:null,parseHTML:e=>e.style.lineHeight,renderHTML:e=>e.lineHeight?{style:`line-height: ${e.lineHeight}`}:{}}}}]},addCommands(){return{setLineHeight:e=>({chain:n})=>n().setMark("textStyle",{lineHeight:e}).run(),unsetLineHeight:()=>({chain:e})=>e().setMark("textStyle",{lineHeight:null}).removeEmptyTextStyle().run()}}});fe.create({name:"textStyleKit",addExtensions(){const e=[];return this.options.backgroundColor!==!1&&e.push(ro.configure(this.options.backgroundColor)),this.options.color!==!1&&e.push(Sr.configure(this.options.color)),this.options.fontFamily!==!1&&e.push(wr.configure(this.options.fontFamily)),this.options.fontSize!==!1&&e.push(so.configure(this.options.fontSize)),this.options.lineHeight!==!1&&e.push(oo.configure(this.options.lineHeight)),this.options.textStyle!==!1&&e.push(Cr.configure(this.options.textStyle)),e}});var io=fe.create({name:"textAlign",addOptions(){return{types:[],alignments:["left","center","right","justify"],defaultAlignment:null}},addGlobalAttributes(){return[{types:this.options.types,attributes:{textAlign:{default:this.options.defaultAlignment,parseHTML:e=>{const n=e.style.textAlign;return this.options.alignments.includes(n)?n:this.options.defaultAlignment},renderHTML:e=>e.textAlign?{style:`text-align: ${e.textAlign}`}:{}}}}]},addCommands(){return{setTextAlign:e=>({commands:n})=>this.options.alignments.includes(e)?this.options.types.map(r=>n.updateAttributes(r,{textAlign:e})).some(r=>r):!1,unsetTextAlign:()=>({commands:e})=>this.options.types.map(n=>e.resetAttributes(n,"textAlign")).some(n=>n),toggleTextAlign:e=>({editor:n,commands:r})=>this.options.alignments.includes(e)?n.isActive({textAlign:e})?r.unsetTextAlign():r.setTextAlign(e):!1}},addKeyboardShortcuts(){return{"Mod-Shift-l":()=>this.editor.commands.setTextAlign("left"),"Mod-Shift-e":()=>this.editor.commands.setTextAlign("center"),"Mod-Shift-r":()=>this.editor.commands.setTextAlign("right"),"Mod-Shift-j":()=>this.editor.commands.setTextAlign("justify")}}}),lo=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))$/,ao=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))/g,co=ur.create({name:"highlight",addOptions(){return{multicolor:!1,HTMLAttributes:{}}},addAttributes(){return this.options.multicolor?{color:{default:null,parseHTML:e=>e.getAttribute("data-color")||e.style.backgroundColor,renderHTML:e=>e.color?{"data-color":e.color,style:`background-color: ${e.color}; color: inherit`}:{}}}:{}},parseHTML(){return[{tag:"mark"}]},renderHTML({HTMLAttributes:e}){return["mark",Oe(this.options.HTMLAttributes,e),0]},renderMarkdown:(e,n)=>`==${n.renderChildren(e)}==`,parseMarkdown:(e,n)=>n.applyMark("highlight",n.parseInline(e.tokens||[])),markdownTokenizer:{name:"highlight",level:"inline",start:e=>e.indexOf("=="),tokenize(e,n,r){const o=/^(==)([^=]+)(==)/.exec(e);if(o){const i=o[2].trim(),l=r.inlineTokens(i);return{type:"highlight",raw:o[0],text:i,tokens:l}}}},addCommands(){return{setHighlight:e=>({commands:n})=>n.setMark(this.name,e),toggleHighlight:e=>({commands:n})=>n.toggleMark(this.name,e),unsetHighlight:()=>({commands:e})=>e.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-h":()=>this.editor.commands.toggleHighlight()}},addInputRules(){return[ls({find:lo,type:this.type})]},addPasteRules(){return[is({find:ao,type:this.type})]}}),po=/(?:^|\s)(!\[(.+|:?)]\((\S+)(?:(?:\s+)["'](\S+)["'])?\))$/,uo=vt.create({name:"image",addOptions(){return{inline:!1,allowBase64:!1,HTMLAttributes:{},resize:!1}},inline(){return this.options.inline},group(){return this.options.inline?"inline":"block"},draggable:!0,addAttributes(){return{src:{default:null},alt:{default:null},title:{default:null},width:{default:null},height:{default:null}}},parseHTML(){return[{tag:this.options.allowBase64?"img[src]":'img[src]:not([src^="data:"])'}]},renderHTML({HTMLAttributes:e}){return["img",Oe(this.options.HTMLAttributes,e)]},parseMarkdown:(e,n)=>n.createNode("image",{src:e.href,title:e.title,alt:e.text}),renderMarkdown:e=>{var n,r,s,o,i,l;const a=(r=(n=e.attrs)==null?void 0:n.src)!=null?r:"",c=(o=(s=e.attrs)==null?void 0:s.alt)!=null?o:"",d=(l=(i=e.attrs)==null?void 0:i.title)!=null?l:"";return d?`![${c}](${a} "${d}")`:`![${c}](${a})`},addNodeView(){if(!this.options.resize||!this.options.resize.enabled||typeof document>"u")return null;const{directions:e,minWidth:n,minHeight:r,alwaysPreserveAspectRatio:s}=this.options.resize;return({node:o,getPos:i,HTMLAttributes:l,editor:a})=>{const c=document.createElement("img");Object.entries(l).forEach(([f,m])=>{if(m!=null)switch(f){case"width":case"height":break;default:c.setAttribute(f,m);break}}),c.src=l.src;const d=new cs({element:c,editor:a,node:o,getPos:i,onResize:(f,m)=>{c.style.width=`${f}px`,c.style.height=`${m}px`},onCommit:(f,m)=>{const u=i();u!==void 0&&this.editor.chain().setNodeSelection(u).updateAttributes(this.name,{width:f,height:m}).run()},onUpdate:(f,m,u)=>f.type===o.type,options:{directions:e,min:{width:n,height:r},preserveAspectRatio:s===!0}}),h=d.dom;return h.style.visibility="hidden",h.style.pointerEvents="none",c.onload=()=>{h.style.visibility="",h.style.pointerEvents=""},d}},addCommands(){return{setImage:e=>({commands:n})=>n.insertContent({type:this.name,attrs:e})}},addInputRules(){return[as({find:po,type:this.type,getAttributes:e=>{const[,,n,r,s]=e;return{src:r,alt:n,title:s}}})]}});let xn,gn;if(typeof WeakMap<"u"){let e=new WeakMap;xn=n=>e.get(n),gn=(n,r)=>(e.set(n,r),r)}else{const e=[];let r=0;xn=s=>{for(let o=0;o<e.length;o+=2)if(e[o]==s)return e[o+1]},gn=(s,o)=>(r==10&&(r=0),e[r++]=s,e[r++]=o)}var G=class{constructor(e,n,r,s){this.width=e,this.height=n,this.map=r,this.problems=s}findCell(e){for(let n=0;n<this.map.length;n++){const r=this.map[n];if(r!=e)continue;const s=n%this.width,o=n/this.width|0;let i=s+1,l=o+1;for(let a=1;i<this.width&&this.map[n+a]==r;a++)i++;for(let a=1;l<this.height&&this.map[n+this.width*a]==r;a++)l++;return{left:s,top:o,right:i,bottom:l}}throw new RangeError(`No cell with offset ${e} found`)}colCount(e){for(let n=0;n<this.map.length;n++)if(this.map[n]==e)return n%this.width;throw new RangeError(`No cell with offset ${e} found`)}nextCell(e,n,r){const{left:s,right:o,top:i,bottom:l}=this.findCell(e);return n=="horiz"?(r<0?s==0:o==this.width)?null:this.map[i*this.width+(r<0?s-1:o)]:(r<0?i==0:l==this.height)?null:this.map[s+this.width*(r<0?i-1:l)]}rectBetween(e,n){const{left:r,right:s,top:o,bottom:i}=this.findCell(e),{left:l,right:a,top:c,bottom:d}=this.findCell(n);return{left:Math.min(r,l),top:Math.min(o,c),right:Math.max(s,a),bottom:Math.max(i,d)}}cellsInRect(e){const n=[],r={};for(let s=e.top;s<e.bottom;s++)for(let o=e.left;o<e.right;o++){const i=s*this.width+o,l=this.map[i];r[l]||(r[l]=!0,!(o==e.left&&o&&this.map[i-1]==l||s==e.top&&s&&this.map[i-this.width]==l)&&n.push(l))}return n}positionAt(e,n,r){for(let s=0,o=0;;s++){const i=o+r.child(s).nodeSize;if(s==e){let l=n+e*this.width;const a=(e+1)*this.width;for(;l<a&&this.map[l]<o;)l++;return l==a?i-1:this.map[l]}o=i}}static get(e){return xn(e)||gn(e,ho(e))}};function ho(e){if(e.type.spec.tableRole!="table")throw new RangeError("Not a table node: "+e.type.name);const n=fo(e),r=e.childCount,s=[];let o=0,i=null;const l=[];for(let d=0,h=n*r;d<h;d++)s[d]=0;for(let d=0,h=0;d<r;d++){const f=e.child(d);h++;for(let b=0;;b++){for(;o<s.length&&s[o]!=0;)o++;if(b==f.childCount)break;const j=f.child(b),{colspan:C,rowspan:k,colwidth:F}=j.attrs;for(let D=0;D<k;D++){if(D+d>=r){(i||(i=[])).push({type:"overlong_rowspan",pos:h,n:k-D});break}const U=o+D*n;for(let Y=0;Y<C;Y++){s[U+Y]==0?s[U+Y]=h:(i||(i=[])).push({type:"collision",row:d,pos:h,n:C-Y});const Z=F&&F[Y];if(Z){const Q=(U+Y)%n*2,pe=l[Q];pe==null||pe!=Z&&l[Q+1]==1?(l[Q]=Z,l[Q+1]=1):pe==Z&&l[Q+1]++}}}o+=C,h+=j.nodeSize}const m=(d+1)*n;let u=0;for(;o<m;)s[o++]==0&&u++;u&&(i||(i=[])).push({type:"missing",row:d,n:u}),h++}(n===0||r===0)&&(i||(i=[])).push({type:"zero_sized"});const a=new G(n,r,s,i);let c=!1;for(let d=0;!c&&d<l.length;d+=2)l[d]!=null&&l[d+1]<r&&(c=!0);return c&&mo(a,l,e),a}function fo(e){let n=-1,r=!1;for(let s=0;s<e.childCount;s++){const o=e.child(s);let i=0;if(r)for(let l=0;l<s;l++){const a=e.child(l);for(let c=0;c<a.childCount;c++){const d=a.child(c);l+d.attrs.rowspan>s&&(i+=d.attrs.colspan)}}for(let l=0;l<o.childCount;l++){const a=o.child(l);i+=a.attrs.colspan,a.attrs.rowspan>1&&(r=!0)}n==-1?n=i:n!=i&&(n=Math.max(n,i))}return n}function mo(e,n,r){e.problems||(e.problems=[]);const s={};for(let o=0;o<e.map.length;o++){const i=e.map[o];if(s[i])continue;s[i]=!0;const l=r.nodeAt(i);if(!l)throw new RangeError(`No cell with offset ${i} found`);let a=null;const c=l.attrs;for(let d=0;d<c.colspan;d++){const h=n[(o+d)%e.width*2];h!=null&&(!c.colwidth||c.colwidth[d]!=h)&&((a||(a=xo(c)))[d]=h)}a&&e.problems.unshift({type:"colwidth mismatch",pos:i,colwidth:a})}}function xo(e){if(e.colwidth)return e.colwidth.slice();const n=[];for(let r=0;r<e.colspan;r++)n.push(0);return n}function q(e){let n=e.cached.tableNodeTypes;if(!n){n=e.cached.tableNodeTypes={};for(const r in e.nodes){const s=e.nodes[r],o=s.spec.tableRole;o&&(n[o]=s)}}return n}const Re=new Cn("selectingCells");function Be(e){for(let n=e.depth-1;n>0;n--)if(e.node(n).type.spec.tableRole=="row")return e.node(0).resolve(e.before(n+1));return null}function go(e){for(let n=e.depth;n>0;n--){const r=e.node(n).type.spec.tableRole;if(r==="cell"||r==="header_cell")return e.node(n)}return null}function de(e){const n=e.selection.$head;for(let r=n.depth;r>0;r--)if(n.node(r).type.spec.tableRole=="row")return!0;return!1}function Ut(e){const n=e.selection;if("$anchorCell"in n&&n.$anchorCell)return n.$anchorCell.pos>n.$headCell.pos?n.$anchorCell:n.$headCell;if("node"in n&&n.node&&n.node.type.spec.tableRole=="cell")return n.$anchor;const r=Be(n.$head)||bo(n.$head);if(r)return r;throw new RangeError(`No cell found around position ${n.head}`)}function bo(e){for(let n=e.nodeAfter,r=e.pos;n;n=n.firstChild,r++){const s=n.type.spec.tableRole;if(s=="cell"||s=="header_cell")return e.doc.resolve(r)}for(let n=e.nodeBefore,r=e.pos;n;n=n.lastChild,r--){const s=n.type.spec.tableRole;if(s=="cell"||s=="header_cell")return e.doc.resolve(r-n.nodeSize)}}function bn(e){return e.parent.type.spec.tableRole=="row"&&!!e.nodeAfter}function yo(e){return e.node(0).resolve(e.pos+e.nodeAfter.nodeSize)}function wn(e,n){return e.depth==n.depth&&e.pos>=n.start(-1)&&e.pos<=n.end(-1)}function kr(e,n,r){const s=e.node(-1),o=G.get(s),i=e.start(-1),l=o.nextCell(e.pos-i,n,r);return l==null?null:e.node(0).resolve(i+l)}function Pe(e,n,r=1){const s={...e,colspan:e.colspan-r};return s.colwidth&&(s.colwidth=s.colwidth.slice(),s.colwidth.splice(n,r),s.colwidth.some(o=>o>0)||(s.colwidth=null)),s}function Nr(e,n,r=1){const s={...e,colspan:e.colspan+r};if(s.colwidth){s.colwidth=s.colwidth.slice();for(let o=0;o<r;o++)s.colwidth.splice(n,0,0)}return s}function vo(e,n,r){const s=q(n.type.schema).header_cell;for(let o=0;o<e.height;o++)if(n.nodeAt(e.map[r+o*e.width]).type!=s)return!1;return!0}var _=class je extends Ce{constructor(n,r=n){const s=n.node(-1),o=G.get(s),i=n.start(-1),l=o.rectBetween(n.pos-i,r.pos-i),a=n.node(0),c=o.cellsInRect(l).filter(h=>h!=r.pos-i);c.unshift(r.pos-i);const d=c.map(h=>{const f=s.nodeAt(h);if(!f)throw new RangeError(`No cell with offset ${h} found`);const m=i+h+1;return new ds(a.resolve(m),a.resolve(m+f.content.size))});super(d[0].$from,d[0].$to,d),this.$anchorCell=n,this.$headCell=r}map(n,r){const s=n.resolve(r.map(this.$anchorCell.pos)),o=n.resolve(r.map(this.$headCell.pos));if(bn(s)&&bn(o)&&wn(s,o)){const i=this.$anchorCell.node(-1)!=s.node(-1);return i&&this.isRowSelection()?je.rowSelection(s,o):i&&this.isColSelection()?je.colSelection(s,o):new je(s,o)}return Te.between(s,o)}content(){const n=this.$anchorCell.node(-1),r=G.get(n),s=this.$anchorCell.start(-1),o=r.rectBetween(this.$anchorCell.pos-s,this.$headCell.pos-s),i={},l=[];for(let c=o.top;c<o.bottom;c++){const d=[];for(let h=c*r.width+o.left,f=o.left;f<o.right;f++,h++){const m=r.map[h];if(i[m])continue;i[m]=!0;const u=r.findCell(m);let b=n.nodeAt(m);if(!b)throw new RangeError(`No cell with offset ${m} found`);const j=o.left-u.left,C=u.right-o.right;if(j>0||C>0){let k=b.attrs;if(j>0&&(k=Pe(k,0,j)),C>0&&(k=Pe(k,k.colspan-C,C)),u.left<o.left){if(b=b.type.createAndFill(k),!b)throw new RangeError(`Could not create cell with attrs ${JSON.stringify(k)}`)}else b=b.type.create(k,b.content)}if(u.top<o.top||u.bottom>o.bottom){const k={...b.attrs,rowspan:Math.min(u.bottom,o.bottom)-Math.max(u.top,o.top)};u.top<o.top?b=b.type.createAndFill(k):b=b.type.create(k,b.content)}d.push(b)}l.push(n.child(c).copy(he.from(d)))}const a=this.isColSelection()&&this.isRowSelection()?n:l;return new Me(he.from(a),1,1)}replace(n,r=Me.empty){const s=n.steps.length,o=this.ranges;for(let l=0;l<o.length;l++){const{$from:a,$to:c}=o[l],d=n.mapping.slice(s);n.replace(d.map(a.pos),d.map(c.pos),l?Me.empty:r)}const i=Ce.findFrom(n.doc.resolve(n.mapping.slice(s).map(this.to)),-1);i&&n.setSelection(i)}replaceWith(n,r){this.replace(n,new Me(he.from(r),0,0))}forEachCell(n){const r=this.$anchorCell.node(-1),s=G.get(r),o=this.$anchorCell.start(-1),i=s.cellsInRect(s.rectBetween(this.$anchorCell.pos-o,this.$headCell.pos-o));for(let l=0;l<i.length;l++)n(r.nodeAt(i[l]),o+i[l])}isColSelection(){const n=this.$anchorCell.index(-1),r=this.$headCell.index(-1);if(Math.min(n,r)>0)return!1;const s=n+this.$anchorCell.nodeAfter.attrs.rowspan,o=r+this.$headCell.nodeAfter.attrs.rowspan;return Math.max(s,o)==this.$headCell.node(-1).childCount}static colSelection(n,r=n){const s=n.node(-1),o=G.get(s),i=n.start(-1),l=o.findCell(n.pos-i),a=o.findCell(r.pos-i),c=n.node(0);return l.top<=a.top?(l.top>0&&(n=c.resolve(i+o.map[l.left])),a.bottom<o.height&&(r=c.resolve(i+o.map[o.width*(o.height-1)+a.right-1]))):(a.top>0&&(r=c.resolve(i+o.map[a.left])),l.bottom<o.height&&(n=c.resolve(i+o.map[o.width*(o.height-1)+l.right-1]))),new je(n,r)}isRowSelection(){const n=this.$anchorCell.node(-1),r=G.get(n),s=this.$anchorCell.start(-1),o=r.colCount(this.$anchorCell.pos-s),i=r.colCount(this.$headCell.pos-s);if(Math.min(o,i)>0)return!1;const l=o+this.$anchorCell.nodeAfter.attrs.colspan,a=i+this.$headCell.nodeAfter.attrs.colspan;return Math.max(l,a)==r.width}eq(n){return n instanceof je&&n.$anchorCell.pos==this.$anchorCell.pos&&n.$headCell.pos==this.$headCell.pos}static rowSelection(n,r=n){const s=n.node(-1),o=G.get(s),i=n.start(-1),l=o.findCell(n.pos-i),a=o.findCell(r.pos-i),c=n.node(0);return l.left<=a.left?(l.left>0&&(n=c.resolve(i+o.map[l.top*o.width])),a.right<o.width&&(r=c.resolve(i+o.map[o.width*(a.top+1)-1]))):(a.left>0&&(r=c.resolve(i+o.map[a.top*o.width])),l.right<o.width&&(n=c.resolve(i+o.map[o.width*(l.top+1)-1]))),new je(n,r)}toJSON(){return{type:"cell",anchor:this.$anchorCell.pos,head:this.$headCell.pos}}static fromJSON(n,r){return new je(n.resolve(r.anchor),n.resolve(r.head))}static create(n,r,s=r){return new je(n.resolve(r),n.resolve(s))}getBookmark(){return new jo(this.$anchorCell.pos,this.$headCell.pos)}};_.prototype.visible=!1;Ce.jsonID("cell",_);var jo=class zr{constructor(n,r){this.anchor=n,this.head=r}map(n){return new zr(n.map(this.anchor),n.map(this.head))}resolve(n){const r=n.resolve(this.anchor),s=n.resolve(this.head);return r.parent.type.spec.tableRole=="row"&&s.parent.type.spec.tableRole=="row"&&r.index()<r.parent.childCount&&s.index()<s.parent.childCount&&wn(r,s)?new _(r,s):Ce.near(s,1)}};function Co(e){if(!(e.selection instanceof _))return null;const n=[];return e.selection.forEachCell((r,s)=>{n.push(un.node(s,s+r.nodeSize,{class:"selectedCell"}))}),pn.create(e.doc,n)}function So({$from:e,$to:n}){if(e.pos==n.pos||e.pos<n.pos-6)return!1;let r=e.pos,s=n.pos,o=e.depth;for(;o>=0&&!(e.after(o+1)<e.end(o));o--,r++);for(let i=n.depth;i>=0&&!(n.before(i+1)>n.start(i));i--,s--);return r==s&&/row|table/.test(e.node(o).type.spec.tableRole)}function wo({$from:e,$to:n}){let r,s;for(let o=e.depth;o>0;o--){const i=e.node(o);if(i.type.spec.tableRole==="cell"||i.type.spec.tableRole==="header_cell"){r=i;break}}for(let o=n.depth;o>0;o--){const i=n.node(o);if(i.type.spec.tableRole==="cell"||i.type.spec.tableRole==="header_cell"){s=i;break}}return r!==s&&n.parentOffset===0}function ko(e,n,r){const s=(n||e).selection,o=(n||e).doc;let i,l;if(s instanceof us&&(l=s.node.type.spec.tableRole)){if(l=="cell"||l=="header_cell")i=_.create(o,s.from);else if(l=="row"){const a=o.resolve(s.from+1);i=_.rowSelection(a,a)}else if(!r){const a=G.get(s.node),c=s.from+1,d=c+a.map[a.width*a.height-1];i=_.create(o,c+1,d)}}else s instanceof Te&&So(s)?i=Te.create(o,s.from):s instanceof Te&&wo(s)&&(i=Te.create(o,s.$from.start(),s.$from.end()));return i&&(n||(n=e.tr)).setSelection(i),n}const No=new Cn("fix-tables");function Ar(e,n,r,s){const o=e.childCount,i=n.childCount;e:for(let l=0,a=0;l<i;l++){const c=n.child(l);for(let d=a,h=Math.min(o,l+3);d<h;d++)if(e.child(d)==c){a=d+1,r+=c.nodeSize;continue e}s(c,r),a<o&&e.child(a).sameMarkup(c)?Ar(e.child(a),c,r+1,s):c.nodesBetween(0,c.content.size,s,r+1),r+=c.nodeSize}}function Rr(e,n){let r;const s=(o,i)=>{o.type.spec.tableRole=="table"&&(r=zo(e,o,i,r))};return n?n.doc!=e.doc&&Ar(n.doc,e.doc,0,s):e.doc.descendants(s),r}function zo(e,n,r,s){const o=G.get(n);if(!o.problems)return s;s||(s=e.tr);const i=[];for(let c=0;c<o.height;c++)i.push(0);for(let c=0;c<o.problems.length;c++){const d=o.problems[c];if(d.type=="collision"){const h=n.nodeAt(d.pos);if(!h)continue;const f=h.attrs;for(let m=0;m<f.rowspan;m++)i[d.row+m]+=d.n;s.setNodeMarkup(s.mapping.map(r+1+d.pos),null,Pe(f,f.colspan-d.n,d.n))}else if(d.type=="missing")i[d.row]+=d.n;else if(d.type=="overlong_rowspan"){const h=n.nodeAt(d.pos);if(!h)continue;s.setNodeMarkup(s.mapping.map(r+1+d.pos),null,{...h.attrs,rowspan:h.attrs.rowspan-d.n})}else if(d.type=="colwidth mismatch"){const h=n.nodeAt(d.pos);if(!h)continue;s.setNodeMarkup(s.mapping.map(r+1+d.pos),null,{...h.attrs,colwidth:d.colwidth})}else if(d.type=="zero_sized"){const h=s.mapping.map(r);s.delete(h,h+n.nodeSize)}}let l,a;for(let c=0;c<i.length;c++)i[c]&&(l==null&&(l=c),a=c);for(let c=0,d=r+1;c<o.height;c++){const h=n.child(c),f=d+h.nodeSize,m=i[c];if(m>0){let u="cell";h.firstChild&&(u=h.firstChild.type.spec.tableRole);const b=[];for(let C=0;C<m;C++){const k=q(e.schema)[u].createAndFill();k&&b.push(k)}const j=(c==0||l==c-1)&&a==c?d+1:f-1;s.insert(s.mapping.map(j),b)}d=f}return s.setMeta(No,{fixTables:!0})}function me(e){const n=e.selection,r=Ut(e),s=r.node(-1),o=r.start(-1),i=G.get(s);return{...n instanceof _?i.rectBetween(n.$anchorCell.pos-o,n.$headCell.pos-o):i.findCell(r.pos-o),tableStart:o,map:i,table:s}}function Tr(e,{map:n,tableStart:r,table:s},o){let i=o>0?-1:0;vo(n,s,o+i)&&(i=o==0||o==n.width?null:0);for(let l=0;l<n.height;l++){const a=l*n.width+o;if(o>0&&o<n.width&&n.map[a-1]==n.map[a]){const c=n.map[a],d=s.nodeAt(c);e.setNodeMarkup(e.mapping.map(r+c),null,Nr(d.attrs,o-n.colCount(c))),l+=d.attrs.rowspan-1}else{const c=i==null?q(s.type.schema).cell:s.nodeAt(n.map[a+i]).type,d=n.positionAt(l,o,s);e.insert(e.mapping.map(r+d),c.createAndFill())}}return e}function Ao(e,n){if(!de(e))return!1;if(n){const r=me(e);n(Tr(e.tr,r,r.left))}return!0}function Ro(e,n){if(!de(e))return!1;if(n){const r=me(e);n(Tr(e.tr,r,r.right))}return!0}function To(e,{map:n,table:r,tableStart:s},o){const i=e.mapping.maps.length;for(let l=0;l<n.height;){const a=l*n.width+o,c=n.map[a],d=r.nodeAt(c),h=d.attrs;if(o>0&&n.map[a-1]==c||o<n.width-1&&n.map[a+1]==c)e.setNodeMarkup(e.mapping.slice(i).map(s+c),null,Pe(h,o-n.colCount(c)));else{const f=e.mapping.slice(i).map(s+c);e.delete(f,f+d.nodeSize)}l+=h.rowspan}}function Mo(e,n){if(!de(e))return!1;if(n){const r=me(e),s=e.tr;if(r.left==0&&r.right==r.map.width)return!1;for(let o=r.right-1;To(s,r,o),o!=r.left;o--){const i=r.tableStart?s.doc.nodeAt(r.tableStart-1):s.doc;if(!i)throw new RangeError("No table found");r.table=i,r.map=G.get(i)}n(s)}return!0}function Eo(e,n,r){var s;const o=q(n.type.schema).header_cell;for(let i=0;i<e.width;i++)if(((s=n.nodeAt(e.map[i+r*e.width]))===null||s===void 0?void 0:s.type)!=o)return!1;return!0}function Mr(e,{map:n,tableStart:r,table:s},o){let i=r;for(let d=0;d<o;d++)i+=s.child(d).nodeSize;const l=[];let a=o>0?-1:0;Eo(n,s,o+a)&&(a=o==0||o==n.height?null:0);for(let d=0,h=n.width*o;d<n.width;d++,h++)if(o>0&&o<n.height&&n.map[h]==n.map[h-n.width]){const f=n.map[h],m=s.nodeAt(f).attrs;e.setNodeMarkup(r+f,null,{...m,rowspan:m.rowspan+1}),d+=m.colspan-1}else{var c;const f=a==null?q(s.type.schema).cell:(c=s.nodeAt(n.map[h+a*n.width]))===null||c===void 0?void 0:c.type,m=f?.createAndFill();m&&l.push(m)}return e.insert(i,q(s.type.schema).row.create(null,l)),e}function Wo(e,n){if(!de(e))return!1;if(n){const r=me(e);n(Mr(e.tr,r,r.top))}return!0}function Lo(e,n){if(!de(e))return!1;if(n){const r=me(e);n(Mr(e.tr,r,r.bottom))}return!0}function Io(e,{map:n,table:r,tableStart:s},o){let i=0;for(let d=0;d<o;d++)i+=r.child(d).nodeSize;const l=i+r.child(o).nodeSize,a=e.mapping.maps.length;e.delete(i+s,l+s);const c=new Set;for(let d=0,h=o*n.width;d<n.width;d++,h++){const f=n.map[h];if(!c.has(f)){if(c.add(f),o>0&&f==n.map[h-n.width]){const m=r.nodeAt(f).attrs;e.setNodeMarkup(e.mapping.slice(a).map(f+s),null,{...m,rowspan:m.rowspan-1}),d+=m.colspan-1}else if(o<n.height&&f==n.map[h+n.width]){const m=r.nodeAt(f),u=m.attrs,b=m.type.create({...u,rowspan:m.attrs.rowspan-1},m.content),j=n.positionAt(o+1,d,r);e.insert(e.mapping.slice(a).map(s+j),b),d+=u.colspan-1}}}}function Ho(e,n){if(!de(e))return!1;if(n){const r=me(e),s=e.tr;if(r.top==0&&r.bottom==r.map.height)return!1;for(let o=r.bottom-1;Io(s,r,o),o!=r.top;o--){const i=r.tableStart?s.doc.nodeAt(r.tableStart-1):s.doc;if(!i)throw new RangeError("No table found");r.table=i,r.map=G.get(r.table)}n(s)}return!0}function Kn(e){const n=e.content;return n.childCount==1&&n.child(0).isTextblock&&n.child(0).childCount==0}function _o({width:e,height:n,map:r},s){let o=s.top*e+s.left,i=o,l=(s.bottom-1)*e+s.left,a=o+(s.right-s.left-1);for(let c=s.top;c<s.bottom;c++){if(s.left>0&&r[i]==r[i-1]||s.right<e&&r[a]==r[a+1])return!0;i+=e,a+=e}for(let c=s.left;c<s.right;c++){if(s.top>0&&r[o]==r[o-e]||s.bottom<n&&r[l]==r[l+e])return!0;o++,l++}return!1}function Vn(e,n){const r=e.selection;if(!(r instanceof _)||r.$anchorCell.pos==r.$headCell.pos)return!1;const s=me(e),{map:o}=s;if(_o(o,s))return!1;if(n){const i=e.tr,l={};let a=he.empty,c,d;for(let h=s.top;h<s.bottom;h++)for(let f=s.left;f<s.right;f++){const m=o.map[h*o.width+f],u=s.table.nodeAt(m);if(!(l[m]||!u))if(l[m]=!0,c==null)c=m,d=u;else{Kn(u)||(a=a.append(u.content));const b=i.mapping.map(m+s.tableStart);i.delete(b,b+u.nodeSize)}}if(c==null||d==null)return!0;if(i.setNodeMarkup(c+s.tableStart,null,{...Nr(d.attrs,d.attrs.colspan,s.right-s.left-d.attrs.colspan),rowspan:s.bottom-s.top}),a.size>0){const h=c+1+d.content.size,f=Kn(d)?c+1:h;i.replaceWith(f+s.tableStart,h+s.tableStart,a)}i.setSelection(new _(i.doc.resolve(c+s.tableStart))),n(i)}return!0}function Yn(e,n){const r=q(e.schema);return Do(({node:s})=>r[s.type.spec.tableRole])(e,n)}function Do(e){return(n,r)=>{const s=n.selection;let o,i;if(s instanceof _){if(s.$anchorCell.pos!=s.$headCell.pos)return!1;o=s.$anchorCell.nodeAfter,i=s.$anchorCell.pos}else{var l;if(o=go(s.$from),!o)return!1;i=(l=Be(s.$from))===null||l===void 0?void 0:l.pos}if(o==null||i==null||o.attrs.colspan==1&&o.attrs.rowspan==1)return!1;if(r){let a=o.attrs;const c=[],d=a.colwidth;a.rowspan>1&&(a={...a,rowspan:1}),a.colspan>1&&(a={...a,colspan:1});const h=me(n),f=n.tr;for(let u=0;u<h.right-h.left;u++)c.push(d?{...a,colwidth:d&&d[u]?[d[u]]:null}:a);let m;for(let u=h.top;u<h.bottom;u++){let b=h.map.positionAt(u,h.left,h.table);u==h.top&&(b+=o.nodeSize);for(let j=h.left,C=0;j<h.right;j++,C++)j==h.left&&u==h.top||f.insert(m=f.mapping.map(b+h.tableStart,1),e({node:o,row:u,col:j}).createAndFill(c[C]))}f.setNodeMarkup(i,e({node:o,row:h.top,col:h.left}),c[0]),s instanceof _&&f.setSelection(new _(f.doc.resolve(s.$anchorCell.pos),m?f.doc.resolve(m):void 0)),r(f)}return!0}}function $o(e,n){return function(r,s){if(!de(r))return!1;const o=Ut(r);if(o.nodeAfter.attrs[e]===n)return!1;if(s){const i=r.tr;r.selection instanceof _?r.selection.forEachCell((l,a)=>{l.attrs[e]!==n&&i.setNodeMarkup(a,null,{...l.attrs,[e]:n})}):i.setNodeMarkup(o.pos,null,{...o.nodeAfter.attrs,[e]:n}),s(i)}return!0}}function Bo(e){return function(n,r){if(!de(n))return!1;if(r){const s=q(n.schema),o=me(n),i=n.tr,l=o.map.cellsInRect(e=="column"?{left:o.left,top:0,right:o.right,bottom:o.map.height}:e=="row"?{left:0,top:o.top,right:o.map.width,bottom:o.bottom}:o),a=l.map(c=>o.table.nodeAt(c));for(let c=0;c<l.length;c++)a[c].type==s.header_cell&&i.setNodeMarkup(o.tableStart+l[c],s.cell,a[c].attrs);if(i.steps.length===0)for(let c=0;c<l.length;c++)i.setNodeMarkup(o.tableStart+l[c],s.header_cell,a[c].attrs);r(i)}return!0}}function Xn(e,n,r){const s=n.map.cellsInRect({left:0,top:0,right:e=="row"?n.map.width:1,bottom:e=="column"?n.map.height:1});for(let o=0;o<s.length;o++){const i=n.table.nodeAt(s[o]);if(i&&i.type!==r.header_cell)return!1}return!0}function yt(e,n){return n=n||{useDeprecatedLogic:!1},n.useDeprecatedLogic?Bo(e):function(r,s){if(!de(r))return!1;if(s){const o=q(r.schema),i=me(r),l=r.tr,a=Xn("row",i,o),c=Xn("column",i,o),d=(e==="column"?a:e==="row"&&c)?1:0,h=e=="column"?{left:0,top:d,right:1,bottom:i.map.height}:e=="row"?{left:d,top:0,right:i.map.width,bottom:1}:i,f=e=="column"?c?o.cell:o.header_cell:e=="row"?a?o.cell:o.header_cell:o.cell;i.map.cellsInRect(h).forEach(m=>{const u=m+i.tableStart,b=l.doc.nodeAt(u);b&&l.setNodeMarkup(u,f,b.attrs)}),s(l)}return!0}}yt("row",{useDeprecatedLogic:!0});yt("column",{useDeprecatedLogic:!0});const Po=yt("cell",{useDeprecatedLogic:!0});function Oo(e,n){if(n<0){const r=e.nodeBefore;if(r)return e.pos-r.nodeSize;for(let s=e.index(-1)-1,o=e.before();s>=0;s--){const i=e.node(-1).child(s),l=i.lastChild;if(l)return o-1-l.nodeSize;o-=i.nodeSize}}else{if(e.index()<e.parent.childCount-1)return e.pos+e.nodeAfter.nodeSize;const r=e.node(-1);for(let s=e.indexAfter(-1),o=e.after();s<r.childCount;s++){const i=r.child(s);if(i.childCount)return o+1;o+=i.nodeSize}}return null}function Jn(e){return function(n,r){if(!de(n))return!1;const s=Oo(Ut(n),e);if(s==null)return!1;if(r){const o=n.doc.resolve(s);r(n.tr.setSelection(Te.between(o,yo(o))).scrollIntoView())}return!0}}function Fo(e,n){const r=e.selection.$anchor;for(let s=r.depth;s>0;s--)if(r.node(s).type.spec.tableRole=="table")return n&&n(e.tr.delete(r.before(s),r.after(s)).scrollIntoView()),!0;return!1}function _t(e,n){const r=e.selection;if(!(r instanceof _))return!1;if(n){const s=e.tr,o=q(e.schema).cell.createAndFill().content;r.forEachCell((i,l)=>{i.content.eq(o)||s.replace(s.mapping.map(l+1),s.mapping.map(l+i.nodeSize-1),new Me(o,0,0))}),s.docChanged&&n(s)}return!0}function Uo(e){if(e.size===0)return null;let{content:n,openStart:r,openEnd:s}=e;for(;n.childCount==1&&(r>0&&s>0||n.child(0).type.spec.tableRole=="table");)r--,s--,n=n.child(0).content;const o=n.child(0),i=o.type.spec.tableRole,l=o.type.schema,a=[];if(i=="row")for(let c=0;c<n.childCount;c++){let d=n.child(c).content;const h=c?0:Math.max(0,r-1),f=c<n.childCount-1?0:Math.max(0,s-1);(h||f)&&(d=yn(q(l).row,new Me(d,h,f)).content),a.push(d)}else if(i=="cell"||i=="header_cell")a.push(r||s?yn(q(l).row,new Me(n,r,s)).content:n);else return null;return Go(l,a)}function Go(e,n){const r=[];for(let o=0;o<n.length;o++){const i=n[o];for(let l=i.childCount-1;l>=0;l--){const{rowspan:a,colspan:c}=i.child(l).attrs;for(let d=o;d<o+a;d++)r[d]=(r[d]||0)+c}}let s=0;for(let o=0;o<r.length;o++)s=Math.max(s,r[o]);for(let o=0;o<r.length;o++)if(o>=n.length&&n.push(he.empty),r[o]<s){const i=q(e).cell.createAndFill(),l=[];for(let a=r[o];a<s;a++)l.push(i);n[o]=n[o].append(he.from(l))}return{height:n.length,width:s,rows:n}}function yn(e,n){const r=e.createAndFill();return new hs(r).replace(0,r.content.size,n).doc}function Ko({width:e,height:n,rows:r},s,o){if(e!=s){const i=[],l=[];for(let a=0;a<r.length;a++){const c=r[a],d=[];for(let h=i[a]||0,f=0;h<s;f++){let m=c.child(f%c.childCount);h+m.attrs.colspan>s&&(m=m.type.createChecked(Pe(m.attrs,m.attrs.colspan,h+m.attrs.colspan-s),m.content)),d.push(m),h+=m.attrs.colspan;for(let u=1;u<m.attrs.rowspan;u++)i[a+u]=(i[a+u]||0)+m.attrs.colspan}l.push(he.from(d))}r=l,e=s}if(n!=o){const i=[];for(let l=0,a=0;l<o;l++,a++){const c=[],d=r[a%n];for(let h=0;h<d.childCount;h++){let f=d.child(h);l+f.attrs.rowspan>o&&(f=f.type.create({...f.attrs,rowspan:Math.max(1,o-f.attrs.rowspan)},f.content)),c.push(f)}i.push(he.from(c))}r=i,n=o}return{width:e,height:n,rows:r}}function Vo(e,n,r,s,o,i,l){const a=e.doc.type.schema,c=q(a);let d,h;if(o>n.width)for(let f=0,m=0;f<n.height;f++){const u=r.child(f);m+=u.nodeSize;const b=[];let j;u.lastChild==null||u.lastChild.type==c.cell?j=d||(d=c.cell.createAndFill()):j=h||(h=c.header_cell.createAndFill());for(let C=n.width;C<o;C++)b.push(j);e.insert(e.mapping.slice(l).map(m-1+s),b)}if(i>n.height){const f=[];for(let b=0,j=(n.height-1)*n.width;b<Math.max(n.width,o);b++){const C=b>=n.width?!1:r.nodeAt(n.map[j+b]).type==c.header_cell;f.push(C?h||(h=c.header_cell.createAndFill()):d||(d=c.cell.createAndFill()))}const m=c.row.create(null,he.from(f)),u=[];for(let b=n.height;b<i;b++)u.push(m);e.insert(e.mapping.slice(l).map(s+r.nodeSize-2),u)}return!!(d||h)}function qn(e,n,r,s,o,i,l,a){if(l==0||l==n.height)return!1;let c=!1;for(let d=o;d<i;d++){const h=l*n.width+d,f=n.map[h];if(n.map[h-n.width]==f){c=!0;const m=r.nodeAt(f),{top:u,left:b}=n.findCell(f);e.setNodeMarkup(e.mapping.slice(a).map(f+s),null,{...m.attrs,rowspan:l-u}),e.insert(e.mapping.slice(a).map(n.positionAt(l,b,r)),m.type.createAndFill({...m.attrs,rowspan:u+m.attrs.rowspan-l})),d+=m.attrs.colspan-1}}return c}function Qn(e,n,r,s,o,i,l,a){if(l==0||l==n.width)return!1;let c=!1;for(let d=o;d<i;d++){const h=d*n.width+l,f=n.map[h];if(n.map[h-1]==f){c=!0;const m=r.nodeAt(f),u=n.colCount(f),b=e.mapping.slice(a).map(f+s);e.setNodeMarkup(b,null,Pe(m.attrs,l-u,m.attrs.colspan-(l-u))),e.insert(b+m.nodeSize,m.type.createAndFill(Pe(m.attrs,0,l-u))),d+=m.attrs.rowspan-1}}return c}function Zn(e,n,r,s,o){let i=r?e.doc.nodeAt(r-1):e.doc;if(!i)throw new Error("No table found");let l=G.get(i);const{top:a,left:c}=s,d=c+o.width,h=a+o.height,f=e.tr;let m=0;function u(){if(i=r?f.doc.nodeAt(r-1):f.doc,!i)throw new Error("No table found");l=G.get(i),m=f.mapping.maps.length}Vo(f,l,i,r,d,h,m)&&u(),qn(f,l,i,r,c,d,a,m)&&u(),qn(f,l,i,r,c,d,h,m)&&u(),Qn(f,l,i,r,a,h,c,m)&&u(),Qn(f,l,i,r,a,h,d,m)&&u();for(let b=a;b<h;b++){const j=l.positionAt(b,c,i),C=l.positionAt(b,d,i);f.replace(f.mapping.slice(m).map(j+r),f.mapping.slice(m).map(C+r),new Me(o.rows[b-a],0,0))}u(),f.setSelection(new _(f.doc.resolve(r+l.positionAt(a,c,i)),f.doc.resolve(r+l.positionAt(h-1,d-1,i)))),n(f)}const Yo=ps({ArrowLeft:Dt("horiz",-1),ArrowRight:Dt("horiz",1),ArrowUp:Dt("vert",-1),ArrowDown:Dt("vert",1),"Shift-ArrowLeft":$t("horiz",-1),"Shift-ArrowRight":$t("horiz",1),"Shift-ArrowUp":$t("vert",-1),"Shift-ArrowDown":$t("vert",1),Backspace:_t,"Mod-Backspace":_t,Delete:_t,"Mod-Delete":_t});function Pt(e,n,r){return r.eq(e.selection)?!1:(n&&n(e.tr.setSelection(r).scrollIntoView()),!0)}function Dt(e,n){return(r,s,o)=>{if(!o)return!1;const i=r.selection;if(i instanceof _)return Pt(r,s,Ce.near(i.$headCell,n));if(e!="horiz"&&!i.empty)return!1;const l=Er(o,e,n);if(l==null)return!1;if(e=="horiz")return Pt(r,s,Ce.near(r.doc.resolve(i.head+n),n));{const a=r.doc.resolve(l),c=kr(a,e,n);let d;return c?d=Ce.near(c,1):n<0?d=Ce.near(r.doc.resolve(a.before(-1)),-1):d=Ce.near(r.doc.resolve(a.after(-1)),1),Pt(r,s,d)}}}function $t(e,n){return(r,s,o)=>{if(!o)return!1;const i=r.selection;let l;if(i instanceof _)l=i;else{const c=Er(o,e,n);if(c==null)return!1;l=new _(r.doc.resolve(c))}const a=kr(l.$headCell,e,n);return a?Pt(r,s,new _(l.$anchorCell,a)):!1}}function Xo(e,n){const r=e.state.doc,s=Be(r.resolve(n));return s?(e.dispatch(e.state.tr.setSelection(new _(s))),!0):!1}function Jo(e,n,r){if(!de(e.state))return!1;let s=Uo(r);const o=e.state.selection;if(o instanceof _){s||(s={width:1,height:1,rows:[he.from(yn(q(e.state.schema).cell,r))]});const i=o.$anchorCell.node(-1),l=o.$anchorCell.start(-1),a=G.get(i).rectBetween(o.$anchorCell.pos-l,o.$headCell.pos-l);return s=Ko(s,a.right-a.left,a.bottom-a.top),Zn(e.state,e.dispatch,l,a,s),!0}else if(s){const i=Ut(e.state),l=i.start(-1);return Zn(e.state,e.dispatch,l,G.get(i.node(-1)).findCell(i.pos-l),s),!0}else return!1}function qo(e,n){var r;if(n.button!=0||n.ctrlKey||n.metaKey)return;const s=er(e,n.target);let o;if(n.shiftKey&&e.state.selection instanceof _)i(e.state.selection.$anchorCell,n),n.preventDefault();else if(n.shiftKey&&s&&(o=Be(e.state.selection.$anchor))!=null&&((r=dn(e,n))===null||r===void 0?void 0:r.pos)!=o.pos)i(o,n),n.preventDefault();else if(!s)return;function i(c,d){let h=dn(e,d);const f=Re.getState(e.state)==null;if(!h||!wn(c,h))if(f)h=c;else return;const m=new _(c,h);if(f||!e.state.selection.eq(m)){const u=e.state.tr.setSelection(m);f&&u.setMeta(Re,c.pos),e.dispatch(u)}}function l(){e.root.removeEventListener("mouseup",l),e.root.removeEventListener("dragstart",l),e.root.removeEventListener("mousemove",a),Re.getState(e.state)!=null&&e.dispatch(e.state.tr.setMeta(Re,-1))}function a(c){const d=c,h=Re.getState(e.state);let f;if(h!=null)f=e.state.doc.resolve(h);else if(er(e,d.target)!=s&&(f=dn(e,n),!f))return l();f&&i(f,d)}e.root.addEventListener("mouseup",l),e.root.addEventListener("dragstart",l),e.root.addEventListener("mousemove",a)}function Er(e,n,r){if(!(e.state.selection instanceof Te))return null;const{$head:s}=e.state.selection;for(let o=s.depth-1;o>=0;o--){const i=s.node(o);if((r<0?s.index(o):s.indexAfter(o))!=(r<0?0:i.childCount))return null;if(i.type.spec.tableRole=="cell"||i.type.spec.tableRole=="header_cell"){const l=s.before(o),a=n=="vert"?r>0?"down":"up":r>0?"right":"left";return e.endOfTextblock(a)?l:null}}return null}function er(e,n){for(;n&&n!=e.dom;n=n.parentNode)if(n.nodeName=="TD"||n.nodeName=="TH")return n;return null}function dn(e,n){const r=e.posAtCoords({left:n.clientX,top:n.clientY});if(!r)return null;let{inside:s,pos:o}=r;return s>=0&&Be(e.state.doc.resolve(s))||Be(e.state.doc.resolve(o))}var Qo=class{constructor(n,r){this.node=n,this.defaultCellMinWidth=r,this.dom=document.createElement("div"),this.dom.className="tableWrapper",this.table=this.dom.appendChild(document.createElement("table")),this.table.style.setProperty("--default-cell-min-width",`${r}px`),this.colgroup=this.table.appendChild(document.createElement("colgroup")),vn(n,this.colgroup,this.table,r),this.contentDOM=this.table.appendChild(document.createElement("tbody"))}update(n){return n.type!=this.node.type?!1:(this.node=n,vn(n,this.colgroup,this.table,this.defaultCellMinWidth),!0)}ignoreMutation(n){return n.type=="attributes"&&(n.target==this.table||this.colgroup.contains(n.target))}};function vn(e,n,r,s,o,i){let l=0,a=!0,c=n.firstChild;const d=e.firstChild;if(d){for(let f=0,m=0;f<d.childCount;f++){const{colspan:u,colwidth:b}=d.child(f).attrs;for(let j=0;j<u;j++,m++){const C=o==m?i:b&&b[j],k=C?C+"px":"";if(l+=C||s,C||(a=!1),c)c.style.width!=k&&(c.style.width=k),c=c.nextSibling;else{const F=document.createElement("col");F.style.width=k,n.appendChild(F)}}}for(;c;){var h;const f=c.nextSibling;(h=c.parentNode)===null||h===void 0||h.removeChild(c),c=f}a?(r.style.width=l+"px",r.style.minWidth=""):(r.style.width="",r.style.minWidth=l+"px")}}const oe=new Cn("tableColumnResizing");function Zo({handleWidth:e=5,cellMinWidth:n=25,defaultCellMinWidth:r=100,View:s=Qo,lastColumnResizable:o=!0}={}){const i=new hr({key:oe,state:{init(l,a){var c;const d=(c=i.spec)===null||c===void 0||(c=c.props)===null||c===void 0?void 0:c.nodeViews,h=q(a.schema).table.name;return s&&d&&(d[h]=(f,m)=>new s(f,r,m)),new ei(-1,!1)},apply(l,a){return a.apply(l)}},props:{attributes:l=>{const a=oe.getState(l);return a&&a.activeHandle>-1?{class:"resize-cursor"}:{}},handleDOMEvents:{mousemove:(l,a)=>{ti(l,a,e,o)},mouseleave:l=>{ni(l)},mousedown:(l,a)=>{ri(l,a,n,r)}},decorations:l=>{const a=oe.getState(l);if(a&&a.activeHandle>-1)return ai(l,a.activeHandle)},nodeViews:{}}});return i}var ei=class Ot{constructor(n,r){this.activeHandle=n,this.dragging=r}apply(n){const r=this,s=n.getMeta(oe);if(s&&s.setHandle!=null)return new Ot(s.setHandle,!1);if(s&&s.setDragging!==void 0)return new Ot(r.activeHandle,s.setDragging);if(r.activeHandle>-1&&n.docChanged){let o=n.mapping.map(r.activeHandle,-1);return bn(n.doc.resolve(o))||(o=-1),new Ot(o,r.dragging)}return r}};function ti(e,n,r,s){if(!e.editable)return;const o=oe.getState(e.state);if(o&&!o.dragging){const i=oi(n.target);let l=-1;if(i){const{left:a,right:c}=i.getBoundingClientRect();n.clientX-a<=r?l=tr(e,n,"left",r):c-n.clientX<=r&&(l=tr(e,n,"right",r))}if(l!=o.activeHandle){if(!s&&l!==-1){const a=e.state.doc.resolve(l),c=a.node(-1),d=G.get(c),h=a.start(-1);if(d.colCount(a.pos-h)+a.nodeAfter.attrs.colspan-1==d.width-1)return}Wr(e,l)}}}function ni(e){if(!e.editable)return;const n=oe.getState(e.state);n&&n.activeHandle>-1&&!n.dragging&&Wr(e,-1)}function ri(e,n,r,s){var o;if(!e.editable)return!1;const i=(o=e.dom.ownerDocument.defaultView)!==null&&o!==void 0?o:window,l=oe.getState(e.state);if(!l||l.activeHandle==-1||l.dragging)return!1;const a=e.state.doc.nodeAt(l.activeHandle),c=si(e,l.activeHandle,a.attrs);e.dispatch(e.state.tr.setMeta(oe,{setDragging:{startX:n.clientX,startWidth:c}}));function d(f){i.removeEventListener("mouseup",d),i.removeEventListener("mousemove",h);const m=oe.getState(e.state);m?.dragging&&(ii(e,m.activeHandle,nr(m.dragging,f,r)),e.dispatch(e.state.tr.setMeta(oe,{setDragging:null})))}function h(f){if(!f.which)return d(f);const m=oe.getState(e.state);if(m&&m.dragging){const u=nr(m.dragging,f,r);rr(e,m.activeHandle,u,s)}}return rr(e,l.activeHandle,c,s),i.addEventListener("mouseup",d),i.addEventListener("mousemove",h),n.preventDefault(),!0}function si(e,n,{colspan:r,colwidth:s}){const o=s&&s[s.length-1];if(o)return o;const i=e.domAtPos(n);let l=i.node.childNodes[i.offset].offsetWidth,a=r;if(s)for(let c=0;c<r;c++)s[c]&&(l-=s[c],a--);return l/a}function oi(e){for(;e&&e.nodeName!="TD"&&e.nodeName!="TH";)e=e.classList&&e.classList.contains("ProseMirror")?null:e.parentNode;return e}function tr(e,n,r,s){const o=r=="right"?-s:s,i=e.posAtCoords({left:n.clientX+o,top:n.clientY});if(!i)return-1;const{pos:l}=i,a=Be(e.state.doc.resolve(l));if(!a)return-1;if(r=="right")return a.pos;const c=G.get(a.node(-1)),d=a.start(-1),h=c.map.indexOf(a.pos-d);return h%c.width==0?-1:d+c.map[h-1]}function nr(e,n,r){const s=n.clientX-e.startX;return Math.max(r,e.startWidth+s)}function Wr(e,n){e.dispatch(e.state.tr.setMeta(oe,{setHandle:n}))}function ii(e,n,r){const s=e.state.doc.resolve(n),o=s.node(-1),i=G.get(o),l=s.start(-1),a=i.colCount(s.pos-l)+s.nodeAfter.attrs.colspan-1,c=e.state.tr;for(let d=0;d<i.height;d++){const h=d*i.width+a;if(d&&i.map[h]==i.map[h-i.width])continue;const f=i.map[h],m=o.nodeAt(f).attrs,u=m.colspan==1?0:a-i.colCount(f);if(m.colwidth&&m.colwidth[u]==r)continue;const b=m.colwidth?m.colwidth.slice():li(m.colspan);b[u]=r,c.setNodeMarkup(l+f,null,{...m,colwidth:b})}c.docChanged&&e.dispatch(c)}function rr(e,n,r,s){const o=e.state.doc.resolve(n),i=o.node(-1),l=o.start(-1),a=G.get(i).colCount(o.pos-l)+o.nodeAfter.attrs.colspan-1;let c=e.domAtPos(o.start(-1)).node;for(;c&&c.nodeName!="TABLE";)c=c.parentNode;c&&vn(i,c.firstChild,c,s,a,r)}function li(e){return Array(e).fill(0)}function ai(e,n){const r=[],s=e.doc.resolve(n),o=s.node(-1);if(!o)return pn.empty;const i=G.get(o),l=s.start(-1),a=i.colCount(s.pos-l)+s.nodeAfter.attrs.colspan-1;for(let d=0;d<i.height;d++){const h=a+d*i.width;if((a==i.width-1||i.map[h]!=i.map[h+1])&&(d==0||i.map[h]!=i.map[h-i.width])){var c;const f=i.map[h],m=l+f+o.nodeAt(f).nodeSize-1,u=document.createElement("div");u.className="column-resize-handle",!((c=oe.getState(e))===null||c===void 0)&&c.dragging&&r.push(un.node(l+f,l+f+o.nodeAt(f).nodeSize,{class:"column-resize-dragging"})),r.push(un.widget(m,u))}}return pn.create(e.doc,r)}function ci({allowTableNodeSelection:e=!1}={}){return new hr({key:Re,state:{init(){return null},apply(n,r){const s=n.getMeta(Re);if(s!=null)return s==-1?null:s;if(r==null||!n.docChanged)return r;const{deleted:o,pos:i}=n.mapping.mapResult(r);return o?null:i}},props:{decorations:Co,handleDOMEvents:{mousedown:qo},createSelectionBetween(n){return Re.getState(n.state)!=null?n.state.selection:null},handleTripleClick:Xo,handleKeyDown:Yo,handlePaste:Jo},appendTransaction(n,r,s){return ko(s,Rr(s,r),e)}})}var Lr=vt.create({name:"tableCell",addOptions(){return{HTMLAttributes:{}}},content:"block+",addAttributes(){return{colspan:{default:1},rowspan:{default:1},colwidth:{default:null,parseHTML:e=>{var n,r;const s=e.getAttribute("colwidth"),o=s?s.split(",").map(i=>parseInt(i,10)):null;if(!o){const i=(n=e.closest("table"))==null?void 0:n.querySelectorAll("colgroup > col"),l=Array.from(((r=e.parentElement)==null?void 0:r.children)||[]).indexOf(e);if(l&&l>-1&&i&&i[l]){const a=i[l].getAttribute("width");return a?[parseInt(a,10)]:null}}return o}}}},tableRole:"cell",isolating:!0,parseHTML(){return[{tag:"td"}]},renderHTML({HTMLAttributes:e}){return["td",Oe(this.options.HTMLAttributes,e),0]}}),Ir=vt.create({name:"tableHeader",addOptions(){return{HTMLAttributes:{}}},content:"block+",addAttributes(){return{colspan:{default:1},rowspan:{default:1},colwidth:{default:null,parseHTML:e=>{const n=e.getAttribute("colwidth");return n?n.split(",").map(s=>parseInt(s,10)):null}}}},tableRole:"header_cell",isolating:!0,parseHTML(){return[{tag:"th"}]},renderHTML({HTMLAttributes:e}){return["th",Oe(this.options.HTMLAttributes,e),0]}}),Hr=vt.create({name:"tableRow",addOptions(){return{HTMLAttributes:{}}},content:"(tableCell | tableHeader)*",tableRole:"row",parseHTML(){return[{tag:"tr"}]},renderHTML({HTMLAttributes:e}){return["tr",Oe(this.options.HTMLAttributes,e),0]}});function jn(e,n){return n?["width",`${Math.max(n,e)}px`]:["min-width",`${e}px`]}function sr(e,n,r,s,o,i){var l;let a=0,c=!0,d=n.firstChild;const h=e.firstChild;if(h!==null)for(let m=0,u=0;m<h.childCount;m+=1){const{colspan:b,colwidth:j}=h.child(m).attrs;for(let C=0;C<b;C+=1,u+=1){const k=o===u?i:j&&j[C],F=k?`${k}px`:"";if(a+=k||s,k||(c=!1),d){if(d.style.width!==F){const[D,U]=jn(s,k);d.style.setProperty(D,U)}d=d.nextSibling}else{const D=document.createElement("col"),[U,Y]=jn(s,k);D.style.setProperty(U,Y),n.appendChild(D)}}}for(;d;){const m=d.nextSibling;(l=d.parentNode)==null||l.removeChild(d),d=m}const f=e.attrs.style&&typeof e.attrs.style=="string"&&/\bwidth\s*:/i.test(e.attrs.style);c&&!f?(r.style.width=`${a}px`,r.style.minWidth=""):(r.style.width="",r.style.minWidth=`${a}px`)}var di=class{constructor(e,n){this.node=e,this.cellMinWidth=n,this.dom=document.createElement("div"),this.dom.className="tableWrapper",this.table=this.dom.appendChild(document.createElement("table")),e.attrs.style&&(this.table.style.cssText=e.attrs.style),this.colgroup=this.table.appendChild(document.createElement("colgroup")),sr(e,this.colgroup,this.table,n),this.contentDOM=this.table.appendChild(document.createElement("tbody"))}update(e){return e.type!==this.node.type?!1:(this.node=e,sr(e,this.colgroup,this.table,this.cellMinWidth),!0)}ignoreMutation(e){const n=e.target,r=this.dom.contains(n),s=this.contentDOM.contains(n);return!!(r&&!s&&(e.type==="attributes"||e.type==="childList"||e.type==="characterData"))}};function pi(e,n,r,s){let o=0,i=!0;const l=[],a=e.firstChild;if(!a)return{};for(let f=0,m=0;f<a.childCount;f+=1){const{colspan:u,colwidth:b}=a.child(f).attrs;for(let j=0;j<u;j+=1,m+=1){const C=r===m?s:b&&b[j];o+=C||n,C||(i=!1);const[k,F]=jn(n,C);l.push(["col",{style:`${k}: ${F}`}])}}const c=i?`${o}px`:"",d=i?"":`${o}px`;return{colgroup:["colgroup",{},...l],tableWidth:c,tableMinWidth:d}}function or(e,n){return e.createAndFill()}function ui(e){if(e.cached.tableNodeTypes)return e.cached.tableNodeTypes;const n={};return Object.keys(e.nodes).forEach(r=>{const s=e.nodes[r];s.spec.tableRole&&(n[s.spec.tableRole]=s)}),e.cached.tableNodeTypes=n,n}function hi(e,n,r,s,o){const i=ui(e),l=[],a=[];for(let d=0;d<r;d+=1){const h=or(i.cell);if(h&&a.push(h),s){const f=or(i.header_cell);f&&l.push(f)}}const c=[];for(let d=0;d<n;d+=1)c.push(i.row.createChecked(null,s&&d===0?l:a));return i.table.createChecked(null,c)}function fi(e){return e instanceof _}var Bt=({editor:e})=>{const{selection:n}=e.state;if(!fi(n))return!1;let r=0;const s=xs(n.ranges[0].$from,i=>i.type.name==="table");return s?.node.descendants(i=>{if(i.type.name==="table")return!1;["tableCell","tableHeader"].includes(i.type.name)&&(r+=1)}),r===n.ranges.length?(e.commands.deleteTable(),!0):!1},mi="";function xi(e){return(e||"").replace(/\s+/g," ").trim()}function gi(e,n,r={}){var s;const o=(s=r.cellLineSeparator)!=null?s:mi;if(!e||!e.content||e.content.length===0)return"";const i=[];e.content.forEach(b=>{const j=[];b.content&&b.content.forEach(C=>{let k="";C.content&&Array.isArray(C.content)&&C.content.length>1?k=C.content.map(Y=>n.renderChildren(Y)).join(o):k=C.content?n.renderChildren(C.content):"";const F=xi(k),D=C.type==="tableHeader";j.push({text:F,isHeader:D})}),i.push(j)});const l=i.reduce((b,j)=>Math.max(b,j.length),0);if(l===0)return"";const a=new Array(l).fill(0);i.forEach(b=>{var j;for(let C=0;C<l;C+=1){const F=(((j=b[C])==null?void 0:j.text)||"").length;F>a[C]&&(a[C]=F),a[C]<3&&(a[C]=3)}});const c=(b,j)=>b+" ".repeat(Math.max(0,j-b.length)),d=i[0],h=d.some(b=>b.isHeader);let f=`
`;const m=new Array(l).fill(0).map((b,j)=>h&&d[j]&&d[j].text||"");return f+=`| ${m.map((b,j)=>c(b,a[j])).join(" | ")} |
`,f+=`| ${a.map(b=>"-".repeat(Math.max(3,b))).join(" | ")} |
`,(h?i.slice(1):i).forEach(b=>{f+=`| ${new Array(l).fill(0).map((j,C)=>c(b[C]&&b[C].text||"",a[C])).join(" | ")} |
`}),f}var bi=gi,_r=vt.create({name:"table",addOptions(){return{HTMLAttributes:{},resizable:!1,renderWrapper:!1,handleWidth:5,cellMinWidth:25,View:di,lastColumnResizable:!0,allowTableNodeSelection:!1}},content:"tableRow+",tableRole:"table",isolating:!0,group:"block",parseHTML(){return[{tag:"table"}]},renderHTML({node:e,HTMLAttributes:n}){const{colgroup:r,tableWidth:s,tableMinWidth:o}=pi(e,this.options.cellMinWidth),i=n.style;function l(){return i||(s?`width: ${s}`:`min-width: ${o}`)}const a=["table",Oe(this.options.HTMLAttributes,n,{style:l()}),r,["tbody",0]];return this.options.renderWrapper?["div",{class:"tableWrapper"},a]:a},parseMarkdown:(e,n)=>{const r=[];if(e.header){const s=[];e.header.forEach(o=>{s.push(n.createNode("tableHeader",{},[{type:"paragraph",content:n.parseInline(o.tokens)}]))}),r.push(n.createNode("tableRow",{},s))}return e.rows&&e.rows.forEach(s=>{const o=[];s.forEach(i=>{o.push(n.createNode("tableCell",{},[{type:"paragraph",content:n.parseInline(i.tokens)}]))}),r.push(n.createNode("tableRow",{},o))}),n.createNode("table",void 0,r)},renderMarkdown:(e,n)=>bi(e,n),addCommands(){return{insertTable:({rows:e=3,cols:n=3,withHeaderRow:r=!0}={})=>({tr:s,dispatch:o,editor:i})=>{const l=hi(i.schema,e,n,r);if(o){const a=s.selection.from+1;s.replaceSelectionWith(l).scrollIntoView().setSelection(Te.near(s.doc.resolve(a)))}return!0},addColumnBefore:()=>({state:e,dispatch:n})=>Ao(e,n),addColumnAfter:()=>({state:e,dispatch:n})=>Ro(e,n),deleteColumn:()=>({state:e,dispatch:n})=>Mo(e,n),addRowBefore:()=>({state:e,dispatch:n})=>Wo(e,n),addRowAfter:()=>({state:e,dispatch:n})=>Lo(e,n),deleteRow:()=>({state:e,dispatch:n})=>Ho(e,n),deleteTable:()=>({state:e,dispatch:n})=>Fo(e,n),mergeCells:()=>({state:e,dispatch:n})=>Vn(e,n),splitCell:()=>({state:e,dispatch:n})=>Yn(e,n),toggleHeaderColumn:()=>({state:e,dispatch:n})=>yt("column")(e,n),toggleHeaderRow:()=>({state:e,dispatch:n})=>yt("row")(e,n),toggleHeaderCell:()=>({state:e,dispatch:n})=>Po(e,n),mergeOrSplit:()=>({state:e,dispatch:n})=>Vn(e,n)?!0:Yn(e,n),setCellAttribute:(e,n)=>({state:r,dispatch:s})=>$o(e,n)(r,s),goToNextCell:()=>({state:e,dispatch:n})=>Jn(1)(e,n),goToPreviousCell:()=>({state:e,dispatch:n})=>Jn(-1)(e,n),fixTables:()=>({state:e,dispatch:n})=>(n&&Rr(e),!0),setCellSelection:e=>({tr:n,dispatch:r})=>{if(r){const s=_.create(n.doc,e.anchorCell,e.headCell);n.setSelection(s)}return!0}}},addKeyboardShortcuts(){return{Tab:()=>this.editor.commands.goToNextCell()?!0:this.editor.can().addRowAfter()?this.editor.chain().addRowAfter().goToNextCell().run():!1,"Shift-Tab":()=>this.editor.commands.goToPreviousCell(),Backspace:Bt,"Mod-Backspace":Bt,Delete:Bt,"Mod-Delete":Bt}},addProseMirrorPlugins(){return[...this.options.resizable&&this.editor.isEditable?[Zo({handleWidth:this.options.handleWidth,cellMinWidth:this.options.cellMinWidth,defaultCellMinWidth:this.options.cellMinWidth,View:this.options.View,lastColumnResizable:this.options.lastColumnResizable})]:[],ci({allowTableNodeSelection:this.options.allowTableNodeSelection})]},extendNodeSchema(e){const n={name:e.name,options:e.options,storage:e.storage};return{tableRole:fs(ms(e,"tableRole",n))}}});fe.create({name:"tableKit",addExtensions(){const e=[];return this.options.table!==!1&&e.push(_r.configure(this.options.table)),this.options.tableCell!==!1&&e.push(Lr.configure(this.options.tableCell)),this.options.tableHeader!==!1&&e.push(Ir.configure(this.options.tableHeader)),this.options.tableRow!==!1&&e.push(Hr.configure(this.options.tableRow)),e}});const yi=fe.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:e=>e.style.fontSize.replace(/['"]+/g,""),renderHTML:e=>e.fontSize?{style:`font-size: ${e.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:e=>({chain:n})=>n().setMark("textStyle",{fontSize:e}).run(),unsetFontSize:()=>({chain:e})=>e().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),vi=fe.create({name:"lineHeight",addOptions(){return{types:["paragraph","heading"],defaultLineHeight:"normal"}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:this.options.defaultLineHeight,parseHTML:e=>e.style.lineHeight||this.options.defaultLineHeight,renderHTML:e=>e.lineHeight===this.options.defaultLineHeight?{}:{style:`line-height: ${e.lineHeight}`}}}}]},addCommands(){return{setLineHeight:e=>({commands:n})=>this.options.types.every(r=>n.updateAttributes(r,{lineHeight:e})),unsetLineHeight:()=>({commands:e})=>this.options.types.every(n=>e.resetAttributes(n,"lineHeight"))}}}),ir=({content:e,onUpdate:n,onFocus:r,onCreated:s,editable:o,className:i,placeholder:l,style:a})=>{const c=gs({extensions:[vs.configure({heading:!1}),js.configure({levels:[1,2,3,4]}),bs,Cr,wr,yi,vi,Sr,io.configure({types:["heading","paragraph"]}),co.configure({multicolor:!0}),ys,Cs.configure({nested:!0}),uo.configure({inline:!0,allowBase64:!0}),_r.configure({resizable:!0}),Hr,Ir,Lr,Ss.configure({placeholder:l||" ..."})],content:e,editable:o,onUpdate:({editor:d})=>{n(d.getHTML())},onFocus:({editor:d})=>{r(d)},onCreate:({editor:d})=>{s&&s(d)}});return x.useEffect(()=>{if(!c)return;!(c.getHTML()===e)&&!c.isFocused&&c.commands.setContent(e,{emitUpdate:!1})},[e,c]),x.useEffect(()=>{c&&c.setEditable(o)},[o,c]),t.jsx(ws,{editor:c,className:i,style:a,onMouseUp:()=>{}})},ji=({editor:e,onOpenSettings:n})=>{const[,r]=on.useReducer(l=>l+1,0);on.useEffect(()=>{if(!e)return;const l=()=>r();return e.on("transaction",l),e.on("selectionUpdate",l),()=>{e.off("transaction",l),e.off("selectionUpdate",l)}},[e]);const[s,o]=on.useState(""),i=()=>{s&&window.find(s)};return t.jsxs("div",{className:"novel-toolbar author-toolbar",children:[t.jsxs("div",{className:"group",children:[t.jsx("button",{onClick:()=>e?.chain().focus().undo().run(),disabled:!e?.can().undo(),title:"",children:t.jsx("span",{className:"material-symbols-outlined",children:"undo"})}),t.jsx("button",{onClick:()=>e?.chain().focus().redo().run(),disabled:!e?.can().redo(),title:" ",children:t.jsx("span",{className:"material-symbols-outlined",children:"redo"})})]}),t.jsx("div",{className:"separator"}),t.jsxs("select",{onChange:l=>{if(!e)return;const a=l.target.value;a==="p"?e.chain().focus().setParagraph().run():e.chain().focus().toggleHeading({level:parseInt(a)}).run()},value:e?.isActive("heading",{level:1})?"1":e?.isActive("heading",{level:2})?"2":e?.isActive("heading",{level:3})?"3":e?.isActive("heading",{level:4})?"4":"p",disabled:!e,className:"style-select",children:[t.jsx("option",{value:"p",children:""}),t.jsx("option",{value:"1",children:" 1"}),t.jsx("option",{value:"2",children:" 2"}),t.jsx("option",{value:"3",children:" 1"}),t.jsx("option",{value:"4",children:" 2"})]}),t.jsx("div",{className:"separator"}),t.jsxs("select",{onChange:l=>{e&&e.chain().focus().setFontFamily(l.target.value).run()},value:e?.getAttributes("textStyle").fontFamily||"",disabled:!e,className:"font-select",children:[t.jsx("option",{value:"",children:" "}),t.jsx("option",{value:"Inter",children:"Inter"}),t.jsx("option",{value:"Roboto",children:"Roboto"}),t.jsx("option",{value:"Pretendard",children:"Pretendard"}),t.jsx("option",{value:"Nanum Myeongjo",children:""}),t.jsx("option",{value:"serif",children:"Serif"}),t.jsx("option",{value:"monospace",children:"Monospace"})]}),t.jsx("select",{onChange:l=>{e&&e.chain().focus().setFontSize(l.target.value).run()},value:e?.getAttributes("textStyle").fontSize||"16px",disabled:!e,className:"size-select",children:[12,14,16,18,20,24,30,36].map(l=>t.jsxs("option",{value:`${l}px`,children:[l,"px"]},l))}),t.jsx("div",{className:"separator"}),t.jsxs("div",{className:"group",children:[t.jsx("button",{onClick:()=>e?.chain().focus().toggleBold().run(),className:e?.isActive("bold")?"is-active":"",title:"",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_bold"})}),t.jsx("button",{onClick:()=>e?.chain().focus().toggleItalic().run(),className:e?.isActive("italic")?"is-active":"",title:"",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_italic"})}),t.jsx("button",{onClick:()=>e?.chain().focus().toggleUnderline().run(),className:e?.isActive("underline")?"is-active":"",title:"",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_underlined"})}),t.jsx("button",{onClick:()=>e?.chain().focus().toggleStrike().run(),className:e?.isActive("strike")?"is-active":"",title:"",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_strikethrough"})}),t.jsxs("div",{className:"color-picker-wrapper",title:" ",children:[t.jsx("span",{className:"material-symbols-outlined",children:"format_color_text"}),t.jsx("input",{type:"color",onChange:l=>e?.chain().focus().setColor(l.target.value).run(),value:e?.getAttributes("textStyle").color||"var(--foreground)",disabled:!e})]})]}),t.jsx("div",{className:"separator"}),t.jsxs("div",{className:"group",children:[t.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("left").run(),className:e?.isActive({textAlign:"left"})?"is-active":"",title:" ",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_align_left"})}),t.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("center").run(),className:e?.isActive({textAlign:"center"})?"is-active":"",title:" ",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_align_center"})}),t.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("right").run(),className:e?.isActive({textAlign:"right"})?"is-active":"",title:" ",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_align_right"})}),t.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("justify").run(),className:e?.isActive({textAlign:"justify"})?"is-active":"",title:" ",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_align_justify"})})]}),t.jsx("div",{className:"separator"}),t.jsx("div",{className:"group",children:t.jsxs("select",{onChange:l=>{e&&e.chain().focus().setLineHeight(l.target.value).run()},value:e?.getAttributes("paragraph").lineHeight||"normal",disabled:!e,className:"spacing-select",title:"   ",children:[t.jsx("option",{value:"normal",children:" "}),t.jsx("option",{value:"1.0",children:"1.0"}),t.jsx("option",{value:"1.2",children:"1.2"}),t.jsx("option",{value:"1.5",children:"1.5"}),t.jsx("option",{value:"2.0",children:"2.0"}),t.jsx("option",{value:"2.5",children:"2.5"}),t.jsx("option",{value:"3.0",children:"3.0"})]})}),t.jsx("div",{className:"separator"}),t.jsxs("div",{className:"group",children:[t.jsx("button",{onClick:()=>e?.chain().focus().toggleBulletList().run(),className:e?.isActive("bulletList")?"is-active":"",title:"",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_list_bulleted"})}),t.jsx("button",{onClick:()=>e?.chain().focus().toggleOrderedList().run(),className:e?.isActive("orderedList")?"is-active":"",title:"",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"format_list_numbered"})}),t.jsx("button",{onClick:()=>e?.chain().focus().toggleTaskList().run(),className:e?.isActive("taskList")?"is-active":"",title:"",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"checklist"})})]}),t.jsx("div",{className:"separator"}),t.jsxs("div",{className:"group",children:[t.jsx("button",{onClick:()=>{const l=window.prompt(" URL ");if(l)try{const a=new URL(l);if(!["http:","https:"].includes(a.protocol)){alert("http  https URL .");return}e?.chain().focus().setImage({src:l}).run()}catch{alert(" URL .")}},title:" ",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"add_photo_alternate"})}),t.jsx("button",{onClick:()=>e?.chain().focus().insertTable({rows:3,cols:3,withHeaderRow:!0}).run(),title:" ",disabled:!e,children:t.jsx("span",{className:"material-symbols-outlined",children:"grid_on"})}),t.jsxs("div",{className:"color-picker-wrapper",title:"  ()",children:[t.jsx("span",{className:"material-symbols-outlined",children:"label"}),t.jsx("input",{type:"color",onChange:l=>e?.chain().focus().setHighlight({color:l.target.value}).run(),value:e?.getAttributes("highlight").color||"#ffff00",disabled:!e})]})]}),t.jsx("div",{className:"separator"}),t.jsxs("div",{className:"search-group",children:[t.jsx("input",{type:"text",placeholder:"...",value:s,onChange:l=>o(l.target.value),onKeyDown:l=>l.key==="Enter"&&i(),disabled:!e}),t.jsx("button",{onClick:i,disabled:!e,title:"",children:t.jsx("span",{className:"material-symbols-outlined",children:"search"})})]}),t.jsx("div",{className:"separator"}),t.jsx("div",{className:"group",children:t.jsx("button",{onClick:n,className:"settings-btn",title:"",style:{display:"flex",alignItems:"center",justifyContent:"center",color:"var(--foreground)",padding:"6px"},children:t.jsx(fr,{size:20})})})]})},Ci=({editor:e,readerSettings:n,onSettingsChange:r,onBookmark:s,onHighlight:o,onAddMemo:i})=>{const[l,a]=x.useState(null),c=x.useRef(null);x.useEffect(()=>{const u=b=>{c.current&&!c.current.contains(b.target)&&a(null)};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[]);const d=u=>{a(l===u?null:u)},h=()=>{r({fontSize:18,lineHeight:2,paragraphSpacing:40,contentWidth:80,fontFamily:"Noto Sans KR",theme:"light"}),a(null)},f=[{name:"Noto Sans KR",label:"  (Sans)"},{name:"Noto Serif KR",label:"  (Serif)"},{name:"Nanum Myeongjo",label:" "},{name:"Nanum Gothic",label:" "},{name:"Poppins",label:"Poppins"},{name:"Inter",label:"Inter"}],m=[{id:"light",label:"",color:"#ffffff",textColor:"#1c1917"},{id:"sepia",label:"",color:"#ede0d4",textColor:"#311900"},{id:"dark",label:"",color:"#1a1a1a",textColor:"#ffffff"}];return t.jsx("div",{className:"novel-toolbar reader-toolbar",ref:c,children:t.jsxs("div",{className:"group",children:[t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{onClick:()=>d("typography"),className:`toolbar-btn ${l==="typography"?"active":""}`,title:" ",children:t.jsx(ks,{size:20})}),l==="typography"&&t.jsxs("div",{className:"reader-popover",children:[t.jsx("div",{className:"popover-header",children:" "}),t.jsxs("div",{className:"popover-row",children:[t.jsx("button",{className:"popover-btn-small",onClick:()=>r({...n,fontSize:Math.max(12,n.fontSize-1)}),children:t.jsx(Ns,{size:16})}),t.jsx("span",{style:{minWidth:"30px",textAlign:"center",fontWeight:600},children:n.fontSize}),t.jsx("button",{className:"popover-btn-small",onClick:()=>r({...n,fontSize:Math.min(32,n.fontSize+1)}),children:t.jsx(zs,{size:16})}),t.jsx("button",{className:"popover-btn-reset",onClick:h,children:""})]})]})]}),t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{onClick:()=>d("font"),className:`toolbar-btn ${l==="font"?"active":""}`,title:" ",children:t.jsx("span",{style:{fontSize:"18px",fontWeight:700},children:"A"})}),l==="font"&&t.jsxs("div",{className:"reader-popover",children:[t.jsx("div",{className:"popover-header",children:""}),f.map(u=>t.jsxs("div",{className:`popover-item ${n.fontFamily===u.name?"selected":""}`,onClick:()=>{r({...n,fontFamily:u.name}),a(null)},children:[t.jsx("span",{style:{fontFamily:u.name},children:u.label}),n.fontFamily===u.name&&t.jsx(bt,{size:14})]},u.name))]})]}),t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{onClick:()=>d("theme"),className:`toolbar-btn ${l==="theme"?"active":""}`,title:" ",children:t.jsx(As,{size:20})}),l==="theme"&&t.jsxs("div",{className:"reader-popover",children:[t.jsx("div",{className:"popover-header",children:""}),m.map(u=>t.jsxs("div",{className:`popover-item ${n.theme===u.id?"selected":""}`,onClick:()=>{r({...n,theme:u.id}),a(null)},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx("div",{style:{width:"16px",height:"16px",borderRadius:"50%",backgroundColor:u.color,border:"1px solid #e2e8f0"}}),u.label]}),n.theme===u.id&&t.jsx(bt,{size:14})]},u.id))]})]}),t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{onClick:()=>d("spacing"),className:`toolbar-btn ${l==="spacing"?"active":""}`,title:" ",children:t.jsx($n,{size:20})}),l==="spacing"&&t.jsxs("div",{className:"reader-popover",children:[t.jsx("div",{className:"popover-header",children:" "}),[{val:1.5,label:""},{val:2,label:""},{val:2.5,label:" "}].map(u=>t.jsxs("div",{className:`popover-item ${n.lineHeight===u.val?"selected":""}`,onClick:()=>{r({...n,lineHeight:u.val}),a(null)},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx($n,{size:14,style:{opacity:.5}}),u.label]}),n.lineHeight===u.val&&t.jsx(bt,{size:14})]},u.val))]})]}),t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{onClick:()=>d("width"),className:`toolbar-btn ${l==="width"?"active":""}`,title:" ",children:t.jsx(Rs,{size:20})}),l==="width"&&t.jsxs("div",{className:"reader-popover",children:[t.jsx("div",{className:"popover-header",children:" "}),[{val:70,label:""},{val:80,label:""},{val:90,label:""},{val:100,label:""}].map(u=>t.jsxs("div",{className:`popover-item ${n.contentWidth===u.val?"selected":""}`,onClick:()=>{r({...n,contentWidth:u.val}),a(null)},children:[t.jsxs("span",{children:[u.label," (",u.val,"%)"]}),n.contentWidth===u.val&&t.jsx(bt,{size:14})]},u.val))]})]}),t.jsx("div",{className:"separator",style:{margin:"0 8px"}}),t.jsx("button",{onClick:s,title:" ",className:"toolbar-btn",children:t.jsx(Ts,{size:20})}),t.jsx("button",{onClick:o,disabled:!e,title:"",className:"toolbar-btn",children:t.jsx(Ms,{size:20})}),t.jsx("button",{onClick:i,disabled:!e,title:" ",className:"toolbar-btn",children:t.jsx(Es,{size:20})})]})})},Si=async e=>le("/chat/ask",{method:"POST",body:JSON.stringify({question:e.question,novel_id:e.novel_id,chapter_id:e.chapter_id,novel_filter:e.novel_filter,alpha:e.alpha??.32,similarity_threshold:e.similarity_threshold??.5})});function wi({msg:e,onNavigateToScene:n,chapterId:r}){const[s,o]=x.useState(!1),[i,l]=x.useState(!1);let a=e.content,c="";if(e.role==="assistant"&&e.content.includes("[ ]")){const d=e.content.split("[ ]");a=d[0].replace("[ ]","").trim(),c=d[1].trim()}return t.jsx("div",{className:`chatbot-message ${e.role}`,style:{marginBottom:"1rem",alignSelf:e.role==="user"?"flex-end":"flex-start"},children:t.jsxs("div",{className:`chatbot-message-bubble ${e.role==="user"?"user-bubble":"assistant-bubble"}`,style:{padding:"0.75rem 1rem",borderRadius:"1.5rem",maxWidth:"100%",backgroundColor:e.role==="user"?"var(--primary)":"var(--chat-assistant-bg)",color:e.role==="user"?"var(--primary-foreground)":"var(--chat-assistant-text)",border:e.role==="assistant"?"1px solid var(--border)":"none",boxShadow:"0 1px 2px rgba(0,0,0,0.05)"},children:[t.jsx("p",{style:{whiteSpace:"pre-wrap",margin:0},children:a}),c&&t.jsxs("div",{className:"detail-container",style:{marginTop:"0.5rem",borderTop:"1px solid var(--border)",paddingTop:"0.5rem"},children:[t.jsxs("button",{onClick:()=>l(!i),style:{background:"none",border:"none",padding:0,cursor:"pointer",display:"flex",alignItems:"center",gap:"4px",fontSize:"0.75rem",color:"var(--muted-foreground)",fontWeight:"600"},children:[i?t.jsx(ce,{size:14,strokeWidth:2.5}):t.jsx(se,{size:14,strokeWidth:2.5})," "]}),i&&t.jsx("p",{style:{whiteSpace:"pre-wrap",marginTop:"0.5rem",fontSize:"0.9rem",color:"var(--muted-foreground)",lineHeight:"1.5"},children:c})]}),e.source&&t.jsxs("div",{className:"source-container",style:{marginTop:"0.5rem",borderTop:"1px solid var(--border)",paddingTop:"0.5rem"},children:[t.jsxs("button",{onClick:()=>o(!s),style:{background:"none",border:"none",padding:0,cursor:"pointer",display:"flex",alignItems:"center",gap:"4px",fontSize:"0.75rem",color:e.role==="user"?"var(--primary-foreground)":"var(--muted-foreground)",opacity:.9,fontWeight:"600"},children:[s?t.jsx(ce,{size:14,strokeWidth:2.5}):t.jsx(se,{size:14,strokeWidth:2.5}),""]}),s&&t.jsxs("div",{style:{fontSize:"0.75rem",color:e.role==="user"?"var(--primary-foreground)":"var(--muted-foreground)",opacity:.85,marginTop:"0.5rem",fontStyle:"italic",display:"flex",flexDirection:"column",gap:"4px",animation:"fadeIn 0.2s ease-in-out"},children:[t.jsxs("div",{children:[t.jsx("strong",{children:":"})," ",e.source.filename,e.source.scene_index!==void 0&&` (Scene ${e.source.scene_index+1})`]}),e.source.summary&&t.jsx("div",{style:{backgroundColor:"rgba(0,0,0,0.1)",padding:"6px",borderRadius:"4px",marginTop:"2px",borderLeft:"2px solid currentColor",fontSize:"0.8rem",lineHeight:"1.4"},children:e.source.summary}),e.source.scene_index!==void 0&&n&&t.jsxs("button",{onClick:()=>{n(e.source.scene_index)},disabled:!!(e.source.chapter_id&&r&&e.source.chapter_id!==r),style:{background:"rgba(255,255,255,0.2)",border:"1px solid rgba(255,255,255,0.3)",borderRadius:"4px",color:"currentColor",padding:"4px 8px",cursor:e.source.chapter_id&&r&&e.source.chapter_id!==r?"not-allowed":"pointer",opacity:e.source.chapter_id&&r&&e.source.chapter_id!==r?.5:1,alignSelf:"flex-start",fontSize:"0.75rem",marginTop:"6px",transition:"all 0.2s"},title:e.source.chapter_id&&r&&e.source.chapter_id!==r?"  .":"",children:[" ",e.source.chapter_id?`Ch.${e.source.chapter_id} `:"","Scene ",e.source.scene_index+1," "]})]})]})]})})}function ki({onNavigateToScene:e,novelId:n,chapterId:r}){const[s,o]=x.useState(""),[i,l]=x.useState([{role:"assistant",content:"!    ."}]),[a,c]=x.useState(!1),d=x.useRef(null);x.useEffect(()=>{d.current?.scrollIntoView({behavior:"smooth"})},[i]);const h=async()=>{if(s.trim()&&!a){const m=s.trim();o(""),l(u=>[...u,{role:"user",content:m}]),c(!0);try{const u=await Si({question:m,novel_id:n,chapter_id:r,alpha:.32,similarity_threshold:.35});l(b=>[...b,{role:"assistant",content:u.answer,source:u.source,similarity:u.similarity}])}catch(u){console.error("Chat error:",u);const b=u.response?.data?.detail||u.message||"    .";l(j=>[...j,{role:"assistant",content:`: ${b}`}])}finally{c(!1)}}},f=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),h())};return t.jsxs("div",{className:"chatbot-container",style:{display:"flex",flexDirection:"column",height:"100%",backgroundColor:"var(--modal-bg)"},children:[t.jsxs("div",{className:"chatbot-messages",style:{flex:1,overflowY:"auto",padding:"1rem"},children:[i.map((m,u)=>t.jsx(wi,{msg:m,onNavigateToScene:e,chapterId:r},u)),a&&t.jsx("div",{className:"chatbot-message assistant",style:{alignSelf:"flex-start"},children:t.jsx("div",{className:"chatbot-message-bubble assistant-bubble",style:{padding:"0.75rem 1rem",borderRadius:"1.5rem",backgroundColor:"var(--chat-assistant-bg)",border:"1px solid var(--border)",color:"var(--chat-assistant-text)"},children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx(hn,{size:16,strokeWidth:2.5,className:"animate-spin",style:{color:"var(--muted-foreground)"}}),t.jsx("span",{style:{color:"var(--muted-foreground)"},children:"  ..."})]})})}),t.jsx("div",{ref:d})]}),t.jsxs("div",{className:"chatbot-input-area",style:{padding:"1rem",display:"flex",gap:"0.5rem",backgroundColor:"var(--modal-bg)",borderTop:"1px solid var(--border)"},children:[t.jsx("input",{type:"text",className:"chatbot-input",placeholder:" ...",value:s,maxLength:500,onChange:m=>o(m.target.value),onKeyDown:f,disabled:a,style:{flex:1,padding:"0.75rem",borderRadius:"0.5rem",fontSize:"0.95rem",outline:"none",transition:"border-color 0.2s",backgroundColor:"var(--input-bg)",color:"var(--input-text)",border:"1px solid var(--input-border)"}}),t.jsx("button",{className:"chatbot-send",onClick:h,disabled:a||!s.trim(),style:{backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"0.5rem",padding:"0.75rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"transform 0.2s",minWidth:"45px",opacity:a||!s.trim()?.5:1},children:a?t.jsx(hn,{size:20,strokeWidth:2.5,className:"animate-spin"}):t.jsx(mr,{size:20,strokeWidth:2.5})})]})]})}function Ni({onNavigateToScene:e,onAnalyze:n,onPredictStory:r,onOpenCharacterChat:s,onOpenSettings:o,onOpenRelGraph:i,novelId:l,chapterId:a,mode:c="writer"}){const[d,h]=x.useState(!1),[f,m]=x.useState(!1),[u,b]=x.useState(!1),{theme:j}=vr(),C=()=>{h(!d),b(!1)},k=()=>{m(!0),h(!1)},F=()=>{m(!1)},D=U=>{n&&n(U),h(!1),b(!1)};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"floating-menu-container",children:[d&&t.jsx("div",{className:"floating-menu-options",children:u?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-option",onClick:()=>b(!1),title:"",style:{background:"var(--muted)",color:"var(--muted-foreground)",border:"none"},children:t.jsx(fn,{size:20,strokeWidth:2.5})}),t.jsx("button",{className:"menu-option btn-blue",onClick:()=>D("consistency"),title:"  ",children:t.jsx(Bn,{size:20,strokeWidth:2.5})}),t.jsx("button",{className:"menu-option",onClick:()=>D("plot"),title:" ",style:{background:"#7C3AED",color:"#fff",border:"none"},children:t.jsx(xr,{size:20,strokeWidth:2.5})}),t.jsx("button",{className:"menu-option",onClick:()=>D("style"),title:" ",style:{background:"#0891B2",color:"#fff",border:"none"},children:t.jsx(gr,{size:20,strokeWidth:2.5})}),t.jsx("button",{className:"menu-option",onClick:()=>D("overall"),title:" ",style:{background:"#059669",color:"#fff",border:"none"},children:t.jsx(br,{size:20,strokeWidth:2.5})})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-option btn-purple",onClick:()=>{r&&r(),h(!1)},title:"  (What-If)",children:t.jsx(mn,{size:20,strokeWidth:2.5})}),t.jsx("button",{className:"menu-option",onClick:()=>{i&&i(),h(!1)},title:" ",style:{background:"#10B981",color:"#fff",border:"none"},children:t.jsx(yr,{size:20,strokeWidth:2.5})}),c!=="reader"&&t.jsx("button",{className:"menu-option btn-blue",onClick:()=>b(!0),title:"AI ",children:t.jsx(Bn,{size:20,strokeWidth:2.5})}),t.jsx("button",{className:"menu-option btn-brown-med",onClick:k,title:"",children:t.jsx(Ws,{size:20,strokeWidth:2.5})}),t.jsx("button",{className:"menu-option btn-brown-rich",onClick:()=>{s&&s(),h(!1)},title:" ",children:t.jsx(Ft,{size:20,strokeWidth:2.5})}),t.jsx("button",{className:"menu-option btn-brown-dark",onClick:()=>{o&&o(),h(!1)},title:"",children:t.jsx(fr,{size:20,strokeWidth:2.5})})]})}),t.jsx("button",{className:"floating-menu-btn",onClick:C,style:{backgroundColor:j==="sepia"?"var(--color-dark-brown)":"var(--primary)",color:"var(--primary-foreground)"},children:t.jsx(Ls,{size:24,strokeWidth:2.5})})]}),f&&t.jsxs("div",{className:"chatbot-modal",style:{position:"fixed",bottom:"15px",right:"25px",width:"650px",height:"850px",borderRadius:"1rem",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",display:"flex",flexDirection:"column",zIndex:1e3,overflow:"hidden"},children:[t.jsx("div",{className:"chatbot-header",style:{padding:"16px",borderBottom:"1px solid var(--border)",display:"flex",justifyContent:"flex-end",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)"},children:t.jsx("button",{className:"chatbot-close",onClick:F,style:{color:"currentColor",background:"none",border:"none",cursor:"pointer"},children:t.jsx(st,{size:20,strokeWidth:2.5})})}),t.jsx("div",{className:"chatbot-content",style:{flex:1,overflow:"hidden"},children:t.jsx(ki,{onNavigateToScene:e,novelId:l,chapterId:a})})]})]})}function zi({onClose:e}){const[n,r]=x.useState(""),[s,o]=x.useState(""),[i,l]=x.useState(localStorage.getItem("llm_model")||"gemini-2.0-flash"),[a,c]=x.useState(!1);x.useEffect(()=>{d()},[]),x.useEffect(()=>{i&&localStorage.setItem("llm_model",i)},[i]);const d=async()=>{try{const u=await le("/auth/me");r(u.username),o(u.email)}catch(u){console.error("Failed to fetch profile:",u),E.error("    .")}},h=()=>{localStorage.removeItem("token"),localStorage.removeItem("userMode"),window.location.href="/"},f=()=>{E.info("    .")},m=[{value:"gemini-2.0-flash",label:"Gemini 2.0 Flash ()"},{value:"gemini-2.5-flash",label:"Gemini 2.5 Flash ()"},{value:"gemini-1.5-pro",label:"Gemini 1.5 Pro ()"},{value:"gemini-2.0",label:"Gemini 2.0 ()"}];return t.jsx("div",{className:"settings-panel",children:t.jsxs("div",{className:"settings-container",children:[t.jsxs("div",{className:"settings-header",children:[t.jsx("h2",{className:"settings-title",children:""}),t.jsx("button",{onClick:e,className:"close-button","aria-label":"Close settings",children:t.jsx(st,{size:24,strokeWidth:2})})]}),t.jsxs("div",{className:"settings-content",children:[t.jsx("div",{className:"profile-section",children:t.jsxs("div",{className:"profile-header-text",children:[t.jsx("h3",{className:"section-title",children:" "}),t.jsx("p",{className:"section-description",children:"   AI   ."})]})}),t.jsxs("div",{className:"settings-form",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:""}),t.jsx("input",{className:"form-input",value:n,onChange:u=>r(u.target.value),placeholder:" "})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:""}),t.jsx("input",{className:"form-input disabled",value:s,disabled:!0}),t.jsx("p",{className:"input-note",children:"    "})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"LLM AI  "}),t.jsxs("div",{className:"select-wrapper",children:[t.jsxs("button",{className:`select-button ${a?"active":""}`,onClick:()=>c(!a),children:[t.jsx("span",{children:m.find(u=>u.value===i)?.label||i}),t.jsx(se,{size:16,className:`dropdown-icon ${a?"open":""}`})]}),a&&t.jsx("div",{className:"select-dropdown",children:m.map(u=>t.jsx("button",{className:`select-option ${i===u.value?"selected":""}`,onClick:()=>{l(u.value),c(!1)},children:u.label},u.value))})]}),t.jsx("p",{className:"model-note",children:" AI      "})]}),t.jsxs("div",{className:"danger-zone",children:[t.jsx("h3",{className:"danger-title",children:" "}),t.jsx("p",{className:"danger-description",children:"     ."}),t.jsx("button",{className:"btn btn-destructive",onClick:f,children:" "})]})]})]}),t.jsx("div",{className:"settings-footer",children:t.jsxs("button",{className:"btn btn-outline",onClick:h,children:[t.jsx(Is,{size:18}),""]})})]})})}const Ai={:{color:"#DC2626",bg:"rgba(220, 38, 38, 0.1)",label:""},:{color:"#D97706",bg:"rgba(217, 119, 6, 0.1)",label:""},:{color:"#2563EB",bg:"rgba(37, 99, 235, 0.1)",label:""}};function Ri({severity:e}){const n=e?Ai[e]:null;return n?t.jsx("span",{style:{fontSize:"0.75rem",fontWeight:"700",padding:"2px 8px",borderRadius:"10px",backgroundColor:n.bg,color:n.color,marginLeft:"6px"},children:n.label}):null}function kn({score:e}){const n=e>=80?"#16A34A":e>=60?"#D97706":"#DC2626";return t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px 0"},children:[t.jsxs("div",{style:{position:"relative",width:"56px",height:"56px"},children:[t.jsxs("svg",{width:"56",height:"56",viewBox:"0 0 56 56",children:[t.jsx("circle",{cx:"28",cy:"28",r:"24",fill:"none",stroke:"var(--border)",strokeWidth:"5"}),t.jsx("circle",{cx:"28",cy:"28",r:"24",fill:"none",stroke:n,strokeWidth:"5",strokeDasharray:`${e/100*150.8} 150.8`,strokeLinecap:"round",transform:"rotate(-90 28 28)"})]}),t.jsx("span",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",fontSize:"0.9rem",fontWeight:"700",color:n},children:e})]}),t.jsx("span",{style:{fontSize:"0.85rem",color:"var(--muted-foreground)"},children:"/ 100"})]})}function lr({result:e,onNavigateToQuote:n,onApplySuggestion:r,filter:s}){const o=(e.results||[]).filter(i=>s==="all"||i.severity===s);return t.jsxs("div",{children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"16px",borderRadius:"8px",backgroundColor:e.status==="  "?"rgba(220, 38, 38, 0.1)":"rgba(22, 163, 74, 0.1)",marginBottom:"16px",border:"1px solid",borderColor:e.status==="  "?"rgba(220, 38, 38, 0.2)":"rgba(22, 163, 74, 0.2)"},children:[e.status==="  "?t.jsx(Sn,{size:24,color:"#DC2626",strokeWidth:2.5}):t.jsx(Pn,{size:24,color:"#16A34A",strokeWidth:2.5}),t.jsxs("div",{children:[t.jsx("h3",{style:{margin:0,fontSize:"1.05rem",fontWeight:"600",color:e.status==="  "?"#DC2626":"#16A34A"},children:e.status}),e.results&&e.results.length>0&&t.jsxs("span",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)"},children:[e.results.length," "]})]})]}),o.length>0?t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"14px"},children:o.map((i,l)=>t.jsxs("div",{style:{padding:"14px",border:"1px solid var(--modal-border)",borderRadius:"8px",backgroundColor:"var(--card)",color:"var(--card-foreground)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[t.jsx("span",{style:{fontSize:"0.8rem",fontWeight:"600",padding:"3px 10px",borderRadius:"12px",backgroundColor:i.type===" "?"rgba(220, 38, 38, 0.1)":"rgba(217, 119, 6, 0.1)",color:i.type===" "?"#DC2626":"#D97706"},children:i.type}),t.jsx(Ri,{severity:i.severity})]}),n&&i.quote&&t.jsxs("button",{onClick:()=>n(i.quote),style:{display:"flex",alignItems:"center",gap:"4px",padding:"3px 8px",fontSize:"0.75rem",backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"4px",cursor:"pointer"},children:[t.jsx(_s,{size:12,strokeWidth:2.5})," "]})]}),t.jsxs("div",{style:{marginBottom:"10px"},children:[t.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.8rem",fontWeight:"600",color:"var(--modal-text)"},children:" :"}),t.jsxs("p",{style:{margin:0,fontSize:"0.85rem",fontStyle:"italic",backgroundColor:"var(--secondary)",padding:"8px",borderRadius:"4px",border:"1px solid var(--border)",color:"var(--modal-text)"},children:['"',i.quote,'"']})]}),i.evidence&&t.jsxs("div",{style:{marginBottom:"10px"},children:[t.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.8rem",fontWeight:"600",color:"var(--modal-text)"},children:":"}),t.jsx("p",{style:{margin:0,fontSize:"0.85rem",color:"var(--muted-foreground)",lineHeight:"1.5"},children:i.evidence})]}),t.jsxs("div",{style:{marginBottom:"10px"},children:[t.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.8rem",fontWeight:"600",color:"var(--modal-text)"},children:":"}),t.jsx("p",{style:{margin:0,fontSize:"0.85rem",color:"var(--muted-foreground)",lineHeight:"1.5"},children:i.description})]}),t.jsxs("div",{children:[t.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.8rem",fontWeight:"600",color:"var(--modal-text)"},children:":"}),t.jsx("p",{style:{margin:0,fontSize:"0.85rem",color:"#059669",lineHeight:"1.5"},children:i.suggestion}),r&&i.quote&&i.suggestion&&t.jsxs("button",{onClick:()=>r(i.quote,i.suggestion),style:{marginTop:"6px",display:"flex",alignItems:"center",gap:"4px",padding:"4px 10px",fontSize:"0.75rem",backgroundColor:"rgba(5, 150, 105, 0.1)",color:"#059669",border:"1px solid rgba(5, 150, 105, 0.3)",borderRadius:"4px",cursor:"pointer"},children:[t.jsx(Ds,{size:12}),"  "]})]})]},l))}):t.jsxs("div",{style:{textAlign:"center",padding:"30px 20px",color:"var(--muted-foreground)"},children:[t.jsx(Pn,{size:40,color:"#16A34A",strokeWidth:2.5,style:{margin:"0 auto 12px"}}),t.jsx("p",{style:{fontSize:"0.95rem",fontWeight:"500"},children:"  !"})]})]})}function ar({data:e}){return!e||e.error?t.jsx("p",{style:{color:"var(--muted-foreground)"},children:"   ."}):t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.evaluation?.score!=null&&t.jsx(kn,{score:e.evaluation.score}),e.structure&&t.jsxs("div",{children:[t.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[": ",e.structure.type]}),(e.structure.sections||[]).map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",backgroundColor:"var(--secondary)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsx("strong",{children:n.name}),": ",n.description]},r))]}),e.conflicts&&e.conflicts.length>0&&t.jsxs("div",{children:[t.jsx("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:" "}),e.conflicts.map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsx("span",{style:{padding:"2px 6px",borderRadius:"4px",backgroundColor:"rgba(220, 38, 38, 0.1)",color:"#DC2626",fontSize:"0.75rem",fontWeight:"600"},children:n.type}),t.jsxs("span",{style:{marginLeft:"6px",fontSize:"0.75rem",color:"var(--muted-foreground)"},children:[": ",n.intensity,"/10"]}),t.jsx("p",{style:{margin:"6px 0 0",color:"var(--muted-foreground)"},children:n.description})]},r))]}),e.pacing&&t.jsxs("div",{children:[t.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[" : ",e.pacing.overall]}),(e.pacing.issues||[]).map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsx("p",{style:{margin:"0 0 4px",fontWeight:"500"},children:n.description}),n.suggestion&&t.jsxs("p",{style:{margin:0,color:"#059669",fontSize:"0.8rem"},children:["->"," ",n.suggestion]})]},r))]}),e.foreshadowing&&e.foreshadowing.length>0&&t.jsxs("div",{children:[t.jsx("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:"/"}),e.foreshadowing.map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",backgroundColor:"var(--secondary)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsx("span",{style:{padding:"2px 6px",borderRadius:"4px",backgroundColor:n.type===""?"rgba(22, 163, 74, 0.1)":n.type===""?"rgba(37, 99, 235, 0.1)":"rgba(217, 119, 6, 0.1)",color:n.type===""?"#16A34A":n.type===""?"#2563EB":"#D97706",fontSize:"0.75rem",fontWeight:"600"},children:n.type}),t.jsx("p",{style:{margin:"6px 0 0",color:"var(--muted-foreground)"},children:n.description})]},r))]}),e.evaluation&&t.jsxs("div",{children:[e.evaluation.strengths?.length>0&&t.jsxs("div",{style:{marginBottom:"8px"},children:[t.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#16A34A"},children:""}),e.evaluation.strengths.map((n,r)=>t.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["+ ",n]},r))]}),e.evaluation.weaknesses?.length>0&&t.jsxs("div",{style:{marginBottom:"8px"},children:[t.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#DC2626"},children:""}),e.evaluation.weaknesses.map((n,r)=>t.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["- ",n]},r))]})]})]})}function cr({data:e}){return!e||e.error?t.jsx("p",{style:{color:"var(--muted-foreground)"},children:"   ."}):t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.evaluation?.score!=null&&t.jsx(kn,{score:e.evaluation.score}),e.tone&&t.jsxs("div",{children:[t.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[": ",e.tone.primary," (",e.tone.consistency,")"]}),(e.tone.issues||[]).map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsx("p",{style:{margin:"0 0 4px"},children:n.description}),n.suggestion&&t.jsxs("p",{style:{margin:0,color:"#059669",fontSize:"0.8rem"},children:["->"," ",n.suggestion]})]},r))]}),e.sentence_structure&&t.jsxs("div",{children:[t.jsx("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:" "}),t.jsxs("p",{style:{margin:"0 0 4px",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:[" : ",e.sentence_structure.dialogue_ratio]}),t.jsxs("p",{style:{margin:"0 0 8px",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["  : ",e.sentence_structure.avg_length]}),(e.sentence_structure.issues||[]).map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsx("p",{style:{margin:"0 0 4px"},children:n.description}),n.suggestion&&t.jsxs("p",{style:{margin:0,color:"#059669",fontSize:"0.8rem"},children:["->"," ",n.suggestion]})]},r))]}),e.vocabulary&&t.jsxs("div",{children:[t.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[" : ",e.vocabulary.diversity]}),(e.vocabulary.repetitions||[]).map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",backgroundColor:"var(--secondary)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsxs("strong",{children:['"',n.word,'"']})," (",n.count,") ","->"," : ",(n.alternatives||[]).join(", ")]},r)),(e.vocabulary.cliches||[]).map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsx("span",{style:{color:"#D97706"},children:":"}),' "',n.expression,'"',n.suggestion&&t.jsxs("p",{style:{margin:"4px 0 0",color:"#059669",fontSize:"0.8rem"},children:["->"," ",n.suggestion]})]},r))]}),e.point_of_view&&t.jsxs("div",{children:[t.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[" : ",e.point_of_view.type," (",e.point_of_view.consistency,")"]}),(e.point_of_view.issues||[]).map((n,r)=>t.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[t.jsx("p",{style:{margin:"0 0 4px"},children:n.description}),n.suggestion&&t.jsxs("p",{style:{margin:0,color:"#059669",fontSize:"0.8rem"},children:["->"," ",n.suggestion]})]},r))]}),e.evaluation&&t.jsxs("div",{children:[e.evaluation.strengths?.length>0&&t.jsxs("div",{style:{marginBottom:"8px"},children:[t.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#16A34A"},children:""}),e.evaluation.strengths.map((n,r)=>t.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["+ ",n]},r))]}),e.evaluation.weaknesses?.length>0&&t.jsxs("div",{style:{marginBottom:"8px"},children:[t.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#DC2626"},children:""}),e.evaluation.weaknesses.map((n,r)=>t.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["- ",n]},r))]})]})]})}const dr={consistency:{label:"  ",icon:Sn},plot:{label:" ",icon:xr},style:{label:" ",icon:gr},overall:{label:" ",icon:br}};function Ti({isOpen:e,onClose:n,result:r,isLoading:s,onNavigateToQuote:o,onReanalyze:i,onApplySuggestion:l,analysisType:a="consistency"}){const[c,d]=x.useState("all");if(!e)return null;const h=dr[a]||dr.consistency,f=h.icon,m=()=>{if(s)return t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",gap:"16px"},children:[t.jsx(hn,{size:48,strokeWidth:2.5,style:{animation:"spin 1s linear infinite",color:"var(--primary)"}}),t.jsx("p",{style:{color:"var(--muted-foreground)",fontSize:"0.95rem"},children:" ..."})]});if(!r)return t.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",color:"var(--muted-foreground)"},children:[t.jsx("p",{children:"  ."}),t.jsx("p",{style:{fontSize:"0.9rem",marginTop:"8px"},children:"    ."})]});if(r.error)return t.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",color:"#DC2626"},children:[t.jsx(Sn,{size:40,style:{margin:"0 auto 12px"}}),t.jsx("p",{children:"   ."}),t.jsx("p",{style:{fontSize:"0.85rem",marginTop:"8px",color:"var(--muted-foreground)"},children:r.error})]});switch(a){case"consistency":return t.jsx(lr,{result:r,onNavigateToQuote:o,onApplySuggestion:l,filter:c});case"plot":return t.jsx(ar,{data:r});case"style":return t.jsx(cr,{data:r});case"overall":return t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"20px"},children:[r.evaluation?.score!=null&&t.jsx(kn,{score:r.evaluation.score}),r.evaluation?.strengths?.length>0&&t.jsxs("div",{children:[t.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#16A34A"},children:""}),r.evaluation.strengths.map((u,b)=>t.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["+ ",u]},b))]}),r.evaluation?.weaknesses?.length>0&&t.jsxs("div",{children:[t.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#DC2626"},children:""}),r.evaluation.weaknesses.map((u,b)=>t.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["- ",u]},b))]}),t.jsx("h3",{style:{margin:"8px 0 0",fontSize:"1rem",fontWeight:"600",borderTop:"1px solid var(--border)",paddingTop:"12px"},children:" "}),t.jsx(ar,{data:r.plot}),t.jsx("h3",{style:{margin:"8px 0 0",fontSize:"1rem",fontWeight:"600",borderTop:"1px solid var(--border)",paddingTop:"12px"},children:" "}),t.jsx(cr,{data:r.style})]});default:return t.jsx(lr,{result:r,onNavigateToQuote:o,onApplySuggestion:l,filter:c})}};return t.jsxs("div",{style:{position:"fixed",bottom:"16px",right:"20px",width:"450px",height:"750px",backgroundColor:"var(--modal-bg)",color:"var(--modal-text)",boxShadow:"0 8px 32px rgba(0,0,0,0.15)",zIndex:1e3,display:"flex",flexDirection:"column",borderRadius:"16px",border:"1px solid var(--modal-border)",animation:"slideUp 0.3s ease"},children:[t.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)",borderRadius:"16px 16px 0 0"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx(f,{size:18,strokeWidth:2.5}),t.jsx("h2",{style:{margin:0,fontSize:"1.1rem",fontWeight:"600",color:"inherit"},children:h.label})]}),t.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[i&&r&&!s&&t.jsx("button",{onClick:i,title:"",style:{background:"none",border:"none",cursor:"pointer",padding:"4px",color:"inherit",display:"flex",alignItems:"center"},children:t.jsx(Hs,{size:18,strokeWidth:2.5})}),t.jsx("button",{onClick:n,style:{background:"none",border:"none",cursor:"pointer",padding:"4px",color:"inherit"},children:t.jsx(st,{size:22,strokeWidth:2.5})})]})]}),a==="consistency"&&r&&r.results&&r.results.length>0&&!s&&t.jsxs("div",{style:{padding:"8px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx("span",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)"},children:":"}),t.jsxs("div",{style:{position:"relative"},children:[t.jsxs("select",{value:c,onChange:u=>d(u.target.value),style:{appearance:"none",fontSize:"0.8rem",padding:"4px 24px 4px 8px",border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--card)",color:"var(--card-foreground)",cursor:"pointer"},children:[t.jsx("option",{value:"all",children:""}),t.jsx("option",{value:"",children:""}),t.jsx("option",{value:"",children:""}),t.jsx("option",{value:"",children:""})]}),t.jsx(se,{size:12,style:{position:"absolute",right:"6px",top:"50%",transform:"translateY(-50%)",pointerEvents:"none",color:"var(--muted-foreground)"}})]})]}),t.jsx("div",{style:{flex:1,overflowY:"auto",padding:"20px",backgroundColor:"var(--modal-bg)",borderRadius:"0 0 16px 16px"},children:m()}),t.jsx("style",{children:`
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                @keyframes slideUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `})]})}const pr=["#4F46E5","#DC2626","#059669","#D97706","#7C3AED","#DB2777","#0891B2","#65A30D","#EA580C","#6366F1","#14B8A6","#F59E0B","#EF4444","#8B5CF6","#EC4899"];function ve(e){return e.source||e.character1||""}function Ae(e){return e.target||e.character2||""}function Mi(){const e=getComputedStyle(document.documentElement);return{foreground:e.getPropertyValue("--foreground").trim()||"#1c1917",mutedForeground:e.getPropertyValue("--muted-foreground").trim()||"#78716c",modalBg:e.getPropertyValue("--modal-bg").trim()||"#ffffff",border:e.getPropertyValue("--border").trim()||"#e7e5e4",modalText:e.getPropertyValue("--modal-text").trim()||"#1c1917"}}function Ei({isOpen:e,onClose:n,relationships:r,characters:s=[]}){const o=x.useRef(null),i=x.useRef(null),[l,a]=x.useState(null),[c,d]=x.useState({w:600,h:500}),h=x.useRef([]),f=x.useRef(0),m=x.useRef(null),[u,b]=x.useState(!1),j=x.useMemo(()=>{const v=new Set;for(const g of r){const w=ve(g),z=Ae(g);w&&v.add(w),z&&v.add(z)}return Array.from(v)},[r]),C=x.useMemo(()=>{const v=new Map;return j.forEach((g,w)=>v.set(g,pr[w%pr.length])),v},[j]),k=x.useMemo(()=>{const v=new Map;for(const g of s)v.set(g.name,g);return v},[s]),F=x.useMemo(()=>{let v=1/0,g=0;for(const w of s){const z=w.appearance_count||0;z<v&&(v=z),z>g&&(g=z)}return v===1/0&&(v=0),{min:v,max:g}},[s]),D=x.useMemo(()=>{const v=new Map;for(const g of r){const w=ve(g),z=Ae(g);v.set(w,(v.get(w)||0)+1),v.set(z,(v.get(z)||0)+1)}return v},[r]),[U,Y]=x.useState(new Set);x.useEffect(()=>{e&&j.length>0&&U.size===0&&Y(new Set(j.slice(0,Math.min(3,j.length))))},[e,j]);const Z=x.useMemo(()=>U.size===0?[]:r.filter(v=>U.has(ve(v))&&U.has(Ae(v))),[r,U]),Q=x.useMemo(()=>Array.from(U),[U]),pe=v=>{Y(g=>{const w=new Set(g);return w.has(v)?w.delete(v):w.add(v),w})},te=()=>Y(new Set(j)),Fe=()=>Y(new Set),ot=x.useCallback((v,g)=>{const z=k.get(v)?.appearance_count||0,{min:I,max:H}=F;if(H===I||H===0)return g;const ie=(z-I)/(H-I),T=g*.75,M=g*1.4;return T+ie*(M-T)},[k,F]);x.useEffect(()=>{if(!e||!i.current)return;const v=()=>{if(!i.current)return;const z=i.current.getBoundingClientRect();z.width>0&&z.height>0&&d({w:z.width,h:z.height})};requestAnimationFrame(v);const g=setTimeout(v,100),w=new ResizeObserver(v);return w.observe(i.current),()=>{clearTimeout(g),w.disconnect()}},[e]),x.useEffect(()=>{if(!e)return;const{w:v,h:g}=c,w=v/2,z=g/2,I=Q.length,H=Math.min(v,g)*.32,ie=Math.max(30,Math.min(45,v/(I*2.2)));h.current=Q.map((T,M)=>{const $=2*Math.PI*M/I-Math.PI/2;return{name:T,x:I===1?w:w+H*Math.cos($),y:I===1?z:z+H*Math.sin($),color:C.get(T)||"#4F46E5",initials:T.slice(0,2),radius:ot(T,ie)}})},[e,Q,c,C,ot]);const Ue=x.useCallback(v=>h.current.find(g=>g.name===v),[]),Ee=x.useCallback((v,g)=>{if(g)return 3.5;const w=v.description?.length||0,z=k.get(ve(v))?.appearance_count||0,I=k.get(Ae(v))?.appearance_count||0,H=w+(z+I)*2;return H>100?3:H>40?2.2:1.5},[k]),it=x.useMemo(()=>{const v=new Map;for(const g of Z){const w=[ve(g),Ae(g)].sort().join("|"),z=v.get(w);z?z.total++:v.set(w,{total:1,current:0})}return v},[Z]),We=x.useCallback(()=>{const v=o.current;if(!v)return;const g=v.getContext("2d");if(!g)return;const{w,h:z}=c,I=window.devicePixelRatio||1;v.width=w*I,v.height=z*I,g.scale(I,I),g.clearRect(0,0,w,z);const H=Mi();if(Q.length===0){g.font='14px Pretendard, "Noto Sans KR", sans-serif',g.fillStyle=H.mutedForeground,g.textAlign="center",g.textBaseline="middle",g.fillText("  ",w/2,z/2);return}const ie=new Map;for(const T of Z){const M=Ue(ve(T)),$=Ue(Ae(T));if(!M||!$)continue;const xe=l===M.name||l===$.name,lt=Ee(T,xe),Se=[M.name,$.name].sort().join("|"),Ke=it.get(Se),ue=ie.get(Se)||0;ie.set(Se,ue+1);const Ve=Ke?.total||1,K=Ve>1?(ue-(Ve-1)/2)*40:0,Ye=(M.x+$.x)/2,He=(M.y+$.y)/2,ge=Math.atan2($.y-M.y,$.x-M.x),at=-Math.sin(ge)*K,_e=Math.cos(ge)*K,ct=Ye+at,we=He+_e;g.beginPath(),g.moveTo(M.x,M.y),K!==0?g.quadraticCurveTo(ct,we,$.x,$.y):g.lineTo($.x,$.y),g.strokeStyle=xe?M.color:`${H.mutedForeground}66`,g.lineWidth=lt,g.setLineDash([]),g.stroke();const Xe=K!==0?(M.x+2*ct+$.x)/4:Ye,Je=K!==0?(M.y+2*we+$.y)/4:He,re=K!==0?Math.atan2($.y-M.y+_e,$.x-M.x+at):ge,ae=8;if(g.beginPath(),g.moveTo(Xe+ae*Math.cos(re),Je+ae*Math.sin(re)),g.lineTo(Xe-ae*Math.cos(re-.4),Je-ae*Math.sin(re-.4)),g.lineTo(Xe-ae*Math.cos(re+.4),Je-ae*Math.sin(re+.4)),g.closePath(),g.fillStyle=xe?M.color:`${H.mutedForeground}88`,g.fill(),T.relation){const be=K!==0?ct:Ye,ke=(K!==0?we:He)-14,kt=T.relation;g.font=`${xe?"bold 13":"11"}px Pretendard, "Noto Sans KR", sans-serif`;const Nt=g.measureText(kt),qe=5;g.fillStyle=`${H.modalBg}ee`,g.beginPath(),g.roundRect(be-Nt.width/2-qe,ke-8-qe,Nt.width+qe*2,16+qe*2,6),g.fill(),g.strokeStyle=xe?M.color:`${H.border}`,g.lineWidth=1,g.stroke(),g.fillStyle=xe?M.color:H.mutedForeground,g.textAlign="center",g.textBaseline="middle",g.fillText(kt,be,ke)}}for(const T of h.current){const M=l===T.name,$=M?T.radius+5:T.radius;g.shadowColor=M?`${T.color}55`:"rgba(0,0,0,0.1)",g.shadowBlur=M?20:8,g.shadowOffsetX=0,g.shadowOffsetY=3,M&&(g.beginPath(),g.arc(T.x,T.y,$+5,0,Math.PI*2),g.fillStyle=`${T.color}20`,g.fill()),g.beginPath(),g.arc(T.x,T.y,$,0,Math.PI*2),g.fillStyle=T.color,g.fill(),g.shadowColor="transparent",g.strokeStyle=H.modalBg,g.lineWidth=3,g.stroke(),g.font=`bold ${Math.round($*.55)}px Pretendard, "Noto Sans KR", sans-serif`,g.fillStyle="#fff",g.textAlign="center",g.textBaseline="middle",g.fillText(T.initials,T.x,T.y),g.font=`${M?"bold ":""}13px Pretendard, "Noto Sans KR", sans-serif`,g.fillStyle=H.foreground,g.textBaseline="top",g.fillText(T.name,T.x,T.y+$+10)}},[Z,Q,l,c,Ue,Ee,it]);x.useEffect(()=>{e&&(cancelAnimationFrame(f.current),f.current=requestAnimationFrame(We))},[We,e]);const Le=x.useCallback(v=>{const g=o.current;if(!g)return{mx:0,my:0};const w=g.getBoundingClientRect();return{mx:v.clientX-w.left,my:v.clientY-w.top}},[]),W=x.useCallback((v,g)=>{for(const w of h.current){const z=v-w.x,I=g-w.y;if(z*z+I*I<(w.radius+12)*(w.radius+12))return w}return null},[]),jt=x.useCallback(v=>{const{mx:g,my:w}=Le(v),z=W(g,w);z&&(m.current={name:z.name,offsetX:g-z.x,offsetY:w-z.y},b(!0))},[Le,W]),Gt=x.useCallback(v=>{const{mx:g,my:w}=Le(v);if(m.current){const I=h.current.find(H=>H.name===m.current.name);I&&(I.x=g-m.current.offsetX,I.y=w-m.current.offsetY,cancelAnimationFrame(f.current),f.current=requestAnimationFrame(We));return}const z=W(g,w);a(z?.name||null)},[Le,W,We]),Ct=x.useCallback(()=>{m.current=null,b(!1)},[]),X=x.useCallback(()=>{m.current=null,b(!1),a(null)},[]);if(!e)return null;const ne=l?k.get(l):null,O=l?Z.filter(v=>ve(v)===l||Ae(v)===l):[],Ge=l&&D.get(l)||0,Ie=u?"grabbing":l?"grab":"default",St=j.length===0,wt=j.length>0&&r.length===0;return t.jsx("div",{style:{position:"fixed",inset:0,zIndex:1100,background:"rgba(0,0,0,0.6)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center"},onClick:v=>{v.target===v.currentTarget&&n()},children:t.jsxs("div",{style:{width:"92vw",maxWidth:"1200px",height:"82vh",maxHeight:"800px",background:"var(--modal-bg, #fff)",borderRadius:"16px",border:"1px solid var(--modal-border, #e5e7eb)",boxShadow:"0 20px 60px rgba(0,0,0,0.3)",display:"flex",flexDirection:"column",overflow:"hidden"},children:[t.jsxs("div",{style:{padding:"14px 24px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"space-between",background:"var(--modal-header-bg)",color:"var(--modal-header-text)"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[t.jsx(yr,{size:22}),t.jsx("h2",{style:{margin:0,fontSize:"1.1rem",fontWeight:700},children:" "}),t.jsxs("span",{style:{fontSize:"0.78rem",opacity:.6},children:[U.size,"/",j.length,"   ",Z.length," "]})]}),t.jsx("button",{onClick:n,style:{background:"none",border:"none",cursor:"pointer",color:"currentColor",padding:"4px"},children:t.jsx(st,{size:22})})]}),St?t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"16px",color:"var(--muted-foreground)",padding:"40px"},children:[t.jsx($s,{size:48,strokeWidth:1.5}),t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("p",{style:{fontSize:"1rem",fontWeight:600,margin:"0 0 8px"},children:"  "}),t.jsx("p",{style:{fontSize:"0.85rem",opacity:.7,margin:0},children:"   ."})]})]}):wt?t.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"16px",color:"var(--muted-foreground)",padding:"40px"},children:[t.jsx(Ft,{size:48,strokeWidth:1.5}),t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx("p",{style:{fontSize:"1rem",fontWeight:600,margin:"0 0 8px"},children:"    "}),t.jsxs("p",{style:{fontSize:"0.85rem",opacity:.7,margin:0},children:[j.length,"       ."]})]})]}):t.jsxs("div",{style:{flex:1,display:"flex",overflow:"hidden"},children:[t.jsxs("div",{style:{width:"220px",borderRight:"1px solid var(--border)",display:"flex",flexDirection:"column",background:"var(--card-bg, #fafafa)"},children:[t.jsxs("div",{style:{padding:"10px 14px",borderBottom:"1px solid var(--border)",display:"flex",gap:"6px"},children:[t.jsx("button",{onClick:te,style:{flex:1,padding:"5px",fontSize:"0.75rem",fontWeight:600,border:"1px solid var(--border)",borderRadius:"6px",cursor:"pointer",background:"transparent",color:"var(--foreground)"},children:" "}),t.jsx("button",{onClick:Fe,style:{flex:1,padding:"5px",fontSize:"0.75rem",fontWeight:600,border:"1px solid var(--border)",borderRadius:"6px",cursor:"pointer",background:"transparent",color:"var(--foreground)"},children:" "})]}),t.jsx("div",{style:{flex:1,overflowY:"auto",padding:"6px"},children:j.map(v=>{const g=U.has(v),w=C.get(v)||"#4F46E5",z=k.get(v),I=D.get(v)||0,H=z?.appearance_count;return t.jsxs("button",{onClick:()=>pe(v),style:{width:"100%",display:"flex",alignItems:"center",gap:"10px",padding:"8px 10px",marginBottom:"2px",borderRadius:"8px",border:"none",cursor:"pointer",textAlign:"left",background:g?`${w}12`:"transparent",transition:"background 0.15s"},children:[t.jsx("div",{style:{width:"30px",height:"30px",borderRadius:"50%",background:g?w:"#ddd",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:"0.7rem",fontWeight:700,transition:"background 0.15s"},children:g?t.jsx(bt,{size:14,strokeWidth:3}):v.slice(0,1)}),t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsx("div",{style:{fontSize:"0.85rem",fontWeight:g?700:500,color:g?w:"var(--foreground)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:v}),t.jsxs("div",{style:{fontSize:"0.7rem",color:"var(--muted-foreground)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:[I," ",H?`  ${H} `:"",z?.traits?.[0]?`  ${z.traits[0]}`:""]})]})]},v)})})]}),t.jsxs("div",{ref:i,style:{flex:1,position:"relative",minHeight:0},children:[t.jsx("canvas",{ref:o,style:{width:"100%",height:"100%",cursor:Ie},onMouseDown:jt,onMouseMove:Gt,onMouseUp:Ct,onMouseLeave:X}),l&&!u&&t.jsxs("div",{style:{position:"absolute",bottom:"16px",left:"16px",maxWidth:"380px",background:"var(--modal-bg, #fff)",border:"1px solid var(--border)",borderRadius:"12px",padding:"14px 18px",boxShadow:"0 4px 16px rgba(0,0,0,0.12)",pointerEvents:"none",color:"var(--modal-text, #1c1917)"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"8px"},children:[t.jsx("div",{style:{width:"28px",height:"28px",borderRadius:"50%",background:C.get(l)||"#4F46E5",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:"0.7rem",fontWeight:700},children:l.slice(0,2)}),t.jsxs("div",{children:[t.jsx("span",{style:{fontWeight:700,fontSize:"0.95rem"},children:l}),t.jsxs("div",{style:{fontSize:"0.72rem",color:"var(--muted-foreground)",marginTop:"1px"},children:[Ge," ",ne?.appearance_count?`  ${ne.appearance_count} `:""]})]})]}),ne?.traits&&ne.traits.length>0&&t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",marginBottom:"8px"},children:ne.traits.map((v,g)=>t.jsx("span",{style:{fontSize:"0.68rem",padding:"2px 8px",borderRadius:"10px",background:`${C.get(l)||"#4F46E5"}18`,color:C.get(l)||"#4F46E5",fontWeight:600,border:`1px solid ${C.get(l)||"#4F46E5"}30`},children:v},g))}),ne?.description&&t.jsx("p",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)",margin:"0 0 8px",lineHeight:1.5},children:ne.description.length>150?ne.description.slice(0,150)+"...":ne.description}),O.length>0&&t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"},children:O.map((v,g)=>{const w=ve(v)===l?Ae(v):ve(v);return t.jsxs("span",{style:{fontSize:"0.7rem",padding:"2px 8px",borderRadius:"10px",background:`${C.get(w)||"#666"}22`,color:C.get(w)||"#666",fontWeight:600},children:[w,": ",v.relation||""]},g)})})]})]})]})]})})}function Wi({isOpen:e,onClose:n,messages:r,onSendMessage:s,isLoading:o,onClearChat:i}){const[l,a]=x.useState(""),c=x.useRef(null),d=()=>{c.current?.scrollIntoView({behavior:"smooth"})},h=u=>{const b=u.match(/[^.!?]+[.!?]+(\s|$)/g);if(!b)return u;let j="";for(let C=0;C<b.length;C++)j+=b[C],(C+1)%2===0&&C<b.length-1&&(j+=`

`);return j||u};x.useEffect(()=>{e&&d()},[r,e,o]);const f=u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),m())},m=()=>{!l.trim()||o||(s(l),a(""))};return e?t.jsxs("div",{style:{position:"fixed",bottom:"16px",right:"20px",width:"500px",height:"850px",backgroundColor:"var(--modal-bg)",boxShadow:"0 8px 32px rgba(0,0,0,0.15)",zIndex:1e3,display:"flex",flexDirection:"column",borderRadius:"16px",border:"1px solid var(--modal-border)",animation:"slideUp 0.3s ease"},children:[t.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)",borderRadius:"16px 16px 0 0"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx(mn,{size:20,strokeWidth:2.5,className:o?"animate-spin":"",style:{color:"var(--primary)"}}),t.jsx("h3",{style:{margin:0,fontSize:"1.1rem",fontWeight:"bold",color:"inherit"},children:"  "})]}),t.jsxs("div",{style:{display:"flex",gap:"8px"},children:[i&&r.length>0&&t.jsx("button",{onClick:i,title:" ",style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(Bs,{size:18,strokeWidth:2.5})}),t.jsx("button",{onClick:n,style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(st,{size:20,strokeWidth:2.5})})]})]}),t.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"20px",backgroundColor:"var(--modal-bg)",display:"flex",flexDirection:"column",gap:"20px"},children:[r.length===0&&t.jsxs("div",{style:{textAlign:"center",color:"var(--muted-foreground)",marginTop:"60px",display:"flex",flexDirection:"column",alignItems:"center",gap:"12px"},children:[t.jsx(mn,{size:48,strokeWidth:2.5,style:{opacity:.2,color:"var(--primary)"}}),t.jsxs("p",{style:{lineHeight:"1.5"},children:['"   ?"',t.jsx("br",{}),"AI   ."]})]}),r.map(u=>t.jsxs("div",{style:{display:"flex",justifyContent:u.role==="user"?"flex-end":"flex-start",gap:"12px"},children:[u.role==="assistant"&&t.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:"4px"},children:t.jsx(Ps,{size:18,strokeWidth:2.5,style:{color:"var(--primary)"}})}),t.jsx("div",{style:{maxWidth:"85%",padding:"12px 16px",borderRadius:"12px",borderTopLeftRadius:u.role==="assistant"?"2px":"12px",borderTopRightRadius:u.role==="user"?"2px":"12px",backgroundColor:u.role==="user"?"var(--primary)":"var(--input-bg)",color:u.role==="user"?"var(--primary-foreground)":"var(--input-text)",boxShadow:u.role==="assistant"?"0 1px 2px rgba(0,0,0,0.05)":"none",border:u.role==="assistant"?"1px solid var(--input-border)":"none",lineHeight:"1.6",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:u.role==="assistant"?h(u.content):u.content}),u.role==="user"&&t.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:"4px"},children:t.jsx(Os,{size:18,strokeWidth:2.5,style:{color:"var(--muted-foreground)"}})})]},u.id)),o&&t.jsxs("div",{style:{display:"flex",gap:"12px"},children:[t.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:t.jsx(On,{className:"animate-spin",size:18,strokeWidth:2.5,style:{color:"var(--primary)"}})}),t.jsx("div",{style:{padding:"12px 16px",borderRadius:"12px",borderTopLeftRadius:"2px",backgroundColor:"var(--input-bg)",border:"1px solid var(--input-border)",color:"var(--muted-foreground)",boxShadow:"0 1px 2px rgba(0,0,0,0.05)"},children:"  ..."})]}),t.jsx("div",{ref:c})]}),t.jsx("div",{style:{padding:"16px",backgroundColor:"var(--modal-bg)",borderTop:"1px solid var(--modal-border)",borderRadius:"0 0 16px 16px"},children:t.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"flex-end",backgroundColor:"var(--input-bg)",padding:"8px",borderRadius:"12px",border:"1px solid var(--input-border)"},children:[t.jsx("textarea",{value:l,onChange:u=>a(u.target.value),onKeyDown:f,placeholder:" ...",style:{flex:1,border:"none",background:"transparent",resize:"none",height:"auto",minHeight:"24px",maxHeight:"120px",padding:"8px",fontSize:"0.95rem",outline:"none",fontFamily:"inherit",overflowY:"auto",color:"var(--input-text)"},rows:1,onInput:u=>{u.currentTarget.style.height="auto",u.currentTarget.style.height=u.currentTarget.scrollHeight+"px"}}),t.jsx("button",{onClick:m,disabled:!l.trim()||o,style:{backgroundColor:l.trim()&&!o?"var(--primary)":"var(--muted)",color:l.trim()&&!o?"var(--primary-foreground)":"var(--muted-foreground)",border:"none",borderRadius:"8px",padding:"8px",display:"flex",alignItems:"center",justifyContent:"center",cursor:l.trim()&&!o?"pointer":"not-allowed",transition:"background-color 0.2s",width:"36px",height:"36px"},children:o?t.jsx(On,{size:18,strokeWidth:2.5,className:"animate-spin"}):t.jsx(mr,{size:18,strokeWidth:2.5})})]})}),t.jsx("style",{children:`
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                @keyframes slideUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-spin {
                    animation: spin 1s linear infinite;
                }
            `})]}):null}const Li=async(e,n)=>le("/prediction/request",{method:"POST",body:JSON.stringify({novel_id:e,text:n})}),Ii=async e=>le(`/prediction/task/${e}`),Hi=async e=>le(`/prediction/history/${e}`),_i=async e=>le(`/prediction/history/${e}`,{method:"DELETE"});async function Di(e,n){return le(`/analysis/consistency/${e}/${n}`)}async function $i(e){return le("/analysis/consistency",{method:"POST",body:JSON.stringify(e)})}async function Bi(e){return le(`/analysis/task/${e}`)}async function Pi(e){return le("/analysis/chapter-analysis",{method:"POST",body:JSON.stringify(e)})}async function Oi(e,n,r){return le(`/analysis/chapter-analysis/${e}/${n}/${r}`)}const Fi=()=>{const e=localStorage.getItem("token"),n={"Content-Type":"application/json"};return e&&(n.Authorization=`Bearer ${e}`),n},Ui=async e=>le("/images/generate",{method:"POST",headers:Fi(),body:JSON.stringify(e)});function Ji({fileName:e,onBack:n,novelId:r,chapterId:s,mode:o="writer",onOpenCharacterChat:i,onCloseCharacterChat:l,onNavigateChapter:a,showCharacterChat:c}){const[d,h]=x.useState(!0),[f,m]=x.useState(!0),[u,b]=x.useState(!1),[j,C]=x.useState(!1),[k,F]=x.useState(!1),[D,U]=x.useState(!1),[Y,Z]=x.useState(!1),[Q,pe]=x.useState(!1),[te,Fe]=x.useState(""),[ot,Ue]=x.useState(!1),[Ee,it]=x.useState(!1),[We,Le]=x.useState(!1),[W,jt]=x.useState(null),[Gt,Ct]=x.useState(!1),[X,ne]=x.useState([]),[O,Ge]=x.useState(void 0),[Ie,St]=x.useState(""),[wt,v]=x.useState(""),[g,w]=x.useState(!1),[z,I]=x.useState(!1),H=x.useRef(null),ie=x.useRef(),[T,M]=x.useState(!1),[$,xe]=x.useState(!1),lt=x.useRef(null),Se=x.useRef(),Ke=x.useRef(),[ue,Ve]=x.useState(!1),[K,Ye]=x.useState(!1),[He,ge]=x.useState(!1),[at,_e]=x.useState([]),[ct,we]=x.useState(!1),[Xe,Je]=x.useState(null),[re,ae]=x.useState(null),[be,ke]=x.useState(!1),[kt,Nt]=x.useState(0),[qe,Dr]=x.useState(0),[Qe,$r]=x.useState([]),Kt=x.useRef(!1),Vt=x.useRef(()=>Promise.resolve()),{theme:zt,setTheme:Br}=vr(),[ee,Nn]=x.useState(()=>{const p=localStorage.getItem("reader-settings");return p?JSON.parse(p):{fontSize:18,lineHeight:2,paragraphSpacing:40,contentWidth:80,fontFamily:"Noto Serif KR",theme:"light"}});x.useEffect(()=>{o==="reader"&&ee.theme!==zt&&Nn(p=>({...p,theme:zt}))},[zt,o]);const Pr=p=>{Nn(p),p.theme&&p.theme!==zt&&Br(p.theme)};x.useEffect(()=>{localStorage.setItem("reader-settings",JSON.stringify(ee)),o==="reader"?(document.documentElement.setAttribute("data-reader-theme",ee.theme),document.documentElement.setAttribute("data-theme",ee.theme)):document.documentElement.removeAttribute("data-reader-theme")},[ee,o]),x.useEffect(()=>{if(Xe){const p=setTimeout(()=>{Je(null)},15e3);return()=>clearTimeout(p)}},[Xe]),x.useEffect(()=>{r&&s?(zn(),An()):We||(Fe(`          .
               .
"     ?"  .

  (      )                .            .

    .    ", ! !"         . (     ,      .)            ,   .    ,           .       ,          .`),Le(!0))},[r,s]),x.useEffect(()=>{let p,y=!1;if(O==="PROCESSING"||O==="PENDING"){let S=3e3;const N=async()=>{if(!(y||!r||!s)){try{const L=await Js(r,s),A=(L.status||"").toUpperCase();if(A==="COMPLETED"||A==="FAILED"){Ge(A),Ve(!1),A==="COMPLETED"?(E.success(" !  ."),zn(),An()):E.error(` : ${L.message||"   "}`);return}}catch{E.error("   .")}y||(S=Math.min(S*1.5,2e4),p=setTimeout(N,S))}};N()}return()=>{y=!0,p&&clearTimeout(p)}},[O,r,s]),x.useEffect(()=>()=>{Se.current&&clearTimeout(Se.current),Ke.current&&clearTimeout(Ke.current)},[]);const zn=async()=>{if(!(!r||!s)){Ue(!0);try{const p=await Ks(r,s);Fe(p.content),Ge(p.storyboard_status)}catch{E.error("   .")}finally{Ue(!1),Le(!0)}}},An=async()=>{if(!(!r||!s)){Ct(!0);try{const p=await Vs(r,s);jt(p),p.scenes&&p.scenes.length>0&&ne(p.scenes.map(y=>y.original_text.trim()))}catch{}finally{Ct(!1)}}},Yt=async()=>{if(!(!r||!s)){it(!0);try{const p=X.length>0?X.map(y=>y.trim()).join(`

`):te;await qs(r,s,{content:p}),ke(!1),E.success(".")}catch{E.error(" .")}finally{it(!1)}}},[B,dt]=x.useState(null),[V,pt]=x.useState(null),[Ze,At]=x.useState(null),[De,Rt]=x.useState(null),[Xt,ut]=x.useState(!1),[Or,Ne]=x.useState(!1),[Fr,$e]=x.useState(null),[Rn,Tn]=x.useState("consistency"),[J,ht]=x.useState(null),[Ur,Gr]=x.useState({}),[Tt,Mn]=x.useState(!1),[Mt,En]=x.useState(!1),[Et,Wn]=x.useState(!1),ft=x.useRef(),mt=x.useRef();x.useEffect(()=>{c&&(ut(!1),ge(!1))},[c]),x.useEffect(()=>{Kt.current=be},[be]),x.useEffect(()=>{Vt.current=Yt}),x.useEffect(()=>{r&&Ys(r).then(p=>{$r(p.sort((y,S)=>y.chapter_number-S.chapter_number))}).catch(()=>{})},[r]),x.useEffect(()=>{if(o==="reader"||!r||!s)return;const p=setInterval(()=>{Kt.current&&Vt.current()},3e4);return()=>clearInterval(p)},[r,s,o]),x.useEffect(()=>{const p=y=>{Kt.current&&(y.preventDefault(),y.returnValue="")};return window.addEventListener("beforeunload",p),()=>window.removeEventListener("beforeunload",p)},[]),x.useEffect(()=>{const p=y=>{(y.ctrlKey||y.metaKey)&&y.key==="s"&&(y.preventDefault(),o!=="reader"&&r&&s&&Vt.current()),y.key==="Escape"&&(Xt?ut(!1):He?ge(!1):Q&&pe(!1))};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[o,r,s,Xt,He,Q]);const xt=x.useRef();x.useEffect(()=>(xt.current&&clearTimeout(xt.current),xt.current=setTimeout(()=>{const y=(X.length>0?X.join(`

`):te).replace(/<br\s*\/?>/gi,`
`).replace(/<[^>]+>/g,"");Nt(y.replace(/\s/g,"").length);const S=y.trim().split(/\s+/).filter(Boolean);Dr(S.length)},500),()=>{xt.current&&clearTimeout(xt.current)}),[te,X]);const Wt=Qe.findIndex(p=>p.id===s),Ln=Wt>0?Qe[Wt-1]:null,In=Wt<Qe.length-1?Qe[Wt+1]:null,Hn=async p=>{be&&r&&s&&await Yt(),a?.(p.id,p.title)},ye=(p,y)=>{dt(null),pt(null),At(null),Rt(null),ht(null),Mn(!1),En(!1),Wn(!1),pe(!1),y&&y.trim()&&Je({sceneIndex:p,text:y.trim(),timestamp:Date.now()}),ft.current&&clearTimeout(ft.current),mt.current&&clearTimeout(mt.current),ft.current=setTimeout(()=>{const S=document.getElementById(`scene-block-${p}`);S&&(S.scrollIntoView({behavior:"smooth",block:"start"}),S.style.transition="background-color 0.5s",S.style.backgroundColor="rgba(79, 70, 229, 0.1)",mt.current=setTimeout(()=>{S.style.backgroundColor="transparent"},1e3))},100)},_n=async p=>{Ne(!0),$e(null),Tn(p);try{let y;if(p==="consistency"){const A=X.length>0?X.join(`

`):te;y=(await $i({novel_id:r,chapter_id:s,text:A})).task_id}else y=(await Pi({novel_id:r,chapter_id:s,analysis_type:p})).task_id;let S=2e3,N=0;const L=async()=>{if(N++,N>60){Ne(!1),$e({status:"",message:"    .   ."});return}try{const A=await Bi(y);if(A.status==="COMPLETED"){$e(A.result),Ne(!1),E.success(" .");return}else if(A.status==="FAILED"){Ne(!1),$e({status:"",message:A.error||"  ."}),E.error("   .");return}}catch(A){console.error("Polling error:",A),Ne(!1),$e({status:"",message:"      ."});return}S=Math.min(S*1.5,15e3),Se.current=setTimeout(L,S)};Se.current=setTimeout(L,S)}catch(y){console.error("Analysis error:",y),$e({status:" ",message:"    ."}),Ne(!1)}},Kr=async(p="consistency")=>{if(ut(!0),ge(!1),Tn(p),l?.(),r&&s)try{Ne(!0);const S=await(p==="consistency"?Di(r,s):Oi(r,s,p));if(S.cached&&S.result){$e(S.result),Ne(!1);return}}catch{}await _n(p)},Vr=(p,y)=>{if(X.length>0){const S=X.map(N=>N.replace(p,y));ne(S),ke(!0),E.success(" .")}else{const S=te.replace(p,y);S!==te?(Fe(S),ke(!0),E.success(" .")):E.error("     .")}},Yr=async()=>{if(ge(!0),ut(!1),l?.(),r&&at.length===0)try{const{history:p}=await Hi(r);if(p.length>0){const y=[];for(const S of p)y.push({id:`h-u-${S.id}`,role:"user",content:S.user_input}),y.push({id:`h-a-${S.id}`,role:"assistant",content:S.prediction});_e(y)}}catch{}},Xr=async p=>{if(!r||!p.trim())return;const y={id:Date.now().toString(),role:"user",content:p};_e(S=>[...S,y]),we(!0);try{const{task_id:S}=await Li(r,p);let N=2e3;const L=async()=>{try{const A=await Ii(S);if(A.status==="COMPLETED"){const P=A.result.prediction||A.result.text||(typeof A.result=="string"?A.result:JSON.stringify(A.result)),ze={id:(Date.now()+1).toString(),role:"assistant",content:P};_e(sn=>[...sn,ze]),we(!1),document.hidden&&"Notification"in window&&(Notification.permission==="granted"?new Notification("StoryProof  ",{body:" .",icon:"/favicon.ico"}):Notification.permission==="default"&&Notification.requestPermission());return}else if(A.status==="FAILED"){we(!1),E.error("    .");return}}catch{}N=Math.min(N*1.5,15e3),Ke.current=setTimeout(L,N)};Ke.current=setTimeout(L,N)}catch{we(!1),E.error("  .")}},Jr=()=>{Yr()},qr=p=>{if(!p)return;const y=N=>N.replace(/[^a-zA-Z0-9-]/g,""),S=y(p);if(X.length>0){let N=-1;if(N=X.findIndex(L=>y(L).includes(S)),N===-1&&S.length>40){const L=S.substring(0,30),A=S.substring(S.length-30);N=X.findIndex(P=>{const ze=y(P);return ze.includes(L)&&ze.includes(A)})}N!==-1?ye(N,p):E.error("     . (       )")}else{const N=document.querySelector(".novel-text-editor");if(N&&te)if(y(te).indexOf(S)!==-1){const P=te.indexOf(p);if(P!==-1){N.focus(),N.setSelectionRange(P,P+p.length);const ze=te.substring(0,P).split(`
`).length;N.scrollTop=(ze-1)*24}else E.warning(" ,      .")}else E.error("     .")}},Qr=()=>{E.info("   .")},Zr=()=>{re&&re.chain().focus().toggleHighlight().run()},es=()=>{E.info("   .")},Dn=()=>{pe(!0)},Jt=x.useMemo(()=>W?.characters&&W.characters.length>0?W.characters:[{name:"",first_appearance:0,appearance_count:5,appearances:[0,1,2,3,4],traits:[" "," "]},{name:" ",first_appearance:0,appearance_count:3,appearances:[0,1,3],traits:[""," "]},{name:"",first_appearance:0,appearance_count:1,appearances:[0]}],[W]),qt=x.useMemo(()=>W?.items&&W.items.length>0?W.items:[{name:"",first_appearance:0},{name:"",first_appearance:0},{name:" ",first_appearance:0}],[W]),Qt=x.useMemo(()=>W?.key_events&&W.key_events.length>0?W.key_events:[{summary:"     ",scene_index:0,importance:""},{summary:"    ",scene_index:1,importance:""},{summary:"    ",scene_index:2,importance:""}],[W]),ts=()=>{if(!(!r||!s)){if(O==="PROCESSING"){E.warning("   .  .");return}E(" ?",{description:"  (,  )   .",action:{label:"",onClick:async()=>{Ve(!0),Ge("PROCESSING");try{await Qs(r,s),E.success("  .   .")}catch{E.error("  "),Ge("FAILED"),Ve(!1)}}},cancel:{label:"",onClick:()=>{}}})}},Zt=x.useMemo(()=>W?.locations&&W.locations.length>0?W.locations:[{name:"",description:"   ",scenes:[0]},{name:" ",description:"   ",scenes:[2]}],[W]),R=wt.trim().toLowerCase(),et=x.useMemo(()=>R?Jt.filter(p=>p.name.toLowerCase().includes(R)||(p.description||"").toLowerCase().includes(R)||(p.traits||[]).some(y=>y.toLowerCase().includes(R))):Jt,[Jt,R]),tt=x.useMemo(()=>R?qt.filter(p=>p.name.toLowerCase().includes(R)||(p.description||"").toLowerCase().includes(R)):qt,[qt,R]),nt=x.useMemo(()=>R?Zt.filter(p=>p.name.toLowerCase().includes(R)||(p.description||"").toLowerCase().includes(R)):Zt,[Zt,R]),rt=x.useMemo(()=>R?Qt.filter(p=>(p.summary||"").toLowerCase().includes(R)):Qt,[Qt,R]),gt=x.useMemo(()=>(W?.relationships||[]).map(p=>({...p,source:p.source||p.character1||"",target:p.target||p.character2||""})),[W]),en=x.useMemo(()=>R?gt.filter(p=>(p.source||"").toLowerCase().includes(R)||(p.target||"").toLowerCase().includes(R)||(p.relation||"").toLowerCase().includes(R)||(p.description||"").toLowerCase().includes(R)):gt,[gt,R]),Lt=x.useMemo(()=>!R||!W?.scenes?[]:W.scenes.filter(p=>(p.original_text||"").toLowerCase().includes(R)||(p.summary||"").toLowerCase().includes(R)),[W,R]);x.useEffect(()=>(ie.current&&clearTimeout(ie.current),ie.current=setTimeout(()=>{v(Ie)},300),()=>{ie.current&&clearTimeout(ie.current)}),[Ie]),x.useEffect(()=>()=>{ft.current&&clearTimeout(ft.current),mt.current&&clearTimeout(mt.current)},[]),x.useEffect(()=>{R&&(et.length>0&&m(!0),tt.length>0&&b(!0),nt.length>0&&C(!0),rt.length>0&&F(!0))},[R,et.length,tt.length,nt.length,rt.length]),x.useEffect(()=>{const p=S=>{H.current&&!H.current.contains(S.target)&&w(!1)},y=S=>{S.key==="Escape"&&g&&w(!1)};return document.addEventListener("mousedown",p),document.addEventListener("keydown",y),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("keydown",y)}},[g]),x.useEffect(()=>{const p=S=>{lt.current&&!lt.current.contains(S.target)&&M(!1)},y=S=>{S.key==="Escape"&&T&&M(!1)};return document.addEventListener("mousedown",p),document.addEventListener("keydown",y),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("keydown",y)}},[T]);const ns=(p,y,S=80)=>{if(!y)return t.jsx("span",{children:p.length>S?p.slice(0,S)+"...":p});const L=p.toLowerCase().indexOf(y.toLowerCase());if(L===-1)return t.jsx("span",{children:p.length>S?p.slice(0,S)+"...":p});const A=Math.max(0,L-20),P=Math.min(p.length,L+y.length+40),ze=A>0?"...":"",sn=P<p.length?"...":"",rs=p.slice(A,L),ss=p.slice(L,L+y.length),os=p.slice(L+y.length,P);return t.jsxs("span",{children:[ze,rs,t.jsx("mark",{className:"bible-search-highlight",children:ss}),os,sn]})},tn=async p=>{if(!(!r||!s)){I(!0),w(!1);try{await eo(r,s,p,wt||void 0),E.success(`${p.toUpperCase()}  .`)}catch{E.error(" .")}finally{I(!1)}}},nn=async p=>{if(!(!r||!s)){xe(!0),M(!1);try{await Zs(r,s,p),E.success(`${p.toUpperCase()}  .`)}catch{E.error(" .")}finally{xe(!1)}}};if(ot&&!We)return t.jsx("div",{className:`chapter-detail-container loading ${d?"sidebar-open":""}`,children:t.jsx("div",{className:"loading-spinner"})});const rn=async(p,y)=>{if(!r||!s){E.error("/  .");return}Ye(!0);try{const N=(await Ui({novel_id:r,chapter_id:s,entity_type:p,entity_name:y.name,description:y.description||y.name})).image_url,L=A=>A.map(P=>P.name===y.name?{...P,image:N}:P);jt(A=>{if(!A)return null;const P={...A};return p==="character"&&(P.characters=L(P.characters)),p==="item"&&(P.items=L(P.items)),p==="location"&&(P.locations=L(P.locations)),P}),p==="character"&&B?.name===y.name&&dt(A=>A?{...A,image:N}:null),p==="item"&&V?.name===y.name&&pt(A=>A?{...A,image:N}:null),p==="location"&&J?.name===y.name&&ht(A=>A?{...A,image:N}:null),E.success(" !")}catch(S){console.error("Image generation failed:",S),E.error("  .")}finally{Ye(!1)}};return t.jsxs("div",{className:`chapter-detail-container ${d?"sidebar-open":""}`,children:[t.jsx("style",{children:`
                @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                .spin-animation { animation: spin 1s linear infinite; }
            `}),t.jsxs("div",{className:"chapter-detail-header",style:{display:"flex",alignItems:"center",padding:"16px 24px",borderBottom:"1px solid var(--border)",backgroundColor:"var(--card)",position:"sticky",top:0,zIndex:51},children:[t.jsx("button",{className:"back-button",onClick:n,style:{marginRight:"16px",padding:"8px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(Fs,{size:24,color:"var(--muted-foreground)"})}),t.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:"4px"},children:[Qe.length>1&&Ln&&t.jsx("button",{onClick:()=>Hn(Ln),title:" ",style:{padding:"4px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",color:"var(--muted-foreground)"},children:t.jsx(fn,{size:20})}),t.jsx("h1",{className:"chapter-detail-title",style:{fontSize:"1.25rem",fontWeight:600,color:"var(--foreground)",margin:0},children:e}),Qe.length>1&&In&&t.jsx("button",{onClick:()=>Hn(In),title:" ",style:{padding:"4px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",color:"var(--muted-foreground)"},children:t.jsx(ln,{size:20})})]}),r&&s&&o!=="reader"&&t.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[t.jsxs("span",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)",whiteSpace:"nowrap"},children:[kt.toLocaleString(),"  ",qe.toLocaleString(),""]}),t.jsx("span",{style:{fontSize:"0.75rem",color:be?"#D97706":"var(--muted-foreground)",whiteSpace:"nowrap",padding:"2px 8px",borderRadius:"4px",backgroundColor:be?"rgba(217, 119, 6, 0.1)":"transparent"},children:Ee?" ...":be?" ":""}),t.jsxs("button",{className:"reanalyze-button",onClick:ts,disabled:O==="PROCESSING"||O==="PENDING"||ue,title:O==="PROCESSING"||O==="PENDING"?"  ...":"AI ",style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 16px",backgroundColor:O==="PROCESSING"||O==="PENDING"||ue?"var(--muted)":"transparent",color:O==="PROCESSING"||O==="PENDING"||ue?"var(--muted-foreground)":"var(--primary)",border:O==="PROCESSING"||O==="PENDING"||ue?"1px solid var(--border)":"1px solid var(--primary)",borderRadius:"6px",cursor:O==="PROCESSING"||O==="PENDING"||ue?"not-allowed":"pointer",fontSize:"0.9rem",fontWeight:500},children:[t.jsx(It,{size:16,className:O==="PROCESSING"||O==="PENDING"||ue?"spin-animation":""}),O==="PROCESSING"||O==="PENDING"||ue?" ...":""]}),t.jsxs("button",{className:"save-button",onClick:Yt,disabled:Ee,style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 16px",backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"6px",cursor:Ee?"wait":"pointer",fontSize:"0.9rem",fontWeight:500},children:[t.jsx(Us,{size:18}),Ee?" ...":""]}),t.jsxs("div",{className:"chapter-export-wrapper",ref:lt,children:[t.jsx("button",{className:"chapter-export-btn",onClick:()=>M(!T),disabled:$,title:" ",children:t.jsx(Fn,{size:16})}),T&&t.jsxs("div",{className:"chapter-export-dropdown",children:[t.jsxs("button",{onClick:()=>nn("txt"),className:"export-dropdown-item",children:[t.jsx(an,{size:14})," TXT ()"]}),t.jsxs("button",{onClick:()=>nn("pdf"),className:"export-dropdown-item",children:[t.jsx(cn,{size:14})," PDF"]}),t.jsxs("button",{onClick:()=>nn("docx"),className:"export-dropdown-item",children:[t.jsx(cn,{size:14})," DOCX ()"]})]})]})]})]}),o==="reader"?t.jsx(Ci,{editor:re,readerSettings:ee,onSettingsChange:Pr,onBookmark:Qr,onHighlight:Zr,onAddMemo:es}):t.jsx(ji,{editor:re,onOpenSettings:()=>{Dn()}}),t.jsxs("div",{className:"chapter-detail-layout",children:[t.jsxs("div",{className:`dictionary-sidebar ${d?"open":"closed"}`,children:[t.jsxs("div",{className:"bible-toolbar",children:[t.jsxs("div",{className:"bible-search-wrapper",children:[t.jsx(Un,{size:14,className:"bible-search-icon"}),t.jsx("input",{type:"text",className:"bible-search-input",placeholder:" ...",value:Ie,maxLength:100,onChange:p=>St(p.target.value)}),Ie&&t.jsx("button",{className:"bible-search-clear",onClick:()=>{St(""),v("")},children:t.jsx(st,{size:12})})]}),t.jsxs("div",{className:"export-dropdown-wrapper",ref:H,children:[t.jsx("button",{className:"bible-export-btn",onClick:()=>w(!g),disabled:z,title:Ie?" ":" ",children:z?t.jsx(It,{size:14,className:"spin-animation"}):t.jsx(Fn,{size:14})}),g&&t.jsxs("div",{className:"export-dropdown",children:[t.jsxs("button",{onClick:()=>tn("txt"),className:"export-dropdown-item",children:[t.jsx(an,{size:14}),t.jsx("span",{children:"TXT ()"})]}),t.jsxs("button",{onClick:()=>tn("pdf"),className:"export-dropdown-item",children:[t.jsx(cn,{size:14}),t.jsx("span",{children:"PDF"})]}),t.jsxs("button",{onClick:()=>tn("docx"),className:"export-dropdown-item",children:[t.jsx(an,{size:14}),t.jsx("span",{children:"DOCX ()"})]})]})]})]}),R&&Lt.length>0&&t.jsxs("div",{className:"sidebar-section",children:[t.jsx("div",{className:"section-header active",style:{cursor:"default"},children:t.jsxs("div",{className:"section-header-content",children:[t.jsx(Un,{size:18}),t.jsxs("h3",{className:"section-title",children:["  (",Lt.length,")"]})]})}),t.jsx("div",{className:"section-content",children:Lt.map((p,y)=>t.jsxs("div",{className:"section-item bible-scene-result interactable",onClick:()=>ye(p.scene_index),style:{cursor:"pointer"},children:[t.jsxs("div",{className:"item-name",style:{fontSize:"0.85rem"},children:["Scene ",p.scene_index+1]}),t.jsx("div",{className:"item-description",style:{fontSize:"0.8rem"},children:ns(p.original_text,R,100)})]},y))})]}),R&&Lt.length===0&&et.length===0&&tt.length===0&&nt.length===0&&rt.length===0&&t.jsx("div",{style:{padding:"16px",textAlign:"center",color:"var(--muted-foreground)",fontSize:"0.875rem"},children:"  ."}),t.jsxs("div",{className:"sidebar-section",children:[t.jsxs("button",{className:`section-header ${f?"active":""}`,onClick:()=>m(!f),children:[t.jsxs("div",{className:"section-header-content",children:[t.jsx(Ft,{size:18}),t.jsxs("h3",{className:"section-title",children:[" ",R&&`(${et.length})`]})]}),f?t.jsx(ce,{size:18}):t.jsx(se,{size:18})]}),f&&t.jsx("div",{className:"section-content",children:Gt?t.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:" ..."}):et.length===0&&R?t.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):et.map((p,y)=>t.jsxs("div",{className:"section-item interactable",onClick:()=>dt(p),style:{cursor:"pointer"},children:[t.jsx("div",{className:"item-name",children:p.name}),t.jsx("div",{className:"item-description",children:p.traits&&p.traits.length>0?t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",marginTop:"4px"},children:p.traits.slice(0,3).map((S,N)=>t.jsx("span",{className:"trait-tag",children:S},N))}):typeof p.description=="string"&&p.description?p.description.slice(0,30)+"...":`: ${p.appearance_count}`})]},y))})]}),t.jsxs("div",{className:"sidebar-section",children:[t.jsxs("button",{className:`section-header ${u?"active":""}`,onClick:()=>b(!u),children:[t.jsxs("div",{className:"section-header-content",children:[t.jsx(Ht,{size:18}),t.jsxs("h3",{className:"section-title",children:[" ",R&&`(${tt.length})`]})]}),u?t.jsx(ce,{size:18}):t.jsx(se,{size:18})]}),u&&t.jsx("div",{className:"section-content",children:tt.length===0&&R?t.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):tt.map((p,y)=>t.jsxs("div",{className:"section-item interactable",onClick:()=>pt(p),style:{cursor:"pointer",display:"flex",alignItems:"flex-start",gap:"8px"},children:[t.jsx("span",{style:{minWidth:"22px",height:"22px",borderRadius:"50%",backgroundColor:"var(--primary, #4F46E5)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.7rem",fontWeight:"bold",flexShrink:0,marginTop:"2px"},children:y+1}),t.jsxs("div",{style:{flex:1},children:[t.jsx("div",{className:"item-name",children:p.name}),t.jsx("div",{className:"item-description",children:typeof p.significance=="string"&&p.significance?p.significance:typeof p.description=="string"&&p.description?p.description:` : ${p.first_appearance+1}`})]})]},y))})]}),t.jsxs("div",{className:"sidebar-section",children:[t.jsxs("button",{className:`section-header ${j?"active":""}`,onClick:()=>C(!j),children:[t.jsxs("div",{className:"section-header-content",children:[t.jsx(Gn,{size:18}),t.jsxs("h3",{className:"section-title",children:[" ",R&&`(${nt.length})`]})]}),j?t.jsx(ce,{size:18}):t.jsx(se,{size:18})]}),j&&t.jsx("div",{className:"section-content",children:nt.length===0&&R?t.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):nt.map((p,y)=>t.jsxs("div",{className:"section-item interactable",onClick:()=>ht(p),style:{cursor:"pointer"},children:[t.jsx("div",{className:"item-name",children:p.name}),t.jsx("div",{className:"item-description",children:typeof p.description=="string"&&p.description?p.description:`: ${p.scenes?.length||0}`})]},y))})]}),gt.length>0&&t.jsxs("div",{className:"sidebar-section",children:[t.jsxs("button",{className:`section-header ${D?"active":""}`,onClick:()=>U(!D),children:[t.jsxs("div",{className:"section-header-content",children:[t.jsx(Gs,{size:18}),t.jsxs("h3",{className:"section-title",children:["  ",R&&`(${en.length})`]})]}),D?t.jsx(ce,{size:18}):t.jsx(se,{size:18})]}),D&&t.jsx("div",{className:"section-content",children:en.length===0&&R?t.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):en.map((p,y)=>t.jsxs("div",{className:"section-item",children:[t.jsxs("div",{className:"item-name",style:{fontSize:"0.9rem"},children:[p.source,"  ",p.target]}),t.jsxs("div",{className:"item-description",children:[t.jsx("span",{className:"trait-tag",children:p.relation||""}),p.description&&t.jsx("span",{style:{marginLeft:"6px"},children:p.description.length>40?p.description.slice(0,40)+"...":p.description})]})]},y))})]}),t.jsxs("div",{className:"sidebar-section",children:[t.jsxs("button",{className:`section-header ${k?"active":""}`,onClick:()=>F(!k),children:[t.jsxs("div",{className:"section-header-content",children:[t.jsx(It,{size:18}),t.jsxs("h3",{className:"section-title",children:["  ",R&&`(${rt.length})`]})]}),k?t.jsx(ce,{size:18}):t.jsx(se,{size:18})]}),k&&t.jsx("div",{className:"section-content",children:rt.length===0&&R?t.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):rt.map((p,y)=>t.jsxs("div",{className:"section-item interactable",onClick:()=>At(p),style:{cursor:"pointer"},children:[t.jsx("div",{className:"item-name",style:{fontSize:"0.95rem"},children:p.summary&&p.summary.length>20?p.summary.substring(0,20)+"...":p.summary}),t.jsxs("div",{className:"item-description",children:[p.scene_index!==void 0?`${p.scene_index+1}`:"",p.importance&&`  : ${p.importance}`]})]},y))})]}),W&&Object.keys(W).filter(p=>!["characters","items","timeline","locations","key_events","scenes","relationships","chapter_id"].includes(p)).map(p=>{const y=W[p];if(!Array.isArray(y))return null;const S=Ur[p]??!1;return t.jsxs("div",{className:"sidebar-section",children:[t.jsxs("button",{className:`section-header ${S?"active":""}`,onClick:()=>Gr(N=>({...N,[p]:!N[p]})),children:[t.jsxs("div",{className:"section-header-content",children:[t.jsx(Ht,{size:18})," ",t.jsx("h3",{className:"section-title",children:p.toUpperCase()})]}),S?t.jsx(ce,{size:18}):t.jsx(se,{size:18})]}),S&&t.jsx("div",{className:"section-content",children:y.map((N,L)=>t.jsxs("div",{className:"section-item interactable",onClick:()=>Rt({title:p,item:N}),style:{cursor:"pointer"},children:[t.jsx("div",{className:"item-name",children:N.name||N.title||`Item ${L+1}`}),t.jsx("div",{className:"item-description",children:N.description||N.summary||(typeof N=="string"?N:JSON.stringify(N).slice(0,50))})]},L))})]},p)})]}),t.jsx("button",{className:"dictionary-toggle",onClick:()=>h(!d),children:d?t.jsx(fn,{size:20}):t.jsx(ln,{size:20})}),t.jsx("div",{className:"text-area",style:{overflow:"hidden",display:"flex",flexDirection:"column"},children:t.jsx("div",{className:"text-content",style:{flex:1,padding:0,height:"100%"},children:ot?t.jsx("div",{style:{padding:"20px",textAlign:"center"},children:" ..."}):X.length>0?t.jsx("div",{className:"scenes-container",style:{height:"100%",overflowY:"auto",padding:"20px",backgroundColor:o==="reader"?"var(--reader-bg)":"var(--background)"},children:X.map((p,y)=>t.jsxs("div",{id:`scene-block-${y}`,className:"scene-block",style:{position:"relative",marginBottom:"60px"},children:[t.jsxs("div",{style:{position:"absolute",top:"-12px",left:"10px",fontSize:"12px",fontWeight:"bold",color:"var(--primary)",backgroundColor:"var(--card)",padding:"2px 10px",borderRadius:"12px",border:"1px solid var(--border)",zIndex:5,boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},children:["Scene ",y+1]}),t.jsx("div",{className:"scene-content-wrapper",style:{maxWidth:o==="reader"?`${ee.contentWidth}%`:"100%",margin:o==="reader"?"0 auto":"0"},children:t.jsx(ir,{content:p.replace(/\n/g,"<br>"),onUpdate:S=>{const N=[...X];N[y]=S,ne(N),ke(!0)},onFocus:S=>ae(S),onCreated:S=>{y===0&&!re&&ae(S)},editable:o!=="reader",placeholder:` ${y+1}  ...`,className:"tiptap-editor-scene",style:o==="reader"?{fontSize:`${ee.fontSize}px`,lineHeight:ee.lineHeight,fontFamily:ee.fontFamily,color:"var(--text-primary)"}:void 0})})]},y))}):t.jsx("div",{style:{maxWidth:o==="reader"?`${ee.contentWidth}%`:"100%",margin:o==="reader"?"0 auto":"0",height:"100%"},children:t.jsx(ir,{content:te.replace(/\n/g,"<br>"),onUpdate:p=>{Fe(p),ke(!0)},onFocus:p=>ae(p),onCreated:p=>{re||ae(p)},editable:o!=="reader",placeholder:"  ...",className:"tiptap-editor-full",style:o==="reader"?{fontSize:`${ee.fontSize}px`,lineHeight:ee.lineHeight,fontFamily:ee.fontFamily,color:"var(--text-primary)"}:void 0})})})})]}),B&&t.jsx("div",{className:"modal-overlay",onClick:()=>dt(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs("div",{className:"modal-content",onClick:p=>p.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[t.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:B.name}),t.jsx("button",{onClick:()=>dt(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:t.jsx(Ft,{size:20})})]}),t.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[B.image?t.jsx("img",{src:B.image,alt:B.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):t.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),t.jsx("button",{onClick:()=>rn("character",B),disabled:K,style:{padding:"8px 16px",backgroundColor:K?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:K?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:K?" ...":B.image?" ":" "})]}),B.aliases&&B.aliases.length>0&&t.jsxs("div",{style:{marginBottom:"16px"},children:[t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:B.aliases.map((p,y)=>t.jsx("span",{style:{fontSize:"0.8rem",padding:"2px 8px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"12px",color:"var(--muted-foreground, #475569)",border:"1px solid var(--border)",opacity:.9},children:p},y))})]}),t.jsxs("div",{style:{marginBottom:"16px"},children:[t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),t.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:B.description||"  ."})]}),B.traits&&B.traits.length>0&&t.jsxs("div",{style:{marginBottom:"16px"},children:[t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:B.traits.map((p,y)=>t.jsx("span",{style:{fontSize:"0.8rem",padding:"4px 10px",backgroundColor:"var(--muted, rgba(79, 70, 229, 0.1))",color:"var(--primary, #4F46E5)",borderRadius:"6px",fontWeight:"500",border:"1px solid var(--border)"},children:p},y))})]}),t.jsxs("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[t.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"}),t.jsxs("button",{onClick:()=>ye(B.first_appearance,B.name),style:{background:"none",border:"none",color:"var(--primary, #4F46E5)",fontWeight:"bold",cursor:"pointer",textDecoration:"underline",padding:0,fontSize:"inherit"},children:[B.first_appearance+1,""]})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",B.appearance_count,"",B.appearances&&B.appearances.length>0&&t.jsxs("button",{onClick:()=>Mn(!Tt),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[Tt?t.jsx(ce,{size:12}):t.jsx(se,{size:12}),Tt?"":" "]})]}),Tt&&B.appearances&&t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:B.appearances.map(p=>t.jsxs("button",{onClick:()=>ye(p,B.name),style:{background:"var(--muted, #f1f5f9)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--muted-foreground, #475569)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",p+1]},p))})]})]})]})}),V&&t.jsx("div",{className:"modal-overlay",onClick:()=>pt(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs("div",{className:"modal-content",onClick:p=>p.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[t.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:V.name}),t.jsx("button",{onClick:()=>pt(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:t.jsx(Ht,{size:20})})]}),t.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[V.image?t.jsx("img",{src:V.image,alt:V.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):t.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),t.jsx("button",{onClick:()=>rn("item",V),disabled:K,style:{padding:"8px 16px",backgroundColor:K?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:K?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:K?" ...":V.image?" ":" "})]}),t.jsxs("div",{style:{marginBottom:"16px"},children:[t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),t.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:V.description||"  ."})]}),t.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"}),t.jsxs("button",{onClick:()=>ye(V.first_appearance,V.name),style:{background:"none",border:"none",color:"var(--primary, #4F46E5)",fontWeight:"bold",cursor:"pointer",textDecoration:"underline",padding:0,fontSize:"inherit"},children:[V.first_appearance+1,""]})]}),V.appearance_count>0&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginTop:"4px"},children:[t.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",V.appearance_count,"",V.appearances&&V.appearances.length>0&&t.jsxs("button",{onClick:()=>En(!Mt),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[Mt?t.jsx(ce,{size:12}):t.jsx(se,{size:12}),Mt?"":" "]})]}),Mt&&V.appearances&&t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:V.appearances.map(p=>t.jsxs("button",{onClick:()=>ye(p,V.name),style:{background:"var(--muted, #f1f5f9)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--muted-foreground, #475569)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",p+1]},p))})]})})]})}),J&&t.jsx("div",{className:"modal-overlay",onClick:()=>ht(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs("div",{className:"modal-content",onClick:p=>p.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[t.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:J.name}),t.jsx("button",{onClick:()=>ht(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:t.jsx(Gn,{size:20})})]}),t.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[J.image?t.jsx("img",{src:J.image,alt:J.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):t.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),t.jsx("button",{onClick:()=>rn("location",J),disabled:K,style:{padding:"8px 16px",backgroundColor:K?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:K?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:K?" ...":J.image?" ":" "})]}),t.jsxs("div",{style:{marginBottom:"16px"},children:[t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),t.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:J.description||"  ."})]}),t.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",J.appearance_count||(J.scenes?J.scenes.length:0),"",J.scenes&&J.scenes.length>0&&t.jsxs("button",{onClick:()=>Wn(!Et),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[Et?t.jsx(ce,{size:12}):t.jsx(se,{size:12}),Et?"":" "]})]}),Et&&J.scenes&&t.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:J.scenes.map(p=>t.jsxs("button",{onClick:()=>ye(p),style:{background:"var(--secondary)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--primary)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",p+1]},p))})]})})]})}),Ze&&t.jsx("div",{className:"modal-overlay",onClick:()=>At(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs("div",{className:"modal-content",onClick:p=>p.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[t.jsx("h2",{style:{fontSize:"1.25rem",fontWeight:"bold",margin:0,lineHeight:1.4},children:Ze.summary}),t.jsx("button",{onClick:()=>At(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:t.jsx(It,{size:20})})]}),t.jsx("div",{style:{marginBottom:"24px"},children:Ze.importance&&t.jsxs("div",{style:{display:"inline-block",padding:"4px 8px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"4px",fontSize:"0.875rem",fontWeight:"500",color:"var(--muted-foreground, #475569)",marginTop:"8px"},children:[": ",Ze.importance]})}),t.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"16px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:t.jsx("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start",width:"100%"},children:t.jsxs("button",{onClick:()=>ye(Ze.scene_index),style:{width:"100%",background:"var(--primary, #4F46E5)",border:"none",borderRadius:"6px",padding:"10px 16px",fontSize:"0.95rem",fontWeight:"600",color:"var(--primary-foreground, #ffffff)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",transition:"background 0.2s"},children:[t.jsxs("span",{children:["   (",Ze.scene_index+1,")"]}),t.jsx(ln,{size:16})]})})})]})}),De&&t.jsx("div",{className:"modal-overlay",onClick:()=>Rt(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs("div",{className:"modal-content",onClick:p=>p.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[t.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:De.item.name||De.item.title||"Detail"}),t.jsx("button",{onClick:()=>Rt(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:t.jsx(Ht,{size:20})})]}),t.jsxs("div",{style:{marginBottom:"16px"},children:[t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:De.title.toUpperCase()}),t.jsx("div",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0,maxHeight:"300px",overflowY:"auto"},children:De.item.description||De.item.summary||t.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"0.8rem",backgroundColor:"var(--muted, #f1f5f9)",color:"var(--modal-text)",padding:"8px",borderRadius:"4px",border:"1px solid var(--border)"},children:JSON.stringify(De.item,null,2)})})]})]})}),t.jsx(Xs,{}),Q&&t.jsx("div",{style:{position:"fixed",bottom:"20px",right:"25px",width:"600px",height:"750px",zIndex:1002,animation:"slideUp 0.3s ease"},children:t.jsx(zi,{onClose:()=>pe(!1)})}),t.jsx(Ti,{isOpen:Xt,onClose:()=>ut(!1),result:Fr,isLoading:Or,onNavigateToQuote:qr,onReanalyze:()=>_n(Rn),onApplySuggestion:Vr,analysisType:Rn}),t.jsx(Wi,{isOpen:He,onClose:()=>ge(!1),messages:at,onSendMessage:Xr,isLoading:ct,onClearChat:()=>{_e([]),r&&_i(r).catch(()=>{})}}),t.jsx(Ni,{onNavigateToScene:ye,onAnalyze:Kr,onPredictStory:Jr,onOpenCharacterChat:i,onOpenSettings:Dn,onOpenRelGraph:()=>Z(!0),novelId:r,chapterId:s,mode:o}),t.jsx(Ei,{isOpen:Y,onClose:()=>Z(!1),relationships:gt.map(p=>({source:p.source||p.character1,target:p.target||p.character2,relation:p.relation,description:p.description})),characters:W?.characters?.map(p=>({name:p.name,description:p.description,traits:p.traits,appearance_count:p.appearance_count}))||[]})]})}export{Ji as ChapterDetail};
