import{j as e}from"./tiptap-BONCSYqO.js";import{r as p,t as f}from"./toast-Dj7VaHEs.js";import{m as $,c as O,T as U,j as X,k as _,d as q}from"./index-ipNFXMzf.js";import{_ as N,$ as L,a0 as G,a1 as H,X as J,O as K}from"./icons-DnCnHeol.js";function Q({novelId:y,onSuccess:a}){const[h,l]=p.useState(!1),[g,m]=p.useState([]),[b,C]=p.useState(!1);return{isMergeMode:h,selectedSourceIds:g,isMerging:b,toggleMergeMode:()=>{l(r=>!r),h&&m([])},handleFileSelect:r=>{h&&m(x=>x.includes(r)?x.filter(j=>j!==r):[...x,r])},executeMerge:()=>{if(!y||g.length<2){f.error("합칠 파일을 2개 이상 선택해 주세요.");return}f(`${g.length}개의 파일을 병합하시겠습니까?`,{description:"병합 후 원본 파일들은 삭제됩니다.",action:{label:"병합",onClick:async()=>{C(!0);try{const r=g[0],x=g.slice(1),j=await $(y,r,x);f.success("파일이 성공적으로 병합되었습니다."),l(!1),m([]),a&&a(j.id)}catch(r){console.error("Merge failed:",r),f.error("파일 병합에 실패했습니다.")}finally{C(!1)}}},cancel:{label:"취소",onClick:()=>{}}})},cancelMerge:()=>{l(!1),m([])},setIsMergeMode:l,setSelectedSourceIds:m}}function ee({onFileClick:y,novelId:a,mode:h="writer"}){const[l,g]=p.useState([]),[m,b]=p.useState(!1),[C,k]=p.useState({}),v=p.useRef(null),i=p.useRef({}),{isMergeMode:n,selectedSourceIds:r,isMerging:x,toggleMergeMode:j,handleFileSelect:T,executeMerge:E,cancelMerge:R}=Q({novelId:a,onSuccess:()=>{S()}}),D=async t=>{if(a)try{const s=await q(a,t);k(o=>({...o,[t]:s})),(s.status==="completed"||s.status==="failed")&&i.current[t]!==void 0&&(clearTimeout(i.current[t]),delete i.current[t])}catch{}},F=t=>{i.current[t]&&clearTimeout(i.current[t]);let s=2e3;const o=async()=>{await D(t),i.current[t]!==void 0&&(s=Math.min(s*1.5,1e4),i.current[t]=setTimeout(o,s))};i.current[t]=setTimeout(o,0)};p.useEffect(()=>()=>{Object.values(i.current).forEach(clearTimeout),i.current={}},[]),p.useEffect(()=>{a&&S()},[a]);const S=async()=>{if(a)try{const t=await O(a);g(t),t.forEach(s=>{const o=s.storyboard_status?.toLowerCase();(o==="processing"||o==="pending")&&F(s.id)})}catch(t){console.error("Failed to load chapters:",t)}},w=t=>{t.preventDefault(),t.stopPropagation(),t.type==="dragenter"||t.type==="dragover"?b(!0):t.type==="dragleave"&&b(!1)},A=t=>{t.preventDefault(),t.stopPropagation(),b(!1),t.dataTransfer.files&&t.dataTransfer.files[0]&&z(t.dataTransfer.files)},P=t=>{t.target.files&&t.target.files[0]&&z(t.target.files),t.target.value=""},z=async t=>{if(!a){f.error("소설 정보가 없습니다. 다시 로그인해주세요.");return}const s=Array.from(t);let o=l.reduce((c,d)=>Math.max(c,d.chapter_number||0),0);for(const c of s)try{o++;const d=o,u=c.name,M=await _(a,c,d,u);F(M.id)}catch(d){f.error(`${c.name} 업로드 실패: ${d.message||"알 수 없는 오류"}`)}S()},B=t=>{a&&f("이 파일을 정말 삭제하시겠습니까?",{action:{label:"삭제",onClick:async()=>{try{await X(a,t),g(s=>s.filter(o=>o.id!==t))}catch{f.error("파일 삭제 실패")}}},cancel:{label:"취소",onClick:()=>{}}})},W=()=>{v.current?.click()};return e.jsxs("div",{className:"upload-container",onDragEnter:w,onDragLeave:w,onDragOver:w,onDrop:A,children:[m&&e.jsx("div",{className:"drag-overlay",children:e.jsxs("div",{className:"drag-overlay-content",children:[e.jsx(N,{size:64}),e.jsx("p",{children:"파일을 여기에 놓으세요"})]})}),e.jsx("input",{ref:v,id:"file-upload-input",type:"file",className:"upload-input",onChange:P,multiple:!0,accept:".txt,.pdf,.docx"}),!n&&e.jsx("button",{className:"floating-upload-btn",onClick:W,title:"파일 업로드",children:e.jsx(N,{size:24})}),e.jsx("div",{className:"upload-main",children:e.jsxs("div",{className:"upload-content",children:[e.jsx("div",{className:"upload-header",style:{textAlign:"center",justifyContent:"center"},children:e.jsxs("div",{children:[e.jsx("h1",{className:"upload-title",children:h==="reader"?"작품 라이브러리":"파일 업로드"}),e.jsx("p",{className:"upload-subtitle",children:"StoryProof"})]})}),l.length===0&&e.jsx("div",{className:"upload-area",children:e.jsxs("label",{htmlFor:"file-upload-input",className:"upload-label",style:{cursor:"pointer"},children:[e.jsx(N,{size:48,className:"upload-icon"}),e.jsx("p",{className:"upload-text-main",children:h==="reader"?"작품 파일을 추가하여 읽기 시작하기":"파일을 드래그하거나 클릭하여 업로드"}),e.jsx("p",{className:"upload-text-sub",children:"TXT, PDF, DOCX 파일 지원"})]})}),l.length>0&&e.jsxs("div",{className:"uploaded-files-section",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[e.jsx("h2",{className:"uploaded-files-title",style:{marginBottom:0},children:n?"병합할 파일 선택":"업로드된 파일"}),h==="writer"&&l.length>1&&e.jsx("div",{children:n?e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsx("button",{onClick:R,style:{padding:"8px 16px",borderRadius:"8px",border:"1px solid #e5e7eb",backgroundColor:"white",cursor:"pointer",color:"#6b7280",fontSize:"14px"},children:"취소"}),e.jsx("button",{onClick:E,disabled:r.length<2||x,style:{padding:"8px 16px",borderRadius:"8px",border:"none",backgroundColor:r.length<2?"#e5e7eb":"#4F46E5",cursor:r.length<2?"not-allowed":"pointer",color:r.length<2?"#9ca3af":"white",fontSize:"14px",fontWeight:600},children:x?"병합 중...":`${r.length}개 병합`})]}):e.jsxs("button",{onClick:j,className:"merge-toggle-btn",style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 16px",borderRadius:"8px",border:"1px solid #e5e7eb",backgroundColor:"white",cursor:"pointer",fontWeight:500,color:"#374151",fontSize:"14px"},children:[e.jsx(L,{size:16}),"파일 병합"]})})]}),e.jsx("div",{className:"uploaded-files-grid",children:l.map(t=>{const s=C[t.id],o=s?.status==="processing",c=s?.status==="completed",d=s?.status==="failed",u=r.includes(t.id);return e.jsxs("div",{className:`uploaded-file-card ${u?"selected":""}`,onClick:()=>{n?T(t.id):o||y(t)},style:{cursor:n?"pointer":o?"wait":"pointer",border:u?"2px solid #4F46E5":"1px solid #e5e7eb",position:"relative"},children:[n&&e.jsxs("div",{style:{position:"absolute",top:"12px",left:"12px",color:u?"#4F46E5":"#9ca3af",display:"flex",alignItems:"center",gap:"4px"},children:[u?e.jsx(G,{size:20}):e.jsx(H,{size:20}),u&&e.jsx("span",{style:{fontSize:"12px",fontWeight:"bold",backgroundColor:"#4F46E5",color:"white",width:"20px",height:"20px",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center"},children:r.indexOf(t.id)+1})]}),!n&&e.jsx("button",{className:"file-remove-btn",onClick:M=>{M.stopPropagation(),B(t.id)},disabled:o,children:e.jsx(J,{size:16})}),e.jsx(K,{size:40,className:"file-icon",style:{color:u?"#4F46E5":void 0}}),e.jsx("p",{className:"file-name",children:t.title}),n&&u&&r[0]===t.id&&e.jsx("span",{style:{fontSize:"10px",backgroundColor:"#EEF2FF",color:"#4F46E5",padding:"2px 6px",borderRadius:"4px",marginTop:"4px"},children:"대표(저장) 파일"}),!n&&s&&e.jsxs("div",{style:{marginTop:"8px",width:"100%"},children:[e.jsx("div",{style:{textAlign:"center",marginBottom:"8px"},children:e.jsx("span",{style:{display:"inline-block",fontSize:"11px",fontWeight:600,padding:"4px 8px",borderRadius:"4px",backgroundColor:d?"#ffe0e0":c?"#e0ffe0":"#e0e8ff",color:d?"#ff6b6b":c?"#51cf66":"#4c6ef5"},children:d?"❌ 실패":c?"✅ 완료":"⏳ 처리 중"})}),o&&e.jsx("div",{style:{textAlign:"center",marginBottom:"6px"},children:e.jsxs("span",{style:{fontSize:"13px",color:"#333",fontWeight:600},children:[s.progress,"%"]})}),s.message&&e.jsx("div",{style:{textAlign:"center",marginBottom:"6px"},children:e.jsx("span",{style:{fontSize:"11px",color:"#666",fontWeight:500},children:s.message})}),o&&e.jsx("div",{style:{width:"100%",height:"5px",backgroundColor:"#e0e0e0",borderRadius:"3px",overflow:"hidden",marginBottom:"4px"},children:e.jsx("div",{style:{height:"100%",width:`${s.progress}%`,backgroundColor:"#4c6ef5",transition:"width 0.3s ease",borderRadius:"3px",boxShadow:"0 0 10px rgba(76, 110, 245, 0.5)"}})}),c&&e.jsx("div",{style:{width:"100%",height:"5px",backgroundColor:"#51cf66",borderRadius:"3px",boxShadow:"0 0 10px rgba(81, 207, 102, 0.5)"}}),d&&e.jsxs("div",{children:[e.jsx("div",{style:{width:"100%",height:"5px",backgroundColor:"#ff6b6b",borderRadius:"3px",boxShadow:"0 0 10px rgba(255, 107, 107, 0.5)",marginBottom:"4px"}}),s.error&&e.jsx("div",{style:{textAlign:"center",marginTop:"4px"},children:e.jsx("span",{style:{fontSize:"10px",color:"#ff6b6b",fontWeight:500},children:s.error})})]})]})]},t.id)})})]})]})}),e.jsx(U,{})]})}export{ee as FileUpload};
