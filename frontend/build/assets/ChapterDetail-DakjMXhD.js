import{M as qn,m as ke,E as le,a as Ks,b as Vs,N as Xe,n as Ys,R as Xs,P as Qn,c as on,S as ue,d as Js,T as xe,F as ie,e as ge,D as Yt,f as Xt,k as qs,g as Qs,h as Zs,i as er,l as tr,o as nr,u as sr,U as rr,p as or,q as ir,H as lr,r as ar,s as cr,j as n,t as dr}from"./tiptap-BONCSYqO.js";import{r as x,R as Ft,t as I}from"./toast-Dj7VaHEs.js";import{c as Zn,T as ur,d as pr,P as hr,e as xt,f as fr,g as zn,h as mr,i as xr,H as gr,j as br,k as Jt,l as es,m as re,n as ne,o as qt,N as ts,p as yr,q as vr,r as Qt,s as jr,X as Ie,t as Cr,R as wr,u as Sr,v as An,w as kr,x as Nr,y as zr,U as Ar,z as Rn,A as Rr,D as Tn,F as Ut,G as gt,I as Tr,J as Mn,K as Gt,O as Kt,Q as En,V as bt,W as Ln,Y as Mr}from"./icons-Clq0l1QS.js";import{r as be,u as ns,g as Er,a as Lr,b as Hr,T as Ir,c as Wr,d as _r,e as $r,f as Dr,h as Pr,A as Hn}from"./index-Bli6Tylb.js";var Br=20,ss=(e,t=0)=>{const s=[];return!e.children.length||t>Br||Array.from(e.children).forEach(r=>{r.tagName==="SPAN"?s.push(r):r.children.length&&s.push(...ss(r,t+1))}),s},Or=e=>{if(!e.children.length)return;const t=ss(e);t&&t.forEach(s=>{var r,o;const i=s.getAttribute("style"),l=(o=(r=s.parentElement)==null?void 0:r.closest("span"))==null?void 0:o.getAttribute("style");s.setAttribute("style",`${l};${i}`)})},rs=qn.create({name:"textStyle",priority:101,addOptions(){return{HTMLAttributes:{},mergeNestedSpanStyles:!0}},parseHTML(){return[{tag:"span",consuming:!1,getAttrs:e=>e.hasAttribute("style")?(this.options.mergeNestedSpanStyles&&Or(e),{}):!1}]},renderHTML({HTMLAttributes:e}){return["span",ke(this.options.HTMLAttributes,e),0]},addCommands(){return{toggleTextStyle:e=>({commands:t})=>t.toggleMark(this.name,e),removeEmptyTextStyle:()=>({tr:e})=>{const{selection:t}=e;return e.doc.nodesBetween(t.from,t.to,(s,r)=>{if(s.isTextblock)return!0;s.marks.filter(o=>o.type===this.type).some(o=>Object.values(o.attrs).some(i=>!!i))||e.removeMark(r,r+s.nodeSize,this.type)}),!0}}}}),Fr=le.create({name:"backgroundColor",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{backgroundColor:{default:null,parseHTML:e=>{var t;const s=e.getAttribute("style");if(s){const r=s.split(";").map(o=>o.trim()).filter(Boolean);for(let o=r.length-1;o>=0;o-=1){const i=r[o].split(":");if(i.length>=2){const l=i[0].trim().toLowerCase(),c=i.slice(1).join(":").trim();if(l==="background-color")return c.replace(/['"]+/g,"")}}}return(t=e.style.backgroundColor)==null?void 0:t.replace(/['"]+/g,"")},renderHTML:e=>e.backgroundColor?{style:`background-color: ${e.backgroundColor}`}:{}}}}]},addCommands(){return{setBackgroundColor:e=>({chain:t})=>t().setMark("textStyle",{backgroundColor:e}).run(),unsetBackgroundColor:()=>({chain:e})=>e().setMark("textStyle",{backgroundColor:null}).removeEmptyTextStyle().run()}}}),os=le.create({name:"color",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{color:{default:null,parseHTML:e=>{var t;const s=e.getAttribute("style");if(s){const r=s.split(";").map(o=>o.trim()).filter(Boolean);for(let o=r.length-1;o>=0;o-=1){const i=r[o].split(":");if(i.length>=2){const l=i[0].trim().toLowerCase(),c=i.slice(1).join(":").trim();if(l==="color")return c.replace(/['"]+/g,"")}}}return(t=e.style.color)==null?void 0:t.replace(/['"]+/g,"")},renderHTML:e=>e.color?{style:`color: ${e.color}`}:{}}}}]},addCommands(){return{setColor:e=>({chain:t})=>t().setMark("textStyle",{color:e}).run(),unsetColor:()=>({chain:e})=>e().setMark("textStyle",{color:null}).removeEmptyTextStyle().run()}}}),is=le.create({name:"fontFamily",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontFamily:{default:null,parseHTML:e=>e.style.fontFamily,renderHTML:e=>e.fontFamily?{style:`font-family: ${e.fontFamily}`}:{}}}}]},addCommands(){return{setFontFamily:e=>({chain:t})=>t().setMark("textStyle",{fontFamily:e}).run(),unsetFontFamily:()=>({chain:e})=>e().setMark("textStyle",{fontFamily:null}).removeEmptyTextStyle().run()}}}),Ur=le.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:e=>e.style.fontSize,renderHTML:e=>e.fontSize?{style:`font-size: ${e.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:e=>({chain:t})=>t().setMark("textStyle",{fontSize:e}).run(),unsetFontSize:()=>({chain:e})=>e().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),Gr=le.create({name:"lineHeight",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:null,parseHTML:e=>e.style.lineHeight,renderHTML:e=>e.lineHeight?{style:`line-height: ${e.lineHeight}`}:{}}}}]},addCommands(){return{setLineHeight:e=>({chain:t})=>t().setMark("textStyle",{lineHeight:e}).run(),unsetLineHeight:()=>({chain:e})=>e().setMark("textStyle",{lineHeight:null}).removeEmptyTextStyle().run()}}});le.create({name:"textStyleKit",addExtensions(){const e=[];return this.options.backgroundColor!==!1&&e.push(Fr.configure(this.options.backgroundColor)),this.options.color!==!1&&e.push(os.configure(this.options.color)),this.options.fontFamily!==!1&&e.push(is.configure(this.options.fontFamily)),this.options.fontSize!==!1&&e.push(Ur.configure(this.options.fontSize)),this.options.lineHeight!==!1&&e.push(Gr.configure(this.options.lineHeight)),this.options.textStyle!==!1&&e.push(rs.configure(this.options.textStyle)),e}});var Kr=le.create({name:"textAlign",addOptions(){return{types:[],alignments:["left","center","right","justify"],defaultAlignment:null}},addGlobalAttributes(){return[{types:this.options.types,attributes:{textAlign:{default:this.options.defaultAlignment,parseHTML:e=>{const t=e.style.textAlign;return this.options.alignments.includes(t)?t:this.options.defaultAlignment},renderHTML:e=>e.textAlign?{style:`text-align: ${e.textAlign}`}:{}}}}]},addCommands(){return{setTextAlign:e=>({commands:t})=>this.options.alignments.includes(e)?this.options.types.map(s=>t.updateAttributes(s,{textAlign:e})).some(s=>s):!1,unsetTextAlign:()=>({commands:e})=>this.options.types.map(t=>e.resetAttributes(t,"textAlign")).some(t=>t),toggleTextAlign:e=>({editor:t,commands:s})=>this.options.alignments.includes(e)?t.isActive({textAlign:e})?s.unsetTextAlign():s.setTextAlign(e):!1}},addKeyboardShortcuts(){return{"Mod-Shift-l":()=>this.editor.commands.setTextAlign("left"),"Mod-Shift-e":()=>this.editor.commands.setTextAlign("center"),"Mod-Shift-r":()=>this.editor.commands.setTextAlign("right"),"Mod-Shift-j":()=>this.editor.commands.setTextAlign("justify")}}}),Vr=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))$/,Yr=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))/g,Xr=qn.create({name:"highlight",addOptions(){return{multicolor:!1,HTMLAttributes:{}}},addAttributes(){return this.options.multicolor?{color:{default:null,parseHTML:e=>e.getAttribute("data-color")||e.style.backgroundColor,renderHTML:e=>e.color?{"data-color":e.color,style:`background-color: ${e.color}; color: inherit`}:{}}}:{}},parseHTML(){return[{tag:"mark"}]},renderHTML({HTMLAttributes:e}){return["mark",ke(this.options.HTMLAttributes,e),0]},renderMarkdown:(e,t)=>`==${t.renderChildren(e)}==`,parseMarkdown:(e,t)=>t.applyMark("highlight",t.parseInline(e.tokens||[])),markdownTokenizer:{name:"highlight",level:"inline",start:e=>e.indexOf("=="),tokenize(e,t,s){const o=/^(==)([^=]+)(==)/.exec(e);if(o){const i=o[2].trim(),l=s.inlineTokens(i);return{type:"highlight",raw:o[0],text:i,tokens:l}}}},addCommands(){return{setHighlight:e=>({commands:t})=>t.setMark(this.name,e),toggleHighlight:e=>({commands:t})=>t.toggleMark(this.name,e),unsetHighlight:()=>({commands:e})=>e.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-h":()=>this.editor.commands.toggleHighlight()}},addInputRules(){return[Vs({find:Vr,type:this.type})]},addPasteRules(){return[Ks({find:Yr,type:this.type})]}}),Jr=/(?:^|\s)(!\[(.+|:?)]\((\S+)(?:(?:\s+)["'](\S+)["'])?\))$/,qr=Xe.create({name:"image",addOptions(){return{inline:!1,allowBase64:!1,HTMLAttributes:{},resize:!1}},inline(){return this.options.inline},group(){return this.options.inline?"inline":"block"},draggable:!0,addAttributes(){return{src:{default:null},alt:{default:null},title:{default:null},width:{default:null},height:{default:null}}},parseHTML(){return[{tag:this.options.allowBase64?"img[src]":'img[src]:not([src^="data:"])'}]},renderHTML({HTMLAttributes:e}){return["img",ke(this.options.HTMLAttributes,e)]},parseMarkdown:(e,t)=>t.createNode("image",{src:e.href,title:e.title,alt:e.text}),renderMarkdown:e=>{var t,s,r,o,i,l;const c=(s=(t=e.attrs)==null?void 0:t.src)!=null?s:"",a=(o=(r=e.attrs)==null?void 0:r.alt)!=null?o:"",d=(l=(i=e.attrs)==null?void 0:i.title)!=null?l:"";return d?`![${a}](${c} "${d}")`:`![${a}](${c})`},addNodeView(){if(!this.options.resize||!this.options.resize.enabled||typeof document>"u")return null;const{directions:e,minWidth:t,minHeight:s,alwaysPreserveAspectRatio:r}=this.options.resize;return({node:o,getPos:i,HTMLAttributes:l,editor:c})=>{const a=document.createElement("img");Object.entries(l).forEach(([f,m])=>{if(m!=null)switch(f){case"width":case"height":break;default:a.setAttribute(f,m);break}}),a.src=l.src;const d=new Xs({element:a,editor:c,node:o,getPos:i,onResize:(f,m)=>{a.style.width=`${f}px`,a.style.height=`${m}px`},onCommit:(f,m)=>{const h=i();h!==void 0&&this.editor.chain().setNodeSelection(h).updateAttributes(this.name,{width:f,height:m}).run()},onUpdate:(f,m,h)=>f.type===o.type,options:{directions:e,min:{width:t,height:s},preserveAspectRatio:r===!0}}),p=d.dom;return p.style.visibility="hidden",p.style.pointerEvents="none",a.onload=()=>{p.style.visibility="",p.style.pointerEvents=""},d}},addCommands(){return{setImage:e=>({commands:t})=>t.insertContent({type:this.name,attrs:e})}},addInputRules(){return[Ys({find:Jr,type:this.type,getAttributes:e=>{const[,,t,s,r]=e;return{src:s,alt:t,title:r}}})]}});let Zt,en;if(typeof WeakMap<"u"){let e=new WeakMap;Zt=t=>e.get(t),en=(t,s)=>(e.set(t,s),s)}else{const e=[];let s=0;Zt=r=>{for(let o=0;o<e.length;o+=2)if(e[o]==r)return e[o+1]},en=(r,o)=>(s==10&&(s=0),e[s++]=r,e[s++]=o)}var O=class{constructor(e,t,s,r){this.width=e,this.height=t,this.map=s,this.problems=r}findCell(e){for(let t=0;t<this.map.length;t++){const s=this.map[t];if(s!=e)continue;const r=t%this.width,o=t/this.width|0;let i=r+1,l=o+1;for(let c=1;i<this.width&&this.map[t+c]==s;c++)i++;for(let c=1;l<this.height&&this.map[t+this.width*c]==s;c++)l++;return{left:r,top:o,right:i,bottom:l}}throw new RangeError(`No cell with offset ${e} found`)}colCount(e){for(let t=0;t<this.map.length;t++)if(this.map[t]==e)return t%this.width;throw new RangeError(`No cell with offset ${e} found`)}nextCell(e,t,s){const{left:r,right:o,top:i,bottom:l}=this.findCell(e);return t=="horiz"?(s<0?r==0:o==this.width)?null:this.map[i*this.width+(s<0?r-1:o)]:(s<0?i==0:l==this.height)?null:this.map[r+this.width*(s<0?i-1:l)]}rectBetween(e,t){const{left:s,right:r,top:o,bottom:i}=this.findCell(e),{left:l,right:c,top:a,bottom:d}=this.findCell(t);return{left:Math.min(s,l),top:Math.min(o,a),right:Math.max(r,c),bottom:Math.max(i,d)}}cellsInRect(e){const t=[],s={};for(let r=e.top;r<e.bottom;r++)for(let o=e.left;o<e.right;o++){const i=r*this.width+o,l=this.map[i];s[l]||(s[l]=!0,!(o==e.left&&o&&this.map[i-1]==l||r==e.top&&r&&this.map[i-this.width]==l)&&t.push(l))}return t}positionAt(e,t,s){for(let r=0,o=0;;r++){const i=o+s.child(r).nodeSize;if(r==e){let l=t+e*this.width;const c=(e+1)*this.width;for(;l<c&&this.map[l]<o;)l++;return l==c?i-1:this.map[l]}o=i}}static get(e){return Zt(e)||en(e,Qr(e))}};function Qr(e){if(e.type.spec.tableRole!="table")throw new RangeError("Not a table node: "+e.type.name);const t=Zr(e),s=e.childCount,r=[];let o=0,i=null;const l=[];for(let d=0,p=t*s;d<p;d++)r[d]=0;for(let d=0,p=0;d<s;d++){const f=e.child(d);p++;for(let g=0;;g++){for(;o<r.length&&r[o]!=0;)o++;if(g==f.childCount)break;const v=f.child(g),{colspan:j,rowspan:k,colwidth:F}=v.attrs;for(let L=0;L<k;L++){if(L+d>=s){(i||(i=[])).push({type:"overlong_rowspan",pos:p,n:k-L});break}const G=o+L*t;for(let K=0;K<j;K++){r[G+K]==0?r[G+K]=p:(i||(i=[])).push({type:"collision",row:d,pos:p,n:j-K});const w=F&&F[K];if(w){const y=(G+K)%t*2,H=l[y];H==null||H!=w&&l[y+1]==1?(l[y]=w,l[y+1]=1):H==w&&l[y+1]++}}}o+=j,p+=v.nodeSize}const m=(d+1)*t;let h=0;for(;o<m;)r[o++]==0&&h++;h&&(i||(i=[])).push({type:"missing",row:d,n:h}),p++}(t===0||s===0)&&(i||(i=[])).push({type:"zero_sized"});const c=new O(t,s,r,i);let a=!1;for(let d=0;!a&&d<l.length;d+=2)l[d]!=null&&l[d+1]<s&&(a=!0);return a&&eo(c,l,e),c}function Zr(e){let t=-1,s=!1;for(let r=0;r<e.childCount;r++){const o=e.child(r);let i=0;if(s)for(let l=0;l<r;l++){const c=e.child(l);for(let a=0;a<c.childCount;a++){const d=c.child(a);l+d.attrs.rowspan>r&&(i+=d.attrs.colspan)}}for(let l=0;l<o.childCount;l++){const c=o.child(l);i+=c.attrs.colspan,c.attrs.rowspan>1&&(s=!0)}t==-1?t=i:t!=i&&(t=Math.max(t,i))}return t}function eo(e,t,s){e.problems||(e.problems=[]);const r={};for(let o=0;o<e.map.length;o++){const i=e.map[o];if(r[i])continue;r[i]=!0;const l=s.nodeAt(i);if(!l)throw new RangeError(`No cell with offset ${i} found`);let c=null;const a=l.attrs;for(let d=0;d<a.colspan;d++){const p=t[(o+d)%e.width*2];p!=null&&(!a.colwidth||a.colwidth[d]!=p)&&((c||(c=to(a)))[d]=p)}c&&e.problems.unshift({type:"colwidth mismatch",pos:i,colwidth:c})}}function to(e){if(e.colwidth)return e.colwidth.slice();const t=[];for(let s=0;s<e.colspan;s++)t.push(0);return t}function J(e){let t=e.cached.tableNodeTypes;if(!t){t=e.cached.tableNodeTypes={};for(const s in e.nodes){const r=e.nodes[s],o=r.spec.tableRole;o&&(t[o]=r)}}return t}const me=new on("selectingCells");function we(e){for(let t=e.depth-1;t>0;t--)if(e.node(t).type.spec.tableRole=="row")return e.node(0).resolve(e.before(t+1));return null}function no(e){for(let t=e.depth;t>0;t--){const s=e.node(t).type.spec.tableRole;if(s==="cell"||s==="header_cell")return e.node(t)}return null}function oe(e){const t=e.selection.$head;for(let s=t.depth;s>0;s--)if(t.node(s).type.spec.tableRole=="row")return!0;return!1}function kt(e){const t=e.selection;if("$anchorCell"in t&&t.$anchorCell)return t.$anchorCell.pos>t.$headCell.pos?t.$anchorCell:t.$headCell;if("node"in t&&t.node&&t.node.type.spec.tableRole=="cell")return t.$anchor;const s=we(t.$head)||so(t.$head);if(s)return s;throw new RangeError(`No cell found around position ${t.head}`)}function so(e){for(let t=e.nodeAfter,s=e.pos;t;t=t.firstChild,s++){const r=t.type.spec.tableRole;if(r=="cell"||r=="header_cell")return e.doc.resolve(s)}for(let t=e.nodeBefore,s=e.pos;t;t=t.lastChild,s--){const r=t.type.spec.tableRole;if(r=="cell"||r=="header_cell")return e.doc.resolve(s-t.nodeSize)}}function tn(e){return e.parent.type.spec.tableRole=="row"&&!!e.nodeAfter}function ro(e){return e.node(0).resolve(e.pos+e.nodeAfter.nodeSize)}function ln(e,t){return e.depth==t.depth&&e.pos>=t.start(-1)&&e.pos<=t.end(-1)}function ls(e,t,s){const r=e.node(-1),o=O.get(r),i=e.start(-1),l=o.nextCell(e.pos-i,t,s);return l==null?null:e.node(0).resolve(i+l)}function Se(e,t,s=1){const r={...e,colspan:e.colspan-s};return r.colwidth&&(r.colwidth=r.colwidth.slice(),r.colwidth.splice(t,s),r.colwidth.some(o=>o>0)||(r.colwidth=null)),r}function as(e,t,s=1){const r={...e,colspan:e.colspan+s};if(r.colwidth){r.colwidth=r.colwidth.slice();for(let o=0;o<s;o++)r.colwidth.splice(t,0,0)}return r}function oo(e,t,s){const r=J(t.type.schema).header_cell;for(let o=0;o<e.height;o++)if(t.nodeAt(e.map[s+o*e.width]).type!=r)return!1;return!0}var $=class de extends ue{constructor(t,s=t){const r=t.node(-1),o=O.get(r),i=t.start(-1),l=o.rectBetween(t.pos-i,s.pos-i),c=t.node(0),a=o.cellsInRect(l).filter(p=>p!=s.pos-i);a.unshift(s.pos-i);const d=a.map(p=>{const f=r.nodeAt(p);if(!f)throw new RangeError(`No cell with offset ${p} found`);const m=i+p+1;return new Js(c.resolve(m),c.resolve(m+f.content.size))});super(d[0].$from,d[0].$to,d),this.$anchorCell=t,this.$headCell=s}map(t,s){const r=t.resolve(s.map(this.$anchorCell.pos)),o=t.resolve(s.map(this.$headCell.pos));if(tn(r)&&tn(o)&&ln(r,o)){const i=this.$anchorCell.node(-1)!=r.node(-1);return i&&this.isRowSelection()?de.rowSelection(r,o):i&&this.isColSelection()?de.colSelection(r,o):new de(r,o)}return xe.between(r,o)}content(){const t=this.$anchorCell.node(-1),s=O.get(t),r=this.$anchorCell.start(-1),o=s.rectBetween(this.$anchorCell.pos-r,this.$headCell.pos-r),i={},l=[];for(let a=o.top;a<o.bottom;a++){const d=[];for(let p=a*s.width+o.left,f=o.left;f<o.right;f++,p++){const m=s.map[p];if(i[m])continue;i[m]=!0;const h=s.findCell(m);let g=t.nodeAt(m);if(!g)throw new RangeError(`No cell with offset ${m} found`);const v=o.left-h.left,j=h.right-o.right;if(v>0||j>0){let k=g.attrs;if(v>0&&(k=Se(k,0,v)),j>0&&(k=Se(k,k.colspan-j,j)),h.left<o.left){if(g=g.type.createAndFill(k),!g)throw new RangeError(`Could not create cell with attrs ${JSON.stringify(k)}`)}else g=g.type.create(k,g.content)}if(h.top<o.top||h.bottom>o.bottom){const k={...g.attrs,rowspan:Math.min(h.bottom,o.bottom)-Math.max(h.top,o.top)};h.top<o.top?g=g.type.createAndFill(k):g=g.type.create(k,g.content)}d.push(g)}l.push(t.child(a).copy(ie.from(d)))}const c=this.isColSelection()&&this.isRowSelection()?t:l;return new ge(ie.from(c),1,1)}replace(t,s=ge.empty){const r=t.steps.length,o=this.ranges;for(let l=0;l<o.length;l++){const{$from:c,$to:a}=o[l],d=t.mapping.slice(r);t.replace(d.map(c.pos),d.map(a.pos),l?ge.empty:s)}const i=ue.findFrom(t.doc.resolve(t.mapping.slice(r).map(this.to)),-1);i&&t.setSelection(i)}replaceWith(t,s){this.replace(t,new ge(ie.from(s),0,0))}forEachCell(t){const s=this.$anchorCell.node(-1),r=O.get(s),o=this.$anchorCell.start(-1),i=r.cellsInRect(r.rectBetween(this.$anchorCell.pos-o,this.$headCell.pos-o));for(let l=0;l<i.length;l++)t(s.nodeAt(i[l]),o+i[l])}isColSelection(){const t=this.$anchorCell.index(-1),s=this.$headCell.index(-1);if(Math.min(t,s)>0)return!1;const r=t+this.$anchorCell.nodeAfter.attrs.rowspan,o=s+this.$headCell.nodeAfter.attrs.rowspan;return Math.max(r,o)==this.$headCell.node(-1).childCount}static colSelection(t,s=t){const r=t.node(-1),o=O.get(r),i=t.start(-1),l=o.findCell(t.pos-i),c=o.findCell(s.pos-i),a=t.node(0);return l.top<=c.top?(l.top>0&&(t=a.resolve(i+o.map[l.left])),c.bottom<o.height&&(s=a.resolve(i+o.map[o.width*(o.height-1)+c.right-1]))):(c.top>0&&(s=a.resolve(i+o.map[c.left])),l.bottom<o.height&&(t=a.resolve(i+o.map[o.width*(o.height-1)+l.right-1]))),new de(t,s)}isRowSelection(){const t=this.$anchorCell.node(-1),s=O.get(t),r=this.$anchorCell.start(-1),o=s.colCount(this.$anchorCell.pos-r),i=s.colCount(this.$headCell.pos-r);if(Math.min(o,i)>0)return!1;const l=o+this.$anchorCell.nodeAfter.attrs.colspan,c=i+this.$headCell.nodeAfter.attrs.colspan;return Math.max(l,c)==s.width}eq(t){return t instanceof de&&t.$anchorCell.pos==this.$anchorCell.pos&&t.$headCell.pos==this.$headCell.pos}static rowSelection(t,s=t){const r=t.node(-1),o=O.get(r),i=t.start(-1),l=o.findCell(t.pos-i),c=o.findCell(s.pos-i),a=t.node(0);return l.left<=c.left?(l.left>0&&(t=a.resolve(i+o.map[l.top*o.width])),c.right<o.width&&(s=a.resolve(i+o.map[o.width*(c.top+1)-1]))):(c.left>0&&(s=a.resolve(i+o.map[c.top*o.width])),l.right<o.width&&(t=a.resolve(i+o.map[o.width*(l.top+1)-1]))),new de(t,s)}toJSON(){return{type:"cell",anchor:this.$anchorCell.pos,head:this.$headCell.pos}}static fromJSON(t,s){return new de(t.resolve(s.anchor),t.resolve(s.head))}static create(t,s,r=s){return new de(t.resolve(s),t.resolve(r))}getBookmark(){return new io(this.$anchorCell.pos,this.$headCell.pos)}};$.prototype.visible=!1;ue.jsonID("cell",$);var io=class cs{constructor(t,s){this.anchor=t,this.head=s}map(t){return new cs(t.map(this.anchor),t.map(this.head))}resolve(t){const s=t.resolve(this.anchor),r=t.resolve(this.head);return s.parent.type.spec.tableRole=="row"&&r.parent.type.spec.tableRole=="row"&&s.index()<s.parent.childCount&&r.index()<r.parent.childCount&&ln(s,r)?new $(s,r):ue.near(r,1)}};function lo(e){if(!(e.selection instanceof $))return null;const t=[];return e.selection.forEachCell((s,r)=>{t.push(Xt.node(r,r+s.nodeSize,{class:"selectedCell"}))}),Yt.create(e.doc,t)}function ao({$from:e,$to:t}){if(e.pos==t.pos||e.pos<t.pos-6)return!1;let s=e.pos,r=t.pos,o=e.depth;for(;o>=0&&!(e.after(o+1)<e.end(o));o--,s++);for(let i=t.depth;i>=0&&!(t.before(i+1)>t.start(i));i--,r--);return s==r&&/row|table/.test(e.node(o).type.spec.tableRole)}function co({$from:e,$to:t}){let s,r;for(let o=e.depth;o>0;o--){const i=e.node(o);if(i.type.spec.tableRole==="cell"||i.type.spec.tableRole==="header_cell"){s=i;break}}for(let o=t.depth;o>0;o--){const i=t.node(o);if(i.type.spec.tableRole==="cell"||i.type.spec.tableRole==="header_cell"){r=i;break}}return s!==r&&t.parentOffset===0}function uo(e,t,s){const r=(t||e).selection,o=(t||e).doc;let i,l;if(r instanceof Qs&&(l=r.node.type.spec.tableRole)){if(l=="cell"||l=="header_cell")i=$.create(o,r.from);else if(l=="row"){const c=o.resolve(r.from+1);i=$.rowSelection(c,c)}else if(!s){const c=O.get(r.node),a=r.from+1,d=a+c.map[c.width*c.height-1];i=$.create(o,a+1,d)}}else r instanceof xe&&ao(r)?i=xe.create(o,r.from):r instanceof xe&&co(r)&&(i=xe.create(o,r.$from.start(),r.$from.end()));return i&&(t||(t=e.tr)).setSelection(i),t}const po=new on("fix-tables");function ds(e,t,s,r){const o=e.childCount,i=t.childCount;e:for(let l=0,c=0;l<i;l++){const a=t.child(l);for(let d=c,p=Math.min(o,l+3);d<p;d++)if(e.child(d)==a){c=d+1,s+=a.nodeSize;continue e}r(a,s),c<o&&e.child(c).sameMarkup(a)?ds(e.child(c),a,s+1,r):a.nodesBetween(0,a.content.size,r,s+1),s+=a.nodeSize}}function us(e,t){let s;const r=(o,i)=>{o.type.spec.tableRole=="table"&&(s=ho(e,o,i,s))};return t?t.doc!=e.doc&&ds(t.doc,e.doc,0,r):e.doc.descendants(r),s}function ho(e,t,s,r){const o=O.get(t);if(!o.problems)return r;r||(r=e.tr);const i=[];for(let a=0;a<o.height;a++)i.push(0);for(let a=0;a<o.problems.length;a++){const d=o.problems[a];if(d.type=="collision"){const p=t.nodeAt(d.pos);if(!p)continue;const f=p.attrs;for(let m=0;m<f.rowspan;m++)i[d.row+m]+=d.n;r.setNodeMarkup(r.mapping.map(s+1+d.pos),null,Se(f,f.colspan-d.n,d.n))}else if(d.type=="missing")i[d.row]+=d.n;else if(d.type=="overlong_rowspan"){const p=t.nodeAt(d.pos);if(!p)continue;r.setNodeMarkup(r.mapping.map(s+1+d.pos),null,{...p.attrs,rowspan:p.attrs.rowspan-d.n})}else if(d.type=="colwidth mismatch"){const p=t.nodeAt(d.pos);if(!p)continue;r.setNodeMarkup(r.mapping.map(s+1+d.pos),null,{...p.attrs,colwidth:d.colwidth})}else if(d.type=="zero_sized"){const p=r.mapping.map(s);r.delete(p,p+t.nodeSize)}}let l,c;for(let a=0;a<i.length;a++)i[a]&&(l==null&&(l=a),c=a);for(let a=0,d=s+1;a<o.height;a++){const p=t.child(a),f=d+p.nodeSize,m=i[a];if(m>0){let h="cell";p.firstChild&&(h=p.firstChild.type.spec.tableRole);const g=[];for(let j=0;j<m;j++){const k=J(e.schema)[h].createAndFill();k&&g.push(k)}const v=(a==0||l==a-1)&&c==a?d+1:f-1;r.insert(r.mapping.map(v),g)}d=f}return r.setMeta(po,{fixTables:!0})}function ae(e){const t=e.selection,s=kt(e),r=s.node(-1),o=s.start(-1),i=O.get(r);return{...t instanceof $?i.rectBetween(t.$anchorCell.pos-o,t.$headCell.pos-o):i.findCell(s.pos-o),tableStart:o,map:i,table:r}}function ps(e,{map:t,tableStart:s,table:r},o){let i=o>0?-1:0;oo(t,r,o+i)&&(i=o==0||o==t.width?null:0);for(let l=0;l<t.height;l++){const c=l*t.width+o;if(o>0&&o<t.width&&t.map[c-1]==t.map[c]){const a=t.map[c],d=r.nodeAt(a);e.setNodeMarkup(e.mapping.map(s+a),null,as(d.attrs,o-t.colCount(a))),l+=d.attrs.rowspan-1}else{const a=i==null?J(r.type.schema).cell:r.nodeAt(t.map[c+i]).type,d=t.positionAt(l,o,r);e.insert(e.mapping.map(s+d),a.createAndFill())}}return e}function fo(e,t){if(!oe(e))return!1;if(t){const s=ae(e);t(ps(e.tr,s,s.left))}return!0}function mo(e,t){if(!oe(e))return!1;if(t){const s=ae(e);t(ps(e.tr,s,s.right))}return!0}function xo(e,{map:t,table:s,tableStart:r},o){const i=e.mapping.maps.length;for(let l=0;l<t.height;){const c=l*t.width+o,a=t.map[c],d=s.nodeAt(a),p=d.attrs;if(o>0&&t.map[c-1]==a||o<t.width-1&&t.map[c+1]==a)e.setNodeMarkup(e.mapping.slice(i).map(r+a),null,Se(p,o-t.colCount(a)));else{const f=e.mapping.slice(i).map(r+a);e.delete(f,f+d.nodeSize)}l+=p.rowspan}}function go(e,t){if(!oe(e))return!1;if(t){const s=ae(e),r=e.tr;if(s.left==0&&s.right==s.map.width)return!1;for(let o=s.right-1;xo(r,s,o),o!=s.left;o--){const i=s.tableStart?r.doc.nodeAt(s.tableStart-1):r.doc;if(!i)throw new RangeError("No table found");s.table=i,s.map=O.get(i)}t(r)}return!0}function bo(e,t,s){var r;const o=J(t.type.schema).header_cell;for(let i=0;i<e.width;i++)if(((r=t.nodeAt(e.map[i+s*e.width]))===null||r===void 0?void 0:r.type)!=o)return!1;return!0}function hs(e,{map:t,tableStart:s,table:r},o){let i=s;for(let d=0;d<o;d++)i+=r.child(d).nodeSize;const l=[];let c=o>0?-1:0;bo(t,r,o+c)&&(c=o==0||o==t.height?null:0);for(let d=0,p=t.width*o;d<t.width;d++,p++)if(o>0&&o<t.height&&t.map[p]==t.map[p-t.width]){const f=t.map[p],m=r.nodeAt(f).attrs;e.setNodeMarkup(s+f,null,{...m,rowspan:m.rowspan+1}),d+=m.colspan-1}else{var a;const f=c==null?J(r.type.schema).cell:(a=r.nodeAt(t.map[p+c*t.width]))===null||a===void 0?void 0:a.type,m=f?.createAndFill();m&&l.push(m)}return e.insert(i,J(r.type.schema).row.create(null,l)),e}function yo(e,t){if(!oe(e))return!1;if(t){const s=ae(e);t(hs(e.tr,s,s.top))}return!0}function vo(e,t){if(!oe(e))return!1;if(t){const s=ae(e);t(hs(e.tr,s,s.bottom))}return!0}function jo(e,{map:t,table:s,tableStart:r},o){let i=0;for(let d=0;d<o;d++)i+=s.child(d).nodeSize;const l=i+s.child(o).nodeSize,c=e.mapping.maps.length;e.delete(i+r,l+r);const a=new Set;for(let d=0,p=o*t.width;d<t.width;d++,p++){const f=t.map[p];if(!a.has(f)){if(a.add(f),o>0&&f==t.map[p-t.width]){const m=s.nodeAt(f).attrs;e.setNodeMarkup(e.mapping.slice(c).map(f+r),null,{...m,rowspan:m.rowspan-1}),d+=m.colspan-1}else if(o<t.height&&f==t.map[p+t.width]){const m=s.nodeAt(f),h=m.attrs,g=m.type.create({...h,rowspan:m.attrs.rowspan-1},m.content),v=t.positionAt(o+1,d,s);e.insert(e.mapping.slice(c).map(r+v),g),d+=h.colspan-1}}}}function Co(e,t){if(!oe(e))return!1;if(t){const s=ae(e),r=e.tr;if(s.top==0&&s.bottom==s.map.height)return!1;for(let o=s.bottom-1;jo(r,s,o),o!=s.top;o--){const i=s.tableStart?r.doc.nodeAt(s.tableStart-1):r.doc;if(!i)throw new RangeError("No table found");s.table=i,s.map=O.get(s.table)}t(r)}return!0}function In(e){const t=e.content;return t.childCount==1&&t.child(0).isTextblock&&t.child(0).childCount==0}function wo({width:e,height:t,map:s},r){let o=r.top*e+r.left,i=o,l=(r.bottom-1)*e+r.left,c=o+(r.right-r.left-1);for(let a=r.top;a<r.bottom;a++){if(r.left>0&&s[i]==s[i-1]||r.right<e&&s[c]==s[c+1])return!0;i+=e,c+=e}for(let a=r.left;a<r.right;a++){if(r.top>0&&s[o]==s[o-e]||r.bottom<t&&s[l]==s[l+e])return!0;o++,l++}return!1}function Wn(e,t){const s=e.selection;if(!(s instanceof $)||s.$anchorCell.pos==s.$headCell.pos)return!1;const r=ae(e),{map:o}=r;if(wo(o,r))return!1;if(t){const i=e.tr,l={};let c=ie.empty,a,d;for(let p=r.top;p<r.bottom;p++)for(let f=r.left;f<r.right;f++){const m=o.map[p*o.width+f],h=r.table.nodeAt(m);if(!(l[m]||!h))if(l[m]=!0,a==null)a=m,d=h;else{In(h)||(c=c.append(h.content));const g=i.mapping.map(m+r.tableStart);i.delete(g,g+h.nodeSize)}}if(a==null||d==null)return!0;if(i.setNodeMarkup(a+r.tableStart,null,{...as(d.attrs,d.attrs.colspan,r.right-r.left-d.attrs.colspan),rowspan:r.bottom-r.top}),c.size>0){const p=a+1+d.content.size,f=In(d)?a+1:p;i.replaceWith(f+r.tableStart,p+r.tableStart,c)}i.setSelection(new $(i.doc.resolve(a+r.tableStart))),t(i)}return!0}function _n(e,t){const s=J(e.schema);return So(({node:r})=>s[r.type.spec.tableRole])(e,t)}function So(e){return(t,s)=>{const r=t.selection;let o,i;if(r instanceof $){if(r.$anchorCell.pos!=r.$headCell.pos)return!1;o=r.$anchorCell.nodeAfter,i=r.$anchorCell.pos}else{var l;if(o=no(r.$from),!o)return!1;i=(l=we(r.$from))===null||l===void 0?void 0:l.pos}if(o==null||i==null||o.attrs.colspan==1&&o.attrs.rowspan==1)return!1;if(s){let c=o.attrs;const a=[],d=c.colwidth;c.rowspan>1&&(c={...c,rowspan:1}),c.colspan>1&&(c={...c,colspan:1});const p=ae(t),f=t.tr;for(let h=0;h<p.right-p.left;h++)a.push(d?{...c,colwidth:d&&d[h]?[d[h]]:null}:c);let m;for(let h=p.top;h<p.bottom;h++){let g=p.map.positionAt(h,p.left,p.table);h==p.top&&(g+=o.nodeSize);for(let v=p.left,j=0;v<p.right;v++,j++)v==p.left&&h==p.top||f.insert(m=f.mapping.map(g+p.tableStart,1),e({node:o,row:h,col:v}).createAndFill(a[j]))}f.setNodeMarkup(i,e({node:o,row:p.top,col:p.left}),a[0]),r instanceof $&&f.setSelection(new $(f.doc.resolve(r.$anchorCell.pos),m?f.doc.resolve(m):void 0)),s(f)}return!0}}function ko(e,t){return function(s,r){if(!oe(s))return!1;const o=kt(s);if(o.nodeAfter.attrs[e]===t)return!1;if(r){const i=s.tr;s.selection instanceof $?s.selection.forEachCell((l,c)=>{l.attrs[e]!==t&&i.setNodeMarkup(c,null,{...l.attrs,[e]:t})}):i.setNodeMarkup(o.pos,null,{...o.nodeAfter.attrs,[e]:t}),r(i)}return!0}}function No(e){return function(t,s){if(!oe(t))return!1;if(s){const r=J(t.schema),o=ae(t),i=t.tr,l=o.map.cellsInRect(e=="column"?{left:o.left,top:0,right:o.right,bottom:o.map.height}:e=="row"?{left:0,top:o.top,right:o.map.width,bottom:o.bottom}:o),c=l.map(a=>o.table.nodeAt(a));for(let a=0;a<l.length;a++)c[a].type==r.header_cell&&i.setNodeMarkup(o.tableStart+l[a],r.cell,c[a].attrs);if(i.steps.length===0)for(let a=0;a<l.length;a++)i.setNodeMarkup(o.tableStart+l[a],r.header_cell,c[a].attrs);s(i)}return!0}}function $n(e,t,s){const r=t.map.cellsInRect({left:0,top:0,right:e=="row"?t.map.width:1,bottom:e=="column"?t.map.height:1});for(let o=0;o<r.length;o++){const i=t.table.nodeAt(r[o]);if(i&&i.type!==s.header_cell)return!1}return!0}function Ye(e,t){return t=t||{useDeprecatedLogic:!1},t.useDeprecatedLogic?No(e):function(s,r){if(!oe(s))return!1;if(r){const o=J(s.schema),i=ae(s),l=s.tr,c=$n("row",i,o),a=$n("column",i,o),d=(e==="column"?c:e==="row"&&a)?1:0,p=e=="column"?{left:0,top:d,right:1,bottom:i.map.height}:e=="row"?{left:d,top:0,right:i.map.width,bottom:1}:i,f=e=="column"?a?o.cell:o.header_cell:e=="row"?c?o.cell:o.header_cell:o.cell;i.map.cellsInRect(p).forEach(m=>{const h=m+i.tableStart,g=l.doc.nodeAt(h);g&&l.setNodeMarkup(h,f,g.attrs)}),r(l)}return!0}}Ye("row",{useDeprecatedLogic:!0});Ye("column",{useDeprecatedLogic:!0});const zo=Ye("cell",{useDeprecatedLogic:!0});function Ao(e,t){if(t<0){const s=e.nodeBefore;if(s)return e.pos-s.nodeSize;for(let r=e.index(-1)-1,o=e.before();r>=0;r--){const i=e.node(-1).child(r),l=i.lastChild;if(l)return o-1-l.nodeSize;o-=i.nodeSize}}else{if(e.index()<e.parent.childCount-1)return e.pos+e.nodeAfter.nodeSize;const s=e.node(-1);for(let r=e.indexAfter(-1),o=e.after();r<s.childCount;r++){const i=s.child(r);if(i.childCount)return o+1;o+=i.nodeSize}}return null}function Dn(e){return function(t,s){if(!oe(t))return!1;const r=Ao(kt(t),e);if(r==null)return!1;if(s){const o=t.doc.resolve(r);s(t.tr.setSelection(xe.between(o,ro(o))).scrollIntoView())}return!0}}function Ro(e,t){const s=e.selection.$anchor;for(let r=s.depth;r>0;r--)if(s.node(r).type.spec.tableRole=="table")return t&&t(e.tr.delete(s.before(r),s.after(r)).scrollIntoView()),!0;return!1}function yt(e,t){const s=e.selection;if(!(s instanceof $))return!1;if(t){const r=e.tr,o=J(e.schema).cell.createAndFill().content;s.forEachCell((i,l)=>{i.content.eq(o)||r.replace(r.mapping.map(l+1),r.mapping.map(l+i.nodeSize-1),new ge(o,0,0))}),r.docChanged&&t(r)}return!0}function To(e){if(e.size===0)return null;let{content:t,openStart:s,openEnd:r}=e;for(;t.childCount==1&&(s>0&&r>0||t.child(0).type.spec.tableRole=="table");)s--,r--,t=t.child(0).content;const o=t.child(0),i=o.type.spec.tableRole,l=o.type.schema,c=[];if(i=="row")for(let a=0;a<t.childCount;a++){let d=t.child(a).content;const p=a?0:Math.max(0,s-1),f=a<t.childCount-1?0:Math.max(0,r-1);(p||f)&&(d=nn(J(l).row,new ge(d,p,f)).content),c.push(d)}else if(i=="cell"||i=="header_cell")c.push(s||r?nn(J(l).row,new ge(t,s,r)).content:t);else return null;return Mo(l,c)}function Mo(e,t){const s=[];for(let o=0;o<t.length;o++){const i=t[o];for(let l=i.childCount-1;l>=0;l--){const{rowspan:c,colspan:a}=i.child(l).attrs;for(let d=o;d<o+c;d++)s[d]=(s[d]||0)+a}}let r=0;for(let o=0;o<s.length;o++)r=Math.max(r,s[o]);for(let o=0;o<s.length;o++)if(o>=t.length&&t.push(ie.empty),s[o]<r){const i=J(e).cell.createAndFill(),l=[];for(let c=s[o];c<r;c++)l.push(i);t[o]=t[o].append(ie.from(l))}return{height:t.length,width:r,rows:t}}function nn(e,t){const s=e.createAndFill();return new Zs(s).replace(0,s.content.size,t).doc}function Eo({width:e,height:t,rows:s},r,o){if(e!=r){const i=[],l=[];for(let c=0;c<s.length;c++){const a=s[c],d=[];for(let p=i[c]||0,f=0;p<r;f++){let m=a.child(f%a.childCount);p+m.attrs.colspan>r&&(m=m.type.createChecked(Se(m.attrs,m.attrs.colspan,p+m.attrs.colspan-r),m.content)),d.push(m),p+=m.attrs.colspan;for(let h=1;h<m.attrs.rowspan;h++)i[c+h]=(i[c+h]||0)+m.attrs.colspan}l.push(ie.from(d))}s=l,e=r}if(t!=o){const i=[];for(let l=0,c=0;l<o;l++,c++){const a=[],d=s[c%t];for(let p=0;p<d.childCount;p++){let f=d.child(p);l+f.attrs.rowspan>o&&(f=f.type.create({...f.attrs,rowspan:Math.max(1,o-f.attrs.rowspan)},f.content)),a.push(f)}i.push(ie.from(a))}s=i,t=o}return{width:e,height:t,rows:s}}function Lo(e,t,s,r,o,i,l){const c=e.doc.type.schema,a=J(c);let d,p;if(o>t.width)for(let f=0,m=0;f<t.height;f++){const h=s.child(f);m+=h.nodeSize;const g=[];let v;h.lastChild==null||h.lastChild.type==a.cell?v=d||(d=a.cell.createAndFill()):v=p||(p=a.header_cell.createAndFill());for(let j=t.width;j<o;j++)g.push(v);e.insert(e.mapping.slice(l).map(m-1+r),g)}if(i>t.height){const f=[];for(let g=0,v=(t.height-1)*t.width;g<Math.max(t.width,o);g++){const j=g>=t.width?!1:s.nodeAt(t.map[v+g]).type==a.header_cell;f.push(j?p||(p=a.header_cell.createAndFill()):d||(d=a.cell.createAndFill()))}const m=a.row.create(null,ie.from(f)),h=[];for(let g=t.height;g<i;g++)h.push(m);e.insert(e.mapping.slice(l).map(r+s.nodeSize-2),h)}return!!(d||p)}function Pn(e,t,s,r,o,i,l,c){if(l==0||l==t.height)return!1;let a=!1;for(let d=o;d<i;d++){const p=l*t.width+d,f=t.map[p];if(t.map[p-t.width]==f){a=!0;const m=s.nodeAt(f),{top:h,left:g}=t.findCell(f);e.setNodeMarkup(e.mapping.slice(c).map(f+r),null,{...m.attrs,rowspan:l-h}),e.insert(e.mapping.slice(c).map(t.positionAt(l,g,s)),m.type.createAndFill({...m.attrs,rowspan:h+m.attrs.rowspan-l})),d+=m.attrs.colspan-1}}return a}function Bn(e,t,s,r,o,i,l,c){if(l==0||l==t.width)return!1;let a=!1;for(let d=o;d<i;d++){const p=d*t.width+l,f=t.map[p];if(t.map[p-1]==f){a=!0;const m=s.nodeAt(f),h=t.colCount(f),g=e.mapping.slice(c).map(f+r);e.setNodeMarkup(g,null,Se(m.attrs,l-h,m.attrs.colspan-(l-h))),e.insert(g+m.nodeSize,m.type.createAndFill(Se(m.attrs,0,l-h))),d+=m.attrs.rowspan-1}}return a}function On(e,t,s,r,o){let i=s?e.doc.nodeAt(s-1):e.doc;if(!i)throw new Error("No table found");let l=O.get(i);const{top:c,left:a}=r,d=a+o.width,p=c+o.height,f=e.tr;let m=0;function h(){if(i=s?f.doc.nodeAt(s-1):f.doc,!i)throw new Error("No table found");l=O.get(i),m=f.mapping.maps.length}Lo(f,l,i,s,d,p,m)&&h(),Pn(f,l,i,s,a,d,c,m)&&h(),Pn(f,l,i,s,a,d,p,m)&&h(),Bn(f,l,i,s,c,p,a,m)&&h(),Bn(f,l,i,s,c,p,d,m)&&h();for(let g=c;g<p;g++){const v=l.positionAt(g,a,i),j=l.positionAt(g,d,i);f.replace(f.mapping.slice(m).map(v+s),f.mapping.slice(m).map(j+s),new ge(o.rows[g-c],0,0))}h(),f.setSelection(new $(f.doc.resolve(s+l.positionAt(c,a,i)),f.doc.resolve(s+l.positionAt(p-1,d-1,i)))),t(f)}const Ho=qs({ArrowLeft:vt("horiz",-1),ArrowRight:vt("horiz",1),ArrowUp:vt("vert",-1),ArrowDown:vt("vert",1),"Shift-ArrowLeft":jt("horiz",-1),"Shift-ArrowRight":jt("horiz",1),"Shift-ArrowUp":jt("vert",-1),"Shift-ArrowDown":jt("vert",1),Backspace:yt,"Mod-Backspace":yt,Delete:yt,"Mod-Delete":yt});function wt(e,t,s){return s.eq(e.selection)?!1:(t&&t(e.tr.setSelection(s).scrollIntoView()),!0)}function vt(e,t){return(s,r,o)=>{if(!o)return!1;const i=s.selection;if(i instanceof $)return wt(s,r,ue.near(i.$headCell,t));if(e!="horiz"&&!i.empty)return!1;const l=fs(o,e,t);if(l==null)return!1;if(e=="horiz")return wt(s,r,ue.near(s.doc.resolve(i.head+t),t));{const c=s.doc.resolve(l),a=ls(c,e,t);let d;return a?d=ue.near(a,1):t<0?d=ue.near(s.doc.resolve(c.before(-1)),-1):d=ue.near(s.doc.resolve(c.after(-1)),1),wt(s,r,d)}}}function jt(e,t){return(s,r,o)=>{if(!o)return!1;const i=s.selection;let l;if(i instanceof $)l=i;else{const a=fs(o,e,t);if(a==null)return!1;l=new $(s.doc.resolve(a))}const c=ls(l.$headCell,e,t);return c?wt(s,r,new $(l.$anchorCell,c)):!1}}function Io(e,t){const s=e.state.doc,r=we(s.resolve(t));return r?(e.dispatch(e.state.tr.setSelection(new $(r))),!0):!1}function Wo(e,t,s){if(!oe(e.state))return!1;let r=To(s);const o=e.state.selection;if(o instanceof $){r||(r={width:1,height:1,rows:[ie.from(nn(J(e.state.schema).cell,s))]});const i=o.$anchorCell.node(-1),l=o.$anchorCell.start(-1),c=O.get(i).rectBetween(o.$anchorCell.pos-l,o.$headCell.pos-l);return r=Eo(r,c.right-c.left,c.bottom-c.top),On(e.state,e.dispatch,l,c,r),!0}else if(r){const i=kt(e.state),l=i.start(-1);return On(e.state,e.dispatch,l,O.get(i.node(-1)).findCell(i.pos-l),r),!0}else return!1}function _o(e,t){var s;if(t.button!=0||t.ctrlKey||t.metaKey)return;const r=Fn(e,t.target);let o;if(t.shiftKey&&e.state.selection instanceof $)i(e.state.selection.$anchorCell,t),t.preventDefault();else if(t.shiftKey&&r&&(o=we(e.state.selection.$anchor))!=null&&((s=Vt(e,t))===null||s===void 0?void 0:s.pos)!=o.pos)i(o,t),t.preventDefault();else if(!r)return;function i(a,d){let p=Vt(e,d);const f=me.getState(e.state)==null;if(!p||!ln(a,p))if(f)p=a;else return;const m=new $(a,p);if(f||!e.state.selection.eq(m)){const h=e.state.tr.setSelection(m);f&&h.setMeta(me,a.pos),e.dispatch(h)}}function l(){e.root.removeEventListener("mouseup",l),e.root.removeEventListener("dragstart",l),e.root.removeEventListener("mousemove",c),me.getState(e.state)!=null&&e.dispatch(e.state.tr.setMeta(me,-1))}function c(a){const d=a,p=me.getState(e.state);let f;if(p!=null)f=e.state.doc.resolve(p);else if(Fn(e,d.target)!=r&&(f=Vt(e,t),!f))return l();f&&i(f,d)}e.root.addEventListener("mouseup",l),e.root.addEventListener("dragstart",l),e.root.addEventListener("mousemove",c)}function fs(e,t,s){if(!(e.state.selection instanceof xe))return null;const{$head:r}=e.state.selection;for(let o=r.depth-1;o>=0;o--){const i=r.node(o);if((s<0?r.index(o):r.indexAfter(o))!=(s<0?0:i.childCount))return null;if(i.type.spec.tableRole=="cell"||i.type.spec.tableRole=="header_cell"){const l=r.before(o),c=t=="vert"?s>0?"down":"up":s>0?"right":"left";return e.endOfTextblock(c)?l:null}}return null}function Fn(e,t){for(;t&&t!=e.dom;t=t.parentNode)if(t.nodeName=="TD"||t.nodeName=="TH")return t;return null}function Vt(e,t){const s=e.posAtCoords({left:t.clientX,top:t.clientY});if(!s)return null;let{inside:r,pos:o}=s;return r>=0&&we(e.state.doc.resolve(r))||we(e.state.doc.resolve(o))}var $o=class{constructor(t,s){this.node=t,this.defaultCellMinWidth=s,this.dom=document.createElement("div"),this.dom.className="tableWrapper",this.table=this.dom.appendChild(document.createElement("table")),this.table.style.setProperty("--default-cell-min-width",`${s}px`),this.colgroup=this.table.appendChild(document.createElement("colgroup")),sn(t,this.colgroup,this.table,s),this.contentDOM=this.table.appendChild(document.createElement("tbody"))}update(t){return t.type!=this.node.type?!1:(this.node=t,sn(t,this.colgroup,this.table,this.defaultCellMinWidth),!0)}ignoreMutation(t){return t.type=="attributes"&&(t.target==this.table||this.colgroup.contains(t.target))}};function sn(e,t,s,r,o,i){let l=0,c=!0,a=t.firstChild;const d=e.firstChild;if(d){for(let f=0,m=0;f<d.childCount;f++){const{colspan:h,colwidth:g}=d.child(f).attrs;for(let v=0;v<h;v++,m++){const j=o==m?i:g&&g[v],k=j?j+"px":"";if(l+=j||r,j||(c=!1),a)a.style.width!=k&&(a.style.width=k),a=a.nextSibling;else{const F=document.createElement("col");F.style.width=k,t.appendChild(F)}}}for(;a;){var p;const f=a.nextSibling;(p=a.parentNode)===null||p===void 0||p.removeChild(a),a=f}c?(s.style.width=l+"px",s.style.minWidth=""):(s.style.width="",s.style.minWidth=l+"px")}}const ee=new on("tableColumnResizing");function Do({handleWidth:e=5,cellMinWidth:t=25,defaultCellMinWidth:s=100,View:r=$o,lastColumnResizable:o=!0}={}){const i=new Qn({key:ee,state:{init(l,c){var a;const d=(a=i.spec)===null||a===void 0||(a=a.props)===null||a===void 0?void 0:a.nodeViews,p=J(c.schema).table.name;return r&&d&&(d[p]=(f,m)=>new r(f,s,m)),new Po(-1,!1)},apply(l,c){return c.apply(l)}},props:{attributes:l=>{const c=ee.getState(l);return c&&c.activeHandle>-1?{class:"resize-cursor"}:{}},handleDOMEvents:{mousemove:(l,c)=>{Bo(l,c,e,o)},mouseleave:l=>{Oo(l)},mousedown:(l,c)=>{Fo(l,c,t,s)}},decorations:l=>{const c=ee.getState(l);if(c&&c.activeHandle>-1)return Yo(l,c.activeHandle)},nodeViews:{}}});return i}var Po=class St{constructor(t,s){this.activeHandle=t,this.dragging=s}apply(t){const s=this,r=t.getMeta(ee);if(r&&r.setHandle!=null)return new St(r.setHandle,!1);if(r&&r.setDragging!==void 0)return new St(s.activeHandle,r.setDragging);if(s.activeHandle>-1&&t.docChanged){let o=t.mapping.map(s.activeHandle,-1);return tn(t.doc.resolve(o))||(o=-1),new St(o,s.dragging)}return s}};function Bo(e,t,s,r){if(!e.editable)return;const o=ee.getState(e.state);if(o&&!o.dragging){const i=Go(t.target);let l=-1;if(i){const{left:c,right:a}=i.getBoundingClientRect();t.clientX-c<=s?l=Un(e,t,"left",s):a-t.clientX<=s&&(l=Un(e,t,"right",s))}if(l!=o.activeHandle){if(!r&&l!==-1){const c=e.state.doc.resolve(l),a=c.node(-1),d=O.get(a),p=c.start(-1);if(d.colCount(c.pos-p)+c.nodeAfter.attrs.colspan-1==d.width-1)return}ms(e,l)}}}function Oo(e){if(!e.editable)return;const t=ee.getState(e.state);t&&t.activeHandle>-1&&!t.dragging&&ms(e,-1)}function Fo(e,t,s,r){var o;if(!e.editable)return!1;const i=(o=e.dom.ownerDocument.defaultView)!==null&&o!==void 0?o:window,l=ee.getState(e.state);if(!l||l.activeHandle==-1||l.dragging)return!1;const c=e.state.doc.nodeAt(l.activeHandle),a=Uo(e,l.activeHandle,c.attrs);e.dispatch(e.state.tr.setMeta(ee,{setDragging:{startX:t.clientX,startWidth:a}}));function d(f){i.removeEventListener("mouseup",d),i.removeEventListener("mousemove",p);const m=ee.getState(e.state);m?.dragging&&(Ko(e,m.activeHandle,Gn(m.dragging,f,s)),e.dispatch(e.state.tr.setMeta(ee,{setDragging:null})))}function p(f){if(!f.which)return d(f);const m=ee.getState(e.state);if(m&&m.dragging){const h=Gn(m.dragging,f,s);Kn(e,m.activeHandle,h,r)}}return Kn(e,l.activeHandle,a,r),i.addEventListener("mouseup",d),i.addEventListener("mousemove",p),t.preventDefault(),!0}function Uo(e,t,{colspan:s,colwidth:r}){const o=r&&r[r.length-1];if(o)return o;const i=e.domAtPos(t);let l=i.node.childNodes[i.offset].offsetWidth,c=s;if(r)for(let a=0;a<s;a++)r[a]&&(l-=r[a],c--);return l/c}function Go(e){for(;e&&e.nodeName!="TD"&&e.nodeName!="TH";)e=e.classList&&e.classList.contains("ProseMirror")?null:e.parentNode;return e}function Un(e,t,s,r){const o=s=="right"?-r:r,i=e.posAtCoords({left:t.clientX+o,top:t.clientY});if(!i)return-1;const{pos:l}=i,c=we(e.state.doc.resolve(l));if(!c)return-1;if(s=="right")return c.pos;const a=O.get(c.node(-1)),d=c.start(-1),p=a.map.indexOf(c.pos-d);return p%a.width==0?-1:d+a.map[p-1]}function Gn(e,t,s){const r=t.clientX-e.startX;return Math.max(s,e.startWidth+r)}function ms(e,t){e.dispatch(e.state.tr.setMeta(ee,{setHandle:t}))}function Ko(e,t,s){const r=e.state.doc.resolve(t),o=r.node(-1),i=O.get(o),l=r.start(-1),c=i.colCount(r.pos-l)+r.nodeAfter.attrs.colspan-1,a=e.state.tr;for(let d=0;d<i.height;d++){const p=d*i.width+c;if(d&&i.map[p]==i.map[p-i.width])continue;const f=i.map[p],m=o.nodeAt(f).attrs,h=m.colspan==1?0:c-i.colCount(f);if(m.colwidth&&m.colwidth[h]==s)continue;const g=m.colwidth?m.colwidth.slice():Vo(m.colspan);g[h]=s,a.setNodeMarkup(l+f,null,{...m,colwidth:g})}a.docChanged&&e.dispatch(a)}function Kn(e,t,s,r){const o=e.state.doc.resolve(t),i=o.node(-1),l=o.start(-1),c=O.get(i).colCount(o.pos-l)+o.nodeAfter.attrs.colspan-1;let a=e.domAtPos(o.start(-1)).node;for(;a&&a.nodeName!="TABLE";)a=a.parentNode;a&&sn(i,a.firstChild,a,r,c,s)}function Vo(e){return Array(e).fill(0)}function Yo(e,t){const s=[],r=e.doc.resolve(t),o=r.node(-1);if(!o)return Yt.empty;const i=O.get(o),l=r.start(-1),c=i.colCount(r.pos-l)+r.nodeAfter.attrs.colspan-1;for(let d=0;d<i.height;d++){const p=c+d*i.width;if((c==i.width-1||i.map[p]!=i.map[p+1])&&(d==0||i.map[p]!=i.map[p-i.width])){var a;const f=i.map[p],m=l+f+o.nodeAt(f).nodeSize-1,h=document.createElement("div");h.className="column-resize-handle",!((a=ee.getState(e))===null||a===void 0)&&a.dragging&&s.push(Xt.node(l+f,l+f+o.nodeAt(f).nodeSize,{class:"column-resize-dragging"})),s.push(Xt.widget(m,h))}}return Yt.create(e.doc,s)}function Xo({allowTableNodeSelection:e=!1}={}){return new Qn({key:me,state:{init(){return null},apply(t,s){const r=t.getMeta(me);if(r!=null)return r==-1?null:r;if(s==null||!t.docChanged)return s;const{deleted:o,pos:i}=t.mapping.mapResult(s);return o?null:i}},props:{decorations:lo,handleDOMEvents:{mousedown:_o},createSelectionBetween(t){return me.getState(t.state)!=null?t.state.selection:null},handleTripleClick:Io,handleKeyDown:Ho,handlePaste:Wo},appendTransaction(t,s,r){return uo(r,us(r,s),e)}})}var xs=Xe.create({name:"tableCell",addOptions(){return{HTMLAttributes:{}}},content:"block+",addAttributes(){return{colspan:{default:1},rowspan:{default:1},colwidth:{default:null,parseHTML:e=>{var t,s;const r=e.getAttribute("colwidth"),o=r?r.split(",").map(i=>parseInt(i,10)):null;if(!o){const i=(t=e.closest("table"))==null?void 0:t.querySelectorAll("colgroup > col"),l=Array.from(((s=e.parentElement)==null?void 0:s.children)||[]).indexOf(e);if(l&&l>-1&&i&&i[l]){const c=i[l].getAttribute("width");return c?[parseInt(c,10)]:null}}return o}}}},tableRole:"cell",isolating:!0,parseHTML(){return[{tag:"td"}]},renderHTML({HTMLAttributes:e}){return["td",ke(this.options.HTMLAttributes,e),0]}}),gs=Xe.create({name:"tableHeader",addOptions(){return{HTMLAttributes:{}}},content:"block+",addAttributes(){return{colspan:{default:1},rowspan:{default:1},colwidth:{default:null,parseHTML:e=>{const t=e.getAttribute("colwidth");return t?t.split(",").map(r=>parseInt(r,10)):null}}}},tableRole:"header_cell",isolating:!0,parseHTML(){return[{tag:"th"}]},renderHTML({HTMLAttributes:e}){return["th",ke(this.options.HTMLAttributes,e),0]}}),bs=Xe.create({name:"tableRow",addOptions(){return{HTMLAttributes:{}}},content:"(tableCell | tableHeader)*",tableRole:"row",parseHTML(){return[{tag:"tr"}]},renderHTML({HTMLAttributes:e}){return["tr",ke(this.options.HTMLAttributes,e),0]}});function rn(e,t){return t?["width",`${Math.max(t,e)}px`]:["min-width",`${e}px`]}function Vn(e,t,s,r,o,i){var l;let c=0,a=!0,d=t.firstChild;const p=e.firstChild;if(p!==null)for(let m=0,h=0;m<p.childCount;m+=1){const{colspan:g,colwidth:v}=p.child(m).attrs;for(let j=0;j<g;j+=1,h+=1){const k=o===h?i:v&&v[j],F=k?`${k}px`:"";if(c+=k||r,k||(a=!1),d){if(d.style.width!==F){const[L,G]=rn(r,k);d.style.setProperty(L,G)}d=d.nextSibling}else{const L=document.createElement("col"),[G,K]=rn(r,k);L.style.setProperty(G,K),t.appendChild(L)}}}for(;d;){const m=d.nextSibling;(l=d.parentNode)==null||l.removeChild(d),d=m}const f=e.attrs.style&&typeof e.attrs.style=="string"&&/\bwidth\s*:/i.test(e.attrs.style);a&&!f?(s.style.width=`${c}px`,s.style.minWidth=""):(s.style.width="",s.style.minWidth=`${c}px`)}var Jo=class{constructor(e,t){this.node=e,this.cellMinWidth=t,this.dom=document.createElement("div"),this.dom.className="tableWrapper",this.table=this.dom.appendChild(document.createElement("table")),e.attrs.style&&(this.table.style.cssText=e.attrs.style),this.colgroup=this.table.appendChild(document.createElement("colgroup")),Vn(e,this.colgroup,this.table,t),this.contentDOM=this.table.appendChild(document.createElement("tbody"))}update(e){return e.type!==this.node.type?!1:(this.node=e,Vn(e,this.colgroup,this.table,this.cellMinWidth),!0)}ignoreMutation(e){const t=e.target,s=this.dom.contains(t),r=this.contentDOM.contains(t);return!!(s&&!r&&(e.type==="attributes"||e.type==="childList"||e.type==="characterData"))}};function qo(e,t,s,r){let o=0,i=!0;const l=[],c=e.firstChild;if(!c)return{};for(let f=0,m=0;f<c.childCount;f+=1){const{colspan:h,colwidth:g}=c.child(f).attrs;for(let v=0;v<h;v+=1,m+=1){const j=s===m?r:g&&g[v];o+=j||t,j||(i=!1);const[k,F]=rn(t,j);l.push(["col",{style:`${k}: ${F}`}])}}const a=i?`${o}px`:"",d=i?"":`${o}px`;return{colgroup:["colgroup",{},...l],tableWidth:a,tableMinWidth:d}}function Yn(e,t){return e.createAndFill()}function Qo(e){if(e.cached.tableNodeTypes)return e.cached.tableNodeTypes;const t={};return Object.keys(e.nodes).forEach(s=>{const r=e.nodes[s];r.spec.tableRole&&(t[r.spec.tableRole]=r)}),e.cached.tableNodeTypes=t,t}function Zo(e,t,s,r,o){const i=Qo(e),l=[],c=[];for(let d=0;d<s;d+=1){const p=Yn(i.cell);if(p&&c.push(p),r){const f=Yn(i.header_cell);f&&l.push(f)}}const a=[];for(let d=0;d<t;d+=1)a.push(i.row.createChecked(null,r&&d===0?l:c));return i.table.createChecked(null,a)}function ei(e){return e instanceof $}var Ct=({editor:e})=>{const{selection:t}=e.state;if(!ei(t))return!1;let s=0;const r=nr(t.ranges[0].$from,i=>i.type.name==="table");return r?.node.descendants(i=>{if(i.type.name==="table")return!1;["tableCell","tableHeader"].includes(i.type.name)&&(s+=1)}),s===t.ranges.length?(e.commands.deleteTable(),!0):!1},ti="";function ni(e){return(e||"").replace(/\s+/g," ").trim()}function si(e,t,s={}){var r;const o=(r=s.cellLineSeparator)!=null?r:ti;if(!e||!e.content||e.content.length===0)return"";const i=[];e.content.forEach(g=>{const v=[];g.content&&g.content.forEach(j=>{let k="";j.content&&Array.isArray(j.content)&&j.content.length>1?k=j.content.map(K=>t.renderChildren(K)).join(o):k=j.content?t.renderChildren(j.content):"";const F=ni(k),L=j.type==="tableHeader";v.push({text:F,isHeader:L})}),i.push(v)});const l=i.reduce((g,v)=>Math.max(g,v.length),0);if(l===0)return"";const c=new Array(l).fill(0);i.forEach(g=>{var v;for(let j=0;j<l;j+=1){const F=(((v=g[j])==null?void 0:v.text)||"").length;F>c[j]&&(c[j]=F),c[j]<3&&(c[j]=3)}});const a=(g,v)=>g+" ".repeat(Math.max(0,v-g.length)),d=i[0],p=d.some(g=>g.isHeader);let f=`
`;const m=new Array(l).fill(0).map((g,v)=>p&&d[v]&&d[v].text||"");return f+=`| ${m.map((g,v)=>a(g,c[v])).join(" | ")} |
`,f+=`| ${c.map(g=>"-".repeat(Math.max(3,g))).join(" | ")} |
`,(p?i.slice(1):i).forEach(g=>{f+=`| ${new Array(l).fill(0).map((v,j)=>a(g[j]&&g[j].text||"",c[j])).join(" | ")} |
`}),f}var ri=si,ys=Xe.create({name:"table",addOptions(){return{HTMLAttributes:{},resizable:!1,renderWrapper:!1,handleWidth:5,cellMinWidth:25,View:Jo,lastColumnResizable:!0,allowTableNodeSelection:!1}},content:"tableRow+",tableRole:"table",isolating:!0,group:"block",parseHTML(){return[{tag:"table"}]},renderHTML({node:e,HTMLAttributes:t}){const{colgroup:s,tableWidth:r,tableMinWidth:o}=qo(e,this.options.cellMinWidth),i=t.style;function l(){return i||(r?`width: ${r}`:`min-width: ${o}`)}const c=["table",ke(this.options.HTMLAttributes,t,{style:l()}),s,["tbody",0]];return this.options.renderWrapper?["div",{class:"tableWrapper"},c]:c},parseMarkdown:(e,t)=>{const s=[];if(e.header){const r=[];e.header.forEach(o=>{r.push(t.createNode("tableHeader",{},[{type:"paragraph",content:t.parseInline(o.tokens)}]))}),s.push(t.createNode("tableRow",{},r))}return e.rows&&e.rows.forEach(r=>{const o=[];r.forEach(i=>{o.push(t.createNode("tableCell",{},[{type:"paragraph",content:t.parseInline(i.tokens)}]))}),s.push(t.createNode("tableRow",{},o))}),t.createNode("table",void 0,s)},renderMarkdown:(e,t)=>ri(e,t),addCommands(){return{insertTable:({rows:e=3,cols:t=3,withHeaderRow:s=!0}={})=>({tr:r,dispatch:o,editor:i})=>{const l=Zo(i.schema,e,t,s);if(o){const c=r.selection.from+1;r.replaceSelectionWith(l).scrollIntoView().setSelection(xe.near(r.doc.resolve(c)))}return!0},addColumnBefore:()=>({state:e,dispatch:t})=>fo(e,t),addColumnAfter:()=>({state:e,dispatch:t})=>mo(e,t),deleteColumn:()=>({state:e,dispatch:t})=>go(e,t),addRowBefore:()=>({state:e,dispatch:t})=>yo(e,t),addRowAfter:()=>({state:e,dispatch:t})=>vo(e,t),deleteRow:()=>({state:e,dispatch:t})=>Co(e,t),deleteTable:()=>({state:e,dispatch:t})=>Ro(e,t),mergeCells:()=>({state:e,dispatch:t})=>Wn(e,t),splitCell:()=>({state:e,dispatch:t})=>_n(e,t),toggleHeaderColumn:()=>({state:e,dispatch:t})=>Ye("column")(e,t),toggleHeaderRow:()=>({state:e,dispatch:t})=>Ye("row")(e,t),toggleHeaderCell:()=>({state:e,dispatch:t})=>zo(e,t),mergeOrSplit:()=>({state:e,dispatch:t})=>Wn(e,t)?!0:_n(e,t),setCellAttribute:(e,t)=>({state:s,dispatch:r})=>ko(e,t)(s,r),goToNextCell:()=>({state:e,dispatch:t})=>Dn(1)(e,t),goToPreviousCell:()=>({state:e,dispatch:t})=>Dn(-1)(e,t),fixTables:()=>({state:e,dispatch:t})=>(t&&us(e),!0),setCellSelection:e=>({tr:t,dispatch:s})=>{if(s){const r=$.create(t.doc,e.anchorCell,e.headCell);t.setSelection(r)}return!0}}},addKeyboardShortcuts(){return{Tab:()=>this.editor.commands.goToNextCell()?!0:this.editor.can().addRowAfter()?this.editor.chain().addRowAfter().goToNextCell().run():!1,"Shift-Tab":()=>this.editor.commands.goToPreviousCell(),Backspace:Ct,"Mod-Backspace":Ct,Delete:Ct,"Mod-Delete":Ct}},addProseMirrorPlugins(){return[...this.options.resizable&&this.editor.isEditable?[Do({handleWidth:this.options.handleWidth,cellMinWidth:this.options.cellMinWidth,defaultCellMinWidth:this.options.cellMinWidth,View:this.options.View,lastColumnResizable:this.options.lastColumnResizable})]:[],Xo({allowTableNodeSelection:this.options.allowTableNodeSelection})]},extendNodeSchema(e){const t={name:e.name,options:e.options,storage:e.storage};return{tableRole:er(tr(e,"tableRole",t))}}});le.create({name:"tableKit",addExtensions(){const e=[];return this.options.table!==!1&&e.push(ys.configure(this.options.table)),this.options.tableCell!==!1&&e.push(xs.configure(this.options.tableCell)),this.options.tableHeader!==!1&&e.push(gs.configure(this.options.tableHeader)),this.options.tableRow!==!1&&e.push(bs.configure(this.options.tableRow)),e}});const oi=le.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:e=>e.style.fontSize.replace(/['"]+/g,""),renderHTML:e=>e.fontSize?{style:`font-size: ${e.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:e=>({chain:t})=>t().setMark("textStyle",{fontSize:e}).run(),unsetFontSize:()=>({chain:e})=>e().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),ii=le.create({name:"lineHeight",addOptions(){return{types:["paragraph","heading"],defaultLineHeight:"normal"}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:this.options.defaultLineHeight,parseHTML:e=>e.style.lineHeight||this.options.defaultLineHeight,renderHTML:e=>e.lineHeight===this.options.defaultLineHeight?{}:{style:`line-height: ${e.lineHeight}`}}}}]},addCommands(){return{setLineHeight:e=>({commands:t})=>this.options.types.every(s=>t.updateAttributes(s,{lineHeight:e})),unsetLineHeight:()=>({commands:e})=>this.options.types.every(t=>e.resetAttributes(t,"lineHeight"))}}}),Xn=({content:e,onUpdate:t,onFocus:s,onCreated:r,editable:o,className:i,placeholder:l,style:c})=>{const a=sr({extensions:[ir.configure({heading:!1}),lr.configure({levels:[1,2,3,4]}),rr,rs,is,oi,ii,os,Kr.configure({types:["heading","paragraph"]}),Xr.configure({multicolor:!0}),or,ar.configure({nested:!0}),qr.configure({inline:!0,allowBase64:!0}),ys.configure({resizable:!0}),bs,gs,xs,cr.configure({placeholder:l||" ..."})],content:e,editable:o,onUpdate:({editor:d})=>{t(d.getHTML())},onFocus:({editor:d})=>{s(d)},onCreate:({editor:d})=>{r&&r(d)}});return x.useEffect(()=>{if(!a)return;!(a.getHTML()===e)&&!a.isFocused&&a.commands.setContent(e,{emitUpdate:!1})},[e,a]),x.useEffect(()=>{a&&a.setEditable(o)},[o,a]),n.jsx(dr,{editor:a,className:i,style:c,onMouseUp:()=>{}})},li=({editor:e,onOpenSettings:t})=>{const[,s]=Ft.useReducer(l=>l+1,0);Ft.useEffect(()=>{if(!e)return;const l=()=>s();return e.on("transaction",l),e.on("selectionUpdate",l),()=>{e.off("transaction",l),e.off("selectionUpdate",l)}},[e]);const[r,o]=Ft.useState(""),i=()=>{r&&window.find(r)};return n.jsxs("div",{className:"novel-toolbar author-toolbar",children:[n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>e?.chain().focus().undo().run(),disabled:!e?.can().undo(),title:"",children:n.jsx("span",{className:"material-symbols-outlined",children:"undo"})}),n.jsx("button",{onClick:()=>e?.chain().focus().redo().run(),disabled:!e?.can().redo(),title:" ",children:n.jsx("span",{className:"material-symbols-outlined",children:"redo"})})]}),n.jsx("div",{className:"separator"}),n.jsxs("select",{onChange:l=>{if(!e)return;const c=l.target.value;c==="p"?e.chain().focus().setParagraph().run():e.chain().focus().toggleHeading({level:parseInt(c)}).run()},value:e?.isActive("heading",{level:1})?"1":e?.isActive("heading",{level:2})?"2":e?.isActive("heading",{level:3})?"3":e?.isActive("heading",{level:4})?"4":"p",disabled:!e,className:"style-select",children:[n.jsx("option",{value:"p",children:""}),n.jsx("option",{value:"1",children:" 1"}),n.jsx("option",{value:"2",children:" 2"}),n.jsx("option",{value:"3",children:" 1"}),n.jsx("option",{value:"4",children:" 2"})]}),n.jsx("div",{className:"separator"}),n.jsxs("select",{onChange:l=>{e&&e.chain().focus().setFontFamily(l.target.value).run()},value:e?.getAttributes("textStyle").fontFamily||"",disabled:!e,className:"font-select",children:[n.jsx("option",{value:"",children:" "}),n.jsx("option",{value:"Inter",children:"Inter"}),n.jsx("option",{value:"Roboto",children:"Roboto"}),n.jsx("option",{value:"Pretendard",children:"Pretendard"}),n.jsx("option",{value:"Nanum Myeongjo",children:""}),n.jsx("option",{value:"serif",children:"Serif"}),n.jsx("option",{value:"monospace",children:"Monospace"})]}),n.jsx("select",{onChange:l=>{e&&e.chain().focus().setFontSize(l.target.value).run()},value:e?.getAttributes("textStyle").fontSize||"16px",disabled:!e,className:"size-select",children:[12,14,16,18,20,24,30,36].map(l=>n.jsxs("option",{value:`${l}px`,children:[l,"px"]},l))}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>e?.chain().focus().toggleBold().run(),className:e?.isActive("bold")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_bold"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleItalic().run(),className:e?.isActive("italic")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_italic"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleUnderline().run(),className:e?.isActive("underline")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_underlined"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleStrike().run(),className:e?.isActive("strike")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_strikethrough"})}),n.jsxs("div",{className:"color-picker-wrapper",title:" ",children:[n.jsx("span",{className:"material-symbols-outlined",children:"format_color_text"}),n.jsx("input",{type:"color",onChange:l=>e?.chain().focus().setColor(l.target.value).run(),value:e?.getAttributes("textStyle").color||"var(--foreground)",disabled:!e})]})]}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("left").run(),className:e?.isActive({textAlign:"left"})?"is-active":"",title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_align_left"})}),n.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("center").run(),className:e?.isActive({textAlign:"center"})?"is-active":"",title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_align_center"})}),n.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("right").run(),className:e?.isActive({textAlign:"right"})?"is-active":"",title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_align_right"})}),n.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("justify").run(),className:e?.isActive({textAlign:"justify"})?"is-active":"",title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_align_justify"})})]}),n.jsx("div",{className:"separator"}),n.jsx("div",{className:"group",children:n.jsxs("select",{onChange:l=>{e&&e.chain().focus().setLineHeight(l.target.value).run()},value:e?.getAttributes("paragraph").lineHeight||"normal",disabled:!e,className:"spacing-select",title:"   ",children:[n.jsx("option",{value:"normal",children:" "}),n.jsx("option",{value:"1.0",children:"1.0"}),n.jsx("option",{value:"1.2",children:"1.2"}),n.jsx("option",{value:"1.5",children:"1.5"}),n.jsx("option",{value:"2.0",children:"2.0"}),n.jsx("option",{value:"2.5",children:"2.5"}),n.jsx("option",{value:"3.0",children:"3.0"})]})}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>e?.chain().focus().toggleBulletList().run(),className:e?.isActive("bulletList")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_list_bulleted"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleOrderedList().run(),className:e?.isActive("orderedList")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_list_numbered"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleTaskList().run(),className:e?.isActive("taskList")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"checklist"})})]}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>{const l=window.prompt(" URL ");if(l)try{const c=new URL(l);if(!["http:","https:"].includes(c.protocol)){alert("http  https URL .");return}e?.chain().focus().setImage({src:l}).run()}catch{alert(" URL .")}},title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"add_photo_alternate"})}),n.jsx("button",{onClick:()=>e?.chain().focus().insertTable({rows:3,cols:3,withHeaderRow:!0}).run(),title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"grid_on"})}),n.jsxs("div",{className:"color-picker-wrapper",title:"  ()",children:[n.jsx("span",{className:"material-symbols-outlined",children:"label"}),n.jsx("input",{type:"color",onChange:l=>e?.chain().focus().setHighlight({color:l.target.value}).run(),value:e?.getAttributes("highlight").color||"#ffff00",disabled:!e})]})]}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"search-group",children:[n.jsx("input",{type:"text",placeholder:"...",value:r,onChange:l=>o(l.target.value),onKeyDown:l=>l.key==="Enter"&&i(),disabled:!e}),n.jsx("button",{onClick:i,disabled:!e,title:"",children:n.jsx("span",{className:"material-symbols-outlined",children:"search"})})]}),n.jsx("div",{className:"separator"}),n.jsx("div",{className:"group",children:n.jsx("button",{onClick:t,className:"settings-btn",title:"",style:{display:"flex",alignItems:"center",justifyContent:"center",color:"var(--foreground)",padding:"6px"},children:n.jsx(Zn,{size:20})})})]})},ai=({editor:e,readerSettings:t,onSettingsChange:s,onBookmark:r,onHighlight:o,onAddMemo:i})=>{const[l,c]=x.useState(null),a=x.useRef(null);x.useEffect(()=>{const h=g=>{a.current&&!a.current.contains(g.target)&&c(null)};return document.addEventListener("mousedown",h),()=>document.removeEventListener("mousedown",h)},[]);const d=h=>{c(l===h?null:h)},p=()=>{s({fontSize:18,lineHeight:2,paragraphSpacing:40,contentWidth:80,fontFamily:"Noto Sans KR",theme:"light"}),c(null)},f=[{name:"Noto Sans KR",label:"  (Sans)"},{name:"Noto Serif KR",label:"  (Serif)"},{name:"Nanum Myeongjo",label:" "},{name:"Nanum Gothic",label:" "},{name:"Poppins",label:"Poppins"},{name:"Inter",label:"Inter"}],m=[{id:"light",label:"",color:"#ffffff",textColor:"#1c1917"},{id:"sepia",label:"",color:"#ede0d4",textColor:"#311900"},{id:"dark",label:"",color:"#1a1a1a",textColor:"#ffffff"}];return n.jsx("div",{className:"novel-toolbar reader-toolbar",ref:a,children:n.jsxs("div",{className:"group",children:[n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>d("typography"),className:`toolbar-btn ${l==="typography"?"active":""}`,title:" ",children:n.jsx(ur,{size:20})}),l==="typography"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:" "}),n.jsxs("div",{className:"popover-row",children:[n.jsx("button",{className:"popover-btn-small",onClick:()=>s({...t,fontSize:Math.max(12,t.fontSize-1)}),children:n.jsx(pr,{size:16})}),n.jsx("span",{style:{minWidth:"30px",textAlign:"center",fontWeight:600},children:t.fontSize}),n.jsx("button",{className:"popover-btn-small",onClick:()=>s({...t,fontSize:Math.min(32,t.fontSize+1)}),children:n.jsx(hr,{size:16})}),n.jsx("button",{className:"popover-btn-reset",onClick:p,children:""})]})]})]}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>d("font"),className:`toolbar-btn ${l==="font"?"active":""}`,title:" ",children:n.jsx("span",{style:{fontSize:"18px",fontWeight:700},children:"A"})}),l==="font"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:""}),f.map(h=>n.jsxs("div",{className:`popover-item ${t.fontFamily===h.name?"selected":""}`,onClick:()=>{s({...t,fontFamily:h.name}),c(null)},children:[n.jsx("span",{style:{fontFamily:h.name},children:h.label}),t.fontFamily===h.name&&n.jsx(xt,{size:14})]},h.name))]})]}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>d("theme"),className:`toolbar-btn ${l==="theme"?"active":""}`,title:" ",children:n.jsx(fr,{size:20})}),l==="theme"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:""}),m.map(h=>n.jsxs("div",{className:`popover-item ${t.theme===h.id?"selected":""}`,onClick:()=>{s({...t,theme:h.id}),c(null)},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("div",{style:{width:"16px",height:"16px",borderRadius:"50%",backgroundColor:h.color,border:"1px solid #e2e8f0"}}),h.label]}),t.theme===h.id&&n.jsx(xt,{size:14})]},h.id))]})]}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>d("spacing"),className:`toolbar-btn ${l==="spacing"?"active":""}`,title:" ",children:n.jsx(zn,{size:20})}),l==="spacing"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:" "}),[{val:1.5,label:""},{val:2,label:""},{val:2.5,label:" "}].map(h=>n.jsxs("div",{className:`popover-item ${t.lineHeight===h.val?"selected":""}`,onClick:()=>{s({...t,lineHeight:h.val}),c(null)},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx(zn,{size:14,style:{opacity:.5}}),h.label]}),t.lineHeight===h.val&&n.jsx(xt,{size:14})]},h.val))]})]}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>d("width"),className:`toolbar-btn ${l==="width"?"active":""}`,title:" ",children:n.jsx(mr,{size:20})}),l==="width"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:" "}),[{val:70,label:""},{val:80,label:""},{val:90,label:""},{val:100,label:""}].map(h=>n.jsxs("div",{className:`popover-item ${t.contentWidth===h.val?"selected":""}`,onClick:()=>{s({...t,contentWidth:h.val}),c(null)},children:[n.jsxs("span",{children:[h.label," (",h.val,"%)"]}),t.contentWidth===h.val&&n.jsx(xt,{size:14})]},h.val))]})]}),n.jsx("div",{className:"separator",style:{margin:"0 8px"}}),n.jsx("button",{onClick:r,title:" ",className:"toolbar-btn",children:n.jsx(xr,{size:20})}),n.jsx("button",{onClick:o,disabled:!e,title:"",className:"toolbar-btn",children:n.jsx(gr,{size:20})}),n.jsx("button",{onClick:i,disabled:!e,title:" ",className:"toolbar-btn",children:n.jsx(br,{size:20})})]})})},ci=async e=>be("/chat/ask",{method:"POST",body:JSON.stringify({question:e.question,novel_id:e.novel_id,chapter_id:e.chapter_id,novel_filter:e.novel_filter,alpha:e.alpha??.32,similarity_threshold:e.similarity_threshold??.5})});function di({msg:e,onNavigateToScene:t,chapterId:s}){const[r,o]=x.useState(!1),[i,l]=x.useState(!1);let c=e.content,a="";if(e.role==="assistant"&&e.content.includes("[ ]")){const d=e.content.split("[ ]");c=d[0].replace("[ ]","").trim(),a=d[1].trim()}return n.jsx("div",{className:`chatbot-message ${e.role}`,style:{marginBottom:"1rem",alignSelf:e.role==="user"?"flex-end":"flex-start"},children:n.jsxs("div",{className:`chatbot-message-bubble ${e.role==="user"?"user-bubble":"assistant-bubble"}`,style:{padding:"0.75rem 1rem",borderRadius:"1.5rem",maxWidth:"100%",backgroundColor:e.role==="user"?"var(--primary)":"var(--chat-assistant-bg)",color:e.role==="user"?"var(--primary-foreground)":"var(--chat-assistant-text)",border:e.role==="assistant"?"1px solid var(--border)":"none",boxShadow:"0 1px 2px rgba(0,0,0,0.05)"},children:[n.jsx("p",{style:{whiteSpace:"pre-wrap",margin:0},children:c}),a&&n.jsxs("div",{className:"detail-container",style:{marginTop:"0.5rem",borderTop:"1px solid var(--border)",paddingTop:"0.5rem"},children:[n.jsxs("button",{onClick:()=>l(!i),style:{background:"none",border:"none",padding:0,cursor:"pointer",display:"flex",alignItems:"center",gap:"4px",fontSize:"0.75rem",color:"var(--muted-foreground)",fontWeight:"600"},children:[i?n.jsx(re,{size:14,strokeWidth:2.5}):n.jsx(ne,{size:14,strokeWidth:2.5})," "]}),i&&n.jsx("p",{style:{whiteSpace:"pre-wrap",marginTop:"0.5rem",fontSize:"0.9rem",color:"var(--muted-foreground)",lineHeight:"1.5"},children:a})]}),e.source&&n.jsxs("div",{className:"source-container",style:{marginTop:"0.5rem",borderTop:"1px solid var(--border)",paddingTop:"0.5rem"},children:[n.jsxs("button",{onClick:()=>o(!r),style:{background:"none",border:"none",padding:0,cursor:"pointer",display:"flex",alignItems:"center",gap:"4px",fontSize:"0.75rem",color:e.role==="user"?"var(--primary-foreground)":"var(--muted-foreground)",opacity:.9,fontWeight:"600"},children:[r?n.jsx(re,{size:14,strokeWidth:2.5}):n.jsx(ne,{size:14,strokeWidth:2.5}),""]}),r&&n.jsxs("div",{style:{fontSize:"0.75rem",color:e.role==="user"?"var(--primary-foreground)":"var(--muted-foreground)",opacity:.85,marginTop:"0.5rem",fontStyle:"italic",display:"flex",flexDirection:"column",gap:"4px",animation:"fadeIn 0.2s ease-in-out"},children:[n.jsxs("div",{children:[n.jsx("strong",{children:":"})," ",e.source.filename,e.source.scene_index!==void 0&&` (Scene ${e.source.scene_index+1})`]}),e.source.summary&&n.jsx("div",{style:{backgroundColor:"rgba(0,0,0,0.1)",padding:"6px",borderRadius:"4px",marginTop:"2px",borderLeft:"2px solid currentColor",fontSize:"0.8rem",lineHeight:"1.4"},children:e.source.summary}),e.source.scene_index!==void 0&&t&&n.jsxs("button",{onClick:()=>{t(e.source.scene_index)},disabled:!!(e.source.chapter_id&&s&&e.source.chapter_id!==s),style:{background:"rgba(255,255,255,0.2)",border:"1px solid rgba(255,255,255,0.3)",borderRadius:"4px",color:"currentColor",padding:"4px 8px",cursor:e.source.chapter_id&&s&&e.source.chapter_id!==s?"not-allowed":"pointer",opacity:e.source.chapter_id&&s&&e.source.chapter_id!==s?.5:1,alignSelf:"flex-start",fontSize:"0.75rem",marginTop:"6px",transition:"all 0.2s"},title:e.source.chapter_id&&s&&e.source.chapter_id!==s?"  .":"",children:[" ",e.source.chapter_id?`Ch.${e.source.chapter_id} `:"","Scene ",e.source.scene_index+1," "]})]})]})]})})}function ui({onNavigateToScene:e,novelId:t,chapterId:s}){const[r,o]=x.useState(""),[i,l]=x.useState([{role:"assistant",content:"!    ."}]),[c,a]=x.useState(!1),d=x.useRef(null);x.useEffect(()=>{d.current?.scrollIntoView({behavior:"smooth"})},[i]);const p=async()=>{if(r.trim()&&!c){const m=r.trim();o(""),l(h=>[...h,{role:"user",content:m}]),a(!0);try{const h=await ci({question:m,novel_id:t,chapter_id:s,alpha:.32,similarity_threshold:.35});l(g=>[...g,{role:"assistant",content:h.answer,source:h.source,similarity:h.similarity}])}catch(h){console.error("Chat error:",h);const g=h.response?.data?.detail||h.message||"    .";l(v=>[...v,{role:"assistant",content:`: ${g}`}])}finally{a(!1)}}},f=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),p())};return n.jsxs("div",{className:"chatbot-container",style:{display:"flex",flexDirection:"column",height:"100%",backgroundColor:"var(--modal-bg)"},children:[n.jsxs("div",{className:"chatbot-messages",style:{flex:1,overflowY:"auto",padding:"1rem"},children:[i.map((m,h)=>n.jsx(di,{msg:m,onNavigateToScene:e,chapterId:s},h)),c&&n.jsx("div",{className:"chatbot-message assistant",style:{alignSelf:"flex-start"},children:n.jsx("div",{className:"chatbot-message-bubble assistant-bubble",style:{padding:"0.75rem 1rem",borderRadius:"1.5rem",backgroundColor:"var(--chat-assistant-bg)",border:"1px solid var(--border)",color:"var(--chat-assistant-text)"},children:n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[n.jsx(Jt,{size:16,strokeWidth:2.5,className:"animate-spin",style:{color:"var(--muted-foreground)"}}),n.jsx("span",{style:{color:"var(--muted-foreground)"},children:"  ..."})]})})}),n.jsx("div",{ref:d})]}),n.jsxs("div",{className:"chatbot-input-area",style:{padding:"1rem",display:"flex",gap:"0.5rem",backgroundColor:"var(--modal-bg)",borderTop:"1px solid var(--border)"},children:[n.jsx("input",{type:"text",className:"chatbot-input",placeholder:" ...",value:r,maxLength:500,onChange:m=>o(m.target.value),onKeyDown:f,disabled:c,style:{flex:1,padding:"0.75rem",borderRadius:"0.5rem",fontSize:"0.95rem",outline:"none",transition:"border-color 0.2s",backgroundColor:"var(--input-bg)",color:"var(--input-text)",border:"1px solid var(--input-border)"}}),n.jsx("button",{className:"chatbot-send",onClick:p,disabled:c||!r.trim(),style:{backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"0.5rem",padding:"0.75rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"transform 0.2s",minWidth:"45px",opacity:c||!r.trim()?.5:1},children:c?n.jsx(Jt,{size:20,strokeWidth:2.5,className:"animate-spin"}):n.jsx(es,{size:20,strokeWidth:2.5})})]})]})}function pi({onNavigateToScene:e,onCheckConsistency:t,onPredictStory:s,onOpenCharacterChat:r,onOpenSettings:o,onOpenRelGraph:i,novelId:l,chapterId:c,mode:a="writer"}){const[d,p]=x.useState(!1),[f,m]=x.useState(!1),{theme:h}=ns(),g=()=>{p(!d)},v=()=>{m(!0),p(!1)},j=()=>{m(!1)},k=()=>{t&&t(),p(!1)};return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"floating-menu-container",children:[d&&n.jsxs("div",{className:"floating-menu-options",children:[n.jsx("button",{className:"menu-option btn-purple",onClick:()=>{s&&s(),p(!1)},title:"  (What-If)",children:n.jsx(qt,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option",onClick:()=>{i&&i(),p(!1)},title:" ",style:{background:"#10B981",color:"#fff",border:"none"},children:n.jsx(ts,{size:20,strokeWidth:2.5})}),a!=="reader"&&n.jsx(n.Fragment,{children:n.jsx("button",{className:"menu-option btn-blue",onClick:k,title:"",children:n.jsx(yr,{size:20,strokeWidth:2.5})})}),n.jsx("button",{className:"menu-option btn-brown-med",onClick:v,title:"",children:n.jsx(vr,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option btn-brown-rich",onClick:()=>{r&&r(),p(!1)},title:" ",children:n.jsx(Qt,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option btn-brown-dark",onClick:()=>{o&&o(),p(!1)},title:"",children:n.jsx(Zn,{size:20,strokeWidth:2.5})})]}),n.jsx("button",{className:"floating-menu-btn",onClick:g,style:{backgroundColor:h==="sepia"?"var(--color-dark-brown)":"var(--primary)",color:"var(--primary-foreground)"},children:n.jsx(jr,{size:24,strokeWidth:2.5})})]}),f&&n.jsxs("div",{className:"chatbot-modal",style:{position:"fixed",bottom:"15px",right:"25px",width:"650px",height:"850px",borderRadius:"1rem",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",display:"flex",flexDirection:"column",zIndex:1e3,overflow:"hidden"},children:[n.jsx("div",{className:"chatbot-header",style:{padding:"16px",borderBottom:"1px solid var(--border)",display:"flex",justifyContent:"flex-end",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)"},children:n.jsx("button",{className:"chatbot-close",onClick:j,style:{color:"currentColor",background:"none",border:"none",cursor:"pointer"},children:n.jsx(Ie,{size:20,strokeWidth:2.5})})}),n.jsx("div",{className:"chatbot-content",style:{flex:1,overflow:"hidden"},children:n.jsx(ui,{onNavigateToScene:e,novelId:l,chapterId:c})})]})]})}function hi({onClose:e}){const[t,s]=x.useState(""),[r,o]=x.useState(""),[i,l]=x.useState(localStorage.getItem("llm_model")||"gemini-2.0-flash"),[c,a]=x.useState(!1);x.useEffect(()=>{d()},[]),x.useEffect(()=>{i&&localStorage.setItem("llm_model",i)},[i]);const d=async()=>{try{const h=await be("/auth/me");s(h.username),o(h.email)}catch(h){console.error("Failed to fetch profile:",h),I.error("    .")}},p=()=>{localStorage.removeItem("token"),localStorage.removeItem("userMode"),window.location.href="/"},f=()=>{I.info("    .")},m=[{value:"gemini-2.0-flash",label:"Gemini 2.0 Flash ()"},{value:"gemini-2.5-flash",label:"Gemini 2.5 Flash ()"},{value:"gemini-1.5-pro",label:"Gemini 1.5 Pro ()"},{value:"gemini-2.0",label:"Gemini 2.0 ()"}];return n.jsx("div",{className:"settings-panel",children:n.jsxs("div",{className:"settings-container",children:[n.jsxs("div",{className:"settings-header",children:[n.jsx("h2",{className:"settings-title",children:""}),n.jsx("button",{onClick:e,className:"close-button","aria-label":"Close settings",children:n.jsx(Ie,{size:24,strokeWidth:2})})]}),n.jsxs("div",{className:"settings-content",children:[n.jsx("div",{className:"profile-section",children:n.jsxs("div",{className:"profile-header-text",children:[n.jsx("h3",{className:"section-title",children:" "}),n.jsx("p",{className:"section-description",children:"   AI   ."})]})}),n.jsxs("div",{className:"settings-form",children:[n.jsxs("div",{className:"form-group",children:[n.jsx("label",{className:"form-label",children:""}),n.jsx("input",{className:"form-input",value:t,onChange:h=>s(h.target.value),placeholder:" "})]}),n.jsxs("div",{className:"form-group",children:[n.jsx("label",{className:"form-label",children:""}),n.jsx("input",{className:"form-input disabled",value:r,disabled:!0}),n.jsx("p",{className:"input-note",children:"    "})]}),n.jsxs("div",{className:"form-group",children:[n.jsx("label",{className:"form-label",children:"LLM AI  "}),n.jsxs("div",{className:"select-wrapper",children:[n.jsxs("button",{className:`select-button ${c?"active":""}`,onClick:()=>a(!c),children:[n.jsx("span",{children:m.find(h=>h.value===i)?.label||i}),n.jsx(ne,{size:16,className:`dropdown-icon ${c?"open":""}`})]}),c&&n.jsx("div",{className:"select-dropdown",children:m.map(h=>n.jsx("button",{className:`select-option ${i===h.value?"selected":""}`,onClick:()=>{l(h.value),a(!1)},children:h.label},h.value))})]}),n.jsx("p",{className:"model-note",children:" AI      "})]}),n.jsxs("div",{className:"danger-zone",children:[n.jsx("h3",{className:"danger-title",children:" "}),n.jsx("p",{className:"danger-description",children:"     ."}),n.jsx("button",{className:"btn btn-destructive",onClick:f,children:" "})]})]})]}),n.jsx("div",{className:"settings-footer",children:n.jsxs("button",{className:"btn btn-outline",onClick:p,children:[n.jsx(Cr,{size:18}),""]})})]})})}function fi({isOpen:e,onClose:t,result:s,isLoading:r,onNavigateToQuote:o,onReanalyze:i}){return e?n.jsxs("div",{style:{position:"fixed",bottom:"16px",right:"20px",width:"450px",height:"750px",backgroundColor:"var(--modal-bg)",color:"var(--modal-text)",boxShadow:"0 8px 32px rgba(0,0,0,0.15)",zIndex:1e3,display:"flex",flexDirection:"column",borderRadius:"16px",border:"1px solid var(--modal-border)",animation:"slideUp 0.3s ease"},children:[n.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)",borderRadius:"16px 16px 0 0"},children:[n.jsx("h2",{style:{margin:0,fontSize:"1.15rem",fontWeight:"600",color:"inherit"},children:"   "}),n.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[i&&s&&!r&&n.jsx("button",{onClick:i,title:"",style:{background:"none",border:"none",cursor:"pointer",padding:"4px",color:"inherit",display:"flex",alignItems:"center"},children:n.jsx(wr,{size:18,strokeWidth:2.5})}),n.jsx("button",{onClick:t,style:{background:"none",border:"none",cursor:"pointer",padding:"4px",color:"inherit"},children:n.jsx(Ie,{size:22,strokeWidth:2.5})})]})]}),n.jsx("div",{style:{flex:1,overflowY:"auto",padding:"20px",backgroundColor:"var(--modal-bg)",borderRadius:"0 0 16px 16px"},children:r?n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",gap:"16px"},children:[n.jsx(Jt,{size:48,strokeWidth:2.5,style:{animation:"spin 1s linear infinite",color:"var(--primary)"}}),n.jsx("p",{style:{color:"var(--muted-foreground)",fontSize:"0.95rem"},children:" ..."})]}):s?n.jsxs("div",{children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"16px",borderRadius:"8px",backgroundColor:s.status==="  "?"rgba(220, 38, 38, 0.1)":"rgba(22, 163, 74, 0.1)",marginBottom:"20px",border:"1px solid",borderColor:s.status==="  "?"rgba(220, 38, 38, 0.2)":"rgba(22, 163, 74, 0.2)"},children:[s.status==="  "?n.jsx(Sr,{size:24,color:"#DC2626",strokeWidth:2.5}):n.jsx(An,{size:24,color:"#16A34A",strokeWidth:2.5}),n.jsxs("div",{children:[n.jsx("h3",{style:{margin:0,fontSize:"1.1rem",fontWeight:"600",color:s.status==="  "?"#DC2626":"#16A34A"},children:s.status}),s.message&&n.jsx("p",{style:{margin:"4px 0 0 0",fontSize:"0.9rem",color:"var(--muted-foreground)"},children:s.message})]})]}),s.results&&s.results.length>0?n.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:s.results.map((l,c)=>n.jsxs("div",{style:{padding:"16px",border:"1px solid var(--modal-border)",borderRadius:"8px",backgroundColor:"var(--card)",color:"var(--card-foreground)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"12px"},children:[n.jsx("span",{style:{fontSize:"0.85rem",fontWeight:"600",padding:"4px 10px",borderRadius:"12px",backgroundColor:l.type===" "?"rgba(220, 38, 38, 0.1)":"rgba(217, 119, 6, 0.1)",color:l.type===" "?"#DC2626":"#D97706"},children:l.type}),o&&l.quote&&n.jsxs("button",{onClick:()=>o(l.quote),style:{display:"flex",alignItems:"center",gap:"4px",padding:"4px 8px",fontSize:"0.8rem",backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"4px",cursor:"pointer"},children:[n.jsx(kr,{size:14,strokeWidth:2.5}),""]})]}),n.jsxs("div",{style:{marginBottom:"12px"},children:[n.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.85rem",fontWeight:"600",color:"var(--modal-text)"},children:" :"}),n.jsxs("p",{style:{margin:0,fontSize:"0.9rem",color:"var(--modal-text)",fontStyle:"italic",backgroundColor:"var(--secondary)",padding:"8px",borderRadius:"4px",border:"1px solid var(--border)"},children:['"',l.quote,'"']})]}),n.jsxs("div",{style:{marginBottom:"12px"},children:[n.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.85rem",fontWeight:"600",color:"var(--modal-text)"},children:":"}),n.jsx("p",{style:{margin:0,fontSize:"0.9rem",color:"var(--muted-foreground)",lineHeight:"1.5"},children:l.description})]}),n.jsxs("div",{children:[n.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.85rem",fontWeight:"600",color:"var(--modal-text)"},children:":"}),n.jsx("p",{style:{margin:0,fontSize:"0.9rem",color:"#059669",lineHeight:"1.5"},children:l.suggestion})]})]},c))}):n.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",color:"var(--muted-foreground)"},children:[n.jsx(An,{size:48,color:"#16A34A",strokeWidth:2.5,style:{margin:"0 auto 16px"}}),n.jsx("p",{style:{fontSize:"1rem",fontWeight:"500"},children:"  !"}),n.jsx("p",{style:{fontSize:"0.9rem",marginTop:"8px"},children:"   ."})]})]}):n.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",color:"var(--muted-foreground)"},children:[n.jsx("p",{children:"  ."}),n.jsx("p",{style:{fontSize:"0.9rem",marginTop:"8px"},children:"    ."})]})}),n.jsx("style",{children:`
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                @keyframes slideUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `})]}):null}const Jn=["#4F46E5","#DC2626","#059669","#D97706","#7C3AED","#DB2777","#0891B2","#65A30D","#EA580C","#6366F1","#14B8A6","#F59E0B","#EF4444","#8B5CF6","#EC4899"];function mi({isOpen:e,onClose:t,relationships:s,characters:r=[]}){const o=x.useRef(null),i=x.useRef(null),[l,c]=x.useState(null),[a,d]=x.useState(null),[p,f]=x.useState({w:800,h:600}),m=x.useRef([]),h=x.useRef(0),g=x.useRef(new Map);x.useEffect(()=>{const w=new Map;for(const y of r)w.set(y.name,y);g.current=w},[r]),x.useEffect(()=>{if(!e||!i.current)return;const w=()=>{if(!i.current)return;const P=i.current.getBoundingClientRect();P.width>0&&P.height>0&&f({w:P.width,h:P.height})};requestAnimationFrame(w);const y=setTimeout(w,100),H=new ResizeObserver(w);return H.observe(i.current),()=>{clearTimeout(y),H.disconnect()}},[e]),x.useEffect(()=>{if(!e)return;const w=new Set;for(const E of s){const W=E.source||E.character1||"",V=E.target||E.character2||"";W&&w.add(W),V&&w.add(V)}const y=Array.from(w),{w:H,h:P}=p,q=H/2,Z=P/2,z=Math.min(H,P)*.35,T=y.length;m.current=y.map((E,W)=>{const V=g.current.get(E),R=2*Math.PI*W/T-Math.PI/2;return{name:E,x:q+z*Math.cos(R),y:Z+z*Math.sin(R),color:Jn[W%Jn.length],description:V?.description||"",initials:E.slice(0,2)}})},[e,s,p]);const v=x.useCallback(w=>m.current.find(y=>y.name===w),[]),j=x.useCallback(()=>{const w=o.current;if(!w)return;const y=w.getContext("2d");if(!y)return;const{w:H,h:P}=p,q=window.devicePixelRatio||1;w.width=H*q,w.height=P*q,y.scale(q,q),y.clearRect(0,0,H,P);const Z=Math.max(28,Math.min(40,H/(m.current.length*2.5)));for(const z of s){const T=v(z.source||z.character1||""),E=v(z.target||z.character2||"");if(!T||!E)continue;const W=l===T.name||l===E.name||a===T.name||a===E.name,V=(l||a)&&!W,R=(T.x+E.x)/2,pe=(T.y+E.y)/2;if(y.beginPath(),y.moveTo(T.x,T.y),y.lineTo(E.x,E.y),y.strokeStyle=V?"rgba(180,180,180,0.15)":W?T.color:"rgba(150,150,150,0.5)",y.lineWidth=W?3:1.5,V?y.setLineDash([4,4]):y.setLineDash([]),y.stroke(),y.setLineDash([]),z.relation&&!V){const Je=R,We=pe;y.font=`${W?"bold ":""}${W?13:11}px Pretendard, "Noto Sans KR", sans-serif`;const Y=z.relation,_e=y.measureText(Y),D=5,Ne=Je-_e.width/2-D,ye=We-8-D,qe=_e.width+D*2,Qe=16+D*2;y.fillStyle=W?"rgba(255,255,255,0.95)":"rgba(255,255,255,0.85)",y.beginPath(),y.roundRect(Ne,ye,qe,Qe,4),y.fill(),W&&(y.strokeStyle=T.color,y.lineWidth=1,y.stroke()),y.fillStyle=W?T.color:"#666",y.textAlign="center",y.textBaseline="middle",y.fillText(Y,Je,We)}}for(const z of m.current){const T=l===z.name||a===z.name,E=(l||a)&&!T&&!s.some(V=>{const R=V.source||V.character1||"",pe=V.target||V.character2||"";return R===z.name&&(pe===l||pe===a)||pe===z.name&&(R===l||R===a)}),W=T?Z+6:Z;y.shadowColor=T?`${z.color}66`:"rgba(0,0,0,0.08)",y.shadowBlur=T?20:6,y.shadowOffsetX=0,y.shadowOffsetY=T?0:3,T&&(y.beginPath(),y.arc(z.x,z.y,W+4,0,Math.PI*2),y.fillStyle=`${z.color}22`,y.fill()),y.beginPath(),y.arc(z.x,z.y,W,0,Math.PI*2),y.fillStyle=E?"#ccc":z.color,y.fill(),y.shadowColor="transparent",y.strokeStyle=E?"#bbb":"#fff",y.lineWidth=3,y.stroke(),y.font=`bold ${Math.round(W*.6)}px Pretendard, "Noto Sans KR", sans-serif`,y.fillStyle="#fff",y.textAlign="center",y.textBaseline="middle",y.fillText(z.initials,z.x,z.y),y.font=`${T?"bold ":""}${T?14:12}px Pretendard, "Noto Sans KR", sans-serif`,y.fillStyle=E?"#aaa":"var(--foreground, #333)",y.textBaseline="top",y.fillText(z.name,z.x,z.y+W+8)}},[s,l,a,p,v]);x.useEffect(()=>{e&&(cancelAnimationFrame(h.current),h.current=requestAnimationFrame(j))},[j,e]);const k=x.useCallback(w=>{const y=o.current;if(!y)return;const H=y.getBoundingClientRect(),P=w.clientX-H.left,q=w.clientY-H.top;let Z=null;const z=Math.max(28,Math.min(40,p.w/(m.current.length*2.5)));for(const T of m.current){const E=P-T.x,W=q-T.y;if(E*E+W*W<(z+10)*(z+10)){Z=T.name;break}}c(Z)},[p]),F=x.useCallback(w=>{const y=o.current;if(!y)return;const H=y.getBoundingClientRect(),P=w.clientX-H.left,q=w.clientY-H.top,Z=Math.max(28,Math.min(40,p.w/(m.current.length*2.5)));for(const z of m.current){const T=P-z.x,E=q-z.y;if(T*T+E*E<(Z+10)*(Z+10)){d(W=>W===z.name?null:z.name);return}}d(null)},[p]);if(!e)return null;const L=a||l,G=L?g.current.get(L):null,K=L?s.filter(w=>{const y=w.source||w.character1||"",H=w.target||w.character2||"";return y===L||H===L}):[];return n.jsx("div",{style:{position:"fixed",inset:0,zIndex:1100,background:"rgba(0,0,0,0.6)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",animation:"fadeIn 0.2s ease"},onClick:w=>{w.target===w.currentTarget&&t()},children:n.jsxs("div",{style:{width:"90vw",maxWidth:"1100px",height:"80vh",maxHeight:"750px",background:"var(--modal-bg, #fff)",borderRadius:"16px",border:"1px solid var(--modal-border, #e5e7eb)",boxShadow:"0 20px 60px rgba(0,0,0,0.3)",display:"flex",flexDirection:"column",overflow:"hidden"},children:[n.jsxs("div",{style:{padding:"16px 24px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"space-between",background:"var(--modal-header-bg)",color:"var(--modal-header-text)"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[n.jsx(ts,{size:22}),n.jsx("h2",{style:{margin:0,fontSize:"1.15rem",fontWeight:700},children:" "}),n.jsxs("span",{style:{fontSize:"0.8rem",opacity:.6},children:[m.current.length,"  ",s.length," "]})]}),n.jsx("button",{onClick:t,style:{background:"none",border:"none",cursor:"pointer",color:"currentColor",padding:"4px"},children:n.jsx(Ie,{size:22})})]}),n.jsxs("div",{style:{flex:1,display:"flex",overflow:"hidden"},children:[n.jsx("div",{ref:i,style:{flex:1,position:"relative",minHeight:0},children:s.length===0?n.jsx("div",{style:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground)",fontSize:"0.95rem"},children:"  .   ."}):n.jsx("canvas",{ref:o,style:{width:"100%",height:"100%",cursor:l?"pointer":"default"},onMouseMove:k,onClick:F,onMouseLeave:()=>c(null)})}),L&&n.jsxs("div",{style:{width:"260px",borderLeft:"1px solid var(--border)",padding:"20px",overflowY:"auto",background:"var(--card-bg, #fafafa)"},children:[n.jsx("div",{style:{width:"64px",height:"64px",borderRadius:"50%",background:v(L)?.color||"#4F46E5",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 12px",color:"#fff",fontSize:"1.5rem",fontWeight:700},children:L.slice(0,2)}),n.jsx("h3",{style:{textAlign:"center",margin:"0 0 8px",fontSize:"1.1rem"},children:L}),G?.description&&n.jsx("p",{style:{fontSize:"0.82rem",color:"var(--muted-foreground)",lineHeight:1.5,margin:"0 0 12px"},children:G.description}),G?.traits&&G.traits.length>0&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",marginBottom:"16px"},children:G.traits.map((w,y)=>n.jsx("span",{style:{fontSize:"0.72rem",padding:"2px 8px",borderRadius:"10px",background:"var(--primary, #4F46E5)",color:"#fff",fontWeight:600},children:w},y))}),K.length>0&&n.jsxs(n.Fragment,{children:[n.jsx("h4",{style:{fontSize:"0.85rem",margin:"0 0 8px",fontWeight:700},children:""}),K.map((w,y)=>{const H=(w.source||w.character1)===L?w.target||w.character2:w.source||w.character1;return n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",borderRadius:"8px",fontSize:"0.8rem",border:"1px solid var(--border)",background:"var(--modal-bg, #fff)"},children:[n.jsxs("div",{style:{fontWeight:600},children:[" ",H,n.jsx("span",{style:{marginLeft:"6px",fontSize:"0.72rem",padding:"1px 6px",borderRadius:"8px",background:"var(--primary, #4F46E5)",color:"#fff"},children:w.relation||""})]}),w.description&&n.jsx("div",{style:{marginTop:"4px",color:"var(--muted-foreground)",lineHeight:1.4},children:w.description})]},y)})]})]})]})]})})}function xi({isOpen:e,onClose:t,messages:s,onSendMessage:r,isLoading:o,onClearChat:i}){const[l,c]=x.useState(""),a=x.useRef(null),d=()=>{a.current?.scrollIntoView({behavior:"smooth"})},p=h=>{const g=h.match(/[^.!?]+[.!?]+(\s|$)/g);if(!g)return h;let v="";for(let j=0;j<g.length;j++)v+=g[j],(j+1)%2===0&&j<g.length-1&&(v+=`

`);return v||h};x.useEffect(()=>{e&&d()},[s,e,o]);const f=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),m())},m=()=>{!l.trim()||o||(r(l),c(""))};return e?n.jsxs("div",{style:{position:"fixed",bottom:"16px",right:"20px",width:"500px",height:"850px",backgroundColor:"var(--modal-bg)",boxShadow:"0 8px 32px rgba(0,0,0,0.15)",zIndex:1e3,display:"flex",flexDirection:"column",borderRadius:"16px",border:"1px solid var(--modal-border)",animation:"slideUp 0.3s ease"},children:[n.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)",borderRadius:"16px 16px 0 0"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx(qt,{size:20,strokeWidth:2.5,className:o?"animate-spin":"",style:{color:"var(--primary)"}}),n.jsx("h3",{style:{margin:0,fontSize:"1.1rem",fontWeight:"bold",color:"inherit"},children:"  "})]}),n.jsxs("div",{style:{display:"flex",gap:"8px"},children:[i&&s.length>0&&n.jsx("button",{onClick:i,title:" ",style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx(Nr,{size:18,strokeWidth:2.5})}),n.jsx("button",{onClick:t,style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx(Ie,{size:20,strokeWidth:2.5})})]})]}),n.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"20px",backgroundColor:"var(--modal-bg)",display:"flex",flexDirection:"column",gap:"20px"},children:[s.length===0&&n.jsxs("div",{style:{textAlign:"center",color:"var(--muted-foreground)",marginTop:"60px",display:"flex",flexDirection:"column",alignItems:"center",gap:"12px"},children:[n.jsx(qt,{size:48,strokeWidth:2.5,style:{opacity:.2,color:"var(--primary)"}}),n.jsxs("p",{style:{lineHeight:"1.5"},children:['"   ?"',n.jsx("br",{}),"AI   ."]})]}),s.map(h=>n.jsxs("div",{style:{display:"flex",justifyContent:h.role==="user"?"flex-end":"flex-start",gap:"12px"},children:[h.role==="assistant"&&n.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:"4px"},children:n.jsx(zr,{size:18,strokeWidth:2.5,style:{color:"var(--primary)"}})}),n.jsx("div",{style:{maxWidth:"85%",padding:"12px 16px",borderRadius:"12px",borderTopLeftRadius:h.role==="assistant"?"2px":"12px",borderTopRightRadius:h.role==="user"?"2px":"12px",backgroundColor:h.role==="user"?"var(--primary)":"var(--input-bg)",color:h.role==="user"?"var(--primary-foreground)":"var(--input-text)",boxShadow:h.role==="assistant"?"0 1px 2px rgba(0,0,0,0.05)":"none",border:h.role==="assistant"?"1px solid var(--input-border)":"none",lineHeight:"1.6",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:h.role==="assistant"?p(h.content):h.content}),h.role==="user"&&n.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:"4px"},children:n.jsx(Ar,{size:18,strokeWidth:2.5,style:{color:"var(--muted-foreground)"}})})]},h.id)),o&&n.jsxs("div",{style:{display:"flex",gap:"12px"},children:[n.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:n.jsx(Rn,{className:"animate-spin",size:18,strokeWidth:2.5,style:{color:"var(--primary)"}})}),n.jsx("div",{style:{padding:"12px 16px",borderRadius:"12px",borderTopLeftRadius:"2px",backgroundColor:"var(--input-bg)",border:"1px solid var(--input-border)",color:"var(--muted-foreground)",boxShadow:"0 1px 2px rgba(0,0,0,0.05)"},children:"  ..."})]}),n.jsx("div",{ref:a})]}),n.jsx("div",{style:{padding:"16px",backgroundColor:"var(--modal-bg)",borderTop:"1px solid var(--modal-border)",borderRadius:"0 0 16px 16px"},children:n.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"flex-end",backgroundColor:"var(--input-bg)",padding:"8px",borderRadius:"12px",border:"1px solid var(--input-border)"},children:[n.jsx("textarea",{value:l,onChange:h=>c(h.target.value),onKeyDown:f,placeholder:" ...",style:{flex:1,border:"none",background:"transparent",resize:"none",height:"auto",minHeight:"24px",maxHeight:"120px",padding:"8px",fontSize:"0.95rem",outline:"none",fontFamily:"inherit",overflowY:"auto",color:"var(--input-text)"},rows:1,onInput:h=>{h.currentTarget.style.height="auto",h.currentTarget.style.height=h.currentTarget.scrollHeight+"px"}}),n.jsx("button",{onClick:m,disabled:!l.trim()||o,style:{backgroundColor:l.trim()&&!o?"var(--primary)":"var(--muted)",color:l.trim()&&!o?"var(--primary-foreground)":"var(--muted-foreground)",border:"none",borderRadius:"8px",padding:"8px",display:"flex",alignItems:"center",justifyContent:"center",cursor:l.trim()&&!o?"pointer":"not-allowed",transition:"background-color 0.2s",width:"36px",height:"36px"},children:o?n.jsx(Rn,{size:18,strokeWidth:2.5,className:"animate-spin"}):n.jsx(es,{size:18,strokeWidth:2.5})})]})}),n.jsx("style",{children:`
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                @keyframes slideUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-spin {
                    animation: spin 1s linear infinite;
                }
            `})]}):null}const gi=async(e,t)=>be("/prediction/request",{method:"POST",body:JSON.stringify({novel_id:e,text:t})}),bi=async e=>be(`/prediction/task/${e}`),yi=async e=>be(`/prediction/history/${e}`),vi=async e=>be(`/prediction/history/${e}`,{method:"DELETE"});async function ji(e,t){return be(`/analysis/consistency/${e}/${t}`)}const Ci=()=>{const e=localStorage.getItem("token"),t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t},wi=async e=>be("/images/generate",{method:"POST",headers:Ci(),body:JSON.stringify(e)});function Ri({fileName:e,onBack:t,novelId:s,chapterId:r,mode:o="writer",onOpenCharacterChat:i,onCloseCharacterChat:l,onNavigateChapter:c,showCharacterChat:a}){const[d,p]=x.useState(!0),[f,m]=x.useState(!0),[h,g]=x.useState(!1),[v,j]=x.useState(!1),[k,F]=x.useState(!1),[L,G]=x.useState(!1),[K,w]=x.useState(!1),[y,H]=x.useState(!1),[P,q]=x.useState(""),[Z,z]=x.useState(!1),[T,E]=x.useState(!1),[W,V]=x.useState(!1),[R,pe]=x.useState(null),[Je,We]=x.useState(!1),[Y,_e]=x.useState([]),[D,Ne]=x.useState(void 0),[ye,qe]=x.useState(""),[Qe,an]=x.useState(""),[Ze,et]=x.useState(!1),[cn,dn]=x.useState(!1),Nt=x.useRef(null),$e=x.useRef(),[tt,nt]=x.useState(!1),[vs,un]=x.useState(!1),zt=x.useRef(null),st=x.useRef(),rt=x.useRef(),[ve,At]=x.useState(!1),[te,pn]=x.useState(!1),[Rt,De]=x.useState(!1),[hn,ot]=x.useState([]),[js,it]=x.useState(!1),[fn,mn]=x.useState(null),[ze,lt]=x.useState(null),[Ae,Tt]=x.useState(!1),[Cs,ws]=x.useState(0),[Ss,ks]=x.useState(0),[Re,Ns]=x.useState([]),Mt=x.useRef(!1),Et=x.useRef(()=>Promise.resolve()),{theme:at,setTheme:zs}=ns(),[Q,xn]=x.useState(()=>{const u=localStorage.getItem("reader-settings");return u?JSON.parse(u):{fontSize:18,lineHeight:2,paragraphSpacing:40,contentWidth:80,fontFamily:"Noto Serif KR",theme:"light"}});x.useEffect(()=>{o==="reader"&&Q.theme!==at&&xn(u=>({...u,theme:at}))},[at,o]);const As=u=>{xn(u),u.theme&&u.theme!==at&&zs(u.theme)};x.useEffect(()=>{localStorage.setItem("reader-settings",JSON.stringify(Q)),o==="reader"?(document.documentElement.setAttribute("data-reader-theme",Q.theme),document.documentElement.setAttribute("data-theme",Q.theme)):document.documentElement.removeAttribute("data-reader-theme")},[Q,o]),x.useEffect(()=>{if(fn){const u=setTimeout(()=>{mn(null)},15e3);return()=>clearTimeout(u)}},[fn]),x.useEffect(()=>{s&&r?(gn(),bn()):W||(q(`          .
               .
"     ?"  .

  (      )                .            .

    .    ", ! !"         . (     ,      .)            ,   .    ,           .       ,          .`),V(!0))},[s,r]),x.useEffect(()=>{let u,b=!1;if(D==="PROCESSING"||D==="PENDING"){let C=3e3;const S=async()=>{if(!(b||!s||!r)){try{const M=await Wr(s,r),A=(M.status||"").toUpperCase();if(A==="COMPLETED"||A==="FAILED"){Ne(A),At(!1),A==="COMPLETED"?(I.success(" !  ."),gn(),bn()):I.error(` : ${M.message||"   "}`);return}}catch{I.error("   .")}b||(C=Math.min(C*1.5,2e4),u=setTimeout(S,C))}};S()}return()=>{b=!0,u&&clearTimeout(u)}},[D,s,r]),x.useEffect(()=>()=>{st.current&&clearTimeout(st.current),rt.current&&clearTimeout(rt.current)},[]);const gn=async()=>{if(!(!s||!r)){z(!0);try{const u=await Er(s,r);q(u.content),Ne(u.storyboard_status)}catch{I.error("   .")}finally{z(!1),V(!0)}}},bn=async()=>{if(!(!s||!r)){We(!0);try{const u=await Lr(s,r);pe(u),u.scenes&&u.scenes.length>0&&_e(u.scenes.map(b=>b.original_text.trim()))}catch{}finally{We(!1)}}},Lt=async()=>{if(!(!s||!r)){E(!0);try{const u=Y.length>0?Y.map(b=>b.trim()).join(`

`):P;await _r(s,r,{content:u}),Tt(!1),I.success(".")}catch{I.error(" .")}finally{E(!1)}}},[B,Pe]=x.useState(null),[U,Be]=x.useState(null),[Te,ct]=x.useState(null),[je,dt]=x.useState(null),[Ht,Oe]=x.useState(!1),[Rs,he]=x.useState(!1),[Ts,Ce]=x.useState(null),[X,Fe]=x.useState(null),[Ms,Es]=x.useState({}),[ut,yn]=x.useState(!1),[pt,vn]=x.useState(!1),[ht,jn]=x.useState(!1),Ue=x.useRef(),Ge=x.useRef();x.useEffect(()=>{a&&(Oe(!1),De(!1))},[a]),x.useEffect(()=>{Mt.current=Ae},[Ae]),x.useEffect(()=>{Et.current=Lt}),x.useEffect(()=>{s&&Hr(s).then(u=>{Ns(u.sort((b,C)=>b.chapter_number-C.chapter_number))}).catch(()=>{})},[s]),x.useEffect(()=>{if(o==="reader"||!s||!r)return;const u=setInterval(()=>{Mt.current&&Et.current()},3e4);return()=>clearInterval(u)},[s,r,o]),x.useEffect(()=>{const u=b=>{Mt.current&&(b.preventDefault(),b.returnValue="")};return window.addEventListener("beforeunload",u),()=>window.removeEventListener("beforeunload",u)},[]),x.useEffect(()=>{const u=b=>{(b.ctrlKey||b.metaKey)&&b.key==="s"&&(b.preventDefault(),o!=="reader"&&s&&r&&Et.current()),b.key==="Escape"&&(Ht?Oe(!1):Rt?De(!1):y&&H(!1))};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[o,s,r,Ht,Rt,y]);const Ke=x.useRef();x.useEffect(()=>(Ke.current&&clearTimeout(Ke.current),Ke.current=setTimeout(()=>{const b=(Y.length>0?Y.join(`

`):P).replace(/<br\s*\/?>/gi,`
`).replace(/<[^>]+>/g,"");ws(b.replace(/\s/g,"").length);const C=b.trim().split(/\s+/).filter(Boolean);ks(C.length)},500),()=>{Ke.current&&clearTimeout(Ke.current)}),[P,Y]);const ft=Re.findIndex(u=>u.id===r),Cn=ft>0?Re[ft-1]:null,wn=ft<Re.length-1?Re[ft+1]:null,Sn=async u=>{Ae&&s&&r&&await Lt(),c?.(u.id,u.title)},ce=(u,b)=>{Pe(null),Be(null),ct(null),dt(null),Fe(null),yn(!1),vn(!1),jn(!1),H(!1),b&&b.trim()&&mn({sceneIndex:u,text:b.trim(),timestamp:Date.now()}),Ue.current&&clearTimeout(Ue.current),Ge.current&&clearTimeout(Ge.current),Ue.current=setTimeout(()=>{const C=document.getElementById(`scene-block-${u}`);C&&(C.scrollIntoView({behavior:"smooth",block:"start"}),C.style.transition="background-color 0.5s",C.style.backgroundColor="rgba(79, 70, 229, 0.1)",Ge.current=setTimeout(()=>{C.style.backgroundColor="transparent"},1e3))},100)},kn=async()=>{he(!0),Ce(null);try{const u=Y.length>0?Y.join(`

`):P,b=localStorage.getItem("token"),C=await fetch(`${Hn}/analysis/consistency`,{method:"POST",headers:{"Content-Type":"application/json",...b?{Authorization:`Bearer ${b}`}:{}},body:JSON.stringify({novel_id:s,chapter_id:r,text:u})});if(!C.ok)throw new Error("  ");const{task_id:S}=await C.json();let M=2e3,A=0;const _=async()=>{if(A++,A>60){he(!1),Ce({status:"",message:"    .   ."});return}try{const fe=await(await fetch(`${Hn}/analysis/task/${S}`,{headers:b?{Authorization:`Bearer ${b}`}:{}})).json();if(fe.status==="COMPLETED"){Ce(fe.result),he(!1),I.success(" .");return}else if(fe.status==="FAILED"){he(!1),Ce({status:"",message:fe.error||"  ."}),I.error("   .");return}}catch(se){console.error("Polling error:",se),he(!1),Ce({status:"",message:"      ."});return}M=Math.min(M*1.5,15e3),st.current=setTimeout(_,M)};st.current=setTimeout(_,M)}catch(u){console.error("Analysis error:",u),Ce({status:" ",message:"    ."}),he(!1)}},Ls=async()=>{if(Oe(!0),De(!1),l?.(),s&&r)try{he(!0);const u=await ji(s,r);if(u.cached&&u.result){Ce(u.result),he(!1);return}}catch{}await kn()},Hs=async()=>{if(De(!0),Oe(!1),l?.(),s&&hn.length===0)try{const{history:u}=await yi(s);if(u.length>0){const b=[];for(const C of u)b.push({id:`h-u-${C.id}`,role:"user",content:C.user_input}),b.push({id:`h-a-${C.id}`,role:"assistant",content:C.prediction});ot(b)}}catch{}},Is=async u=>{if(!s||!u.trim())return;const b={id:Date.now().toString(),role:"user",content:u};ot(C=>[...C,b]),it(!0);try{const{task_id:C}=await gi(s,u);let S=2e3;const M=async()=>{try{const A=await bi(C);if(A.status==="COMPLETED"){const _=A.result.prediction||A.result.text||(typeof A.result=="string"?A.result:JSON.stringify(A.result)),se={id:(Date.now()+1).toString(),role:"assistant",content:_};ot(fe=>[...fe,se]),it(!1),document.hidden&&"Notification"in window&&(Notification.permission==="granted"?new Notification("StoryProof  ",{body:" .",icon:"/favicon.ico"}):Notification.permission==="default"&&Notification.requestPermission());return}else if(A.status==="FAILED"){it(!1),I.error("    .");return}}catch{}S=Math.min(S*1.5,15e3),rt.current=setTimeout(M,S)};rt.current=setTimeout(M,S)}catch{it(!1),I.error("  .")}},Ws=()=>{Hs()},_s=u=>{if(!u)return;const b=S=>S.replace(/[^a-zA-Z0-9-]/g,""),C=b(u);if(Y.length>0){let S=-1;if(S=Y.findIndex(M=>b(M).includes(C)),S===-1&&C.length>40){const M=C.substring(0,30),A=C.substring(C.length-30);S=Y.findIndex(_=>{const se=b(_);return se.includes(M)&&se.includes(A)})}S!==-1?ce(S,u):I.error("     . (       )")}else{const S=document.querySelector(".novel-text-editor");if(S&&P)if(b(P).indexOf(C)!==-1){const _=P.indexOf(u);if(_!==-1){S.focus(),S.setSelectionRange(_,_+u.length);const se=P.substring(0,_).split(`
`).length;S.scrollTop=(se-1)*24}else I.warning(" ,      .")}else I.error("     .")}},$s=()=>{I.info("   .")},Ds=()=>{ze&&ze.chain().focus().toggleHighlight().run()},Ps=()=>{I.info("   .")},Nn=()=>{H(!0)},It=x.useMemo(()=>R?.characters&&R.characters.length>0?R.characters:[{name:"",first_appearance:0,appearance_count:5,appearances:[0,1,2,3,4],traits:[" "," "]},{name:" ",first_appearance:0,appearance_count:3,appearances:[0,1,3],traits:[""," "]},{name:"",first_appearance:0,appearance_count:1,appearances:[0]}],[R]),Wt=x.useMemo(()=>R?.items&&R.items.length>0?R.items:[{name:"",first_appearance:0},{name:"",first_appearance:0},{name:" ",first_appearance:0}],[R]),_t=x.useMemo(()=>R?.key_events&&R.key_events.length>0?R.key_events:[{summary:"     ",scene_index:0,importance:""},{summary:"    ",scene_index:1,importance:""},{summary:"    ",scene_index:2,importance:""}],[R]),Bs=()=>{if(!(!s||!r)){if(D==="PROCESSING"){I.warning("   .  .");return}I(" ?",{description:"  (,  )   .",action:{label:"",onClick:async()=>{At(!0),Ne("PROCESSING");try{await $r(s,r),I.success("  .   .")}catch{I.error("  "),Ne("FAILED"),At(!1)}}},cancel:{label:"",onClick:()=>{}}})}},$t=x.useMemo(()=>R?.locations&&R.locations.length>0?R.locations:[{name:"",description:"   ",scenes:[0]},{name:" ",description:"   ",scenes:[2]}],[R]),N=Qe.trim().toLowerCase(),Me=x.useMemo(()=>N?It.filter(u=>u.name.toLowerCase().includes(N)||(u.description||"").toLowerCase().includes(N)||(u.traits||[]).some(b=>b.toLowerCase().includes(N))):It,[It,N]),Ee=x.useMemo(()=>N?Wt.filter(u=>u.name.toLowerCase().includes(N)||(u.description||"").toLowerCase().includes(N)):Wt,[Wt,N]),Le=x.useMemo(()=>N?$t.filter(u=>u.name.toLowerCase().includes(N)||(u.description||"").toLowerCase().includes(N)):$t,[$t,N]),He=x.useMemo(()=>N?_t.filter(u=>(u.summary||"").toLowerCase().includes(N)):_t,[_t,N]),Ve=x.useMemo(()=>(R?.relationships||[]).map(u=>({...u,source:u.source||u.character1||"",target:u.target||u.character2||""})),[R]),Dt=x.useMemo(()=>N?Ve.filter(u=>(u.source||"").toLowerCase().includes(N)||(u.target||"").toLowerCase().includes(N)||(u.relation||"").toLowerCase().includes(N)||(u.description||"").toLowerCase().includes(N)):Ve,[Ve,N]),mt=x.useMemo(()=>!N||!R?.scenes?[]:R.scenes.filter(u=>(u.original_text||"").toLowerCase().includes(N)||(u.summary||"").toLowerCase().includes(N)),[R,N]);x.useEffect(()=>($e.current&&clearTimeout($e.current),$e.current=setTimeout(()=>{an(ye)},300),()=>{$e.current&&clearTimeout($e.current)}),[ye]),x.useEffect(()=>()=>{Ue.current&&clearTimeout(Ue.current),Ge.current&&clearTimeout(Ge.current)},[]),x.useEffect(()=>{N&&(Me.length>0&&m(!0),Ee.length>0&&g(!0),Le.length>0&&j(!0),He.length>0&&F(!0))},[N,Me.length,Ee.length,Le.length,He.length]),x.useEffect(()=>{const u=C=>{Nt.current&&!Nt.current.contains(C.target)&&et(!1)},b=C=>{C.key==="Escape"&&Ze&&et(!1)};return document.addEventListener("mousedown",u),document.addEventListener("keydown",b),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",b)}},[Ze]),x.useEffect(()=>{const u=C=>{zt.current&&!zt.current.contains(C.target)&&nt(!1)},b=C=>{C.key==="Escape"&&tt&&nt(!1)};return document.addEventListener("mousedown",u),document.addEventListener("keydown",b),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",b)}},[tt]);const Os=(u,b,C=80)=>{if(!b)return n.jsx("span",{children:u.length>C?u.slice(0,C)+"...":u});const M=u.toLowerCase().indexOf(b.toLowerCase());if(M===-1)return n.jsx("span",{children:u.length>C?u.slice(0,C)+"...":u});const A=Math.max(0,M-20),_=Math.min(u.length,M+b.length+40),se=A>0?"...":"",fe=_<u.length?"...":"",Fs=u.slice(A,M),Us=u.slice(M,M+b.length),Gs=u.slice(M+b.length,_);return n.jsxs("span",{children:[se,Fs,n.jsx("mark",{className:"bible-search-highlight",children:Us}),Gs,fe]})},Pt=async u=>{if(!(!s||!r)){dn(!0),et(!1);try{await Pr(s,r,u,Qe||void 0),I.success(`${u.toUpperCase()}  .`)}catch{I.error(" .")}finally{dn(!1)}}},Bt=async u=>{if(!(!s||!r)){un(!0),nt(!1);try{await Dr(s,r,u),I.success(`${u.toUpperCase()}  .`)}catch{I.error(" .")}finally{un(!1)}}};if(Z&&!W)return n.jsx("div",{className:`chapter-detail-container loading ${d?"sidebar-open":""}`,children:n.jsx("div",{className:"loading-spinner"})});const Ot=async(u,b)=>{if(!s||!r){I.error("/  .");return}pn(!0);try{const S=(await wi({novel_id:s,chapter_id:r,entity_type:u,entity_name:b.name,description:b.description||b.name})).image_url,M=A=>A.map(_=>_.name===b.name?{..._,image:S}:_);pe(A=>{if(!A)return null;const _={...A};return u==="character"&&(_.characters=M(_.characters)),u==="item"&&(_.items=M(_.items)),u==="location"&&(_.locations=M(_.locations)),_}),u==="character"&&B?.name===b.name&&Pe(A=>A?{...A,image:S}:null),u==="item"&&U?.name===b.name&&Be(A=>A?{...A,image:S}:null),u==="location"&&X?.name===b.name&&Fe(A=>A?{...A,image:S}:null),I.success(" !")}catch(C){console.error("Image generation failed:",C),I.error("  .")}finally{pn(!1)}};return n.jsxs("div",{className:`chapter-detail-container ${d?"sidebar-open":""}`,children:[n.jsx("style",{children:`
                @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                .spin-animation { animation: spin 1s linear infinite; }
            `}),n.jsxs("div",{className:"chapter-detail-header",style:{display:"flex",alignItems:"center",padding:"16px 24px",borderBottom:"1px solid var(--border)",backgroundColor:"var(--card)",position:"sticky",top:0,zIndex:10},children:[n.jsx("button",{className:"back-button",onClick:t,style:{marginRight:"16px",padding:"8px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx(Rr,{size:24,color:"var(--muted-foreground)"})}),n.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:"4px"},children:[Re.length>1&&Cn&&n.jsx("button",{onClick:()=>Sn(Cn),title:" ",style:{padding:"4px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",color:"var(--muted-foreground)"},children:n.jsx(Tn,{size:20})}),n.jsx("h1",{className:"chapter-detail-title",style:{fontSize:"1.25rem",fontWeight:600,color:"var(--foreground)",margin:0},children:e}),Re.length>1&&wn&&n.jsx("button",{onClick:()=>Sn(wn),title:" ",style:{padding:"4px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",color:"var(--muted-foreground)"},children:n.jsx(Ut,{size:20})})]}),s&&r&&o!=="reader"&&n.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[n.jsxs("span",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)",whiteSpace:"nowrap"},children:[Cs.toLocaleString(),"  ",Ss.toLocaleString(),""]}),n.jsx("span",{style:{fontSize:"0.75rem",color:Ae?"#D97706":"var(--muted-foreground)",whiteSpace:"nowrap",padding:"2px 8px",borderRadius:"4px",backgroundColor:Ae?"rgba(217, 119, 6, 0.1)":"transparent"},children:T?" ...":Ae?" ":""}),n.jsxs("button",{className:"reanalyze-button",onClick:Bs,disabled:D==="PROCESSING"||D==="PENDING"||ve,title:D==="PROCESSING"||D==="PENDING"?"  ...":"AI ",style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 16px",backgroundColor:D==="PROCESSING"||D==="PENDING"||ve?"var(--muted)":"transparent",color:D==="PROCESSING"||D==="PENDING"||ve?"var(--muted-foreground)":"var(--primary)",border:D==="PROCESSING"||D==="PENDING"||ve?"1px solid var(--border)":"1px solid var(--primary)",borderRadius:"6px",cursor:D==="PROCESSING"||D==="PENDING"||ve?"not-allowed":"pointer",fontSize:"0.9rem",fontWeight:500},children:[n.jsx(gt,{size:16,className:D==="PROCESSING"||D==="PENDING"||ve?"spin-animation":""}),D==="PROCESSING"||D==="PENDING"||ve?" ...":""]}),n.jsxs("button",{className:"save-button",onClick:Lt,disabled:T,style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 16px",backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"6px",cursor:T?"wait":"pointer",fontSize:"0.9rem",fontWeight:500},children:[n.jsx(Tr,{size:18}),T?" ...":""]}),n.jsxs("div",{className:"chapter-export-wrapper",ref:zt,children:[n.jsx("button",{className:"chapter-export-btn",onClick:()=>nt(!tt),disabled:vs,title:" ",children:n.jsx(Mn,{size:16})}),tt&&n.jsxs("div",{className:"chapter-export-dropdown",children:[n.jsxs("button",{onClick:()=>Bt("txt"),className:"export-dropdown-item",children:[n.jsx(Gt,{size:14})," TXT ()"]}),n.jsxs("button",{onClick:()=>Bt("pdf"),className:"export-dropdown-item",children:[n.jsx(Kt,{size:14})," PDF"]}),n.jsxs("button",{onClick:()=>Bt("docx"),className:"export-dropdown-item",children:[n.jsx(Kt,{size:14})," DOCX ()"]})]})]})]})]}),o==="reader"?n.jsx(ai,{editor:ze,readerSettings:Q,onSettingsChange:As,onBookmark:$s,onHighlight:Ds,onAddMemo:Ps}):n.jsx(li,{editor:ze,onOpenSettings:()=>{Nn()}}),n.jsxs("div",{className:"chapter-detail-layout",children:[n.jsxs("div",{className:`dictionary-sidebar ${d?"open":"closed"}`,children:[n.jsxs("div",{className:"bible-toolbar",children:[n.jsxs("div",{className:"bible-search-wrapper",children:[n.jsx(En,{size:14,className:"bible-search-icon"}),n.jsx("input",{type:"text",className:"bible-search-input",placeholder:" ...",value:ye,maxLength:100,onChange:u=>qe(u.target.value)}),ye&&n.jsx("button",{className:"bible-search-clear",onClick:()=>{qe(""),an("")},children:n.jsx(Ie,{size:12})})]}),n.jsxs("div",{className:"export-dropdown-wrapper",ref:Nt,children:[n.jsx("button",{className:"bible-export-btn",onClick:()=>et(!Ze),disabled:cn,title:ye?" ":" ",children:cn?n.jsx(gt,{size:14,className:"spin-animation"}):n.jsx(Mn,{size:14})}),Ze&&n.jsxs("div",{className:"export-dropdown",children:[n.jsxs("button",{onClick:()=>Pt("txt"),className:"export-dropdown-item",children:[n.jsx(Gt,{size:14}),n.jsx("span",{children:"TXT ()"})]}),n.jsxs("button",{onClick:()=>Pt("pdf"),className:"export-dropdown-item",children:[n.jsx(Kt,{size:14}),n.jsx("span",{children:"PDF"})]}),n.jsxs("button",{onClick:()=>Pt("docx"),className:"export-dropdown-item",children:[n.jsx(Gt,{size:14}),n.jsx("span",{children:"DOCX ()"})]})]})]})]}),N&&mt.length>0&&n.jsxs("div",{className:"sidebar-section",children:[n.jsx("div",{className:"section-header active",style:{cursor:"default"},children:n.jsxs("div",{className:"section-header-content",children:[n.jsx(En,{size:18}),n.jsxs("h3",{className:"section-title",children:["  (",mt.length,")"]})]})}),n.jsx("div",{className:"section-content",children:mt.map((u,b)=>n.jsxs("div",{className:"section-item bible-scene-result interactable",onClick:()=>ce(u.scene_index),style:{cursor:"pointer"},children:[n.jsxs("div",{className:"item-name",style:{fontSize:"0.85rem"},children:["Scene ",u.scene_index+1]}),n.jsx("div",{className:"item-description",style:{fontSize:"0.8rem"},children:Os(u.original_text,N,100)})]},b))})]}),N&&mt.length===0&&Me.length===0&&Ee.length===0&&Le.length===0&&He.length===0&&n.jsx("div",{style:{padding:"16px",textAlign:"center",color:"var(--muted-foreground)",fontSize:"0.875rem"},children:"  ."}),n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${f?"active":""}`,onClick:()=>m(!f),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(Qt,{size:18}),n.jsxs("h3",{className:"section-title",children:[" ",N&&`(${Me.length})`]})]}),f?n.jsx(re,{size:18}):n.jsx(ne,{size:18})]}),f&&n.jsx("div",{className:"section-content",children:Je?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:" ..."}):Me.length===0&&N?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Me.map((u,b)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>Pe(u),style:{cursor:"pointer"},children:[n.jsx("div",{className:"item-name",children:u.name}),n.jsx("div",{className:"item-description",children:u.traits&&u.traits.length>0?n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",marginTop:"4px"},children:u.traits.slice(0,3).map((C,S)=>n.jsx("span",{className:"trait-tag",children:C},S))}):typeof u.description=="string"&&u.description?u.description.slice(0,30)+"...":`: ${u.appearance_count}`})]},b))})]}),n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${h?"active":""}`,onClick:()=>g(!h),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(bt,{size:18}),n.jsxs("h3",{className:"section-title",children:[" ",N&&`(${Ee.length})`]})]}),h?n.jsx(re,{size:18}):n.jsx(ne,{size:18})]}),h&&n.jsx("div",{className:"section-content",children:Ee.length===0&&N?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Ee.map((u,b)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>Be(u),style:{cursor:"pointer",display:"flex",alignItems:"flex-start",gap:"8px"},children:[n.jsx("span",{style:{minWidth:"22px",height:"22px",borderRadius:"50%",backgroundColor:"var(--primary, #4F46E5)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.7rem",fontWeight:"bold",flexShrink:0,marginTop:"2px"},children:b+1}),n.jsxs("div",{style:{flex:1},children:[n.jsx("div",{className:"item-name",children:u.name}),n.jsx("div",{className:"item-description",children:typeof u.significance=="string"&&u.significance?u.significance:typeof u.description=="string"&&u.description?u.description:` : ${u.first_appearance+1}`})]})]},b))})]}),n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${v?"active":""}`,onClick:()=>j(!v),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(Ln,{size:18}),n.jsxs("h3",{className:"section-title",children:[" ",N&&`(${Le.length})`]})]}),v?n.jsx(re,{size:18}):n.jsx(ne,{size:18})]}),v&&n.jsx("div",{className:"section-content",children:Le.length===0&&N?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Le.map((u,b)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>Fe(u),style:{cursor:"pointer"},children:[n.jsx("div",{className:"item-name",children:u.name}),n.jsx("div",{className:"item-description",children:typeof u.description=="string"&&u.description?u.description:`: ${u.scenes?.length||0}`})]},b))})]}),Ve.length>0&&n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${L?"active":""}`,onClick:()=>G(!L),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(Mr,{size:18}),n.jsxs("h3",{className:"section-title",children:["  ",N&&`(${Dt.length})`]})]}),L?n.jsx(re,{size:18}):n.jsx(ne,{size:18})]}),L&&n.jsx("div",{className:"section-content",children:Dt.length===0&&N?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Dt.map((u,b)=>n.jsxs("div",{className:"section-item",children:[n.jsxs("div",{className:"item-name",style:{fontSize:"0.9rem"},children:[u.source,"  ",u.target]}),n.jsxs("div",{className:"item-description",children:[n.jsx("span",{className:"trait-tag",children:u.relation||""}),u.description&&n.jsx("span",{style:{marginLeft:"6px"},children:u.description.length>40?u.description.slice(0,40)+"...":u.description})]})]},b))})]}),n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${k?"active":""}`,onClick:()=>F(!k),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(gt,{size:18}),n.jsxs("h3",{className:"section-title",children:["  ",N&&`(${He.length})`]})]}),k?n.jsx(re,{size:18}):n.jsx(ne,{size:18})]}),k&&n.jsx("div",{className:"section-content",children:He.length===0&&N?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):He.map((u,b)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>ct(u),style:{cursor:"pointer"},children:[n.jsx("div",{className:"item-name",style:{fontSize:"0.95rem"},children:u.summary&&u.summary.length>20?u.summary.substring(0,20)+"...":u.summary}),n.jsxs("div",{className:"item-description",children:[u.scene_index!==void 0?`${u.scene_index+1}`:"",u.importance&&`  : ${u.importance}`]})]},b))})]}),R&&Object.keys(R).filter(u=>!["characters","items","timeline","locations","key_events","scenes","relationships","chapter_id"].includes(u)).map(u=>{const b=R[u];if(!Array.isArray(b))return null;const C=Ms[u]??!1;return n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${C?"active":""}`,onClick:()=>Es(S=>({...S,[u]:!S[u]})),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(bt,{size:18})," ",n.jsx("h3",{className:"section-title",children:u.toUpperCase()})]}),C?n.jsx(re,{size:18}):n.jsx(ne,{size:18})]}),C&&n.jsx("div",{className:"section-content",children:b.map((S,M)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>dt({title:u,item:S}),style:{cursor:"pointer"},children:[n.jsx("div",{className:"item-name",children:S.name||S.title||`Item ${M+1}`}),n.jsx("div",{className:"item-description",children:S.description||S.summary||(typeof S=="string"?S:JSON.stringify(S).slice(0,50))})]},M))})]},u)})]}),n.jsx("button",{className:"dictionary-toggle",onClick:()=>p(!d),children:d?n.jsx(Tn,{size:20}):n.jsx(Ut,{size:20})}),n.jsx("div",{className:"text-area",style:{overflow:"hidden",display:"flex",flexDirection:"column"},children:n.jsx("div",{className:"text-content",style:{flex:1,padding:0,height:"100%"},children:Z?n.jsx("div",{style:{padding:"20px",textAlign:"center"},children:" ..."}):Y.length>0?n.jsx("div",{className:"scenes-container",style:{height:"100%",overflowY:"auto",padding:"20px",backgroundColor:o==="reader"?"var(--reader-bg)":"var(--background)"},children:Y.map((u,b)=>n.jsxs("div",{id:`scene-block-${b}`,className:"scene-block",style:{position:"relative",marginBottom:"60px"},children:[n.jsxs("div",{style:{position:"absolute",top:"-12px",left:"10px",fontSize:"12px",fontWeight:"bold",color:"var(--primary)",backgroundColor:"var(--card)",padding:"2px 10px",borderRadius:"12px",border:"1px solid var(--border)",zIndex:5,boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},children:["Scene ",b+1]}),n.jsx("div",{className:"scene-content-wrapper",style:{maxWidth:o==="reader"?`${Q.contentWidth}%`:"100%",margin:o==="reader"?"0 auto":"0"},children:n.jsx(Xn,{content:u.replace(/\n/g,"<br>"),onUpdate:C=>{const S=[...Y];S[b]=C,_e(S),Tt(!0)},onFocus:C=>lt(C),onCreated:C=>{b===0&&!ze&&lt(C)},editable:o!=="reader",placeholder:` ${b+1}  ...`,className:"tiptap-editor-scene",style:o==="reader"?{fontSize:`${Q.fontSize}px`,lineHeight:Q.lineHeight,fontFamily:Q.fontFamily,color:"var(--text-primary)"}:void 0})})]},b))}):n.jsx("div",{style:{maxWidth:o==="reader"?`${Q.contentWidth}%`:"100%",margin:o==="reader"?"0 auto":"0",height:"100%"},children:n.jsx(Xn,{content:P.replace(/\n/g,"<br>"),onUpdate:u=>{q(u),Tt(!0)},onFocus:u=>lt(u),onCreated:u=>{ze||lt(u)},editable:o!=="reader",placeholder:"  ...",className:"tiptap-editor-full",style:o==="reader"?{fontSize:`${Q.fontSize}px`,lineHeight:Q.lineHeight,fontFamily:Q.fontFamily,color:"var(--text-primary)"}:void 0})})})})]}),B&&n.jsx("div",{className:"modal-overlay",onClick:()=>Pe(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:B.name}),n.jsx("button",{onClick:()=>Pe(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(Qt,{size:20})})]}),n.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[B.image?n.jsx("img",{src:B.image,alt:B.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):n.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),n.jsx("button",{onClick:()=>Ot("character",B),disabled:te,style:{padding:"8px 16px",backgroundColor:te?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:te?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:te?" ...":B.image?" ":" "})]}),B.aliases&&B.aliases.length>0&&n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:B.aliases.map((u,b)=>n.jsx("span",{style:{fontSize:"0.8rem",padding:"2px 8px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"12px",color:"var(--muted-foreground, #475569)",border:"1px solid var(--border)",opacity:.9},children:u},b))})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:B.description||"  ."})]}),B.traits&&B.traits.length>0&&n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:B.traits.map((u,b)=>n.jsx("span",{style:{fontSize:"0.8rem",padding:"4px 10px",backgroundColor:"var(--muted, rgba(79, 70, 229, 0.1))",color:"var(--primary, #4F46E5)",borderRadius:"6px",fontWeight:"500",border:"1px solid var(--border)"},children:u},b))})]}),n.jsxs("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"}),n.jsxs("button",{onClick:()=>ce(B.first_appearance,B.name),style:{background:"none",border:"none",color:"var(--primary, #4F46E5)",fontWeight:"bold",cursor:"pointer",textDecoration:"underline",padding:0,fontSize:"inherit"},children:[B.first_appearance+1,""]})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",B.appearance_count,"",B.appearances&&B.appearances.length>0&&n.jsxs("button",{onClick:()=>yn(!ut),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[ut?n.jsx(re,{size:12}):n.jsx(ne,{size:12}),ut?"":" "]})]}),ut&&B.appearances&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:B.appearances.map(u=>n.jsxs("button",{onClick:()=>ce(u,B.name),style:{background:"var(--muted, #f1f5f9)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--muted-foreground, #475569)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",u+1]},u))})]})]})]})}),U&&n.jsx("div",{className:"modal-overlay",onClick:()=>Be(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:U.name}),n.jsx("button",{onClick:()=>Be(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(bt,{size:20})})]}),n.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[U.image?n.jsx("img",{src:U.image,alt:U.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):n.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),n.jsx("button",{onClick:()=>Ot("item",U),disabled:te,style:{padding:"8px 16px",backgroundColor:te?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:te?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:te?" ...":U.image?" ":" "})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:U.description||"  ."})]}),n.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"}),n.jsxs("button",{onClick:()=>ce(U.first_appearance,U.name),style:{background:"none",border:"none",color:"var(--primary, #4F46E5)",fontWeight:"bold",cursor:"pointer",textDecoration:"underline",padding:0,fontSize:"inherit"},children:[U.first_appearance+1,""]})]}),U.appearance_count>0&&n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginTop:"4px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",U.appearance_count,"",U.appearances&&U.appearances.length>0&&n.jsxs("button",{onClick:()=>vn(!pt),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[pt?n.jsx(re,{size:12}):n.jsx(ne,{size:12}),pt?"":" "]})]}),pt&&U.appearances&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:U.appearances.map(u=>n.jsxs("button",{onClick:()=>ce(u,U.name),style:{background:"var(--muted, #f1f5f9)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--muted-foreground, #475569)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",u+1]},u))})]})})]})}),X&&n.jsx("div",{className:"modal-overlay",onClick:()=>Fe(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:X.name}),n.jsx("button",{onClick:()=>Fe(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(Ln,{size:20})})]}),n.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[X.image?n.jsx("img",{src:X.image,alt:X.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):n.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),n.jsx("button",{onClick:()=>Ot("location",X),disabled:te,style:{padding:"8px 16px",backgroundColor:te?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:te?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:te?" ...":X.image?" ":" "})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:X.description||"  ."})]}),n.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",X.appearance_count||(X.scenes?X.scenes.length:0),"",X.scenes&&X.scenes.length>0&&n.jsxs("button",{onClick:()=>jn(!ht),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[ht?n.jsx(re,{size:12}):n.jsx(ne,{size:12}),ht?"":" "]})]}),ht&&X.scenes&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:X.scenes.map(u=>n.jsxs("button",{onClick:()=>ce(u),style:{background:"var(--secondary)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--primary)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",u+1]},u))})]})})]})}),Te&&n.jsx("div",{className:"modal-overlay",onClick:()=>ct(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.25rem",fontWeight:"bold",margin:0,lineHeight:1.4},children:Te.summary}),n.jsx("button",{onClick:()=>ct(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(gt,{size:20})})]}),n.jsx("div",{style:{marginBottom:"24px"},children:Te.importance&&n.jsxs("div",{style:{display:"inline-block",padding:"4px 8px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"4px",fontSize:"0.875rem",fontWeight:"500",color:"var(--muted-foreground, #475569)",marginTop:"8px"},children:[": ",Te.importance]})}),n.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"16px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:n.jsx("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start",width:"100%"},children:n.jsxs("button",{onClick:()=>ce(Te.scene_index),style:{width:"100%",background:"var(--primary, #4F46E5)",border:"none",borderRadius:"6px",padding:"10px 16px",fontSize:"0.95rem",fontWeight:"600",color:"var(--primary-foreground, #ffffff)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",transition:"background 0.2s"},children:[n.jsxs("span",{children:["   (",Te.scene_index+1,")"]}),n.jsx(Ut,{size:16})]})})})]})}),je&&n.jsx("div",{className:"modal-overlay",onClick:()=>dt(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:je.item.name||je.item.title||"Detail"}),n.jsx("button",{onClick:()=>dt(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(bt,{size:20})})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:je.title.toUpperCase()}),n.jsx("div",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0,maxHeight:"300px",overflowY:"auto"},children:je.item.description||je.item.summary||n.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"0.8rem",backgroundColor:"var(--muted, #f1f5f9)",color:"var(--modal-text)",padding:"8px",borderRadius:"4px",border:"1px solid var(--border)"},children:JSON.stringify(je.item,null,2)})})]})]})}),n.jsx(Ir,{}),y&&n.jsx("div",{style:{position:"fixed",bottom:"20px",right:"25px",width:"600px",height:"750px",zIndex:1002,animation:"slideUp 0.3s ease"},children:n.jsx(hi,{onClose:()=>H(!1)})}),n.jsx(fi,{isOpen:Ht,onClose:()=>Oe(!1),result:Ts,isLoading:Rs,onNavigateToQuote:_s,onReanalyze:kn}),n.jsx(xi,{isOpen:Rt,onClose:()=>De(!1),messages:hn,onSendMessage:Is,isLoading:js,onClearChat:()=>{ot([]),s&&vi(s).catch(()=>{})}}),n.jsx(pi,{onNavigateToScene:ce,onCheckConsistency:Ls,onPredictStory:Ws,onOpenCharacterChat:i,onOpenSettings:Nn,onOpenRelGraph:()=>w(!0),novelId:s,chapterId:r,mode:o}),n.jsx(mi,{isOpen:K,onClose:()=>w(!1),relationships:Ve.map(u=>({source:u.source||u.character1,target:u.target||u.character2,relation:u.relation,description:u.description})),characters:R?.characters?.map(u=>({name:u.name,description:u.description,traits:u.traits}))||[]})]})}export{Ri as ChapterDetail};
