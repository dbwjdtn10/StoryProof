import{j as e}from"./tiptap-BONCSYqO.js";import{r as i,t as j}from"./toast-Dj7VaHEs.js";import{r as b}from"./index-XiybRiy6.js";import{A as z,s as T,$ as _,w as E,X as S,l as W,P as D,o as k}from"./icons-DMwvs2NW.js";const L=async(t,a,d)=>b("/character-chat/generate-persona",{method:"POST",body:JSON.stringify({novel_id:t,chapter_id:d,character_name:a})}),M=async(t,a,d,n)=>b("/character-chat/rooms",{method:"POST",body:JSON.stringify({novel_id:t,chapter_id:n,character_name:a,persona_prompt:d})}),I=async(t,a)=>{let d=`/character-chat/rooms?novel_id=${t}`;return a&&(d+=`&chapter_id=${a}`),b(d,{method:"GET"})},O=async(t,a)=>b(`/character-chat/rooms/${t}/messages`,{method:"POST",body:JSON.stringify({content:a})}),A=async t=>b(`/character-chat/rooms/${t}/messages`,{method:"GET"}),P=async(t,a)=>b(`/character-chat/rooms/${t}`,{method:"PUT",body:JSON.stringify({persona_prompt:a})}),B=async t=>b(`/character-chat/rooms/${t}`,{method:"DELETE"});function w({novelId:t,chapterId:a,onClose:d,onCreated:n,onUpdated:x,initialData:c,mode:l="create"}){const[g,h]=i.useState(c?.character_name||""),[f,m]=i.useState(c?.persona_prompt||""),[s,o]=i.useState(l==="edit"?"review":"input"),[p,r]=i.useState(!1),[y,v]=i.useState(null),C=async()=>{if(g.trim()){r(!0),v(null);try{const u=await L(t,g,a);m(u.persona_prompt),o("review")}catch(u){v(u.message||"페르소나 생성 실패")}finally{r(!1)}}},R=async()=>{if(f.trim()){r(!0);try{if(l==="create"){const u=await M(t,g,f,a);n?.(u)}else if(c?.id){const u=await P(c.id,f);x?.(u)}}catch(u){v(u.message||(l==="create"?"대화방 생성 실패":"대화방 수정 실패")),r(!1)}}};return e.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"var(--modal-bg)",color:"var(--modal-text)",zIndex:10,display:"flex",flexDirection:"column",padding:"20px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"20px",alignItems:"center"},children:[e.jsx("h3",{style:{margin:0,fontWeight:"bold"},children:l==="create"?"새 대화 시작":"페르소나 수정"}),e.jsx("button",{onClick:d,style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)"},children:e.jsx(S,{size:20,strokeWidth:2.5})})]}),y&&e.jsx("div",{style:{backgroundColor:"rgba(220, 38, 38, 0.1)",color:"#dc2626",padding:"10px",borderRadius:"8px",marginBottom:"10px",fontSize:"0.9rem",border:"1px solid rgba(220, 38, 38, 0.2)"},children:y}),s==="input"?e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"8px",fontWeight:"bold",fontSize:"0.9rem"},children:"캐릭터 이름"}),e.jsx("input",{type:"text",value:g,onChange:u=>h(u.target.value),placeholder:"예: 셜록 홈즈",style:{width:"100%",padding:"12px",borderRadius:"8px",border:"1px solid var(--input-border)",fontSize:"1rem",backgroundColor:"var(--input-bg)",color:"var(--input-text)"}}),e.jsx("p",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)",marginTop:"4px"},children:"* 분석된 데이터에 있는 캐릭터 이름을 입력하세요."})]}),e.jsx("button",{onClick:C,disabled:p||!g,style:{backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",padding:"14px",borderRadius:"8px",fontWeight:"bold",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",opacity:p?.7:1},children:p?"생성 중...":e.jsxs(e.Fragment,{children:[e.jsx(k,{size:18,strokeWidth:2.5}),"페르소나 생성"]})})]}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px",flex:1},children:[e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[e.jsx("label",{style:{fontWeight:"bold",fontSize:"0.9rem"},children:"페르소나 프롬프트 (수정 가능)"}),e.jsxs("button",{onClick:C,title:"AI 자동 업데이트 (현재 분석 데이터 기반)",style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)",display:"flex",alignItems:"center",gap:"4px",fontSize:"0.8rem"},children:[e.jsx(k,{size:14,strokeWidth:2.5}),"AI 자동 갱신"]})]}),e.jsx("textarea",{value:f,onChange:u=>m(u.target.value),style:{flex:1,width:"100%",padding:"12px",borderRadius:"8px",border:"1px solid var(--input-border)",fontSize:"0.9rem",resize:"none",fontFamily:"monospace",backgroundColor:"var(--input-bg)",color:"var(--input-text)"}})]}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[l!=="edit"&&e.jsx("button",{onClick:()=>o("input"),style:{flex:1,backgroundColor:"var(--secondary)",color:"var(--secondary-foreground)",border:"none",padding:"14px",borderRadius:"8px",fontWeight:"bold",cursor:"pointer"},children:"뒤로"}),e.jsx("button",{onClick:R,disabled:p,style:{flex:2,backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",padding:"14px",borderRadius:"8px",fontWeight:"bold",cursor:"pointer",opacity:p?.7:1},children:p?l==="create"?"생성 중...":"저장 중...":l==="create"?"대화 시작":"수정 저장"})]})]})]})}function N({novelId:t,chapterId:a,onSelectRoom:d}){const[n,x]=i.useState([]),[c,l]=i.useState(!0),[g,h]=i.useState(!1),f=async()=>{try{l(!0);const s=await I(t,a);x(s)}catch(s){console.error("Failed to fetch rooms:",s),j.error("채팅방 목록을 불러오지 못했습니다.")}finally{l(!1)}};i.useEffect(()=>{f()},[t,a]);const m=s=>{x([s,...n]),h(!1),d(s)};return e.jsxs("div",{style:{padding:"16px",height:"100%",overflowY:"auto",backgroundColor:"var(--modal-bg)"},children:[c?e.jsx("div",{style:{textAlign:"center",padding:"20px",color:"var(--muted-foreground)"},children:"로딩 중..."}):n.length===0?e.jsxs("div",{style:{textAlign:"center",marginTop:"100px",color:"var(--muted-foreground)"},children:[e.jsx("p",{children:"대화방이 없습니다."}),e.jsx("p",{children:"새로운 캐릭터와 대화를 시작해보세요!"})]}):e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"12px"},children:n.map(s=>e.jsxs("div",{onClick:()=>d(s),style:{padding:"16px",borderRadius:"12px",backgroundColor:"var(--card)",border:"1px solid var(--border)",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",transition:"background 0.2s",color:"var(--card-foreground)"},onMouseEnter:o=>o.currentTarget.style.backgroundColor="var(--secondary)",onMouseLeave:o=>o.currentTarget.style.backgroundColor="var(--card)",children:[e.jsx("div",{style:{width:"40px",height:"40px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("span",{style:{fontWeight:"bold",color:"var(--secondary-foreground)"},children:s.character_name.charAt(0)})}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:"bold"},children:s.character_name}),e.jsx("div",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)"},children:new Date(s.updated_at||s.created_at).toLocaleDateString()})]})]},s.id))}),e.jsxs("div",{style:{marginTop:"20px",textAlign:"center",fontSize:"0.75rem",color:"var(--muted-foreground)",paddingBottom:"80px"},children:["* 이미 생성된 대화방의 페르소나(Persona)는 ",e.jsx("br",{})," 자동으로 업데이트되지 않습니다."]}),e.jsx("button",{onClick:()=>h(!0),style:{position:"absolute",bottom:"20px",right:"20px",width:"56px",height:"56px",borderRadius:"50%",backgroundColor:"var(--primary)",border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.2)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"var(--primary-foreground)"},children:e.jsx(D,{size:28,strokeWidth:2.5})}),g&&e.jsx(w,{novelId:t,chapterId:a,onClose:()=>h(!1),onCreated:m})]})}function F({room:t}){const[a,d]=i.useState([]),[n,x]=i.useState(""),[c,l]=i.useState(!1),g=i.useRef(null),h=()=>{g.current?.scrollIntoView({behavior:"smooth"})},f=async()=>{try{const o=await A(t.id);d(o),h()}catch(o){console.error("Failed to fetch messages:",o),j.error("메시지 기록을 불러오지 못했습니다.")}};i.useEffect(()=>{f()},[t.id]),i.useEffect(()=>{h()},[a]);const m=async()=>{if(!n.trim()||c)return;const o=n;x(""),l(!0);const p={id:Date.now(),room_id:t.id,role:"user",content:o,created_at:new Date().toISOString()};d(r=>[...r,p]);try{const r=await O(t.id,o);d(y=>[...y.filter(C=>C.id!==p.id),...r])}catch(r){console.error("Failed to send message:",r),d(y=>y.filter(v=>v.id!==p.id)),j.error("메시지 전송 실패"),x(o)}finally{l(!1)}},s=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),m())};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",backgroundColor:"var(--modal-bg)"},children:[e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"16px",display:"flex",flexDirection:"column",gap:"10px"},children:[e.jsx("div",{style:{textAlign:"center",fontSize:"0.8rem",color:"var(--muted-foreground)",marginBottom:"10px",opacity:.8},children:new Date().toLocaleDateString()}),a.map((o,p)=>{const r=o.role==="user";return e.jsxs("div",{style:{display:"flex",justifyContent:r?"flex-end":"flex-start",alignItems:"flex-start",gap:"8px"},children:[!r&&e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"14px",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.8rem",fontWeight:"bold",color:"var(--secondary-foreground)"},children:t.character_name.charAt(0)}),e.jsxs("div",{style:{maxWidth:"75%"},children:[!r&&e.jsx("div",{style:{fontSize:"0.8rem",marginBottom:"4px",color:"var(--muted-foreground)"},children:t.character_name}),e.jsx("div",{style:{backgroundColor:r?"var(--primary)":"var(--chat-assistant-bg)",color:r?"var(--primary-foreground)":"var(--chat-assistant-text)",padding:"10px 14px",borderRadius:r?"12px 0 12px 12px":"0 12px 12px 12px",fontSize:"0.95rem",lineHeight:"1.5",boxShadow:"0 1px 2px rgba(0,0,0,0.05)",whiteSpace:"pre-wrap",wordBreak:"break-word",border:r?"none":"1px solid var(--border)"},children:o.content}),e.jsx("div",{style:{fontSize:"0.7rem",color:"var(--muted-foreground)",marginTop:"4px",textAlign:r?"right":"left"},children:new Date(o.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]},o.id||p)}),c&&e.jsx("div",{style:{display:"flex",justifyContent:"flex-start",paddingLeft:"44px"},children:e.jsx("div",{style:{backgroundColor:"var(--input-bg)",padding:"8px 12px",borderRadius:"12px",fontSize:"0.8rem",color:"var(--muted-foreground)",border:"1px solid var(--border)"},children:"..."})}),e.jsx("div",{ref:g})]}),e.jsxs("div",{style:{backgroundColor:"var(--modal-bg)",padding:"10px",display:"flex",gap:"8px",borderTop:"1px solid var(--border)"},children:[e.jsx("textarea",{value:n,onChange:o=>x(o.target.value),onKeyDown:s,placeholder:"메시지를 입력하세요...",maxLength:500,style:{flex:1,border:"1px solid var(--input-border)",borderRadius:"8px",padding:"10px",resize:"none",height:"44px",fontFamily:"inherit",backgroundColor:"var(--input-bg)",color:"var(--input-text)"}}),e.jsx("button",{onClick:m,disabled:c||!n.trim(),style:{backgroundColor:"var(--primary)",border:"none",borderRadius:"8px",width:"50px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--primary-foreground)",opacity:c||!n.trim()?.5:1},children:e.jsx(W,{size:18,strokeWidth:2.5})})]})]})}function G({onClose:t,novelId:a,chapterId:d}){const[n,x]=i.useState(null),[c,l]=i.useState(!1),[g,h]=i.useState(!1),[f,m]=i.useState(0),s=i.useRef(null);i.useEffect(()=>{function r(y){s.current&&!s.current.contains(y.target)&&l(!1)}return document.addEventListener("mousedown",r),()=>{document.removeEventListener("mousedown",r)}},[]);const o=()=>{n&&j("정말로 이 대화방을 삭제하시겠습니까?",{action:{label:"삭제",onClick:async()=>{try{await B(n.id),x(null),l(!1),m(r=>r+1)}catch(r){console.error("Failed to delete room:",r),j.error("대화방 삭제 실패")}}},cancel:{label:"취소",onClick:()=>{}}})},p=r=>{x(r),h(!1)};return e.jsxs("div",{className:"character-chat-window",style:{position:"fixed",bottom:"16px",right:"20px",width:"600px",height:"850px",backgroundColor:"var(--modal-bg)",borderRadius:"16px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",display:"flex",flexDirection:"column",zIndex:1001,overflow:"hidden",border:"2px solid var(--modal-border)"},children:[e.jsxs("div",{className:"chat-header",style:{padding:"16px",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)",display:"flex",justifyContent:"space-between",alignItems:"center",fontWeight:"bold",position:"relative",borderBottom:"1px solid var(--border)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n&&e.jsx("button",{onClick:()=>x(null),style:{background:"none",border:"none",cursor:"pointer",padding:0},children:e.jsx(z,{size:20,color:"currentColor",strokeWidth:2.5})}),e.jsx("span",{children:n?n.character_name:"캐릭터 대화"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n&&e.jsxs("div",{style:{position:"relative"},ref:s,children:[e.jsx("button",{onClick:()=>l(!c),style:{background:"none",border:"none",cursor:"pointer",display:"flex",color:"currentColor"},children:e.jsx(T,{size:20,strokeWidth:2.5})}),c&&e.jsxs("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",backgroundColor:"var(--popover)",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:10,minWidth:"150px",overflow:"hidden",border:"1px solid var(--border)"},children:[e.jsxs("button",{onClick:()=>{h(!0),l(!1)},style:{display:"flex",alignItems:"center",gap:"8px",width:"100%",padding:"12px 16px",border:"none",background:"transparent",cursor:"pointer",textAlign:"left",fontSize:"0.9rem",color:"var(--popover-foreground)"},onMouseEnter:r=>r.currentTarget.style.backgroundColor="var(--secondary)",onMouseLeave:r=>r.currentTarget.style.backgroundColor="transparent",children:[e.jsx(_,{size:16,strokeWidth:2.5}),"페르소나 수정"]}),e.jsxs("button",{onClick:o,style:{display:"flex",alignItems:"center",gap:"8px",width:"100%",padding:"12px 16px",border:"none",background:"transparent",cursor:"pointer",textAlign:"left",fontSize:"0.9rem",color:"var(--destructive)",borderTop:"1px solid var(--border)"},onMouseEnter:r=>r.currentTarget.style.backgroundColor="var(--secondary)",onMouseLeave:r=>r.currentTarget.style.backgroundColor="transparent",children:[e.jsx(E,{size:16,strokeWidth:2.5}),"채팅방 삭제"]})]})]}),e.jsx("button",{onClick:t,style:{background:"none",border:"none",cursor:"pointer",color:"currentColor"},children:e.jsx(S,{size:20,strokeWidth:2.5})})]})]}),e.jsx("div",{style:{flex:1,overflow:"hidden",display:"flex",flexDirection:"column"},children:n?e.jsx(F,{room:n}):e.jsx(N,{novelId:a,chapterId:d,onSelectRoom:x},f)}),g&&n&&e.jsx(w,{novelId:a,chapterId:d,initialData:n,mode:"edit",onClose:()=>h(!1),onUpdated:p})]})}export{G as CharacterChatBot};
