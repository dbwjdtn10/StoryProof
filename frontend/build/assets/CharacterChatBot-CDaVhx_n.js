import{j as e}from"./tiptap-BONCSYqO.js";import{r as s,t as C}from"./toast-Dj7VaHEs.js";import{r as b,a as W}from"./index-B9RkMDX7.js";import{A as D,t as L,a2 as M,D as O,X as R,j as A,P as B,q as w}from"./icons-C9JiLwBK.js";const I=async(t,n,c)=>b("/character-chat/generate-persona",{method:"POST",body:JSON.stringify({novel_id:t,chapter_id:c,character_name:n})}),P=async(t,n,c,a)=>b("/character-chat/rooms",{method:"POST",body:JSON.stringify({novel_id:t,chapter_id:a,character_name:n,persona_prompt:c})}),N=async(t,n)=>{let c=`/character-chat/rooms?novel_id=${t}`;return n&&(c+=`&chapter_id=${n}`),b(c,{method:"GET"})},F=async(t,n)=>b(`/character-chat/rooms/${t}/messages`,{method:"POST",body:JSON.stringify({content:n})}),$=async t=>b(`/character-chat/rooms/${t}/messages`,{method:"GET"}),K=async(t,n)=>b(`/character-chat/rooms/${t}`,{method:"PUT",body:JSON.stringify({persona_prompt:n})}),U=async t=>b(`/character-chat/rooms/${t}`,{method:"DELETE"});function z({novelId:t,chapterId:n,onClose:c,onCreated:a,onUpdated:h,initialData:p,mode:d="create"}){const[x,u]=s.useState(p?.character_name||""),[f,m]=s.useState(p?.persona_prompt||""),[i,o]=s.useState(d==="edit"?"review":"input"),[g,r]=s.useState(!1),[y,v]=s.useState(null),[j,T]=s.useState([]);s.useEffect(()=>{d!=="edit"&&W(t,n||0).then(l=>{const k=(l?.characters||[]).map(_=>_.name).filter(Boolean);T(k),k.length>0&&!x&&u(k[0])}).catch(()=>{})},[t,n,d]);const S=async()=>{if(x.trim()){r(!0),v(null);try{const l=await I(t,x,n);m(l.persona_prompt),o("review")}catch(l){v(l.message||"페르소나 생성 실패")}finally{r(!1)}}},E=async()=>{if(f.trim()){r(!0);try{if(d==="create"){const l=await P(t,x,f,n);a?.(l)}else if(p?.id){const l=await K(p.id,f);h?.(l)}}catch(l){v(l.message||(d==="create"?"대화방 생성 실패":"대화방 수정 실패")),r(!1)}}};return e.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"var(--modal-bg)",color:"var(--modal-text)",zIndex:10,display:"flex",flexDirection:"column",padding:"20px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"20px",alignItems:"center"},children:[e.jsx("h3",{style:{margin:0,fontWeight:"bold"},children:d==="create"?"새 대화 시작":"페르소나 수정"}),e.jsx("button",{onClick:c,style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)"},children:e.jsx(R,{size:20,strokeWidth:2.5})})]}),y&&e.jsx("div",{style:{backgroundColor:"rgba(220, 38, 38, 0.1)",color:"#dc2626",padding:"10px",borderRadius:"8px",marginBottom:"10px",fontSize:"0.9rem",border:"1px solid rgba(220, 38, 38, 0.2)"},children:y}),i==="input"?e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"8px",fontWeight:"bold",fontSize:"0.9rem"},children:"캐릭터 선택"}),j.length>0?e.jsx("select",{value:x,onChange:l=>u(l.target.value),style:{width:"100%",padding:"12px",borderRadius:"8px",border:"1px solid var(--input-border)",fontSize:"1rem",backgroundColor:"var(--input-bg)",color:"var(--input-text)",cursor:"pointer"},children:j.map(l=>e.jsx("option",{value:l,children:l},l))}):e.jsx("input",{type:"text",value:x,onChange:l=>u(l.target.value),placeholder:"예: 셜록 홈즈",maxLength:100,style:{width:"100%",padding:"12px",borderRadius:"8px",border:"1px solid var(--input-border)",fontSize:"1rem",backgroundColor:"var(--input-bg)",color:"var(--input-text)"}}),e.jsx("p",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)",marginTop:"4px"},children:j.length>0?"* 바이블에서 추출된 인물 목록입니다.":"* 바이블 데이터가 없습니다. 이름을 직접 입력하세요."})]}),e.jsx("button",{onClick:S,disabled:g||!x,style:{backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",padding:"14px",borderRadius:"8px",fontWeight:"bold",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",opacity:g?.7:1},children:g?"생성 중...":e.jsxs(e.Fragment,{children:[e.jsx(w,{size:18,strokeWidth:2.5}),"페르소나 생성"]})})]}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px",flex:1},children:[e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[e.jsx("label",{style:{fontWeight:"bold",fontSize:"0.9rem"},children:"페르소나 프롬프트 (수정 가능)"}),e.jsxs("button",{onClick:S,title:"AI 자동 업데이트 (현재 분석 데이터 기반)",style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)",display:"flex",alignItems:"center",gap:"4px",fontSize:"0.8rem"},children:[e.jsx(w,{size:14,strokeWidth:2.5}),"AI 자동 갱신"]})]}),e.jsx("textarea",{value:f,onChange:l=>m(l.target.value),maxLength:2e3,style:{flex:1,width:"100%",padding:"12px",borderRadius:"8px",border:"1px solid var(--input-border)",fontSize:"0.9rem",resize:"none",fontFamily:"monospace",backgroundColor:"var(--input-bg)",color:"var(--input-text)"}})]}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[d!=="edit"&&e.jsx("button",{onClick:()=>o("input"),style:{flex:1,backgroundColor:"var(--secondary)",color:"var(--secondary-foreground)",border:"none",padding:"14px",borderRadius:"8px",fontWeight:"bold",cursor:"pointer"},children:"뒤로"}),e.jsx("button",{onClick:E,disabled:g,style:{flex:2,backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",padding:"14px",borderRadius:"8px",fontWeight:"bold",cursor:"pointer",opacity:g?.7:1},children:g?d==="create"?"생성 중...":"저장 중...":d==="create"?"대화 시작":"수정 저장"})]})]})]})}function J({novelId:t,chapterId:n,onSelectRoom:c}){const[a,h]=s.useState([]),[p,d]=s.useState(!0),[x,u]=s.useState(!1),f=async()=>{try{d(!0);const i=await N(t,n);h(i)}catch(i){console.error("Failed to fetch rooms:",i),C.error("채팅방 목록을 불러오지 못했습니다.")}finally{d(!1)}};s.useEffect(()=>{f()},[t,n]);const m=i=>{h([i,...a]),u(!1),c(i)};return e.jsxs("div",{style:{padding:"16px",height:"100%",overflowY:"auto",backgroundColor:"var(--modal-bg)"},children:[p?e.jsx("div",{style:{textAlign:"center",padding:"20px",color:"var(--muted-foreground)"},children:"로딩 중..."}):a.length===0?e.jsxs("div",{style:{textAlign:"center",marginTop:"100px",color:"var(--muted-foreground)"},children:[e.jsx("p",{children:"대화방이 없습니다."}),e.jsx("p",{children:"새로운 캐릭터와 대화를 시작해보세요!"})]}):e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"12px"},children:a.map(i=>e.jsxs("div",{onClick:()=>c(i),style:{padding:"16px",borderRadius:"12px",backgroundColor:"var(--card)",border:"1px solid var(--border)",cursor:"pointer",display:"flex",alignItems:"center",gap:"12px",transition:"background 0.2s",color:"var(--card-foreground)"},onMouseEnter:o=>o.currentTarget.style.backgroundColor="var(--secondary)",onMouseLeave:o=>o.currentTarget.style.backgroundColor="var(--card)",children:[e.jsx("div",{style:{width:"40px",height:"40px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("span",{style:{fontWeight:"bold",color:"var(--secondary-foreground)"},children:i.character_name.charAt(0)})}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:"bold"},children:i.character_name}),e.jsx("div",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)"},children:new Date(i.updated_at||i.created_at).toLocaleDateString()})]})]},i.id))}),e.jsxs("div",{style:{marginTop:"20px",textAlign:"center",fontSize:"0.75rem",color:"var(--muted-foreground)",paddingBottom:"80px"},children:["* 이미 생성된 대화방의 페르소나(Persona)는 ",e.jsx("br",{})," 자동으로 업데이트되지 않습니다."]}),e.jsx("button",{onClick:()=>u(!0),style:{position:"absolute",bottom:"20px",right:"20px",width:"56px",height:"56px",borderRadius:"50%",backgroundColor:"var(--primary)",border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.2)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"var(--primary-foreground)"},children:e.jsx(B,{size:28,strokeWidth:2.5})}),x&&e.jsx(z,{novelId:t,chapterId:n,onClose:()=>u(!1),onCreated:m})]})}function q({room:t}){const[n,c]=s.useState([]),[a,h]=s.useState(""),[p,d]=s.useState(!1),x=s.useRef(null),u=()=>{x.current?.scrollIntoView({behavior:"smooth"})},f=async()=>{try{const o=await $(t.id);c(o),u()}catch(o){console.error("Failed to fetch messages:",o),C.error("메시지 기록을 불러오지 못했습니다.")}};s.useEffect(()=>{f()},[t.id]),s.useEffect(()=>{u()},[n]);const m=async()=>{if(!a.trim()||p)return;const o=a;h(""),d(!0);const g={id:Date.now(),room_id:t.id,role:"user",content:o,created_at:new Date().toISOString()};c(r=>[...r,g]);try{const r=await F(t.id,o);c(y=>[...y.filter(j=>j.id!==g.id),...r])}catch(r){console.error("Failed to send message:",r),c(y=>y.filter(v=>v.id!==g.id)),C.error("메시지 전송 실패"),h(o)}finally{d(!1)}},i=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),m())};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",backgroundColor:"var(--modal-bg)"},children:[e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"16px",display:"flex",flexDirection:"column",gap:"10px"},children:[e.jsx("div",{style:{textAlign:"center",fontSize:"0.8rem",color:"var(--muted-foreground)",marginBottom:"10px",opacity:.8},children:new Date().toLocaleDateString()}),n.map((o,g)=>{const r=o.role==="user";return e.jsxs("div",{style:{display:"flex",justifyContent:r?"flex-end":"flex-start",alignItems:"flex-start",gap:"8px"},children:[!r&&e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"14px",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.8rem",fontWeight:"bold",color:"var(--secondary-foreground)"},children:t.character_name.charAt(0)}),e.jsxs("div",{style:{maxWidth:"75%"},children:[!r&&e.jsx("div",{style:{fontSize:"0.8rem",marginBottom:"4px",color:"var(--muted-foreground)"},children:t.character_name}),e.jsx("div",{style:{backgroundColor:r?"var(--primary)":"var(--chat-assistant-bg)",color:r?"var(--primary-foreground)":"var(--chat-assistant-text)",padding:"10px 14px",borderRadius:r?"12px 0 12px 12px":"0 12px 12px 12px",fontSize:"0.95rem",lineHeight:"1.5",boxShadow:"0 1px 2px rgba(0,0,0,0.05)",whiteSpace:"pre-wrap",wordBreak:"break-word",border:r?"none":"1px solid var(--border)"},children:o.content}),e.jsx("div",{style:{fontSize:"0.7rem",color:"var(--muted-foreground)",marginTop:"4px",textAlign:r?"right":"left"},children:new Date(o.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]},o.id||g)}),p&&e.jsx("div",{style:{display:"flex",justifyContent:"flex-start",paddingLeft:"44px"},children:e.jsx("div",{style:{backgroundColor:"var(--input-bg)",padding:"8px 12px",borderRadius:"12px",fontSize:"0.8rem",color:"var(--muted-foreground)",border:"1px solid var(--border)"},children:"..."})}),e.jsx("div",{ref:x})]}),e.jsxs("div",{style:{backgroundColor:"var(--modal-bg)",padding:"10px",display:"flex",gap:"8px",borderTop:"1px solid var(--border)"},children:[e.jsx("textarea",{value:a,onChange:o=>h(o.target.value),onKeyDown:i,placeholder:"메시지를 입력하세요...",maxLength:500,style:{flex:1,border:"1px solid var(--input-border)",borderRadius:"8px",padding:"10px",resize:"none",height:"44px",fontFamily:"inherit",backgroundColor:"var(--input-bg)",color:"var(--input-text)"}}),e.jsx("button",{onClick:m,disabled:p||!a.trim(),style:{backgroundColor:"var(--primary)",border:"none",borderRadius:"8px",width:"50px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--primary-foreground)",opacity:p||!a.trim()?.5:1},children:e.jsx(A,{size:18,strokeWidth:2.5})})]})]})}function X({onClose:t,novelId:n,chapterId:c}){const[a,h]=s.useState(null),[p,d]=s.useState(!1),[x,u]=s.useState(!1),[f,m]=s.useState(0),i=s.useRef(null);s.useEffect(()=>{function r(y){i.current&&!i.current.contains(y.target)&&d(!1)}return document.addEventListener("mousedown",r),()=>{document.removeEventListener("mousedown",r)}},[]);const o=()=>{a&&C("정말로 이 대화방을 삭제하시겠습니까?",{action:{label:"삭제",onClick:async()=>{try{await U(a.id),h(null),d(!1),m(r=>r+1)}catch(r){console.error("Failed to delete room:",r),C.error("대화방 삭제 실패")}}},cancel:{label:"취소",onClick:()=>{}}})},g=r=>{h(r),u(!1)};return e.jsxs("div",{className:"character-chat-window",style:{position:"fixed",bottom:"16px",right:"20px",width:"600px",height:"850px",backgroundColor:"var(--modal-bg)",borderRadius:"16px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",display:"flex",flexDirection:"column",zIndex:1001,overflow:"hidden",border:"2px solid var(--modal-border)"},children:[e.jsxs("div",{className:"chat-header",style:{padding:"16px",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)",display:"flex",justifyContent:"space-between",alignItems:"center",fontWeight:"bold",position:"relative",borderBottom:"1px solid var(--border)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[a&&e.jsx("button",{onClick:()=>h(null),style:{background:"none",border:"none",cursor:"pointer",padding:0},children:e.jsx(D,{size:20,color:"currentColor",strokeWidth:2.5})}),e.jsx("span",{children:a?a.character_name:"캐릭터 대화"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[a&&e.jsxs("div",{style:{position:"relative"},ref:i,children:[e.jsx("button",{onClick:()=>d(!p),style:{background:"none",border:"none",cursor:"pointer",display:"flex",color:"currentColor"},children:e.jsx(L,{size:20,strokeWidth:2.5})}),p&&e.jsxs("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",backgroundColor:"var(--popover)",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:10,minWidth:"150px",overflow:"hidden",border:"1px solid var(--border)"},children:[e.jsxs("button",{onClick:()=>{u(!0),d(!1)},style:{display:"flex",alignItems:"center",gap:"8px",width:"100%",padding:"12px 16px",border:"none",background:"transparent",cursor:"pointer",textAlign:"left",fontSize:"0.9rem",color:"var(--popover-foreground)"},onMouseEnter:r=>r.currentTarget.style.backgroundColor="var(--secondary)",onMouseLeave:r=>r.currentTarget.style.backgroundColor="transparent",children:[e.jsx(M,{size:16,strokeWidth:2.5}),"페르소나 수정"]}),e.jsxs("button",{onClick:o,style:{display:"flex",alignItems:"center",gap:"8px",width:"100%",padding:"12px 16px",border:"none",background:"transparent",cursor:"pointer",textAlign:"left",fontSize:"0.9rem",color:"var(--destructive)",borderTop:"1px solid var(--border)"},onMouseEnter:r=>r.currentTarget.style.backgroundColor="var(--secondary)",onMouseLeave:r=>r.currentTarget.style.backgroundColor="transparent",children:[e.jsx(O,{size:16,strokeWidth:2.5}),"채팅방 삭제"]})]})]}),e.jsx("button",{onClick:t,style:{background:"none",border:"none",cursor:"pointer",color:"currentColor"},children:e.jsx(R,{size:20,strokeWidth:2.5})})]})]}),e.jsx("div",{style:{flex:1,overflow:"hidden",display:"flex",flexDirection:"column"},children:a?e.jsx(q,{room:a}):e.jsx(J,{novelId:n,chapterId:c,onSelectRoom:h},f)}),x&&a&&e.jsx(z,{novelId:n,chapterId:c,initialData:a,mode:"edit",onClose:()=>u(!1),onUpdated:g})]})}export{X as CharacterChatBot};
