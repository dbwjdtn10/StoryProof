import{j as e}from"./tiptap-BONCSYqO.js";import{r as p,t as f}from"./toast-Dj7VaHEs.js";import{m as O,b as $,T as L,h as G,i as _,c as q}from"./index-Dodc19a6.js";import{W as w,Y as X,Z as H,_ as K,X as Y,K as Z}from"./icons-DT4WnWtV.js";function J({novelId:C,onSuccess:a}){const[h,n]=p.useState(!1),[u,m]=p.useState([]),[j,S]=p.useState(!1);return{isMergeMode:h,selectedSourceIds:u,isMerging:j,toggleMergeMode:()=>{n(r=>!r),h&&m([])},handleFileSelect:r=>{h&&m(g=>g.includes(r)?g.filter(y=>y!==r):[...g,r])},executeMerge:()=>{if(!C||u.length<2){f.error("합칠 파일을 2개 이상 선택해 주세요.");return}f(`${u.length}개의 파일을 병합하시겠습니까?`,{description:"병합 후 원본 파일들은 삭제됩니다.",action:{label:"병합",onClick:async()=>{S(!0);try{const r=u[0],g=u.slice(1),y=await O(C,r,g);f.success("파일이 성공적으로 병합되었습니다."),n(!1),m([]),a&&a(y.id)}catch(r){console.error("Merge failed:",r),f.error("파일 병합에 실패했습니다.")}finally{S(!1)}}},cancel:{label:"취소",onClick:()=>{}}})},cancelMerge:()=>{n(!1),m([])},setIsMergeMode:n,setSelectedSourceIds:m}}function te({onFileClick:C,novelId:a,mode:h="writer"}){const[n,u]=p.useState([]),[m,j]=p.useState(!1),[S,F]=p.useState({}),v=p.useRef(null),l=p.useRef({}),{isMergeMode:c,selectedSourceIds:r,isMerging:g,toggleMergeMode:y,handleFileSelect:T,executeMerge:z,cancelMerge:R}=J({novelId:a,onSuccess:()=>{M()}}),D=async t=>{if(a)try{const s=await q(a,t);F(i=>({...i,[t]:s}));const o=s.status?.toUpperCase();(o==="COMPLETED"||o==="FAILED")&&l.current[t]!==void 0&&(clearTimeout(l.current[t]),delete l.current[t])}catch{}},E=t=>{l.current[t]&&(clearTimeout(l.current[t]),delete l.current[t]);let s=2e3;const o=async()=>{await D(t),l.current[t]!==void 0&&(s=Math.min(s*1.5,15e3),l.current[t]=setTimeout(o,s))};o()};p.useEffect(()=>()=>{Object.values(l.current).forEach(clearTimeout),l.current={}},[]),p.useEffect(()=>{a&&M()},[a]);const M=async()=>{if(a)try{const t=await $(a);u(t),t.forEach(s=>{const o=s.storyboard_status?.toUpperCase();(o==="PROCESSING"||o==="PENDING")&&E(s.id)})}catch(t){console.error("Failed to load chapters:",t)}},N=t=>{t.preventDefault(),t.stopPropagation(),t.type==="dragenter"||t.type==="dragover"?j(!0):t.type==="dragleave"&&j(!1)},P=t=>{t.preventDefault(),t.stopPropagation(),j(!1),t.dataTransfer.files&&t.dataTransfer.files[0]&&k(t.dataTransfer.files)},A=t=>{t.target.files&&t.target.files[0]&&k(t.target.files),t.target.value=""},k=async t=>{if(!a){f.error("소설 정보가 없습니다. 다시 로그인해주세요.");return}const s=Array.from(t);let o=n.reduce((i,d)=>Math.max(i,d.chapter_number||0),0);for(const i of s)try{o++;const d=o,b=i.name,x=await _(a,i,d,b);E(x.id)}catch(d){f.error(`${i.name} 업로드 실패: ${d.message||"알 수 없는 오류"}`)}M()},W=t=>{a&&f("이 파일을 정말 삭제하시겠습니까?",{action:{label:"삭제",onClick:async()=>{try{await G(a,t),u(s=>s.filter(o=>o.id!==t))}catch{f.error("파일 삭제 실패")}}},cancel:{label:"취소",onClick:()=>{}}})},B=()=>{v.current?.click()};return e.jsxs("div",{className:"upload-container",onDragEnter:N,onDragLeave:N,onDragOver:N,onDrop:P,children:[m&&e.jsx("div",{className:"drag-overlay",children:e.jsxs("div",{className:"drag-overlay-content",children:[e.jsx(w,{size:64}),e.jsx("p",{children:"파일을 여기에 놓으세요"})]})}),e.jsx("input",{ref:v,id:"file-upload-input",type:"file",className:"upload-input",onChange:A,multiple:!0,accept:".pdf,.doc,.docx,.txt"}),!c&&e.jsx("button",{className:"floating-upload-btn",onClick:B,title:"파일 업로드",children:e.jsx(w,{size:24})}),e.jsx("div",{className:"upload-main",children:e.jsxs("div",{className:"upload-content",children:[e.jsx("div",{className:"upload-header",style:{textAlign:"center",justifyContent:"center"},children:e.jsxs("div",{children:[e.jsx("h1",{className:"upload-title",children:h==="reader"?"작품 라이브러리":"파일 업로드"}),e.jsx("p",{className:"upload-subtitle",children:"StoryProof"})]})}),n.length===0&&e.jsx("div",{className:"upload-area",children:e.jsxs("label",{htmlFor:"file-upload-input",className:"upload-label",style:{cursor:"pointer"},children:[e.jsx(w,{size:48,className:"upload-icon"}),e.jsx("p",{className:"upload-text-main",children:h==="reader"?"작품 파일을 추가하여 읽기 시작하기":"파일을 드래그하거나 클릭하여 업로드"}),e.jsx("p",{className:"upload-text-sub",children:"PDF, HWP, TXT 파일 지원"})]})}),n.length>0&&e.jsxs("div",{className:"uploaded-files-section",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[e.jsx("h2",{className:"uploaded-files-title",style:{marginBottom:0},children:c?"병합할 파일 선택":"업로드된 파일"}),h==="writer"&&n.length>1&&e.jsx("div",{children:c?e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsx("button",{onClick:R,style:{padding:"8px 16px",borderRadius:"8px",border:"1px solid #e5e7eb",backgroundColor:"white",cursor:"pointer",color:"#6b7280",fontSize:"14px"},children:"취소"}),e.jsx("button",{onClick:z,disabled:r.length<2||g,style:{padding:"8px 16px",borderRadius:"8px",border:"none",backgroundColor:r.length<2?"#e5e7eb":"#4F46E5",cursor:r.length<2?"not-allowed":"pointer",color:r.length<2?"#9ca3af":"white",fontSize:"14px",fontWeight:600},children:g?"병합 중...":`${r.length}개 병합`})]}):e.jsxs("button",{onClick:y,className:"merge-toggle-btn",style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 16px",borderRadius:"8px",border:"1px solid #e5e7eb",backgroundColor:"white",cursor:"pointer",fontWeight:500,color:"#374151",fontSize:"14px"},children:[e.jsx(X,{size:16}),"파일 병합"]})})]}),e.jsx("div",{className:"uploaded-files-grid",children:n.map(t=>{const s=S[t.id],o=s?.status?.toUpperCase(),i=o==="PROCESSING",d=o==="COMPLETED",b=o==="FAILED",x=r.includes(t.id);return e.jsxs("div",{className:`uploaded-file-card ${x?"selected":""}`,onClick:()=>{c?T(t.id):i||C(t)},style:{cursor:c?"pointer":i?"wait":"pointer",border:x?"2px solid #4F46E5":"1px solid #e5e7eb",position:"relative"},children:[c&&e.jsxs("div",{style:{position:"absolute",top:"12px",left:"12px",color:x?"#4F46E5":"#9ca3af",display:"flex",alignItems:"center",gap:"4px"},children:[x?e.jsx(H,{size:20}):e.jsx(K,{size:20}),x&&e.jsx("span",{style:{fontSize:"12px",fontWeight:"bold",backgroundColor:"#4F46E5",color:"white",width:"20px",height:"20px",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center"},children:r.indexOf(t.id)+1})]}),!c&&e.jsx("button",{className:"file-remove-btn",onClick:U=>{U.stopPropagation(),W(t.id)},disabled:i,children:e.jsx(Y,{size:16})}),e.jsx(Z,{size:40,className:"file-icon",style:{color:x?"#4F46E5":void 0}}),e.jsx("p",{className:"file-name",children:t.title}),c&&x&&r[0]===t.id&&e.jsx("span",{style:{fontSize:"10px",backgroundColor:"#EEF2FF",color:"#4F46E5",padding:"2px 6px",borderRadius:"4px",marginTop:"4px"},children:"대표(저장) 파일"}),!c&&s&&e.jsxs("div",{style:{marginTop:"8px",width:"100%"},children:[e.jsx("div",{style:{textAlign:"center",marginBottom:"8px"},children:e.jsx("span",{style:{display:"inline-block",fontSize:"11px",fontWeight:600,padding:"4px 8px",borderRadius:"4px",backgroundColor:b?"#ffe0e0":d?"#e0ffe0":"#e0e8ff",color:b?"#ff6b6b":d?"#51cf66":"#4c6ef5"},children:b?"❌ 실패":d?"✅ 완료":"⏳ 처리 중"})}),i&&e.jsx("div",{style:{textAlign:"center",marginBottom:"6px"},children:e.jsxs("span",{style:{fontSize:"13px",color:"#333",fontWeight:600},children:[s.progress,"%"]})}),s.message&&e.jsx("div",{style:{textAlign:"center",marginBottom:"6px"},children:e.jsx("span",{style:{fontSize:"11px",color:"#666",fontWeight:500},children:s.message})}),i&&e.jsx("div",{style:{width:"100%",height:"5px",backgroundColor:"#e0e0e0",borderRadius:"3px",overflow:"hidden",marginBottom:"4px"},children:e.jsx("div",{style:{height:"100%",width:`${s.progress}%`,backgroundColor:"#4c6ef5",transition:"width 0.3s ease",borderRadius:"3px",boxShadow:"0 0 10px rgba(76, 110, 245, 0.5)"}})}),d&&e.jsx("div",{style:{width:"100%",height:"5px",backgroundColor:"#51cf66",borderRadius:"3px",boxShadow:"0 0 10px rgba(81, 207, 102, 0.5)"}}),b&&e.jsxs("div",{children:[e.jsx("div",{style:{width:"100%",height:"5px",backgroundColor:"#ff6b6b",borderRadius:"3px",boxShadow:"0 0 10px rgba(255, 107, 107, 0.5)",marginBottom:"4px"}}),s.error&&e.jsx("div",{style:{textAlign:"center",marginTop:"4px"},children:e.jsx("span",{style:{fontSize:"10px",color:"#ff6b6b",fontWeight:500},children:s.error})})]})]})]},t.id)})})]})]})}),e.jsx(L,{})]})}export{te as FileUpload};
