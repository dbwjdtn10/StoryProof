import{M as nr,m as $e,E as he,a as Jr,b as qr,N as xt,n as Qr,R as Zr,P as rr,c as mn,S as je,d as es,T as Ae,F as fe,e as Re,D as rn,f as sn,k as ts,g as ns,h as rs,i as ss,l as os,o as is,u as ls,U as as,p as cs,q as ds,H as ps,r as us,s as fs,j as n,t as hs}from"./tiptap-BONCSYqO.js";import{r as x,R as An,t as _}from"./toast-Dj7VaHEs.js";import{T as ms,c as xs,P as gs,d as ht,e as ys,f as Rn,g as bs,h as on,i as sr,j as de,k as re,l as ln,m as Tn,n as or,o as ir,B as lr,p as an,N as ar,q as vs,r as Dt,s as js,t as Cs,X as qe,u as ws,v as xn,w as Ss,R as ks,x as Mn,y as zs,z as Ns,D as As,F as Rs,G as Ts,U as Ms,H as En,A as Es,I as Zt,J as Mt,K as Ws,O as Wn,Q as en,V as tn,W as Ln,Y as Et,Z as _n,_ as Ls}from"./icons-qUjtFtOR.js";import{g as cr,A as _s,u as dr,r as pe,a as Hs,b as Is,c as $s,T as Ds,d as Bs,e as Ps,f as Fs,h as Os,i as Us}from"./index-Bsj232xZ.js";var Ks=20,pr=(e,t=0)=>{const r=[];return!e.children.length||t>Ks||Array.from(e.children).forEach(s=>{s.tagName==="SPAN"?r.push(s):s.children.length&&r.push(...pr(s,t+1))}),r},Vs=e=>{if(!e.children.length)return;const t=pr(e);t&&t.forEach(r=>{var s,o;const i=r.getAttribute("style"),l=(o=(s=r.parentElement)==null?void 0:s.closest("span"))==null?void 0:o.getAttribute("style");r.setAttribute("style",`${l};${i}`)})},ur=nr.create({name:"textStyle",priority:101,addOptions(){return{HTMLAttributes:{},mergeNestedSpanStyles:!0}},parseHTML(){return[{tag:"span",consuming:!1,getAttrs:e=>e.hasAttribute("style")?(this.options.mergeNestedSpanStyles&&Vs(e),{}):!1}]},renderHTML({HTMLAttributes:e}){return["span",$e(this.options.HTMLAttributes,e),0]},addCommands(){return{toggleTextStyle:e=>({commands:t})=>t.toggleMark(this.name,e),removeEmptyTextStyle:()=>({tr:e})=>{const{selection:t}=e;return e.doc.nodesBetween(t.from,t.to,(r,s)=>{if(r.isTextblock)return!0;r.marks.filter(o=>o.type===this.type).some(o=>Object.values(o.attrs).some(i=>!!i))||e.removeMark(s,s+r.nodeSize,this.type)}),!0}}}}),Ys=he.create({name:"backgroundColor",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{backgroundColor:{default:null,parseHTML:e=>{var t;const r=e.getAttribute("style");if(r){const s=r.split(";").map(o=>o.trim()).filter(Boolean);for(let o=s.length-1;o>=0;o-=1){const i=s[o].split(":");if(i.length>=2){const l=i[0].trim().toLowerCase(),c=i.slice(1).join(":").trim();if(l==="background-color")return c.replace(/['"]+/g,"")}}}return(t=e.style.backgroundColor)==null?void 0:t.replace(/['"]+/g,"")},renderHTML:e=>e.backgroundColor?{style:`background-color: ${e.backgroundColor}`}:{}}}}]},addCommands(){return{setBackgroundColor:e=>({chain:t})=>t().setMark("textStyle",{backgroundColor:e}).run(),unsetBackgroundColor:()=>({chain:e})=>e().setMark("textStyle",{backgroundColor:null}).removeEmptyTextStyle().run()}}}),fr=he.create({name:"color",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{color:{default:null,parseHTML:e=>{var t;const r=e.getAttribute("style");if(r){const s=r.split(";").map(o=>o.trim()).filter(Boolean);for(let o=s.length-1;o>=0;o-=1){const i=s[o].split(":");if(i.length>=2){const l=i[0].trim().toLowerCase(),c=i.slice(1).join(":").trim();if(l==="color")return c.replace(/['"]+/g,"")}}}return(t=e.style.color)==null?void 0:t.replace(/['"]+/g,"")},renderHTML:e=>e.color?{style:`color: ${e.color}`}:{}}}}]},addCommands(){return{setColor:e=>({chain:t})=>t().setMark("textStyle",{color:e}).run(),unsetColor:()=>({chain:e})=>e().setMark("textStyle",{color:null}).removeEmptyTextStyle().run()}}}),hr=he.create({name:"fontFamily",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontFamily:{default:null,parseHTML:e=>e.style.fontFamily,renderHTML:e=>e.fontFamily?{style:`font-family: ${e.fontFamily}`}:{}}}}]},addCommands(){return{setFontFamily:e=>({chain:t})=>t().setMark("textStyle",{fontFamily:e}).run(),unsetFontFamily:()=>({chain:e})=>e().setMark("textStyle",{fontFamily:null}).removeEmptyTextStyle().run()}}}),Gs=he.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:e=>e.style.fontSize,renderHTML:e=>e.fontSize?{style:`font-size: ${e.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:e=>({chain:t})=>t().setMark("textStyle",{fontSize:e}).run(),unsetFontSize:()=>({chain:e})=>e().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),Xs=he.create({name:"lineHeight",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:null,parseHTML:e=>e.style.lineHeight,renderHTML:e=>e.lineHeight?{style:`line-height: ${e.lineHeight}`}:{}}}}]},addCommands(){return{setLineHeight:e=>({chain:t})=>t().setMark("textStyle",{lineHeight:e}).run(),unsetLineHeight:()=>({chain:e})=>e().setMark("textStyle",{lineHeight:null}).removeEmptyTextStyle().run()}}});he.create({name:"textStyleKit",addExtensions(){const e=[];return this.options.backgroundColor!==!1&&e.push(Ys.configure(this.options.backgroundColor)),this.options.color!==!1&&e.push(fr.configure(this.options.color)),this.options.fontFamily!==!1&&e.push(hr.configure(this.options.fontFamily)),this.options.fontSize!==!1&&e.push(Gs.configure(this.options.fontSize)),this.options.lineHeight!==!1&&e.push(Xs.configure(this.options.lineHeight)),this.options.textStyle!==!1&&e.push(ur.configure(this.options.textStyle)),e}});var Js=he.create({name:"textAlign",addOptions(){return{types:[],alignments:["left","center","right","justify"],defaultAlignment:null}},addGlobalAttributes(){return[{types:this.options.types,attributes:{textAlign:{default:this.options.defaultAlignment,parseHTML:e=>{const t=e.style.textAlign;return this.options.alignments.includes(t)?t:this.options.defaultAlignment},renderHTML:e=>e.textAlign?{style:`text-align: ${e.textAlign}`}:{}}}}]},addCommands(){return{setTextAlign:e=>({commands:t})=>this.options.alignments.includes(e)?this.options.types.map(r=>t.updateAttributes(r,{textAlign:e})).some(r=>r):!1,unsetTextAlign:()=>({commands:e})=>this.options.types.map(t=>e.resetAttributes(t,"textAlign")).some(t=>t),toggleTextAlign:e=>({editor:t,commands:r})=>this.options.alignments.includes(e)?t.isActive({textAlign:e})?r.unsetTextAlign():r.setTextAlign(e):!1}},addKeyboardShortcuts(){return{"Mod-Shift-l":()=>this.editor.commands.setTextAlign("left"),"Mod-Shift-e":()=>this.editor.commands.setTextAlign("center"),"Mod-Shift-r":()=>this.editor.commands.setTextAlign("right"),"Mod-Shift-j":()=>this.editor.commands.setTextAlign("justify")}}}),qs=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))$/,Qs=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))/g,Zs=nr.create({name:"highlight",addOptions(){return{multicolor:!1,HTMLAttributes:{}}},addAttributes(){return this.options.multicolor?{color:{default:null,parseHTML:e=>e.getAttribute("data-color")||e.style.backgroundColor,renderHTML:e=>e.color?{"data-color":e.color,style:`background-color: ${e.color}; color: inherit`}:{}}}:{}},parseHTML(){return[{tag:"mark"}]},renderHTML({HTMLAttributes:e}){return["mark",$e(this.options.HTMLAttributes,e),0]},renderMarkdown:(e,t)=>`==${t.renderChildren(e)}==`,parseMarkdown:(e,t)=>t.applyMark("highlight",t.parseInline(e.tokens||[])),markdownTokenizer:{name:"highlight",level:"inline",start:e=>e.indexOf("=="),tokenize(e,t,r){const o=/^(==)([^=]+)(==)/.exec(e);if(o){const i=o[2].trim(),l=r.inlineTokens(i);return{type:"highlight",raw:o[0],text:i,tokens:l}}}},addCommands(){return{setHighlight:e=>({commands:t})=>t.setMark(this.name,e),toggleHighlight:e=>({commands:t})=>t.toggleMark(this.name,e),unsetHighlight:()=>({commands:e})=>e.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-h":()=>this.editor.commands.toggleHighlight()}},addInputRules(){return[qr({find:qs,type:this.type})]},addPasteRules(){return[Jr({find:Qs,type:this.type})]}}),eo=/(?:^|\s)(!\[(.+|:?)]\((\S+)(?:(?:\s+)["'](\S+)["'])?\))$/,to=xt.create({name:"image",addOptions(){return{inline:!1,allowBase64:!1,HTMLAttributes:{},resize:!1}},inline(){return this.options.inline},group(){return this.options.inline?"inline":"block"},draggable:!0,addAttributes(){return{src:{default:null},alt:{default:null},title:{default:null},width:{default:null},height:{default:null}}},parseHTML(){return[{tag:this.options.allowBase64?"img[src]":'img[src]:not([src^="data:"])'}]},renderHTML({HTMLAttributes:e}){return["img",$e(this.options.HTMLAttributes,e)]},parseMarkdown:(e,t)=>t.createNode("image",{src:e.href,title:e.title,alt:e.text}),renderMarkdown:e=>{var t,r,s,o,i,l;const c=(r=(t=e.attrs)==null?void 0:t.src)!=null?r:"",a=(o=(s=e.attrs)==null?void 0:s.alt)!=null?o:"",d=(l=(i=e.attrs)==null?void 0:i.title)!=null?l:"";return d?`![${a}](${c} "${d}")`:`![${a}](${c})`},addNodeView(){if(!this.options.resize||!this.options.resize.enabled||typeof document>"u")return null;const{directions:e,minWidth:t,minHeight:r,alwaysPreserveAspectRatio:s}=this.options.resize;return({node:o,getPos:i,HTMLAttributes:l,editor:c})=>{const a=document.createElement("img");Object.entries(l).forEach(([f,h])=>{if(h!=null)switch(f){case"width":case"height":break;default:a.setAttribute(f,h);break}}),a.src=l.src;const d=new Zr({element:a,editor:c,node:o,getPos:i,onResize:(f,h)=>{a.style.width=`${f}px`,a.style.height=`${h}px`},onCommit:(f,h)=>{const m=i();m!==void 0&&this.editor.chain().setNodeSelection(m).updateAttributes(this.name,{width:f,height:h}).run()},onUpdate:(f,h,m)=>f.type===o.type,options:{directions:e,min:{width:t,height:r},preserveAspectRatio:s===!0}}),p=d.dom;return p.style.visibility="hidden",p.style.pointerEvents="none",a.onload=()=>{p.style.visibility="",p.style.pointerEvents=""},d}},addCommands(){return{setImage:e=>({commands:t})=>t.insertContent({type:this.name,attrs:e})}},addInputRules(){return[Qr({find:eo,type:this.type,getAttributes:e=>{const[,,t,r,s]=e;return{src:r,alt:t,title:s}}})]}});let cn,dn;if(typeof WeakMap<"u"){let e=new WeakMap;cn=t=>e.get(t),dn=(t,r)=>(e.set(t,r),r)}else{const e=[];let r=0;cn=s=>{for(let o=0;o<e.length;o+=2)if(e[o]==s)return e[o+1]},dn=(s,o)=>(r==10&&(r=0),e[r++]=s,e[r++]=o)}var K=class{constructor(e,t,r,s){this.width=e,this.height=t,this.map=r,this.problems=s}findCell(e){for(let t=0;t<this.map.length;t++){const r=this.map[t];if(r!=e)continue;const s=t%this.width,o=t/this.width|0;let i=s+1,l=o+1;for(let c=1;i<this.width&&this.map[t+c]==r;c++)i++;for(let c=1;l<this.height&&this.map[t+this.width*c]==r;c++)l++;return{left:s,top:o,right:i,bottom:l}}throw new RangeError(`No cell with offset ${e} found`)}colCount(e){for(let t=0;t<this.map.length;t++)if(this.map[t]==e)return t%this.width;throw new RangeError(`No cell with offset ${e} found`)}nextCell(e,t,r){const{left:s,right:o,top:i,bottom:l}=this.findCell(e);return t=="horiz"?(r<0?s==0:o==this.width)?null:this.map[i*this.width+(r<0?s-1:o)]:(r<0?i==0:l==this.height)?null:this.map[s+this.width*(r<0?i-1:l)]}rectBetween(e,t){const{left:r,right:s,top:o,bottom:i}=this.findCell(e),{left:l,right:c,top:a,bottom:d}=this.findCell(t);return{left:Math.min(r,l),top:Math.min(o,a),right:Math.max(s,c),bottom:Math.max(i,d)}}cellsInRect(e){const t=[],r={};for(let s=e.top;s<e.bottom;s++)for(let o=e.left;o<e.right;o++){const i=s*this.width+o,l=this.map[i];r[l]||(r[l]=!0,!(o==e.left&&o&&this.map[i-1]==l||s==e.top&&s&&this.map[i-this.width]==l)&&t.push(l))}return t}positionAt(e,t,r){for(let s=0,o=0;;s++){const i=o+r.child(s).nodeSize;if(s==e){let l=t+e*this.width;const c=(e+1)*this.width;for(;l<c&&this.map[l]<o;)l++;return l==c?i-1:this.map[l]}o=i}}static get(e){return cn(e)||dn(e,no(e))}};function no(e){if(e.type.spec.tableRole!="table")throw new RangeError("Not a table node: "+e.type.name);const t=ro(e),r=e.childCount,s=[];let o=0,i=null;const l=[];for(let d=0,p=t*r;d<p;d++)s[d]=0;for(let d=0,p=0;d<r;d++){const f=e.child(d);p++;for(let g=0;;g++){for(;o<s.length&&s[o]!=0;)o++;if(g==f.childCount)break;const b=f.child(g),{colspan:v,rowspan:w,colwidth:z}=b.attrs;for(let M=0;M<w;M++){if(M+d>=r){(i||(i=[])).push({type:"overlong_rowspan",pos:p,n:w-M});break}const W=o+M*t;for(let V=0;V<v;V++){s[W+V]==0?s[W+V]=p:(i||(i=[])).push({type:"collision",row:d,pos:p,n:v-V});const X=z&&z[V];if(X){const D=(W+V)%t*2,le=l[D];le==null||le!=X&&l[D+1]==1?(l[D]=X,l[D+1]=1):le==X&&l[D+1]++}}}o+=v,p+=b.nodeSize}const h=(d+1)*t;let m=0;for(;o<h;)s[o++]==0&&m++;m&&(i||(i=[])).push({type:"missing",row:d,n:m}),p++}(t===0||r===0)&&(i||(i=[])).push({type:"zero_sized"});const c=new K(t,r,s,i);let a=!1;for(let d=0;!a&&d<l.length;d+=2)l[d]!=null&&l[d+1]<r&&(a=!0);return a&&so(c,l,e),c}function ro(e){let t=-1,r=!1;for(let s=0;s<e.childCount;s++){const o=e.child(s);let i=0;if(r)for(let l=0;l<s;l++){const c=e.child(l);for(let a=0;a<c.childCount;a++){const d=c.child(a);l+d.attrs.rowspan>s&&(i+=d.attrs.colspan)}}for(let l=0;l<o.childCount;l++){const c=o.child(l);i+=c.attrs.colspan,c.attrs.rowspan>1&&(r=!0)}t==-1?t=i:t!=i&&(t=Math.max(t,i))}return t}function so(e,t,r){e.problems||(e.problems=[]);const s={};for(let o=0;o<e.map.length;o++){const i=e.map[o];if(s[i])continue;s[i]=!0;const l=r.nodeAt(i);if(!l)throw new RangeError(`No cell with offset ${i} found`);let c=null;const a=l.attrs;for(let d=0;d<a.colspan;d++){const p=t[(o+d)%e.width*2];p!=null&&(!a.colwidth||a.colwidth[d]!=p)&&((c||(c=oo(a)))[d]=p)}c&&e.problems.unshift({type:"colwidth mismatch",pos:i,colwidth:c})}}function oo(e){if(e.colwidth)return e.colwidth.slice();const t=[];for(let r=0;r<e.colspan;r++)t.push(0);return t}function Q(e){let t=e.cached.tableNodeTypes;if(!t){t=e.cached.tableNodeTypes={};for(const r in e.nodes){const s=e.nodes[r],o=s.spec.tableRole;o&&(t[o]=s)}}return t}const Ne=new mn("selectingCells");function He(e){for(let t=e.depth-1;t>0;t--)if(e.node(t).type.spec.tableRole=="row")return e.node(0).resolve(e.before(t+1));return null}function io(e){for(let t=e.depth;t>0;t--){const r=e.node(t).type.spec.tableRole;if(r==="cell"||r==="header_cell")return e.node(t)}return null}function ue(e){const t=e.selection.$head;for(let r=t.depth;r>0;r--)if(t.node(r).type.spec.tableRole=="row")return!0;return!1}function Bt(e){const t=e.selection;if("$anchorCell"in t&&t.$anchorCell)return t.$anchorCell.pos>t.$headCell.pos?t.$anchorCell:t.$headCell;if("node"in t&&t.node&&t.node.type.spec.tableRole=="cell")return t.$anchor;const r=He(t.$head)||lo(t.$head);if(r)return r;throw new RangeError(`No cell found around position ${t.head}`)}function lo(e){for(let t=e.nodeAfter,r=e.pos;t;t=t.firstChild,r++){const s=t.type.spec.tableRole;if(s=="cell"||s=="header_cell")return e.doc.resolve(r)}for(let t=e.nodeBefore,r=e.pos;t;t=t.lastChild,r--){const s=t.type.spec.tableRole;if(s=="cell"||s=="header_cell")return e.doc.resolve(r-t.nodeSize)}}function pn(e){return e.parent.type.spec.tableRole=="row"&&!!e.nodeAfter}function ao(e){return e.node(0).resolve(e.pos+e.nodeAfter.nodeSize)}function gn(e,t){return e.depth==t.depth&&e.pos>=t.start(-1)&&e.pos<=t.end(-1)}function mr(e,t,r){const s=e.node(-1),o=K.get(s),i=e.start(-1),l=o.nextCell(e.pos-i,t,r);return l==null?null:e.node(0).resolve(i+l)}function Ie(e,t,r=1){const s={...e,colspan:e.colspan-r};return s.colwidth&&(s.colwidth=s.colwidth.slice(),s.colwidth.splice(t,r),s.colwidth.some(o=>o>0)||(s.colwidth=null)),s}function xr(e,t,r=1){const s={...e,colspan:e.colspan+r};if(s.colwidth){s.colwidth=s.colwidth.slice();for(let o=0;o<r;o++)s.colwidth.splice(t,0,0)}return s}function co(e,t,r){const s=Q(t.type.schema).header_cell;for(let o=0;o<e.height;o++)if(t.nodeAt(e.map[r+o*e.width]).type!=s)return!1;return!0}var $=class ve extends je{constructor(t,r=t){const s=t.node(-1),o=K.get(s),i=t.start(-1),l=o.rectBetween(t.pos-i,r.pos-i),c=t.node(0),a=o.cellsInRect(l).filter(p=>p!=r.pos-i);a.unshift(r.pos-i);const d=a.map(p=>{const f=s.nodeAt(p);if(!f)throw new RangeError(`No cell with offset ${p} found`);const h=i+p+1;return new es(c.resolve(h),c.resolve(h+f.content.size))});super(d[0].$from,d[0].$to,d),this.$anchorCell=t,this.$headCell=r}map(t,r){const s=t.resolve(r.map(this.$anchorCell.pos)),o=t.resolve(r.map(this.$headCell.pos));if(pn(s)&&pn(o)&&gn(s,o)){const i=this.$anchorCell.node(-1)!=s.node(-1);return i&&this.isRowSelection()?ve.rowSelection(s,o):i&&this.isColSelection()?ve.colSelection(s,o):new ve(s,o)}return Ae.between(s,o)}content(){const t=this.$anchorCell.node(-1),r=K.get(t),s=this.$anchorCell.start(-1),o=r.rectBetween(this.$anchorCell.pos-s,this.$headCell.pos-s),i={},l=[];for(let a=o.top;a<o.bottom;a++){const d=[];for(let p=a*r.width+o.left,f=o.left;f<o.right;f++,p++){const h=r.map[p];if(i[h])continue;i[h]=!0;const m=r.findCell(h);let g=t.nodeAt(h);if(!g)throw new RangeError(`No cell with offset ${h} found`);const b=o.left-m.left,v=m.right-o.right;if(b>0||v>0){let w=g.attrs;if(b>0&&(w=Ie(w,0,b)),v>0&&(w=Ie(w,w.colspan-v,v)),m.left<o.left){if(g=g.type.createAndFill(w),!g)throw new RangeError(`Could not create cell with attrs ${JSON.stringify(w)}`)}else g=g.type.create(w,g.content)}if(m.top<o.top||m.bottom>o.bottom){const w={...g.attrs,rowspan:Math.min(m.bottom,o.bottom)-Math.max(m.top,o.top)};m.top<o.top?g=g.type.createAndFill(w):g=g.type.create(w,g.content)}d.push(g)}l.push(t.child(a).copy(fe.from(d)))}const c=this.isColSelection()&&this.isRowSelection()?t:l;return new Re(fe.from(c),1,1)}replace(t,r=Re.empty){const s=t.steps.length,o=this.ranges;for(let l=0;l<o.length;l++){const{$from:c,$to:a}=o[l],d=t.mapping.slice(s);t.replace(d.map(c.pos),d.map(a.pos),l?Re.empty:r)}const i=je.findFrom(t.doc.resolve(t.mapping.slice(s).map(this.to)),-1);i&&t.setSelection(i)}replaceWith(t,r){this.replace(t,new Re(fe.from(r),0,0))}forEachCell(t){const r=this.$anchorCell.node(-1),s=K.get(r),o=this.$anchorCell.start(-1),i=s.cellsInRect(s.rectBetween(this.$anchorCell.pos-o,this.$headCell.pos-o));for(let l=0;l<i.length;l++)t(r.nodeAt(i[l]),o+i[l])}isColSelection(){const t=this.$anchorCell.index(-1),r=this.$headCell.index(-1);if(Math.min(t,r)>0)return!1;const s=t+this.$anchorCell.nodeAfter.attrs.rowspan,o=r+this.$headCell.nodeAfter.attrs.rowspan;return Math.max(s,o)==this.$headCell.node(-1).childCount}static colSelection(t,r=t){const s=t.node(-1),o=K.get(s),i=t.start(-1),l=o.findCell(t.pos-i),c=o.findCell(r.pos-i),a=t.node(0);return l.top<=c.top?(l.top>0&&(t=a.resolve(i+o.map[l.left])),c.bottom<o.height&&(r=a.resolve(i+o.map[o.width*(o.height-1)+c.right-1]))):(c.top>0&&(r=a.resolve(i+o.map[c.left])),l.bottom<o.height&&(t=a.resolve(i+o.map[o.width*(o.height-1)+l.right-1]))),new ve(t,r)}isRowSelection(){const t=this.$anchorCell.node(-1),r=K.get(t),s=this.$anchorCell.start(-1),o=r.colCount(this.$anchorCell.pos-s),i=r.colCount(this.$headCell.pos-s);if(Math.min(o,i)>0)return!1;const l=o+this.$anchorCell.nodeAfter.attrs.colspan,c=i+this.$headCell.nodeAfter.attrs.colspan;return Math.max(l,c)==r.width}eq(t){return t instanceof ve&&t.$anchorCell.pos==this.$anchorCell.pos&&t.$headCell.pos==this.$headCell.pos}static rowSelection(t,r=t){const s=t.node(-1),o=K.get(s),i=t.start(-1),l=o.findCell(t.pos-i),c=o.findCell(r.pos-i),a=t.node(0);return l.left<=c.left?(l.left>0&&(t=a.resolve(i+o.map[l.top*o.width])),c.right<o.width&&(r=a.resolve(i+o.map[o.width*(c.top+1)-1]))):(c.left>0&&(r=a.resolve(i+o.map[c.top*o.width])),l.right<o.width&&(t=a.resolve(i+o.map[o.width*(l.top+1)-1]))),new ve(t,r)}toJSON(){return{type:"cell",anchor:this.$anchorCell.pos,head:this.$headCell.pos}}static fromJSON(t,r){return new ve(t.resolve(r.anchor),t.resolve(r.head))}static create(t,r,s=r){return new ve(t.resolve(r),t.resolve(s))}getBookmark(){return new po(this.$anchorCell.pos,this.$headCell.pos)}};$.prototype.visible=!1;je.jsonID("cell",$);var po=class gr{constructor(t,r){this.anchor=t,this.head=r}map(t){return new gr(t.map(this.anchor),t.map(this.head))}resolve(t){const r=t.resolve(this.anchor),s=t.resolve(this.head);return r.parent.type.spec.tableRole=="row"&&s.parent.type.spec.tableRole=="row"&&r.index()<r.parent.childCount&&s.index()<s.parent.childCount&&gn(r,s)?new $(r,s):je.near(s,1)}};function uo(e){if(!(e.selection instanceof $))return null;const t=[];return e.selection.forEachCell((r,s)=>{t.push(sn.node(s,s+r.nodeSize,{class:"selectedCell"}))}),rn.create(e.doc,t)}function fo({$from:e,$to:t}){if(e.pos==t.pos||e.pos<t.pos-6)return!1;let r=e.pos,s=t.pos,o=e.depth;for(;o>=0&&!(e.after(o+1)<e.end(o));o--,r++);for(let i=t.depth;i>=0&&!(t.before(i+1)>t.start(i));i--,s--);return r==s&&/row|table/.test(e.node(o).type.spec.tableRole)}function ho({$from:e,$to:t}){let r,s;for(let o=e.depth;o>0;o--){const i=e.node(o);if(i.type.spec.tableRole==="cell"||i.type.spec.tableRole==="header_cell"){r=i;break}}for(let o=t.depth;o>0;o--){const i=t.node(o);if(i.type.spec.tableRole==="cell"||i.type.spec.tableRole==="header_cell"){s=i;break}}return r!==s&&t.parentOffset===0}function mo(e,t,r){const s=(t||e).selection,o=(t||e).doc;let i,l;if(s instanceof ns&&(l=s.node.type.spec.tableRole)){if(l=="cell"||l=="header_cell")i=$.create(o,s.from);else if(l=="row"){const c=o.resolve(s.from+1);i=$.rowSelection(c,c)}else if(!r){const c=K.get(s.node),a=s.from+1,d=a+c.map[c.width*c.height-1];i=$.create(o,a+1,d)}}else s instanceof Ae&&fo(s)?i=Ae.create(o,s.from):s instanceof Ae&&ho(s)&&(i=Ae.create(o,s.$from.start(),s.$from.end()));return i&&(t||(t=e.tr)).setSelection(i),t}const xo=new mn("fix-tables");function yr(e,t,r,s){const o=e.childCount,i=t.childCount;e:for(let l=0,c=0;l<i;l++){const a=t.child(l);for(let d=c,p=Math.min(o,l+3);d<p;d++)if(e.child(d)==a){c=d+1,r+=a.nodeSize;continue e}s(a,r),c<o&&e.child(c).sameMarkup(a)?yr(e.child(c),a,r+1,s):a.nodesBetween(0,a.content.size,s,r+1),r+=a.nodeSize}}function br(e,t){let r;const s=(o,i)=>{o.type.spec.tableRole=="table"&&(r=go(e,o,i,r))};return t?t.doc!=e.doc&&yr(t.doc,e.doc,0,s):e.doc.descendants(s),r}function go(e,t,r,s){const o=K.get(t);if(!o.problems)return s;s||(s=e.tr);const i=[];for(let a=0;a<o.height;a++)i.push(0);for(let a=0;a<o.problems.length;a++){const d=o.problems[a];if(d.type=="collision"){const p=t.nodeAt(d.pos);if(!p)continue;const f=p.attrs;for(let h=0;h<f.rowspan;h++)i[d.row+h]+=d.n;s.setNodeMarkup(s.mapping.map(r+1+d.pos),null,Ie(f,f.colspan-d.n,d.n))}else if(d.type=="missing")i[d.row]+=d.n;else if(d.type=="overlong_rowspan"){const p=t.nodeAt(d.pos);if(!p)continue;s.setNodeMarkup(s.mapping.map(r+1+d.pos),null,{...p.attrs,rowspan:p.attrs.rowspan-d.n})}else if(d.type=="colwidth mismatch"){const p=t.nodeAt(d.pos);if(!p)continue;s.setNodeMarkup(s.mapping.map(r+1+d.pos),null,{...p.attrs,colwidth:d.colwidth})}else if(d.type=="zero_sized"){const p=s.mapping.map(r);s.delete(p,p+t.nodeSize)}}let l,c;for(let a=0;a<i.length;a++)i[a]&&(l==null&&(l=a),c=a);for(let a=0,d=r+1;a<o.height;a++){const p=t.child(a),f=d+p.nodeSize,h=i[a];if(h>0){let m="cell";p.firstChild&&(m=p.firstChild.type.spec.tableRole);const g=[];for(let v=0;v<h;v++){const w=Q(e.schema)[m].createAndFill();w&&g.push(w)}const b=(a==0||l==a-1)&&c==a?d+1:f-1;s.insert(s.mapping.map(b),g)}d=f}return s.setMeta(xo,{fixTables:!0})}function me(e){const t=e.selection,r=Bt(e),s=r.node(-1),o=r.start(-1),i=K.get(s);return{...t instanceof $?i.rectBetween(t.$anchorCell.pos-o,t.$headCell.pos-o):i.findCell(r.pos-o),tableStart:o,map:i,table:s}}function vr(e,{map:t,tableStart:r,table:s},o){let i=o>0?-1:0;co(t,s,o+i)&&(i=o==0||o==t.width?null:0);for(let l=0;l<t.height;l++){const c=l*t.width+o;if(o>0&&o<t.width&&t.map[c-1]==t.map[c]){const a=t.map[c],d=s.nodeAt(a);e.setNodeMarkup(e.mapping.map(r+a),null,xr(d.attrs,o-t.colCount(a))),l+=d.attrs.rowspan-1}else{const a=i==null?Q(s.type.schema).cell:s.nodeAt(t.map[c+i]).type,d=t.positionAt(l,o,s);e.insert(e.mapping.map(r+d),a.createAndFill())}}return e}function yo(e,t){if(!ue(e))return!1;if(t){const r=me(e);t(vr(e.tr,r,r.left))}return!0}function bo(e,t){if(!ue(e))return!1;if(t){const r=me(e);t(vr(e.tr,r,r.right))}return!0}function vo(e,{map:t,table:r,tableStart:s},o){const i=e.mapping.maps.length;for(let l=0;l<t.height;){const c=l*t.width+o,a=t.map[c],d=r.nodeAt(a),p=d.attrs;if(o>0&&t.map[c-1]==a||o<t.width-1&&t.map[c+1]==a)e.setNodeMarkup(e.mapping.slice(i).map(s+a),null,Ie(p,o-t.colCount(a)));else{const f=e.mapping.slice(i).map(s+a);e.delete(f,f+d.nodeSize)}l+=p.rowspan}}function jo(e,t){if(!ue(e))return!1;if(t){const r=me(e),s=e.tr;if(r.left==0&&r.right==r.map.width)return!1;for(let o=r.right-1;vo(s,r,o),o!=r.left;o--){const i=r.tableStart?s.doc.nodeAt(r.tableStart-1):s.doc;if(!i)throw new RangeError("No table found");r.table=i,r.map=K.get(i)}t(s)}return!0}function Co(e,t,r){var s;const o=Q(t.type.schema).header_cell;for(let i=0;i<e.width;i++)if(((s=t.nodeAt(e.map[i+r*e.width]))===null||s===void 0?void 0:s.type)!=o)return!1;return!0}function jr(e,{map:t,tableStart:r,table:s},o){let i=r;for(let d=0;d<o;d++)i+=s.child(d).nodeSize;const l=[];let c=o>0?-1:0;Co(t,s,o+c)&&(c=o==0||o==t.height?null:0);for(let d=0,p=t.width*o;d<t.width;d++,p++)if(o>0&&o<t.height&&t.map[p]==t.map[p-t.width]){const f=t.map[p],h=s.nodeAt(f).attrs;e.setNodeMarkup(r+f,null,{...h,rowspan:h.rowspan+1}),d+=h.colspan-1}else{var a;const f=c==null?Q(s.type.schema).cell:(a=s.nodeAt(t.map[p+c*t.width]))===null||a===void 0?void 0:a.type,h=f?.createAndFill();h&&l.push(h)}return e.insert(i,Q(s.type.schema).row.create(null,l)),e}function wo(e,t){if(!ue(e))return!1;if(t){const r=me(e);t(jr(e.tr,r,r.top))}return!0}function So(e,t){if(!ue(e))return!1;if(t){const r=me(e);t(jr(e.tr,r,r.bottom))}return!0}function ko(e,{map:t,table:r,tableStart:s},o){let i=0;for(let d=0;d<o;d++)i+=r.child(d).nodeSize;const l=i+r.child(o).nodeSize,c=e.mapping.maps.length;e.delete(i+s,l+s);const a=new Set;for(let d=0,p=o*t.width;d<t.width;d++,p++){const f=t.map[p];if(!a.has(f)){if(a.add(f),o>0&&f==t.map[p-t.width]){const h=r.nodeAt(f).attrs;e.setNodeMarkup(e.mapping.slice(c).map(f+s),null,{...h,rowspan:h.rowspan-1}),d+=h.colspan-1}else if(o<t.height&&f==t.map[p+t.width]){const h=r.nodeAt(f),m=h.attrs,g=h.type.create({...m,rowspan:h.attrs.rowspan-1},h.content),b=t.positionAt(o+1,d,r);e.insert(e.mapping.slice(c).map(s+b),g),d+=m.colspan-1}}}}function zo(e,t){if(!ue(e))return!1;if(t){const r=me(e),s=e.tr;if(r.top==0&&r.bottom==r.map.height)return!1;for(let o=r.bottom-1;ko(s,r,o),o!=r.top;o--){const i=r.tableStart?s.doc.nodeAt(r.tableStart-1):s.doc;if(!i)throw new RangeError("No table found");r.table=i,r.map=K.get(r.table)}t(s)}return!0}function Hn(e){const t=e.content;return t.childCount==1&&t.child(0).isTextblock&&t.child(0).childCount==0}function No({width:e,height:t,map:r},s){let o=s.top*e+s.left,i=o,l=(s.bottom-1)*e+s.left,c=o+(s.right-s.left-1);for(let a=s.top;a<s.bottom;a++){if(s.left>0&&r[i]==r[i-1]||s.right<e&&r[c]==r[c+1])return!0;i+=e,c+=e}for(let a=s.left;a<s.right;a++){if(s.top>0&&r[o]==r[o-e]||s.bottom<t&&r[l]==r[l+e])return!0;o++,l++}return!1}function In(e,t){const r=e.selection;if(!(r instanceof $)||r.$anchorCell.pos==r.$headCell.pos)return!1;const s=me(e),{map:o}=s;if(No(o,s))return!1;if(t){const i=e.tr,l={};let c=fe.empty,a,d;for(let p=s.top;p<s.bottom;p++)for(let f=s.left;f<s.right;f++){const h=o.map[p*o.width+f],m=s.table.nodeAt(h);if(!(l[h]||!m))if(l[h]=!0,a==null)a=h,d=m;else{Hn(m)||(c=c.append(m.content));const g=i.mapping.map(h+s.tableStart);i.delete(g,g+m.nodeSize)}}if(a==null||d==null)return!0;if(i.setNodeMarkup(a+s.tableStart,null,{...xr(d.attrs,d.attrs.colspan,s.right-s.left-d.attrs.colspan),rowspan:s.bottom-s.top}),c.size>0){const p=a+1+d.content.size,f=Hn(d)?a+1:p;i.replaceWith(f+s.tableStart,p+s.tableStart,c)}i.setSelection(new $(i.doc.resolve(a+s.tableStart))),t(i)}return!0}function $n(e,t){const r=Q(e.schema);return Ao(({node:s})=>r[s.type.spec.tableRole])(e,t)}function Ao(e){return(t,r)=>{const s=t.selection;let o,i;if(s instanceof $){if(s.$anchorCell.pos!=s.$headCell.pos)return!1;o=s.$anchorCell.nodeAfter,i=s.$anchorCell.pos}else{var l;if(o=io(s.$from),!o)return!1;i=(l=He(s.$from))===null||l===void 0?void 0:l.pos}if(o==null||i==null||o.attrs.colspan==1&&o.attrs.rowspan==1)return!1;if(r){let c=o.attrs;const a=[],d=c.colwidth;c.rowspan>1&&(c={...c,rowspan:1}),c.colspan>1&&(c={...c,colspan:1});const p=me(t),f=t.tr;for(let m=0;m<p.right-p.left;m++)a.push(d?{...c,colwidth:d&&d[m]?[d[m]]:null}:c);let h;for(let m=p.top;m<p.bottom;m++){let g=p.map.positionAt(m,p.left,p.table);m==p.top&&(g+=o.nodeSize);for(let b=p.left,v=0;b<p.right;b++,v++)b==p.left&&m==p.top||f.insert(h=f.mapping.map(g+p.tableStart,1),e({node:o,row:m,col:b}).createAndFill(a[v]))}f.setNodeMarkup(i,e({node:o,row:p.top,col:p.left}),a[0]),s instanceof $&&f.setSelection(new $(f.doc.resolve(s.$anchorCell.pos),h?f.doc.resolve(h):void 0)),r(f)}return!0}}function Ro(e,t){return function(r,s){if(!ue(r))return!1;const o=Bt(r);if(o.nodeAfter.attrs[e]===t)return!1;if(s){const i=r.tr;r.selection instanceof $?r.selection.forEachCell((l,c)=>{l.attrs[e]!==t&&i.setNodeMarkup(c,null,{...l.attrs,[e]:t})}):i.setNodeMarkup(o.pos,null,{...o.nodeAfter.attrs,[e]:t}),s(i)}return!0}}function To(e){return function(t,r){if(!ue(t))return!1;if(r){const s=Q(t.schema),o=me(t),i=t.tr,l=o.map.cellsInRect(e=="column"?{left:o.left,top:0,right:o.right,bottom:o.map.height}:e=="row"?{left:0,top:o.top,right:o.map.width,bottom:o.bottom}:o),c=l.map(a=>o.table.nodeAt(a));for(let a=0;a<l.length;a++)c[a].type==s.header_cell&&i.setNodeMarkup(o.tableStart+l[a],s.cell,c[a].attrs);if(i.steps.length===0)for(let a=0;a<l.length;a++)i.setNodeMarkup(o.tableStart+l[a],s.header_cell,c[a].attrs);r(i)}return!0}}function Dn(e,t,r){const s=t.map.cellsInRect({left:0,top:0,right:e=="row"?t.map.width:1,bottom:e=="column"?t.map.height:1});for(let o=0;o<s.length;o++){const i=t.table.nodeAt(s[o]);if(i&&i.type!==r.header_cell)return!1}return!0}function mt(e,t){return t=t||{useDeprecatedLogic:!1},t.useDeprecatedLogic?To(e):function(r,s){if(!ue(r))return!1;if(s){const o=Q(r.schema),i=me(r),l=r.tr,c=Dn("row",i,o),a=Dn("column",i,o),d=(e==="column"?c:e==="row"&&a)?1:0,p=e=="column"?{left:0,top:d,right:1,bottom:i.map.height}:e=="row"?{left:d,top:0,right:i.map.width,bottom:1}:i,f=e=="column"?a?o.cell:o.header_cell:e=="row"?c?o.cell:o.header_cell:o.cell;i.map.cellsInRect(p).forEach(h=>{const m=h+i.tableStart,g=l.doc.nodeAt(m);g&&l.setNodeMarkup(m,f,g.attrs)}),s(l)}return!0}}mt("row",{useDeprecatedLogic:!0});mt("column",{useDeprecatedLogic:!0});const Mo=mt("cell",{useDeprecatedLogic:!0});function Eo(e,t){if(t<0){const r=e.nodeBefore;if(r)return e.pos-r.nodeSize;for(let s=e.index(-1)-1,o=e.before();s>=0;s--){const i=e.node(-1).child(s),l=i.lastChild;if(l)return o-1-l.nodeSize;o-=i.nodeSize}}else{if(e.index()<e.parent.childCount-1)return e.pos+e.nodeAfter.nodeSize;const r=e.node(-1);for(let s=e.indexAfter(-1),o=e.after();s<r.childCount;s++){const i=r.child(s);if(i.childCount)return o+1;o+=i.nodeSize}}return null}function Bn(e){return function(t,r){if(!ue(t))return!1;const s=Eo(Bt(t),e);if(s==null)return!1;if(r){const o=t.doc.resolve(s);r(t.tr.setSelection(Ae.between(o,ao(o))).scrollIntoView())}return!0}}function Wo(e,t){const r=e.selection.$anchor;for(let s=r.depth;s>0;s--)if(r.node(s).type.spec.tableRole=="table")return t&&t(e.tr.delete(r.before(s),r.after(s)).scrollIntoView()),!0;return!1}function Wt(e,t){const r=e.selection;if(!(r instanceof $))return!1;if(t){const s=e.tr,o=Q(e.schema).cell.createAndFill().content;r.forEachCell((i,l)=>{i.content.eq(o)||s.replace(s.mapping.map(l+1),s.mapping.map(l+i.nodeSize-1),new Re(o,0,0))}),s.docChanged&&t(s)}return!0}function Lo(e){if(e.size===0)return null;let{content:t,openStart:r,openEnd:s}=e;for(;t.childCount==1&&(r>0&&s>0||t.child(0).type.spec.tableRole=="table");)r--,s--,t=t.child(0).content;const o=t.child(0),i=o.type.spec.tableRole,l=o.type.schema,c=[];if(i=="row")for(let a=0;a<t.childCount;a++){let d=t.child(a).content;const p=a?0:Math.max(0,r-1),f=a<t.childCount-1?0:Math.max(0,s-1);(p||f)&&(d=un(Q(l).row,new Re(d,p,f)).content),c.push(d)}else if(i=="cell"||i=="header_cell")c.push(r||s?un(Q(l).row,new Re(t,r,s)).content:t);else return null;return _o(l,c)}function _o(e,t){const r=[];for(let o=0;o<t.length;o++){const i=t[o];for(let l=i.childCount-1;l>=0;l--){const{rowspan:c,colspan:a}=i.child(l).attrs;for(let d=o;d<o+c;d++)r[d]=(r[d]||0)+a}}let s=0;for(let o=0;o<r.length;o++)s=Math.max(s,r[o]);for(let o=0;o<r.length;o++)if(o>=t.length&&t.push(fe.empty),r[o]<s){const i=Q(e).cell.createAndFill(),l=[];for(let c=r[o];c<s;c++)l.push(i);t[o]=t[o].append(fe.from(l))}return{height:t.length,width:s,rows:t}}function un(e,t){const r=e.createAndFill();return new rs(r).replace(0,r.content.size,t).doc}function Ho({width:e,height:t,rows:r},s,o){if(e!=s){const i=[],l=[];for(let c=0;c<r.length;c++){const a=r[c],d=[];for(let p=i[c]||0,f=0;p<s;f++){let h=a.child(f%a.childCount);p+h.attrs.colspan>s&&(h=h.type.createChecked(Ie(h.attrs,h.attrs.colspan,p+h.attrs.colspan-s),h.content)),d.push(h),p+=h.attrs.colspan;for(let m=1;m<h.attrs.rowspan;m++)i[c+m]=(i[c+m]||0)+h.attrs.colspan}l.push(fe.from(d))}r=l,e=s}if(t!=o){const i=[];for(let l=0,c=0;l<o;l++,c++){const a=[],d=r[c%t];for(let p=0;p<d.childCount;p++){let f=d.child(p);l+f.attrs.rowspan>o&&(f=f.type.create({...f.attrs,rowspan:Math.max(1,o-f.attrs.rowspan)},f.content)),a.push(f)}i.push(fe.from(a))}r=i,t=o}return{width:e,height:t,rows:r}}function Io(e,t,r,s,o,i,l){const c=e.doc.type.schema,a=Q(c);let d,p;if(o>t.width)for(let f=0,h=0;f<t.height;f++){const m=r.child(f);h+=m.nodeSize;const g=[];let b;m.lastChild==null||m.lastChild.type==a.cell?b=d||(d=a.cell.createAndFill()):b=p||(p=a.header_cell.createAndFill());for(let v=t.width;v<o;v++)g.push(b);e.insert(e.mapping.slice(l).map(h-1+s),g)}if(i>t.height){const f=[];for(let g=0,b=(t.height-1)*t.width;g<Math.max(t.width,o);g++){const v=g>=t.width?!1:r.nodeAt(t.map[b+g]).type==a.header_cell;f.push(v?p||(p=a.header_cell.createAndFill()):d||(d=a.cell.createAndFill()))}const h=a.row.create(null,fe.from(f)),m=[];for(let g=t.height;g<i;g++)m.push(h);e.insert(e.mapping.slice(l).map(s+r.nodeSize-2),m)}return!!(d||p)}function Pn(e,t,r,s,o,i,l,c){if(l==0||l==t.height)return!1;let a=!1;for(let d=o;d<i;d++){const p=l*t.width+d,f=t.map[p];if(t.map[p-t.width]==f){a=!0;const h=r.nodeAt(f),{top:m,left:g}=t.findCell(f);e.setNodeMarkup(e.mapping.slice(c).map(f+s),null,{...h.attrs,rowspan:l-m}),e.insert(e.mapping.slice(c).map(t.positionAt(l,g,r)),h.type.createAndFill({...h.attrs,rowspan:m+h.attrs.rowspan-l})),d+=h.attrs.colspan-1}}return a}function Fn(e,t,r,s,o,i,l,c){if(l==0||l==t.width)return!1;let a=!1;for(let d=o;d<i;d++){const p=d*t.width+l,f=t.map[p];if(t.map[p-1]==f){a=!0;const h=r.nodeAt(f),m=t.colCount(f),g=e.mapping.slice(c).map(f+s);e.setNodeMarkup(g,null,Ie(h.attrs,l-m,h.attrs.colspan-(l-m))),e.insert(g+h.nodeSize,h.type.createAndFill(Ie(h.attrs,0,l-m))),d+=h.attrs.rowspan-1}}return a}function On(e,t,r,s,o){let i=r?e.doc.nodeAt(r-1):e.doc;if(!i)throw new Error("No table found");let l=K.get(i);const{top:c,left:a}=s,d=a+o.width,p=c+o.height,f=e.tr;let h=0;function m(){if(i=r?f.doc.nodeAt(r-1):f.doc,!i)throw new Error("No table found");l=K.get(i),h=f.mapping.maps.length}Io(f,l,i,r,d,p,h)&&m(),Pn(f,l,i,r,a,d,c,h)&&m(),Pn(f,l,i,r,a,d,p,h)&&m(),Fn(f,l,i,r,c,p,a,h)&&m(),Fn(f,l,i,r,c,p,d,h)&&m();for(let g=c;g<p;g++){const b=l.positionAt(g,a,i),v=l.positionAt(g,d,i);f.replace(f.mapping.slice(h).map(b+r),f.mapping.slice(h).map(v+r),new Re(o.rows[g-c],0,0))}m(),f.setSelection(new $(f.doc.resolve(r+l.positionAt(c,a,i)),f.doc.resolve(r+l.positionAt(p-1,d-1,i)))),t(f)}const $o=ts({ArrowLeft:Lt("horiz",-1),ArrowRight:Lt("horiz",1),ArrowUp:Lt("vert",-1),ArrowDown:Lt("vert",1),"Shift-ArrowLeft":_t("horiz",-1),"Shift-ArrowRight":_t("horiz",1),"Shift-ArrowUp":_t("vert",-1),"Shift-ArrowDown":_t("vert",1),Backspace:Wt,"Mod-Backspace":Wt,Delete:Wt,"Mod-Delete":Wt});function It(e,t,r){return r.eq(e.selection)?!1:(t&&t(e.tr.setSelection(r).scrollIntoView()),!0)}function Lt(e,t){return(r,s,o)=>{if(!o)return!1;const i=r.selection;if(i instanceof $)return It(r,s,je.near(i.$headCell,t));if(e!="horiz"&&!i.empty)return!1;const l=Cr(o,e,t);if(l==null)return!1;if(e=="horiz")return It(r,s,je.near(r.doc.resolve(i.head+t),t));{const c=r.doc.resolve(l),a=mr(c,e,t);let d;return a?d=je.near(a,1):t<0?d=je.near(r.doc.resolve(c.before(-1)),-1):d=je.near(r.doc.resolve(c.after(-1)),1),It(r,s,d)}}}function _t(e,t){return(r,s,o)=>{if(!o)return!1;const i=r.selection;let l;if(i instanceof $)l=i;else{const a=Cr(o,e,t);if(a==null)return!1;l=new $(r.doc.resolve(a))}const c=mr(l.$headCell,e,t);return c?It(r,s,new $(l.$anchorCell,c)):!1}}function Do(e,t){const r=e.state.doc,s=He(r.resolve(t));return s?(e.dispatch(e.state.tr.setSelection(new $(s))),!0):!1}function Bo(e,t,r){if(!ue(e.state))return!1;let s=Lo(r);const o=e.state.selection;if(o instanceof $){s||(s={width:1,height:1,rows:[fe.from(un(Q(e.state.schema).cell,r))]});const i=o.$anchorCell.node(-1),l=o.$anchorCell.start(-1),c=K.get(i).rectBetween(o.$anchorCell.pos-l,o.$headCell.pos-l);return s=Ho(s,c.right-c.left,c.bottom-c.top),On(e.state,e.dispatch,l,c,s),!0}else if(s){const i=Bt(e.state),l=i.start(-1);return On(e.state,e.dispatch,l,K.get(i.node(-1)).findCell(i.pos-l),s),!0}else return!1}function Po(e,t){var r;if(t.button!=0||t.ctrlKey||t.metaKey)return;const s=Un(e,t.target);let o;if(t.shiftKey&&e.state.selection instanceof $)i(e.state.selection.$anchorCell,t),t.preventDefault();else if(t.shiftKey&&s&&(o=He(e.state.selection.$anchor))!=null&&((r=nn(e,t))===null||r===void 0?void 0:r.pos)!=o.pos)i(o,t),t.preventDefault();else if(!s)return;function i(a,d){let p=nn(e,d);const f=Ne.getState(e.state)==null;if(!p||!gn(a,p))if(f)p=a;else return;const h=new $(a,p);if(f||!e.state.selection.eq(h)){const m=e.state.tr.setSelection(h);f&&m.setMeta(Ne,a.pos),e.dispatch(m)}}function l(){e.root.removeEventListener("mouseup",l),e.root.removeEventListener("dragstart",l),e.root.removeEventListener("mousemove",c),Ne.getState(e.state)!=null&&e.dispatch(e.state.tr.setMeta(Ne,-1))}function c(a){const d=a,p=Ne.getState(e.state);let f;if(p!=null)f=e.state.doc.resolve(p);else if(Un(e,d.target)!=s&&(f=nn(e,t),!f))return l();f&&i(f,d)}e.root.addEventListener("mouseup",l),e.root.addEventListener("dragstart",l),e.root.addEventListener("mousemove",c)}function Cr(e,t,r){if(!(e.state.selection instanceof Ae))return null;const{$head:s}=e.state.selection;for(let o=s.depth-1;o>=0;o--){const i=s.node(o);if((r<0?s.index(o):s.indexAfter(o))!=(r<0?0:i.childCount))return null;if(i.type.spec.tableRole=="cell"||i.type.spec.tableRole=="header_cell"){const l=s.before(o),c=t=="vert"?r>0?"down":"up":r>0?"right":"left";return e.endOfTextblock(c)?l:null}}return null}function Un(e,t){for(;t&&t!=e.dom;t=t.parentNode)if(t.nodeName=="TD"||t.nodeName=="TH")return t;return null}function nn(e,t){const r=e.posAtCoords({left:t.clientX,top:t.clientY});if(!r)return null;let{inside:s,pos:o}=r;return s>=0&&He(e.state.doc.resolve(s))||He(e.state.doc.resolve(o))}var Fo=class{constructor(t,r){this.node=t,this.defaultCellMinWidth=r,this.dom=document.createElement("div"),this.dom.className="tableWrapper",this.table=this.dom.appendChild(document.createElement("table")),this.table.style.setProperty("--default-cell-min-width",`${r}px`),this.colgroup=this.table.appendChild(document.createElement("colgroup")),fn(t,this.colgroup,this.table,r),this.contentDOM=this.table.appendChild(document.createElement("tbody"))}update(t){return t.type!=this.node.type?!1:(this.node=t,fn(t,this.colgroup,this.table,this.defaultCellMinWidth),!0)}ignoreMutation(t){return t.type=="attributes"&&(t.target==this.table||this.colgroup.contains(t.target))}};function fn(e,t,r,s,o,i){let l=0,c=!0,a=t.firstChild;const d=e.firstChild;if(d){for(let f=0,h=0;f<d.childCount;f++){const{colspan:m,colwidth:g}=d.child(f).attrs;for(let b=0;b<m;b++,h++){const v=o==h?i:g&&g[b],w=v?v+"px":"";if(l+=v||s,v||(c=!1),a)a.style.width!=w&&(a.style.width=w),a=a.nextSibling;else{const z=document.createElement("col");z.style.width=w,t.appendChild(z)}}}for(;a;){var p;const f=a.nextSibling;(p=a.parentNode)===null||p===void 0||p.removeChild(a),a=f}c?(r.style.width=l+"px",r.style.minWidth=""):(r.style.width="",r.style.minWidth=l+"px")}}const se=new mn("tableColumnResizing");function Oo({handleWidth:e=5,cellMinWidth:t=25,defaultCellMinWidth:r=100,View:s=Fo,lastColumnResizable:o=!0}={}){const i=new rr({key:se,state:{init(l,c){var a;const d=(a=i.spec)===null||a===void 0||(a=a.props)===null||a===void 0?void 0:a.nodeViews,p=Q(c.schema).table.name;return s&&d&&(d[p]=(f,h)=>new s(f,r,h)),new Uo(-1,!1)},apply(l,c){return c.apply(l)}},props:{attributes:l=>{const c=se.getState(l);return c&&c.activeHandle>-1?{class:"resize-cursor"}:{}},handleDOMEvents:{mousemove:(l,c)=>{Ko(l,c,e,o)},mouseleave:l=>{Vo(l)},mousedown:(l,c)=>{Yo(l,c,t,r)}},decorations:l=>{const c=se.getState(l);if(c&&c.activeHandle>-1)return Qo(l,c.activeHandle)},nodeViews:{}}});return i}var Uo=class $t{constructor(t,r){this.activeHandle=t,this.dragging=r}apply(t){const r=this,s=t.getMeta(se);if(s&&s.setHandle!=null)return new $t(s.setHandle,!1);if(s&&s.setDragging!==void 0)return new $t(r.activeHandle,s.setDragging);if(r.activeHandle>-1&&t.docChanged){let o=t.mapping.map(r.activeHandle,-1);return pn(t.doc.resolve(o))||(o=-1),new $t(o,r.dragging)}return r}};function Ko(e,t,r,s){if(!e.editable)return;const o=se.getState(e.state);if(o&&!o.dragging){const i=Xo(t.target);let l=-1;if(i){const{left:c,right:a}=i.getBoundingClientRect();t.clientX-c<=r?l=Kn(e,t,"left",r):a-t.clientX<=r&&(l=Kn(e,t,"right",r))}if(l!=o.activeHandle){if(!s&&l!==-1){const c=e.state.doc.resolve(l),a=c.node(-1),d=K.get(a),p=c.start(-1);if(d.colCount(c.pos-p)+c.nodeAfter.attrs.colspan-1==d.width-1)return}wr(e,l)}}}function Vo(e){if(!e.editable)return;const t=se.getState(e.state);t&&t.activeHandle>-1&&!t.dragging&&wr(e,-1)}function Yo(e,t,r,s){var o;if(!e.editable)return!1;const i=(o=e.dom.ownerDocument.defaultView)!==null&&o!==void 0?o:window,l=se.getState(e.state);if(!l||l.activeHandle==-1||l.dragging)return!1;const c=e.state.doc.nodeAt(l.activeHandle),a=Go(e,l.activeHandle,c.attrs);e.dispatch(e.state.tr.setMeta(se,{setDragging:{startX:t.clientX,startWidth:a}}));function d(f){i.removeEventListener("mouseup",d),i.removeEventListener("mousemove",p);const h=se.getState(e.state);h?.dragging&&(Jo(e,h.activeHandle,Vn(h.dragging,f,r)),e.dispatch(e.state.tr.setMeta(se,{setDragging:null})))}function p(f){if(!f.which)return d(f);const h=se.getState(e.state);if(h&&h.dragging){const m=Vn(h.dragging,f,r);Yn(e,h.activeHandle,m,s)}}return Yn(e,l.activeHandle,a,s),i.addEventListener("mouseup",d),i.addEventListener("mousemove",p),t.preventDefault(),!0}function Go(e,t,{colspan:r,colwidth:s}){const o=s&&s[s.length-1];if(o)return o;const i=e.domAtPos(t);let l=i.node.childNodes[i.offset].offsetWidth,c=r;if(s)for(let a=0;a<r;a++)s[a]&&(l-=s[a],c--);return l/c}function Xo(e){for(;e&&e.nodeName!="TD"&&e.nodeName!="TH";)e=e.classList&&e.classList.contains("ProseMirror")?null:e.parentNode;return e}function Kn(e,t,r,s){const o=r=="right"?-s:s,i=e.posAtCoords({left:t.clientX+o,top:t.clientY});if(!i)return-1;const{pos:l}=i,c=He(e.state.doc.resolve(l));if(!c)return-1;if(r=="right")return c.pos;const a=K.get(c.node(-1)),d=c.start(-1),p=a.map.indexOf(c.pos-d);return p%a.width==0?-1:d+a.map[p-1]}function Vn(e,t,r){const s=t.clientX-e.startX;return Math.max(r,e.startWidth+s)}function wr(e,t){e.dispatch(e.state.tr.setMeta(se,{setHandle:t}))}function Jo(e,t,r){const s=e.state.doc.resolve(t),o=s.node(-1),i=K.get(o),l=s.start(-1),c=i.colCount(s.pos-l)+s.nodeAfter.attrs.colspan-1,a=e.state.tr;for(let d=0;d<i.height;d++){const p=d*i.width+c;if(d&&i.map[p]==i.map[p-i.width])continue;const f=i.map[p],h=o.nodeAt(f).attrs,m=h.colspan==1?0:c-i.colCount(f);if(h.colwidth&&h.colwidth[m]==r)continue;const g=h.colwidth?h.colwidth.slice():qo(h.colspan);g[m]=r,a.setNodeMarkup(l+f,null,{...h,colwidth:g})}a.docChanged&&e.dispatch(a)}function Yn(e,t,r,s){const o=e.state.doc.resolve(t),i=o.node(-1),l=o.start(-1),c=K.get(i).colCount(o.pos-l)+o.nodeAfter.attrs.colspan-1;let a=e.domAtPos(o.start(-1)).node;for(;a&&a.nodeName!="TABLE";)a=a.parentNode;a&&fn(i,a.firstChild,a,s,c,r)}function qo(e){return Array(e).fill(0)}function Qo(e,t){const r=[],s=e.doc.resolve(t),o=s.node(-1);if(!o)return rn.empty;const i=K.get(o),l=s.start(-1),c=i.colCount(s.pos-l)+s.nodeAfter.attrs.colspan-1;for(let d=0;d<i.height;d++){const p=c+d*i.width;if((c==i.width-1||i.map[p]!=i.map[p+1])&&(d==0||i.map[p]!=i.map[p-i.width])){var a;const f=i.map[p],h=l+f+o.nodeAt(f).nodeSize-1,m=document.createElement("div");m.className="column-resize-handle",!((a=se.getState(e))===null||a===void 0)&&a.dragging&&r.push(sn.node(l+f,l+f+o.nodeAt(f).nodeSize,{class:"column-resize-dragging"})),r.push(sn.widget(h,m))}}return rn.create(e.doc,r)}function Zo({allowTableNodeSelection:e=!1}={}){return new rr({key:Ne,state:{init(){return null},apply(t,r){const s=t.getMeta(Ne);if(s!=null)return s==-1?null:s;if(r==null||!t.docChanged)return r;const{deleted:o,pos:i}=t.mapping.mapResult(r);return o?null:i}},props:{decorations:uo,handleDOMEvents:{mousedown:Po},createSelectionBetween(t){return Ne.getState(t.state)!=null?t.state.selection:null},handleTripleClick:Do,handleKeyDown:$o,handlePaste:Bo},appendTransaction(t,r,s){return mo(s,br(s,r),e)}})}var Sr=xt.create({name:"tableCell",addOptions(){return{HTMLAttributes:{}}},content:"block+",addAttributes(){return{colspan:{default:1},rowspan:{default:1},colwidth:{default:null,parseHTML:e=>{var t,r;const s=e.getAttribute("colwidth"),o=s?s.split(",").map(i=>parseInt(i,10)):null;if(!o){const i=(t=e.closest("table"))==null?void 0:t.querySelectorAll("colgroup > col"),l=Array.from(((r=e.parentElement)==null?void 0:r.children)||[]).indexOf(e);if(l&&l>-1&&i&&i[l]){const c=i[l].getAttribute("width");return c?[parseInt(c,10)]:null}}return o}}}},tableRole:"cell",isolating:!0,parseHTML(){return[{tag:"td"}]},renderHTML({HTMLAttributes:e}){return["td",$e(this.options.HTMLAttributes,e),0]}}),kr=xt.create({name:"tableHeader",addOptions(){return{HTMLAttributes:{}}},content:"block+",addAttributes(){return{colspan:{default:1},rowspan:{default:1},colwidth:{default:null,parseHTML:e=>{const t=e.getAttribute("colwidth");return t?t.split(",").map(s=>parseInt(s,10)):null}}}},tableRole:"header_cell",isolating:!0,parseHTML(){return[{tag:"th"}]},renderHTML({HTMLAttributes:e}){return["th",$e(this.options.HTMLAttributes,e),0]}}),zr=xt.create({name:"tableRow",addOptions(){return{HTMLAttributes:{}}},content:"(tableCell | tableHeader)*",tableRole:"row",parseHTML(){return[{tag:"tr"}]},renderHTML({HTMLAttributes:e}){return["tr",$e(this.options.HTMLAttributes,e),0]}});function hn(e,t){return t?["width",`${Math.max(t,e)}px`]:["min-width",`${e}px`]}function Gn(e,t,r,s,o,i){var l;let c=0,a=!0,d=t.firstChild;const p=e.firstChild;if(p!==null)for(let h=0,m=0;h<p.childCount;h+=1){const{colspan:g,colwidth:b}=p.child(h).attrs;for(let v=0;v<g;v+=1,m+=1){const w=o===m?i:b&&b[v],z=w?`${w}px`:"";if(c+=w||s,w||(a=!1),d){if(d.style.width!==z){const[M,W]=hn(s,w);d.style.setProperty(M,W)}d=d.nextSibling}else{const M=document.createElement("col"),[W,V]=hn(s,w);M.style.setProperty(W,V),t.appendChild(M)}}}for(;d;){const h=d.nextSibling;(l=d.parentNode)==null||l.removeChild(d),d=h}const f=e.attrs.style&&typeof e.attrs.style=="string"&&/\bwidth\s*:/i.test(e.attrs.style);a&&!f?(r.style.width=`${c}px`,r.style.minWidth=""):(r.style.width="",r.style.minWidth=`${c}px`)}var ei=class{constructor(e,t){this.node=e,this.cellMinWidth=t,this.dom=document.createElement("div"),this.dom.className="tableWrapper",this.table=this.dom.appendChild(document.createElement("table")),e.attrs.style&&(this.table.style.cssText=e.attrs.style),this.colgroup=this.table.appendChild(document.createElement("colgroup")),Gn(e,this.colgroup,this.table,t),this.contentDOM=this.table.appendChild(document.createElement("tbody"))}update(e){return e.type!==this.node.type?!1:(this.node=e,Gn(e,this.colgroup,this.table,this.cellMinWidth),!0)}ignoreMutation(e){const t=e.target,r=this.dom.contains(t),s=this.contentDOM.contains(t);return!!(r&&!s&&(e.type==="attributes"||e.type==="childList"||e.type==="characterData"))}};function ti(e,t,r,s){let o=0,i=!0;const l=[],c=e.firstChild;if(!c)return{};for(let f=0,h=0;f<c.childCount;f+=1){const{colspan:m,colwidth:g}=c.child(f).attrs;for(let b=0;b<m;b+=1,h+=1){const v=r===h?s:g&&g[b];o+=v||t,v||(i=!1);const[w,z]=hn(t,v);l.push(["col",{style:`${w}: ${z}`}])}}const a=i?`${o}px`:"",d=i?"":`${o}px`;return{colgroup:["colgroup",{},...l],tableWidth:a,tableMinWidth:d}}function Xn(e,t){return e.createAndFill()}function ni(e){if(e.cached.tableNodeTypes)return e.cached.tableNodeTypes;const t={};return Object.keys(e.nodes).forEach(r=>{const s=e.nodes[r];s.spec.tableRole&&(t[s.spec.tableRole]=s)}),e.cached.tableNodeTypes=t,t}function ri(e,t,r,s,o){const i=ni(e),l=[],c=[];for(let d=0;d<r;d+=1){const p=Xn(i.cell);if(p&&c.push(p),s){const f=Xn(i.header_cell);f&&l.push(f)}}const a=[];for(let d=0;d<t;d+=1)a.push(i.row.createChecked(null,s&&d===0?l:c));return i.table.createChecked(null,a)}function si(e){return e instanceof $}var Ht=({editor:e})=>{const{selection:t}=e.state;if(!si(t))return!1;let r=0;const s=is(t.ranges[0].$from,i=>i.type.name==="table");return s?.node.descendants(i=>{if(i.type.name==="table")return!1;["tableCell","tableHeader"].includes(i.type.name)&&(r+=1)}),r===t.ranges.length?(e.commands.deleteTable(),!0):!1},oi="";function ii(e){return(e||"").replace(/\s+/g," ").trim()}function li(e,t,r={}){var s;const o=(s=r.cellLineSeparator)!=null?s:oi;if(!e||!e.content||e.content.length===0)return"";const i=[];e.content.forEach(g=>{const b=[];g.content&&g.content.forEach(v=>{let w="";v.content&&Array.isArray(v.content)&&v.content.length>1?w=v.content.map(V=>t.renderChildren(V)).join(o):w=v.content?t.renderChildren(v.content):"";const z=ii(w),M=v.type==="tableHeader";b.push({text:z,isHeader:M})}),i.push(b)});const l=i.reduce((g,b)=>Math.max(g,b.length),0);if(l===0)return"";const c=new Array(l).fill(0);i.forEach(g=>{var b;for(let v=0;v<l;v+=1){const z=(((b=g[v])==null?void 0:b.text)||"").length;z>c[v]&&(c[v]=z),c[v]<3&&(c[v]=3)}});const a=(g,b)=>g+" ".repeat(Math.max(0,b-g.length)),d=i[0],p=d.some(g=>g.isHeader);let f=`
`;const h=new Array(l).fill(0).map((g,b)=>p&&d[b]&&d[b].text||"");return f+=`| ${h.map((g,b)=>a(g,c[b])).join(" | ")} |
`,f+=`| ${c.map(g=>"-".repeat(Math.max(3,g))).join(" | ")} |
`,(p?i.slice(1):i).forEach(g=>{f+=`| ${new Array(l).fill(0).map((b,v)=>a(g[v]&&g[v].text||"",c[v])).join(" | ")} |
`}),f}var ai=li,Nr=xt.create({name:"table",addOptions(){return{HTMLAttributes:{},resizable:!1,renderWrapper:!1,handleWidth:5,cellMinWidth:25,View:ei,lastColumnResizable:!0,allowTableNodeSelection:!1}},content:"tableRow+",tableRole:"table",isolating:!0,group:"block",parseHTML(){return[{tag:"table"}]},renderHTML({node:e,HTMLAttributes:t}){const{colgroup:r,tableWidth:s,tableMinWidth:o}=ti(e,this.options.cellMinWidth),i=t.style;function l(){return i||(s?`width: ${s}`:`min-width: ${o}`)}const c=["table",$e(this.options.HTMLAttributes,t,{style:l()}),r,["tbody",0]];return this.options.renderWrapper?["div",{class:"tableWrapper"},c]:c},parseMarkdown:(e,t)=>{const r=[];if(e.header){const s=[];e.header.forEach(o=>{s.push(t.createNode("tableHeader",{},[{type:"paragraph",content:t.parseInline(o.tokens)}]))}),r.push(t.createNode("tableRow",{},s))}return e.rows&&e.rows.forEach(s=>{const o=[];s.forEach(i=>{o.push(t.createNode("tableCell",{},[{type:"paragraph",content:t.parseInline(i.tokens)}]))}),r.push(t.createNode("tableRow",{},o))}),t.createNode("table",void 0,r)},renderMarkdown:(e,t)=>ai(e,t),addCommands(){return{insertTable:({rows:e=3,cols:t=3,withHeaderRow:r=!0}={})=>({tr:s,dispatch:o,editor:i})=>{const l=ri(i.schema,e,t,r);if(o){const c=s.selection.from+1;s.replaceSelectionWith(l).scrollIntoView().setSelection(Ae.near(s.doc.resolve(c)))}return!0},addColumnBefore:()=>({state:e,dispatch:t})=>yo(e,t),addColumnAfter:()=>({state:e,dispatch:t})=>bo(e,t),deleteColumn:()=>({state:e,dispatch:t})=>jo(e,t),addRowBefore:()=>({state:e,dispatch:t})=>wo(e,t),addRowAfter:()=>({state:e,dispatch:t})=>So(e,t),deleteRow:()=>({state:e,dispatch:t})=>zo(e,t),deleteTable:()=>({state:e,dispatch:t})=>Wo(e,t),mergeCells:()=>({state:e,dispatch:t})=>In(e,t),splitCell:()=>({state:e,dispatch:t})=>$n(e,t),toggleHeaderColumn:()=>({state:e,dispatch:t})=>mt("column")(e,t),toggleHeaderRow:()=>({state:e,dispatch:t})=>mt("row")(e,t),toggleHeaderCell:()=>({state:e,dispatch:t})=>Mo(e,t),mergeOrSplit:()=>({state:e,dispatch:t})=>In(e,t)?!0:$n(e,t),setCellAttribute:(e,t)=>({state:r,dispatch:s})=>Ro(e,t)(r,s),goToNextCell:()=>({state:e,dispatch:t})=>Bn(1)(e,t),goToPreviousCell:()=>({state:e,dispatch:t})=>Bn(-1)(e,t),fixTables:()=>({state:e,dispatch:t})=>(t&&br(e),!0),setCellSelection:e=>({tr:t,dispatch:r})=>{if(r){const s=$.create(t.doc,e.anchorCell,e.headCell);t.setSelection(s)}return!0}}},addKeyboardShortcuts(){return{Tab:()=>this.editor.commands.goToNextCell()?!0:this.editor.can().addRowAfter()?this.editor.chain().addRowAfter().goToNextCell().run():!1,"Shift-Tab":()=>this.editor.commands.goToPreviousCell(),Backspace:Ht,"Mod-Backspace":Ht,Delete:Ht,"Mod-Delete":Ht}},addProseMirrorPlugins(){return[...this.options.resizable&&this.editor.isEditable?[Oo({handleWidth:this.options.handleWidth,cellMinWidth:this.options.cellMinWidth,defaultCellMinWidth:this.options.cellMinWidth,View:this.options.View,lastColumnResizable:this.options.lastColumnResizable})]:[],Zo({allowTableNodeSelection:this.options.allowTableNodeSelection})]},extendNodeSchema(e){const t={name:e.name,options:e.options,storage:e.storage};return{tableRole:ss(os(e,"tableRole",t))}}});he.create({name:"tableKit",addExtensions(){const e=[];return this.options.table!==!1&&e.push(Nr.configure(this.options.table)),this.options.tableCell!==!1&&e.push(Sr.configure(this.options.tableCell)),this.options.tableHeader!==!1&&e.push(kr.configure(this.options.tableHeader)),this.options.tableRow!==!1&&e.push(zr.configure(this.options.tableRow)),e}});const ci=he.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:e=>e.style.fontSize.replace(/['"]+/g,""),renderHTML:e=>e.fontSize?{style:`font-size: ${e.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:e=>({chain:t})=>t().setMark("textStyle",{fontSize:e}).run(),unsetFontSize:()=>({chain:e})=>e().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),di=he.create({name:"lineHeight",addOptions(){return{types:["paragraph","heading"],defaultLineHeight:"normal"}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:this.options.defaultLineHeight,parseHTML:e=>e.style.lineHeight||this.options.defaultLineHeight,renderHTML:e=>e.lineHeight===this.options.defaultLineHeight?{}:{style:`line-height: ${e.lineHeight}`}}}}]},addCommands(){return{setLineHeight:e=>({commands:t})=>this.options.types.every(r=>t.updateAttributes(r,{lineHeight:e})),unsetLineHeight:()=>({commands:e})=>this.options.types.every(t=>e.resetAttributes(t,"lineHeight"))}}}),Jn=({content:e,onUpdate:t,onFocus:r,onCreated:s,editable:o,className:i,placeholder:l,style:c})=>{const a=ls({extensions:[ds.configure({heading:!1}),ps.configure({levels:[1,2,3,4]}),as,ur,hr,ci,di,fr,Js.configure({types:["heading","paragraph"]}),Zs.configure({multicolor:!0}),cs,us.configure({nested:!0}),to.configure({inline:!0,allowBase64:!0}),Nr.configure({resizable:!0}),zr,kr,Sr,fs.configure({placeholder:l||" ..."})],content:e,editable:o,onUpdate:({editor:d})=>{t(d.getHTML())},onFocus:({editor:d})=>{r(d)},onCreate:({editor:d})=>{s&&s(d)}});return x.useEffect(()=>{if(!a)return;!(a.getHTML()===e)&&!a.isFocused&&a.commands.setContent(e,{emitUpdate:!1})},[e,a]),x.useEffect(()=>{a&&a.setEditable(o)},[o,a]),n.jsx(hs,{editor:a,className:i,style:c,onMouseUp:()=>{}})},pi=({editor:e})=>{const[,t]=An.useReducer(r=>r+1,0);return An.useEffect(()=>{if(!e)return;const r=()=>t();return e.on("transaction",r),e.on("selectionUpdate",r),()=>{e.off("transaction",r),e.off("selectionUpdate",r)}},[e]),n.jsxs("div",{className:"novel-toolbar author-toolbar",children:[n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>e?.chain().focus().undo().run(),disabled:!e?.can().undo(),title:"",children:n.jsx("span",{className:"material-symbols-outlined",children:"undo"})}),n.jsx("button",{onClick:()=>e?.chain().focus().redo().run(),disabled:!e?.can().redo(),title:" ",children:n.jsx("span",{className:"material-symbols-outlined",children:"redo"})})]}),n.jsx("div",{className:"separator"}),n.jsxs("select",{onChange:r=>{if(!e)return;const s=r.target.value;s==="p"?e.chain().focus().setParagraph().run():e.chain().focus().toggleHeading({level:parseInt(s)}).run()},value:e?.isActive("heading",{level:1})?"1":e?.isActive("heading",{level:2})?"2":e?.isActive("heading",{level:3})?"3":e?.isActive("heading",{level:4})?"4":"p",disabled:!e,className:"style-select",children:[n.jsx("option",{value:"p",children:""}),n.jsx("option",{value:"1",children:" 1"}),n.jsx("option",{value:"2",children:" 2"}),n.jsx("option",{value:"3",children:" 1"}),n.jsx("option",{value:"4",children:" 2"})]}),n.jsx("div",{className:"separator"}),n.jsxs("select",{onChange:r=>{e&&e.chain().focus().setFontFamily(r.target.value).run()},value:e?.getAttributes("textStyle").fontFamily||"",disabled:!e,className:"font-select",children:[n.jsx("option",{value:"",children:" "}),n.jsx("option",{value:"Inter",children:"Inter"}),n.jsx("option",{value:"Roboto",children:"Roboto"}),n.jsx("option",{value:"Pretendard",children:"Pretendard"}),n.jsx("option",{value:"Nanum Myeongjo",children:""}),n.jsx("option",{value:"serif",children:"Serif"}),n.jsx("option",{value:"monospace",children:"Monospace"})]}),n.jsx("select",{onChange:r=>{e&&e.chain().focus().setFontSize(r.target.value).run()},value:e?.getAttributes("textStyle").fontSize||"16px",disabled:!e,className:"size-select",children:[12,14,16,18,20,24,30,36].map(r=>n.jsxs("option",{value:`${r}px`,children:[r,"px"]},r))}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>e?.chain().focus().toggleBold().run(),className:e?.isActive("bold")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_bold"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleItalic().run(),className:e?.isActive("italic")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_italic"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleUnderline().run(),className:e?.isActive("underline")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_underlined"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleStrike().run(),className:e?.isActive("strike")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_strikethrough"})}),n.jsxs("div",{className:"color-picker-wrapper",title:" ",children:[n.jsx("span",{className:"material-symbols-outlined",children:"format_color_text"}),n.jsx("input",{type:"color",onChange:r=>e?.chain().focus().setColor(r.target.value).run(),value:e?.getAttributes("textStyle").color||"var(--foreground)",disabled:!e})]})]}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("left").run(),className:e?.isActive({textAlign:"left"})?"is-active":"",title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_align_left"})}),n.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("center").run(),className:e?.isActive({textAlign:"center"})?"is-active":"",title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_align_center"})}),n.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("right").run(),className:e?.isActive({textAlign:"right"})?"is-active":"",title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_align_right"})}),n.jsx("button",{onClick:()=>e?.chain().focus().setTextAlign("justify").run(),className:e?.isActive({textAlign:"justify"})?"is-active":"",title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_align_justify"})})]}),n.jsx("div",{className:"separator"}),n.jsx("div",{className:"group",children:n.jsxs("select",{onChange:r=>{e&&e.chain().focus().setLineHeight(r.target.value).run()},value:e?.getAttributes("paragraph").lineHeight||"normal",disabled:!e,className:"spacing-select",title:"   ",children:[n.jsx("option",{value:"normal",children:" "}),n.jsx("option",{value:"1.0",children:"1.0"}),n.jsx("option",{value:"1.2",children:"1.2"}),n.jsx("option",{value:"1.5",children:"1.5"}),n.jsx("option",{value:"2.0",children:"2.0"}),n.jsx("option",{value:"2.5",children:"2.5"}),n.jsx("option",{value:"3.0",children:"3.0"})]})}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>e?.chain().focus().toggleBulletList().run(),className:e?.isActive("bulletList")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_list_bulleted"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleOrderedList().run(),className:e?.isActive("orderedList")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"format_list_numbered"})}),n.jsx("button",{onClick:()=>e?.chain().focus().toggleTaskList().run(),className:e?.isActive("taskList")?"is-active":"",title:"",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"checklist"})})]}),n.jsx("div",{className:"separator"}),n.jsxs("div",{className:"group",children:[n.jsx("button",{onClick:()=>{const r=window.prompt(" URL ");if(r)try{const s=new URL(r);if(!["http:","https:"].includes(s.protocol)){alert("http  https URL .");return}e?.chain().focus().setImage({src:r}).run()}catch{alert(" URL .")}},title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"add_photo_alternate"})}),n.jsx("button",{onClick:()=>e?.chain().focus().insertTable({rows:3,cols:3,withHeaderRow:!0}).run(),title:" ",disabled:!e,children:n.jsx("span",{className:"material-symbols-outlined",children:"grid_on"})}),n.jsxs("div",{className:"color-picker-wrapper",title:"  ()",children:[n.jsx("span",{className:"material-symbols-outlined",children:"label"}),n.jsx("input",{type:"color",onChange:r=>e?.chain().focus().setHighlight({color:r.target.value}).run(),value:e?.getAttributes("highlight").color||"#ffff00",disabled:!e})]})]})]})},ui=({editor:e,readerSettings:t,onSettingsChange:r})=>{const[s,o]=x.useState(null),i=x.useRef(null);x.useEffect(()=>{const p=f=>{i.current&&!i.current.contains(f.target)&&o(null)};return document.addEventListener("mousedown",p),()=>document.removeEventListener("mousedown",p)},[]);const l=p=>{o(s===p?null:p)},c=()=>{r({fontSize:18,lineHeight:2,paragraphSpacing:40,contentWidth:80,fontFamily:"Noto Sans KR",theme:"light"}),o(null)},a=[{name:"Noto Sans KR",label:"  (Sans)"},{name:"Noto Serif KR",label:"  (Serif)"},{name:"Nanum Myeongjo",label:" "},{name:"Nanum Gothic",label:" "},{name:"Poppins",label:"Poppins"},{name:"Inter",label:"Inter"}],d=[{id:"light",label:"",color:"#ffffff",textColor:"#1c1917"},{id:"sepia",label:"",color:"#ede0d4",textColor:"#311900"},{id:"dark",label:"",color:"#1a1a1a",textColor:"#ffffff"}];return n.jsx("div",{className:"novel-toolbar reader-toolbar",ref:i,children:n.jsxs("div",{className:"group",children:[n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>l("typography"),className:`toolbar-btn ${s==="typography"?"active":""}`,title:" ",children:n.jsx(ms,{size:20})}),s==="typography"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:" "}),n.jsxs("div",{className:"popover-row",children:[n.jsx("button",{className:"popover-btn-small",onClick:()=>r({...t,fontSize:Math.max(12,t.fontSize-1)}),children:n.jsx(xs,{size:16})}),n.jsx("span",{style:{minWidth:"30px",textAlign:"center",fontWeight:600},children:t.fontSize}),n.jsx("button",{className:"popover-btn-small",onClick:()=>r({...t,fontSize:Math.min(32,t.fontSize+1)}),children:n.jsx(gs,{size:16})}),n.jsx("button",{className:"popover-btn-reset",onClick:c,children:""})]})]})]}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>l("font"),className:`toolbar-btn ${s==="font"?"active":""}`,title:" ",children:n.jsx("span",{style:{fontSize:"18px",fontWeight:700},children:"A"})}),s==="font"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:""}),a.map(p=>n.jsxs("div",{className:`popover-item ${t.fontFamily===p.name?"selected":""}`,onClick:()=>{r({...t,fontFamily:p.name}),o(null)},children:[n.jsx("span",{style:{fontFamily:p.name},children:p.label}),t.fontFamily===p.name&&n.jsx(ht,{size:14})]},p.name))]})]}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>l("theme"),className:`toolbar-btn ${s==="theme"?"active":""}`,title:" ",children:n.jsx(ys,{size:20})}),s==="theme"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:""}),d.map(p=>n.jsxs("div",{className:`popover-item ${t.theme===p.id?"selected":""}`,onClick:()=>{r({...t,theme:p.id}),o(null)},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("div",{style:{width:"16px",height:"16px",borderRadius:"50%",backgroundColor:p.color,border:"1px solid #e2e8f0"}}),p.label]}),t.theme===p.id&&n.jsx(ht,{size:14})]},p.id))]})]}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>l("spacing"),className:`toolbar-btn ${s==="spacing"?"active":""}`,title:" ",children:n.jsx(Rn,{size:20})}),s==="spacing"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:" "}),[{val:1.5,label:""},{val:2,label:""},{val:2.5,label:" "}].map(p=>n.jsxs("div",{className:`popover-item ${t.lineHeight===p.val?"selected":""}`,onClick:()=>{r({...t,lineHeight:p.val}),o(null)},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx(Rn,{size:14,style:{opacity:.5}}),p.label]}),t.lineHeight===p.val&&n.jsx(ht,{size:14})]},p.val))]})]}),n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>l("width"),className:`toolbar-btn ${s==="width"?"active":""}`,title:" ",children:n.jsx(bs,{size:20})}),s==="width"&&n.jsxs("div",{className:"reader-popover",children:[n.jsx("div",{className:"popover-header",children:" "}),[{val:70,label:""},{val:80,label:""},{val:90,label:""},{val:100,label:""}].map(p=>n.jsxs("div",{className:`popover-item ${t.contentWidth===p.val?"selected":""}`,onClick:()=>{r({...t,contentWidth:p.val}),o(null)},children:[n.jsxs("span",{children:[p.label," (",p.val,"%)"]}),t.contentWidth===p.val&&n.jsx(ht,{size:14})]},p.val))]})]})]})})};function fi(e,t,r){e+=t;const s=e.split(`

`);e=s.pop()??"";for(const o of s){if(!o.startsWith("data: "))continue;const i=o.slice(6).trim();if(i!=="[DONE]")try{const l=JSON.parse(i);r(l)}catch{console.warn("[SSE] parse error:",i)}}return e}const hi=async(e,t,r,s)=>{const o=cr(),i={"Content-Type":"application/json"};o&&(i.Authorization=`Bearer ${o}`);const l=await fetch(`${_s}/chat/ask/stream`,{method:"POST",headers:i,body:JSON.stringify({question:e.question,novel_id:e.novel_id,chapter_id:e.chapter_id,novel_filter:e.novel_filter,alpha:e.alpha,similarity_threshold:e.similarity_threshold})});if(!l.ok){const p=await l.json().catch(()=>({}));throw new Error(p.detail||`HTTP ${l.status}`)}const c=l.body.getReader(),a=new TextDecoder;let d="";for(;;){const{done:p,value:f}=await c.read();if(p)break;d=fi(d,a.decode(f,{stream:!0}),h=>{h.type==="meta"?r(h):h.type==="token"&&h.text&&t(h.text)})}s()};function mi(e){const t=e.split(/\*{0,2}\[? \]?\*{0,2}/);let r=t[0];const s=t[1]?.trim()||"";return r=r.replace(/\*{0,2}\[? \]?\*{0,2}/,"").trim(),r=r.replace(/\*\*(.*?)\*\*/g,"$1"),{main:r,detail:s.replace(/\*\*(.*?)\*\*/g,"$1")}}function xi({msg:e,onNavigateToScene:t,chapterId:r}){const[s,o]=x.useState(!1),[i,l]=x.useState(!1),{main:c,detail:a}=e.role==="assistant"?mi(e.content):{main:e.content,detail:""};return n.jsx("div",{className:`chatbot-message ${e.role}`,style:{marginBottom:"1rem",alignSelf:e.role==="user"?"flex-end":"flex-start"},children:n.jsxs("div",{className:`chatbot-message-bubble ${e.role==="user"?"user-bubble":"assistant-bubble"}`,style:{padding:"0.75rem 1rem",borderRadius:"1.5rem",maxWidth:"100%",backgroundColor:e.role==="user"?"var(--primary)":"var(--chat-assistant-bg)",color:e.role==="user"?"var(--primary-foreground)":"var(--chat-assistant-text)",border:e.role==="assistant"?"1px solid var(--border)":"none",boxShadow:"0 1px 2px rgba(0,0,0,0.05)"},children:[n.jsx("p",{style:{whiteSpace:"pre-wrap",margin:0},children:c}),a&&n.jsxs("div",{className:"detail-container",style:{marginTop:"0.5rem",borderTop:"1px solid var(--border)",paddingTop:"0.5rem"},children:[n.jsxs("button",{onClick:()=>l(!i),style:{background:"none",border:"none",padding:0,cursor:"pointer",display:"flex",alignItems:"center",gap:"4px",fontSize:"0.75rem",color:"var(--muted-foreground)",fontWeight:"600"},children:[i?n.jsx(de,{size:14,strokeWidth:2.5}):n.jsx(re,{size:14,strokeWidth:2.5})," "]}),i&&n.jsx("p",{style:{whiteSpace:"pre-wrap",marginTop:"0.5rem",fontSize:"0.9rem",color:"var(--muted-foreground)",lineHeight:"1.5"},children:a})]}),e.source&&n.jsxs("div",{className:"source-container",style:{marginTop:"0.5rem",borderTop:"1px solid var(--border)",paddingTop:"0.5rem"},children:[n.jsxs("button",{onClick:()=>o(!s),style:{background:"none",border:"none",padding:0,cursor:"pointer",display:"flex",alignItems:"center",gap:"4px",fontSize:"0.75rem",color:e.role==="user"?"var(--primary-foreground)":"var(--muted-foreground)",opacity:.9,fontWeight:"600"},children:[s?n.jsx(de,{size:14,strokeWidth:2.5}):n.jsx(re,{size:14,strokeWidth:2.5}),""]}),s&&n.jsxs("div",{style:{fontSize:"0.75rem",color:e.role==="user"?"var(--primary-foreground)":"var(--muted-foreground)",opacity:.85,marginTop:"0.5rem",fontStyle:"italic",display:"flex",flexDirection:"column",gap:"4px",animation:"fadeIn 0.2s ease-in-out"},children:[n.jsxs("div",{children:[n.jsx("strong",{children:":"})," ",e.source.filename,e.source.scene_index!==void 0&&` (Scene ${e.source.scene_index+1})`]}),e.source.summary&&n.jsx("div",{style:{backgroundColor:"rgba(0,0,0,0.1)",padding:"6px",borderRadius:"4px",marginTop:"2px",borderLeft:"2px solid currentColor",fontSize:"0.8rem",lineHeight:"1.4"},children:e.source.summary}),e.source.scene_index!==void 0&&t&&n.jsxs("button",{onClick:()=>t(e.source.scene_index),disabled:!!(e.source.chapter_id&&r&&e.source.chapter_id!==r),style:{background:"rgba(255,255,255,0.2)",border:"1px solid rgba(255,255,255,0.3)",borderRadius:"4px",color:"currentColor",padding:"4px 8px",cursor:e.source.chapter_id&&r&&e.source.chapter_id!==r?"not-allowed":"pointer",opacity:e.source.chapter_id&&r&&e.source.chapter_id!==r?.5:1,alignSelf:"flex-start",fontSize:"0.75rem",marginTop:"6px",transition:"all 0.2s"},title:e.source.chapter_id&&r&&e.source.chapter_id!==r?"  .":"",children:[" ",e.source.chapter_id?`Ch.${e.source.chapter_id} `:"","Scene ",e.source.scene_index+1," "]})]})]})]})})}function gi({onNavigateToScene:e,novelId:t,chapterId:r}){const[s,o]=x.useState(""),[i,l]=x.useState([{role:"assistant",content:"!    ."}]),[c,a]=x.useState(!1),d=x.useRef(null),p=x.useRef(!1);x.useEffect(()=>{d.current?.scrollIntoView({behavior:"smooth"})},[i]);const f=x.useCallback(async()=>{if(!s.trim()||c)return;const m=s.trim();o(""),l(b=>[...b,{role:"user",content:m}]),a(!0),p.current=!1;const g=i.length+1;l(b=>[...b,{role:"assistant",content:""}]);try{await hi({question:m,novel_id:t,chapter_id:r},b=>{p.current||l(v=>{const w=[...v],z=w[g];return z&&(z.content+=b),w})},b=>{l(v=>{const w=[...v],z=w[g];return z&&(z.source=b.source,z.similarity=b.similarity),w}),b.found_context||l(v=>{const w=[...v],z=w[g];return z&&(z.content=".     ."),w})},()=>{a(!1)})}catch(b){console.error("Chat stream error:",b),l(v=>{const w=[...v],z=w[g];return z&&(z.content=`: ${b.message||"    ."}`),w}),a(!1)}},[s,c,i.length,t,r]),h=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),f())};return n.jsxs("div",{className:"chatbot-container",style:{display:"flex",flexDirection:"column",height:"100%",backgroundColor:"var(--modal-bg)"},children:[n.jsxs("div",{className:"chatbot-messages",style:{flex:1,overflowY:"auto",padding:"1rem"},children:[i.map((m,g)=>m.role==="assistant"&&!m.content&&c?null:n.jsx(xi,{msg:m,onNavigateToScene:e,chapterId:r},g)),c&&i[i.length-1]?.content===""&&n.jsx("div",{className:"chatbot-message assistant",style:{alignSelf:"flex-start"},children:n.jsx("div",{className:"chatbot-message-bubble assistant-bubble",style:{padding:"0.75rem 1rem",borderRadius:"1.5rem",backgroundColor:"var(--chat-assistant-bg)",border:"1px solid var(--border)",color:"var(--chat-assistant-text)"},children:n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[n.jsx(on,{size:16,strokeWidth:2.5,className:"animate-spin",style:{color:"var(--muted-foreground)"}}),n.jsx("span",{style:{color:"var(--muted-foreground)"},children:"  ..."})]})})}),n.jsx("div",{ref:d})]}),n.jsxs("div",{className:"chatbot-input-area",style:{padding:"1rem",display:"flex",gap:"0.5rem",backgroundColor:"var(--modal-bg)",borderTop:"1px solid var(--border)"},children:[n.jsx("input",{type:"text",className:"chatbot-input",placeholder:" ...",value:s,maxLength:500,onChange:m=>o(m.target.value),onKeyDown:h,disabled:c,style:{flex:1,padding:"0.75rem",borderRadius:"0.5rem",fontSize:"0.95rem",outline:"none",transition:"border-color 0.2s",backgroundColor:"var(--input-bg)",color:"var(--input-text)",border:"1px solid var(--input-border)"}}),n.jsx("button",{className:"chatbot-send",onClick:f,disabled:c||!s.trim(),style:{backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"0.5rem",padding:"0.75rem",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"transform 0.2s",minWidth:"45px",opacity:c||!s.trim()?.5:1},children:c?n.jsx(on,{size:20,strokeWidth:2.5,className:"animate-spin"}):n.jsx(sr,{size:20,strokeWidth:2.5})})]})]})}function yi({onNavigateToScene:e,onAnalyze:t,onPredictStory:r,onOpenCharacterChat:s,onOpenSettings:o,onOpenRelGraph:i,novelId:l,chapterId:c,mode:a="writer"}){const[d,p]=x.useState(!1),[f,h]=x.useState(!1),[m,g]=x.useState(!1),{theme:b}=dr(),v=()=>{p(!d),g(!1)},w=()=>{h(!0),p(!1)},z=()=>{h(!1)},M=W=>{t&&t(W),p(!1),g(!1)};return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"floating-menu-container",children:[d&&n.jsx("div",{className:"floating-menu-options",children:m?n.jsxs(n.Fragment,{children:[n.jsx("button",{className:"menu-option",onClick:()=>g(!1),title:"",style:{background:"var(--muted)",color:"var(--muted-foreground)",border:"none"},children:n.jsx(ln,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option btn-blue",onClick:()=>M("consistency"),title:"  ",children:n.jsx(Tn,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option",onClick:()=>M("plot"),title:" ",style:{background:"#7C3AED",color:"#fff",border:"none"},children:n.jsx(or,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option",onClick:()=>M("style"),title:" ",style:{background:"#0891B2",color:"#fff",border:"none"},children:n.jsx(ir,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option",onClick:()=>M("overall"),title:" ",style:{background:"#059669",color:"#fff",border:"none"},children:n.jsx(lr,{size:20,strokeWidth:2.5})})]}):n.jsxs(n.Fragment,{children:[n.jsx("button",{className:"menu-option btn-purple",onClick:()=>{r&&r(),p(!1)},title:"  (What-If)",children:n.jsx(an,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option",onClick:()=>{i&&i(),p(!1)},title:" ",style:{background:"#10B981",color:"#fff",border:"none"},children:n.jsx(ar,{size:20,strokeWidth:2.5})}),a!=="reader"&&n.jsx("button",{className:"menu-option btn-blue",onClick:()=>g(!0),title:"AI ",children:n.jsx(Tn,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option btn-brown-med",onClick:w,title:"",children:n.jsx(vs,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option btn-brown-rich",onClick:()=>{s&&s(),p(!1)},title:" ",children:n.jsx(Dt,{size:20,strokeWidth:2.5})}),n.jsx("button",{className:"menu-option btn-brown-dark",onClick:()=>{o&&o(),p(!1)},title:"",children:n.jsx(js,{size:20,strokeWidth:2.5})})]})}),n.jsx("button",{className:"floating-menu-btn",onClick:v,"aria-label":"",title:"",style:{backgroundColor:b==="sepia"?"var(--color-dark-brown)":"var(--primary)",color:"var(--primary-foreground)"},children:n.jsx(Cs,{size:24,strokeWidth:2.5})})]}),f&&n.jsxs("div",{className:"chatbot-modal",style:{position:"fixed",bottom:"15px",right:"25px",width:"650px",height:"850px",borderRadius:"1rem",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",display:"flex",flexDirection:"column",zIndex:1e3,overflow:"hidden"},children:[n.jsx("div",{className:"chatbot-header",style:{padding:"16px",borderBottom:"1px solid var(--border)",display:"flex",justifyContent:"flex-end",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)"},children:n.jsx("button",{className:"chatbot-close",onClick:z,style:{color:"currentColor",background:"none",border:"none",cursor:"pointer"},children:n.jsx(qe,{size:20,strokeWidth:2.5})})}),n.jsx("div",{className:"chatbot-content",style:{flex:1,overflow:"hidden"},children:n.jsx(gi,{onNavigateToScene:e,novelId:l,chapterId:c})})]})]})}function bi({onClose:e}){const[t,r]=x.useState(""),[s,o]=x.useState(""),[i,l]=x.useState(localStorage.getItem("llm_model")||"gemini-2.0-flash"),[c,a]=x.useState(!1);x.useEffect(()=>{d()},[]),x.useEffect(()=>{i&&localStorage.setItem("llm_model",i)},[i]);const d=async()=>{try{const m=await pe("/auth/me");r(m.username),o(m.email)}catch(m){console.error("Failed to fetch profile:",m),_.error("    .")}},p=()=>{localStorage.removeItem("token"),localStorage.removeItem("userMode"),window.location.href="/"},f=()=>{_.info("    .")},h=[{value:"gemini-2.0-flash",label:"Gemini 2.0 Flash ()"},{value:"gemini-2.5-flash",label:"Gemini 2.5 Flash ()"},{value:"gemini-1.5-pro",label:"Gemini 1.5 Pro ()"},{value:"gemini-2.0",label:"Gemini 2.0 ()"}];return n.jsx("div",{className:"settings-panel",children:n.jsxs("div",{className:"settings-container",children:[n.jsxs("div",{className:"settings-header",children:[n.jsx("h2",{className:"settings-title",children:""}),n.jsx("button",{onClick:e,className:"close-button","aria-label":"Close settings",children:n.jsx(qe,{size:24,strokeWidth:2})})]}),n.jsxs("div",{className:"settings-content",children:[n.jsx("div",{className:"profile-section",children:n.jsxs("div",{className:"profile-header-text",children:[n.jsx("h3",{className:"section-title",children:" "}),n.jsx("p",{className:"section-description",children:"   AI   ."})]})}),n.jsxs("div",{className:"settings-form",children:[n.jsxs("div",{className:"form-group",children:[n.jsx("label",{className:"form-label",children:""}),n.jsx("input",{className:"form-input",value:t,onChange:m=>r(m.target.value),placeholder:" "})]}),n.jsxs("div",{className:"form-group",children:[n.jsx("label",{className:"form-label",children:""}),n.jsx("input",{className:"form-input disabled",value:s,disabled:!0}),n.jsx("p",{className:"input-note",children:"    "})]}),n.jsxs("div",{className:"form-group",children:[n.jsx("label",{className:"form-label",children:"LLM AI  "}),n.jsxs("div",{className:"select-wrapper",children:[n.jsxs("button",{className:`select-button ${c?"active":""}`,onClick:()=>a(!c),children:[n.jsx("span",{children:h.find(m=>m.value===i)?.label||i}),n.jsx(re,{size:16,className:`dropdown-icon ${c?"open":""}`})]}),c&&n.jsx("div",{className:"select-dropdown",children:h.map(m=>n.jsx("button",{className:`select-option ${i===m.value?"selected":""}`,onClick:()=>{l(m.value),a(!1)},children:m.label},m.value))})]}),n.jsx("p",{className:"model-note",children:" AI      "})]}),n.jsxs("div",{className:"danger-zone",children:[n.jsx("h3",{className:"danger-title",children:" "}),n.jsx("p",{className:"danger-description",children:"     ."}),n.jsx("button",{className:"btn btn-destructive",onClick:f,children:" "})]})]})]}),n.jsx("div",{className:"settings-footer",children:n.jsxs("button",{className:"btn btn-outline",onClick:p,children:[n.jsx(ws,{size:18}),""]})})]})})}const vi={:{color:"#DC2626",bg:"rgba(220, 38, 38, 0.1)",label:"",icon:""},:{color:"#D97706",bg:"rgba(217, 119, 6, 0.1)",label:"",icon:""},:{color:"#2563EB",bg:"rgba(37, 99, 235, 0.1)",label:"",icon:""}};function ji({severity:e}){const t=e?vi[e]:null;return t?n.jsxs("span",{style:{fontSize:"0.75rem",fontWeight:"700",padding:"2px 8px",borderRadius:"10px",backgroundColor:t.bg,color:t.color,marginLeft:"6px"},children:[t.icon," ",t.label]}):null}function yn({score:e}){const t=e>=80?"#16A34A":e>=60?"#D97706":"#DC2626";return n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px 0"},children:[n.jsxs("div",{style:{position:"relative",width:"56px",height:"56px"},children:[n.jsxs("svg",{width:"56",height:"56",viewBox:"0 0 56 56",children:[n.jsx("circle",{cx:"28",cy:"28",r:"24",fill:"none",stroke:"var(--border)",strokeWidth:"5"}),n.jsx("circle",{cx:"28",cy:"28",r:"24",fill:"none",stroke:t,strokeWidth:"5",strokeDasharray:`${e/100*150.8} 150.8`,strokeLinecap:"round",transform:"rotate(-90 28 28)"})]}),n.jsx("span",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",fontSize:"0.9rem",fontWeight:"700",color:t},children:e})]}),n.jsx("span",{style:{fontSize:"0.85rem",color:"var(--muted-foreground)"},children:"/ 100"})]})}function qn({result:e,onNavigateToQuote:t,onApplySuggestion:r,filter:s}){const o=(e.results||[]).filter(i=>s==="all"||i.severity===s);return n.jsxs("div",{children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"16px",borderRadius:"8px",backgroundColor:e.status==="  "?"rgba(220, 38, 38, 0.1)":"rgba(22, 163, 74, 0.1)",marginBottom:"16px",border:"1px solid",borderColor:e.status==="  "?"rgba(220, 38, 38, 0.2)":"rgba(22, 163, 74, 0.2)"},children:[e.status==="  "?n.jsx(xn,{size:24,color:"#DC2626",strokeWidth:2.5}):n.jsx(Mn,{size:24,color:"#16A34A",strokeWidth:2.5}),n.jsxs("div",{children:[n.jsx("h3",{style:{margin:0,fontSize:"1.05rem",fontWeight:"600",color:e.status==="  "?"#DC2626":"#16A34A"},children:e.status}),e.results&&e.results.length>0&&n.jsxs("span",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)"},children:[e.results.length," "]})]})]}),o.length>0?n.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"14px"},children:o.map((i,l)=>n.jsxs("div",{style:{padding:"14px",border:"1px solid var(--modal-border)",borderRadius:"8px",backgroundColor:"var(--card)",color:"var(--card-foreground)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[n.jsx("span",{style:{fontSize:"0.8rem",fontWeight:"600",padding:"3px 10px",borderRadius:"12px",backgroundColor:i.type===" "?"rgba(220, 38, 38, 0.1)":"rgba(217, 119, 6, 0.1)",color:i.type===" "?"#DC2626":"#D97706"},children:i.type}),n.jsx(ji,{severity:i.severity})]}),t&&i.quote&&n.jsxs("button",{onClick:()=>t(i.quote),style:{display:"flex",alignItems:"center",gap:"4px",padding:"3px 8px",fontSize:"0.75rem",backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"4px",cursor:"pointer"},children:[n.jsx(zs,{size:12,strokeWidth:2.5})," "]})]}),n.jsxs("div",{style:{marginBottom:"10px"},children:[n.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.8rem",fontWeight:"600",color:"var(--modal-text)"},children:" :"}),n.jsxs("p",{style:{margin:0,fontSize:"0.85rem",fontStyle:"italic",backgroundColor:"var(--secondary)",padding:"8px",borderRadius:"4px",border:"1px solid var(--border)",color:"var(--modal-text)"},children:['"',i.quote,'"']})]}),i.evidence&&n.jsxs("div",{style:{marginBottom:"10px"},children:[n.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.8rem",fontWeight:"600",color:"var(--modal-text)"},children:":"}),n.jsx("p",{style:{margin:0,fontSize:"0.85rem",color:"var(--muted-foreground)",lineHeight:"1.5"},children:i.evidence})]}),n.jsxs("div",{style:{marginBottom:"10px"},children:[n.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.8rem",fontWeight:"600",color:"var(--modal-text)"},children:":"}),n.jsx("p",{style:{margin:0,fontSize:"0.85rem",color:"var(--muted-foreground)",lineHeight:"1.5"},children:i.description})]}),n.jsxs("div",{children:[n.jsx("p",{style:{margin:"0 0 4px 0",fontSize:"0.8rem",fontWeight:"600",color:"var(--modal-text)"},children:":"}),n.jsx("p",{style:{margin:0,fontSize:"0.85rem",color:"#059669",lineHeight:"1.5"},children:i.suggestion}),r&&i.quote&&i.suggestion&&n.jsxs("button",{onClick:()=>r(i.quote,i.suggestion),style:{marginTop:"6px",display:"flex",alignItems:"center",gap:"4px",padding:"4px 10px",fontSize:"0.75rem",backgroundColor:"rgba(5, 150, 105, 0.1)",color:"#059669",border:"1px solid rgba(5, 150, 105, 0.3)",borderRadius:"4px",cursor:"pointer"},children:[n.jsx(Ns,{size:12}),"  "]})]})]},l))}):n.jsxs("div",{style:{textAlign:"center",padding:"30px 20px",color:"var(--muted-foreground)"},children:[n.jsx(Mn,{size:40,color:"#16A34A",strokeWidth:2.5,style:{margin:"0 auto 12px"}}),n.jsx("p",{style:{fontSize:"0.95rem",fontWeight:"500"},children:"  !"})]})]})}function Qn({data:e}){return!e||e.error?n.jsx("p",{style:{color:"var(--muted-foreground)"},children:"   ."}):n.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.evaluation?.score!=null&&n.jsx(yn,{score:e.evaluation.score}),e.structure&&n.jsxs("div",{children:[n.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[": ",e.structure.type]}),(e.structure.sections||[]).map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",backgroundColor:"var(--secondary)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsx("strong",{children:t.name}),": ",t.description]},r))]}),e.conflicts&&e.conflicts.length>0&&n.jsxs("div",{children:[n.jsx("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:" "}),e.conflicts.map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsx("span",{style:{padding:"2px 6px",borderRadius:"4px",backgroundColor:"rgba(220, 38, 38, 0.1)",color:"#DC2626",fontSize:"0.75rem",fontWeight:"600"},children:t.type}),n.jsxs("span",{style:{marginLeft:"6px",fontSize:"0.75rem",color:"var(--muted-foreground)"},children:[": ",t.intensity,"/10"]}),n.jsx("p",{style:{margin:"6px 0 0",color:"var(--muted-foreground)"},children:t.description})]},r))]}),e.pacing&&n.jsxs("div",{children:[n.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[" : ",e.pacing.overall]}),(e.pacing.issues||[]).map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsx("p",{style:{margin:"0 0 4px",fontWeight:"500"},children:t.description}),t.suggestion&&n.jsxs("p",{style:{margin:0,color:"#059669",fontSize:"0.8rem"},children:["->"," ",t.suggestion]})]},r))]}),e.foreshadowing&&e.foreshadowing.length>0&&n.jsxs("div",{children:[n.jsx("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:"/"}),e.foreshadowing.map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",backgroundColor:"var(--secondary)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsx("span",{style:{padding:"2px 6px",borderRadius:"4px",backgroundColor:t.type===""?"rgba(22, 163, 74, 0.1)":t.type===""?"rgba(37, 99, 235, 0.1)":"rgba(217, 119, 6, 0.1)",color:t.type===""?"#16A34A":t.type===""?"#2563EB":"#D97706",fontSize:"0.75rem",fontWeight:"600"},children:t.type}),n.jsx("p",{style:{margin:"6px 0 0",color:"var(--muted-foreground)"},children:t.description})]},r))]}),e.evaluation&&n.jsxs("div",{children:[(e.evaluation.strengths?.length??0)>0&&n.jsxs("div",{style:{marginBottom:"8px"},children:[n.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#16A34A"},children:""}),e.evaluation.strengths?.map((t,r)=>n.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["+ ",t]},r))]}),(e.evaluation.weaknesses?.length??0)>0&&n.jsxs("div",{style:{marginBottom:"8px"},children:[n.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#DC2626"},children:""}),e.evaluation.weaknesses?.map((t,r)=>n.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["- ",t]},r))]})]})]})}function Zn({data:e}){return!e||e.error?n.jsx("p",{style:{color:"var(--muted-foreground)"},children:"   ."}):n.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.evaluation?.score!=null&&n.jsx(yn,{score:e.evaluation.score}),e.tone&&n.jsxs("div",{children:[n.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[": ",e.tone.primary," (",e.tone.consistency,")"]}),(e.tone.issues||[]).map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsx("p",{style:{margin:"0 0 4px"},children:t.description}),t.suggestion&&n.jsxs("p",{style:{margin:0,color:"#059669",fontSize:"0.8rem"},children:["->"," ",t.suggestion]})]},r))]}),e.sentence_structure&&n.jsxs("div",{children:[n.jsx("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:" "}),n.jsxs("p",{style:{margin:"0 0 4px",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:[" : ",e.sentence_structure.dialogue_ratio]}),n.jsxs("p",{style:{margin:"0 0 8px",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["  : ",e.sentence_structure.avg_length]}),(e.sentence_structure.issues||[]).map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsx("p",{style:{margin:"0 0 4px"},children:t.description}),t.suggestion&&n.jsxs("p",{style:{margin:0,color:"#059669",fontSize:"0.8rem"},children:["->"," ",t.suggestion]})]},r))]}),e.vocabulary&&n.jsxs("div",{children:[n.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[" : ",e.vocabulary.diversity]}),(e.vocabulary.repetitions||[]).map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",backgroundColor:"var(--secondary)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsxs("strong",{children:['"',t.word,'"']})," (",t.count,") ","->"," : ",(t.alternatives||[]).join(", ")]},r)),(e.vocabulary.cliches||[]).map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsx("span",{style:{color:"#D97706"},children:":"}),' "',t.expression,'"',t.suggestion&&n.jsxs("p",{style:{margin:"4px 0 0",color:"#059669",fontSize:"0.8rem"},children:["->"," ",t.suggestion]})]},r))]}),e.point_of_view&&n.jsxs("div",{children:[n.jsxs("h4",{style:{margin:"0 0 8px",fontSize:"0.9rem",fontWeight:"600",color:"var(--modal-text)"},children:[" : ",e.point_of_view.type," (",e.point_of_view.consistency,")"]}),(e.point_of_view.issues||[]).map((t,r)=>n.jsxs("div",{style:{padding:"8px",marginBottom:"6px",border:"1px solid var(--border)",borderRadius:"6px",fontSize:"0.85rem"},children:[n.jsx("p",{style:{margin:"0 0 4px"},children:t.description}),t.suggestion&&n.jsxs("p",{style:{margin:0,color:"#059669",fontSize:"0.8rem"},children:["->"," ",t.suggestion]})]},r))]}),e.evaluation&&n.jsxs("div",{children:[(e.evaluation.strengths?.length??0)>0&&n.jsxs("div",{style:{marginBottom:"8px"},children:[n.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#16A34A"},children:""}),e.evaluation.strengths?.map((t,r)=>n.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["+ ",t]},r))]}),(e.evaluation.weaknesses?.length??0)>0&&n.jsxs("div",{style:{marginBottom:"8px"},children:[n.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#DC2626"},children:""}),e.evaluation.weaknesses?.map((t,r)=>n.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["- ",t]},r))]})]})]})}const er={consistency:{label:"  ",icon:xn},plot:{label:" ",icon:or},style:{label:" ",icon:ir},overall:{label:" ",icon:lr}};function Ci({isOpen:e,onClose:t,result:r,isLoading:s,isCachedResult:o,onNavigateToQuote:i,onReanalyze:l,onApplySuggestion:c,analysisType:a="consistency"}){const[d,p]=x.useState("all");if(x.useEffect(()=>{if(!e)return;const g=b=>{b.key==="Escape"&&t()};return document.addEventListener("keydown",g),()=>document.removeEventListener("keydown",g)},[e,t]),!e)return null;const f=er[a]||er.consistency,h=f.icon,m=()=>{if(s)return n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",gap:"16px"},children:[n.jsx(on,{size:48,strokeWidth:2.5,style:{animation:"spin 1s linear infinite",color:"var(--primary)"}}),n.jsx("p",{style:{color:"var(--muted-foreground)",fontSize:"0.95rem"},children:" ..."})]});if(!r)return n.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",color:"var(--muted-foreground)"},children:[n.jsx("p",{children:"  ."}),n.jsx("p",{style:{fontSize:"0.9rem",marginTop:"8px"},children:"    ."})]});if(r.error)return n.jsxs("div",{style:{textAlign:"center",padding:"40px 20px",color:"#DC2626"},children:[n.jsx(xn,{size:40,style:{margin:"0 auto 12px"}}),n.jsx("p",{children:"   ."}),n.jsx("p",{style:{fontSize:"0.85rem",marginTop:"8px",color:"var(--muted-foreground)"},children:r.error})]});switch(a){case"consistency":return n.jsx(qn,{result:r,onNavigateToQuote:i,onApplySuggestion:c,filter:d});case"plot":return n.jsx(Qn,{data:r});case"style":return n.jsx(Zn,{data:r});case"overall":return n.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"20px"},children:[r.evaluation?.score!=null&&n.jsx(yn,{score:r.evaluation.score}),(r.evaluation?.strengths?.length??0)>0&&n.jsxs("div",{children:[n.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#16A34A"},children:""}),r.evaluation?.strengths?.map((g,b)=>n.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["+ ",g]},b))]}),(r.evaluation?.weaknesses?.length??0)>0&&n.jsxs("div",{children:[n.jsx("p",{style:{margin:"0 0 4px",fontSize:"0.8rem",fontWeight:"600",color:"#DC2626"},children:""}),r.evaluation?.weaknesses?.map((g,b)=>n.jsxs("p",{style:{margin:"2px 0",fontSize:"0.85rem",color:"var(--muted-foreground)"},children:["- ",g]},b))]}),n.jsx("h3",{style:{margin:"8px 0 0",fontSize:"1rem",fontWeight:"600",borderTop:"1px solid var(--border)",paddingTop:"12px"},children:" "}),n.jsx(Qn,{data:r.plot}),n.jsx("h3",{style:{margin:"8px 0 0",fontSize:"1rem",fontWeight:"600",borderTop:"1px solid var(--border)",paddingTop:"12px"},children:" "}),n.jsx(Zn,{data:r.style})]});default:return n.jsx(qn,{result:r,onNavigateToQuote:i,onApplySuggestion:c,filter:d})}};return n.jsxs("div",{style:{position:"fixed",bottom:window.innerWidth<=640?"0":"16px",right:window.innerWidth<=640?"0":"20px",width:window.innerWidth<=640?"100%":"450px",height:window.innerWidth<=640?"100%":"750px",maxHeight:"100dvh",borderRadius:window.innerWidth<=640?"0":"16px",backgroundColor:"var(--modal-bg)",color:"var(--modal-text)",boxShadow:"0 8px 32px rgba(0,0,0,0.15)",zIndex:1e3,display:"flex",flexDirection:"column",border:window.innerWidth<=640?"none":"1px solid var(--modal-border)",animation:"slideUp 0.3s ease"},children:[n.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)",borderRadius:"16px 16px 0 0"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx(h,{size:18,strokeWidth:2.5}),n.jsx("h2",{style:{margin:0,fontSize:"1.1rem",fontWeight:"600",color:"inherit"},children:f.label})]}),n.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[r&&!s&&n.jsx("button",{onClick:()=>{const g=JSON.stringify(r,null,2);navigator.clipboard.writeText(g).then(()=>_.success("  ."))},title:" ","aria-label":" ",style:{background:"none",border:"none",cursor:"pointer",padding:"4px",color:"inherit",display:"flex",alignItems:"center"},children:n.jsx(Ss,{size:18,strokeWidth:2.5})}),l&&r&&!s&&n.jsx("button",{onClick:l,title:"",style:{background:"none",border:"none",cursor:"pointer",padding:"4px",color:"inherit",display:"flex",alignItems:"center"},children:n.jsx(ks,{size:18,strokeWidth:2.5})}),n.jsx("button",{onClick:t,"aria-label":"",title:"",style:{background:"none",border:"none",cursor:"pointer",padding:"4px",color:"inherit"},children:n.jsx(qe,{size:22,strokeWidth:2.5})})]})]}),a==="consistency"&&r&&r.results&&r.results.length>0&&!s&&n.jsxs("div",{style:{padding:"8px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("span",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)"},children:":"}),n.jsxs("div",{style:{position:"relative"},children:[n.jsxs("select",{value:d,onChange:g=>p(g.target.value),style:{appearance:"none",fontSize:"0.8rem",padding:"4px 24px 4px 8px",border:"1px solid var(--border)",borderRadius:"4px",backgroundColor:"var(--card)",color:"var(--card-foreground)",cursor:"pointer"},children:[n.jsx("option",{value:"all",children:""}),n.jsx("option",{value:"",children:""}),n.jsx("option",{value:"",children:""}),n.jsx("option",{value:"",children:""})]}),n.jsx(re,{size:12,style:{position:"absolute",right:"6px",top:"50%",transform:"translateY(-50%)",pointerEvents:"none",color:"var(--muted-foreground)"}})]})]}),o&&r&&!s&&n.jsxs("div",{style:{padding:"10px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"rgba(59, 130, 246, 0.08)"},children:[n.jsx("span",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)"},children:"  "}),l&&n.jsx("button",{onClick:l,style:{fontSize:"0.8rem",padding:"4px 12px",borderRadius:"6px",border:"1px solid var(--primary)",backgroundColor:"var(--primary)",color:"white",cursor:"pointer",fontWeight:"500"},children:" "})]}),n.jsx("div",{style:{flex:1,overflowY:"auto",padding:"20px",backgroundColor:"var(--modal-bg)",borderRadius:"0 0 16px 16px"},children:m()}),n.jsx("style",{children:`
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                @keyframes slideUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `})]})}const tr=["#4F46E5","#DC2626","#059669","#D97706","#7C3AED","#DB2777","#0891B2","#65A30D","#EA580C","#6366F1","#14B8A6","#F59E0B","#EF4444","#8B5CF6","#EC4899"];function be(e){return e.source||e.character1||""}function ze(e){return e.target||e.character2||""}function wi(){const e=getComputedStyle(document.documentElement);return{foreground:e.getPropertyValue("--foreground").trim()||"#1c1917",mutedForeground:e.getPropertyValue("--muted-foreground").trim()||"#78716c",modalBg:e.getPropertyValue("--modal-bg").trim()||"#ffffff",border:e.getPropertyValue("--border").trim()||"#e7e5e4",modalText:e.getPropertyValue("--modal-text").trim()||"#1c1917"}}function Si({isOpen:e,onClose:t,relationships:r,characters:s=[]}){const o=x.useRef(null),i=x.useRef(null),[l,c]=x.useState(null),[a,d]=x.useState({w:600,h:500}),p=x.useRef([]),f=x.useRef(0),h=x.useRef(null),[m,g]=x.useState(!1),b=x.useMemo(()=>{const j=new Set;for(const y of r){const S=be(y),N=ze(y);S&&j.add(S),N&&j.add(N)}return Array.from(j)},[r]),v=x.useMemo(()=>{const j=new Map;return b.forEach((y,S)=>j.set(y,tr[S%tr.length])),j},[b]),w=x.useMemo(()=>{const j=new Map;for(const y of s)j.set(y.name,y);return j},[s]),z=x.useMemo(()=>{let j=1/0,y=0;for(const S of s){const N=S.appearance_count||0;N<j&&(j=N),N>y&&(y=N)}return j===1/0&&(j=0),{min:j,max:y}},[s]),M=x.useMemo(()=>{const j=new Map;for(const y of r){const S=be(y),N=ze(y);j.set(S,(j.get(S)||0)+1),j.set(N,(j.get(N)||0)+1)}return j},[r]),[W,V]=x.useState(new Set);x.useEffect(()=>{e&&b.length>0&&W.size===0&&V(new Set(b.slice(0,Math.min(3,b.length))))},[e,b]);const X=x.useMemo(()=>W.size===0?[]:r.filter(j=>W.has(be(j))&&W.has(ze(j))),[r,W]),D=x.useMemo(()=>Array.from(W),[W]),le=j=>{V(y=>{const S=new Set(y);return S.has(j)?S.delete(j):S.add(j),S})},ee=()=>V(new Set(b)),De=()=>V(new Set),Qe=x.useCallback((j,y)=>{const N=w.get(j)?.appearance_count||0,{min:H,max:I}=z;if(I===H||I===0)return y;const oe=(N-H)/(I-H),T=y*.75,E=y*1.4;return T+oe*(E-T)},[w,z]);x.useEffect(()=>{if(!e||!i.current)return;const j=()=>{if(!i.current)return;const N=i.current.getBoundingClientRect();N.width>0&&N.height>0&&d({w:N.width,h:N.height})};requestAnimationFrame(j);const y=setTimeout(j,100),S=new ResizeObserver(j);return S.observe(i.current),()=>{clearTimeout(y),S.disconnect()}},[e]),x.useEffect(()=>{if(!e)return;const{w:j,h:y}=a,S=j/2,N=y/2,H=D.length,I=Math.min(j,y)*.32,oe=Math.max(30,Math.min(45,j/(H*2.2)));p.current=D.map((T,E)=>{const B=2*Math.PI*E/H-Math.PI/2;return{name:T,x:H===1?S:S+I*Math.cos(B),y:H===1?N:N+I*Math.sin(B),color:v.get(T)||"#4F46E5",initials:T.slice(0,2),radius:Qe(T,oe)}})},[e,D,a,v,Qe]);const Be=x.useCallback(j=>p.current.find(y=>y.name===j),[]),Te=x.useCallback((j,y)=>{if(y)return 3.5;const S=j.description?.length||0,N=w.get(be(j))?.appearance_count||0,H=w.get(ze(j))?.appearance_count||0,I=S+(N+H)*2;return I>100?3:I>40?2.2:1.5},[w]),Ze=x.useMemo(()=>{const j=new Map;for(const y of X){const S=[be(y),ze(y)].sort().join("|"),N=j.get(S);N?N.total++:j.set(S,{total:1,current:0})}return j},[X]),Me=x.useCallback(()=>{const j=o.current;if(!j)return;const y=j.getContext("2d");if(!y)return;const{w:S,h:N}=a,H=window.devicePixelRatio||1;j.width=S*H,j.height=N*H,y.scale(H,H),y.clearRect(0,0,S,N);const I=wi();if(D.length===0){y.font='14px Pretendard, "Noto Sans KR", sans-serif',y.fillStyle=I.mutedForeground,y.textAlign="center",y.textBaseline="middle",y.fillText("  ",S/2,N/2);return}const oe=new Map;for(const T of X){const E=Be(be(T)),B=Be(ze(T));if(!E||!B)continue;const xe=l===E.name||l===B.name,et=Te(T,xe),ae=[E.name,B.name].sort().join("|"),tt=Ze.get(ae),Z=oe.get(ae)||0;oe.set(ae,Z+1);const nt=tt?.total||1,ce=nt>1?(Z-(nt-1)/2)*40:0,Fe=(E.x+B.x)/2,Ce=(E.y+B.y)/2,we=Math.atan2(B.y-E.y,B.x-E.x),ge=-Math.sin(we)*ce,Se=Math.cos(we)*ce,rt=Fe+ge,st=Ce+Se;y.beginPath(),y.moveTo(E.x,E.y),ce!==0?y.quadraticCurveTo(rt,st,B.x,B.y):y.lineTo(B.x,B.y),y.strokeStyle=xe?E.color:`${I.mutedForeground}66`,y.lineWidth=et,y.setLineDash([]),y.stroke();const ot=ce!==0?(E.x+2*rt+B.x)/4:Fe,it=ce!==0?(E.y+2*st+B.y)/4:Ce,ne=ce!==0?Math.atan2(B.y-E.y+Se,B.x-E.x+ge):we,ke=8;if(y.beginPath(),y.moveTo(ot+ke*Math.cos(ne),it+ke*Math.sin(ne)),y.lineTo(ot-ke*Math.cos(ne-.4),it-ke*Math.sin(ne-.4)),y.lineTo(ot-ke*Math.cos(ne+.4),it-ke*Math.sin(ne+.4)),y.closePath(),y.fillStyle=xe?E.color:`${I.mutedForeground}88`,y.fill(),T.relation){const Oe=ce!==0?rt:Fe,Ue=(ce!==0?st:Ce)-14,ie=T.relation;y.font=`${xe?"bold 13":"11"}px Pretendard, "Noto Sans KR", sans-serif`;const jt=y.measureText(ie),Le=5;y.fillStyle=`${I.modalBg}ee`,y.beginPath(),y.roundRect(Oe-jt.width/2-Le,Ue-8-Le,jt.width+Le*2,16+Le*2,6),y.fill(),y.strokeStyle=xe?E.color:`${I.border}`,y.lineWidth=1,y.stroke(),y.fillStyle=xe?E.color:I.mutedForeground,y.textAlign="center",y.textBaseline="middle",y.fillText(ie,Oe,Ue)}}for(const T of p.current){const E=l===T.name,B=E?T.radius+5:T.radius;y.shadowColor=E?`${T.color}55`:"rgba(0,0,0,0.1)",y.shadowBlur=E?20:8,y.shadowOffsetX=0,y.shadowOffsetY=3,E&&(y.beginPath(),y.arc(T.x,T.y,B+5,0,Math.PI*2),y.fillStyle=`${T.color}20`,y.fill()),y.beginPath(),y.arc(T.x,T.y,B,0,Math.PI*2),y.fillStyle=T.color,y.fill(),y.shadowColor="transparent",y.strokeStyle=I.modalBg,y.lineWidth=3,y.stroke(),y.font=`bold ${Math.round(B*.55)}px Pretendard, "Noto Sans KR", sans-serif`,y.fillStyle="#fff",y.textAlign="center",y.textBaseline="middle",y.fillText(T.initials,T.x,T.y),y.font=`${E?"bold ":""}13px Pretendard, "Noto Sans KR", sans-serif`,y.fillStyle=I.foreground,y.textBaseline="top",y.fillText(T.name,T.x,T.y+B+10)}},[X,D,l,a,Be,Te,Ze]);x.useEffect(()=>{e&&(cancelAnimationFrame(f.current),f.current=requestAnimationFrame(Me))},[Me,e]);const Ee=x.useCallback(j=>{const y=o.current;if(!y)return{mx:0,my:0};const S=y.getBoundingClientRect();return{mx:j.clientX-S.left,my:j.clientY-S.top}},[]),L=x.useCallback((j,y)=>{for(const S of p.current){const N=j-S.x,H=y-S.y;if(N*N+H*H<(S.radius+12)*(S.radius+12))return S}return null},[]),gt=x.useCallback(j=>{const{mx:y,my:S}=Ee(j),N=L(y,S);N&&(h.current={name:N.name,offsetX:y-N.x,offsetY:S-N.y},g(!0))},[Ee,L]),Pt=x.useCallback(j=>{const{mx:y,my:S}=Ee(j);if(h.current){const H=p.current.find(I=>I.name===h.current.name);H&&(H.x=y-h.current.offsetX,H.y=S-h.current.offsetY,cancelAnimationFrame(f.current),f.current=requestAnimationFrame(Me));return}const N=L(y,S);c(N?.name||null)},[Ee,L,Me]),yt=x.useCallback(()=>{h.current=null,g(!1)},[]),J=x.useCallback(()=>{h.current=null,g(!1),c(null)},[]);if(!e)return null;const te=l?w.get(l):null,O=l?X.filter(j=>be(j)===l||ze(j)===l):[],Pe=l&&M.get(l)||0,We=m?"grabbing":l?"grab":"default",bt=b.length===0,vt=b.length>0&&r.length===0;return n.jsx("div",{style:{position:"fixed",inset:0,zIndex:1100,background:"rgba(0,0,0,0.6)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center"},onClick:j=>{j.target===j.currentTarget&&t()},children:n.jsxs("div",{style:{width:"92vw",maxWidth:"1200px",height:"82vh",maxHeight:"800px",background:"var(--modal-bg, #fff)",borderRadius:"16px",border:"1px solid var(--modal-border, #e5e7eb)",boxShadow:"0 20px 60px rgba(0,0,0,0.3)",display:"flex",flexDirection:"column",overflow:"hidden"},children:[n.jsxs("div",{style:{padding:"14px 24px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"space-between",background:"var(--modal-header-bg)",color:"var(--modal-header-text)"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[n.jsx(ar,{size:22}),n.jsx("h2",{style:{margin:0,fontSize:"1.1rem",fontWeight:700},children:" "}),n.jsxs("span",{style:{fontSize:"0.78rem",opacity:.6},children:[W.size,"/",b.length,"   ",X.length," "]})]}),n.jsx("button",{onClick:t,style:{background:"none",border:"none",cursor:"pointer",color:"currentColor",padding:"4px"},children:n.jsx(qe,{size:22})})]}),bt?n.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"16px",color:"var(--muted-foreground)",padding:"40px"},children:[n.jsx(As,{size:48,strokeWidth:1.5}),n.jsxs("div",{style:{textAlign:"center"},children:[n.jsx("p",{style:{fontSize:"1rem",fontWeight:600,margin:"0 0 8px"},children:"  "}),n.jsx("p",{style:{fontSize:"0.85rem",opacity:.7,margin:0},children:"   ."})]})]}):vt?n.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"16px",color:"var(--muted-foreground)",padding:"40px"},children:[n.jsx(Dt,{size:48,strokeWidth:1.5}),n.jsxs("div",{style:{textAlign:"center"},children:[n.jsx("p",{style:{fontSize:"1rem",fontWeight:600,margin:"0 0 8px"},children:"    "}),n.jsxs("p",{style:{fontSize:"0.85rem",opacity:.7,margin:0},children:[b.length,"       ."]})]})]}):n.jsxs("div",{style:{flex:1,display:"flex",overflow:"hidden"},children:[n.jsxs("div",{style:{width:"220px",borderRight:"1px solid var(--border)",display:"flex",flexDirection:"column",background:"var(--card-bg, #fafafa)"},children:[n.jsxs("div",{style:{padding:"10px 14px",borderBottom:"1px solid var(--border)",display:"flex",gap:"6px"},children:[n.jsx("button",{onClick:ee,style:{flex:1,padding:"5px",fontSize:"0.75rem",fontWeight:600,border:"1px solid var(--border)",borderRadius:"6px",cursor:"pointer",background:"transparent",color:"var(--foreground)"},children:" "}),n.jsx("button",{onClick:De,style:{flex:1,padding:"5px",fontSize:"0.75rem",fontWeight:600,border:"1px solid var(--border)",borderRadius:"6px",cursor:"pointer",background:"transparent",color:"var(--foreground)"},children:" "})]}),n.jsx("div",{style:{flex:1,overflowY:"auto",padding:"6px"},children:b.map(j=>{const y=W.has(j),S=v.get(j)||"#4F46E5",N=w.get(j),H=M.get(j)||0,I=N?.appearance_count;return n.jsxs("button",{onClick:()=>le(j),style:{width:"100%",display:"flex",alignItems:"center",gap:"10px",padding:"8px 10px",marginBottom:"2px",borderRadius:"8px",border:"none",cursor:"pointer",textAlign:"left",background:y?`${S}12`:"transparent",transition:"background 0.15s"},children:[n.jsx("div",{style:{width:"30px",height:"30px",borderRadius:"50%",background:y?S:"#ddd",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:"0.7rem",fontWeight:700,transition:"background 0.15s"},children:y?n.jsx(ht,{size:14,strokeWidth:3}):j.slice(0,1)}),n.jsxs("div",{style:{flex:1,minWidth:0},children:[n.jsx("div",{style:{fontSize:"0.85rem",fontWeight:y?700:500,color:y?S:"var(--foreground)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j}),n.jsxs("div",{style:{fontSize:"0.7rem",color:"var(--muted-foreground)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:[H," ",I?`  ${I} `:"",N?.traits?.[0]?`  ${N.traits[0]}`:""]})]})]},j)})})]}),n.jsxs("div",{ref:i,style:{flex:1,position:"relative",minHeight:0},children:[n.jsx("canvas",{ref:o,style:{width:"100%",height:"100%",cursor:We},onMouseDown:gt,onMouseMove:Pt,onMouseUp:yt,onMouseLeave:J}),l&&!m&&n.jsxs("div",{style:{position:"absolute",bottom:"16px",left:"16px",maxWidth:"380px",background:"var(--modal-bg, #fff)",border:"1px solid var(--border)",borderRadius:"12px",padding:"14px 18px",boxShadow:"0 4px 16px rgba(0,0,0,0.12)",pointerEvents:"none",color:"var(--modal-text, #1c1917)"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"8px"},children:[n.jsx("div",{style:{width:"28px",height:"28px",borderRadius:"50%",background:v.get(l)||"#4F46E5",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:"0.7rem",fontWeight:700},children:l.slice(0,2)}),n.jsxs("div",{children:[n.jsx("span",{style:{fontWeight:700,fontSize:"0.95rem"},children:l}),n.jsxs("div",{style:{fontSize:"0.72rem",color:"var(--muted-foreground)",marginTop:"1px"},children:[Pe," ",te?.appearance_count?`  ${te.appearance_count} `:""]})]})]}),te?.traits&&te.traits.length>0&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",marginBottom:"8px"},children:te.traits.map((j,y)=>n.jsx("span",{style:{fontSize:"0.68rem",padding:"2px 8px",borderRadius:"10px",background:`${v.get(l)||"#4F46E5"}18`,color:v.get(l)||"#4F46E5",fontWeight:600,border:`1px solid ${v.get(l)||"#4F46E5"}30`},children:j},y))}),te?.description&&n.jsx("p",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)",margin:"0 0 8px",lineHeight:1.5},children:te.description.length>150?te.description.slice(0,150)+"...":te.description}),O.length>0&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"},children:O.map((j,y)=>{const S=be(j)===l?ze(j):be(j);return n.jsxs("span",{style:{fontSize:"0.7rem",padding:"2px 8px",borderRadius:"10px",background:`${v.get(S)||"#666"}22`,color:v.get(S)||"#666",fontWeight:600},children:[S,": ",j.relation||""]},y)})})]})]})]})]})})}function ki({isOpen:e,onClose:t,messages:r,onSendMessage:s,isLoading:o,onClearChat:i}){const[l,c]=x.useState(""),a=x.useRef(null),d=()=>{a.current?.scrollIntoView({behavior:"smooth"})},p=m=>{const g=m.match(/[^.!?]+[.!?]+(\s|$)/g);if(!g)return m;let b="";for(let v=0;v<g.length;v++)b+=g[v],(v+1)%2===0&&v<g.length-1&&(b+=`

`);return b||m};x.useEffect(()=>{e&&d()},[r,e,o]);const f=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),h())},h=()=>{!l.trim()||o||(s(l),c(""))};return e?n.jsxs("div",{style:{position:"fixed",bottom:"16px",right:"20px",width:"500px",height:"850px",backgroundColor:"var(--modal-bg)",boxShadow:"0 8px 32px rgba(0,0,0,0.15)",zIndex:1e3,display:"flex",flexDirection:"column",borderRadius:"16px",border:"1px solid var(--modal-border)",animation:"slideUp 0.3s ease"},children:[n.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid var(--modal-border)",display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"var(--modal-header-bg)",color:"var(--modal-header-text)",borderRadius:"16px 16px 0 0"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx(an,{size:20,strokeWidth:2.5,className:o?"animate-spin":"",style:{color:"var(--primary)"}}),n.jsx("h3",{style:{margin:0,fontSize:"1.1rem",fontWeight:"bold",color:"inherit"},children:"  "})]}),n.jsxs("div",{style:{display:"flex",gap:"8px"},children:[i&&r.length>0&&n.jsx("button",{onClick:i,title:" ",style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx(Rs,{size:18,strokeWidth:2.5})}),n.jsx("button",{onClick:t,style:{background:"none",border:"none",cursor:"pointer",color:"var(--muted-foreground)",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx(qe,{size:20,strokeWidth:2.5})})]})]}),n.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"20px",backgroundColor:"var(--modal-bg)",display:"flex",flexDirection:"column",gap:"20px"},children:[r.length===0&&n.jsxs("div",{style:{textAlign:"center",color:"var(--muted-foreground)",marginTop:"60px",display:"flex",flexDirection:"column",alignItems:"center",gap:"12px"},children:[n.jsx(an,{size:48,strokeWidth:2.5,style:{opacity:.2,color:"var(--primary)"}}),n.jsxs("p",{style:{lineHeight:"1.5"},children:['"   ?"',n.jsx("br",{}),"AI   ."]})]}),r.map(m=>n.jsxs("div",{style:{display:"flex",justifyContent:m.role==="user"?"flex-end":"flex-start",gap:"12px"},children:[m.role==="assistant"&&n.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:"4px"},children:n.jsx(Ts,{size:18,strokeWidth:2.5,style:{color:"var(--primary)"}})}),n.jsx("div",{style:{maxWidth:"85%",padding:"12px 16px",borderRadius:"12px",borderTopLeftRadius:m.role==="assistant"?"2px":"12px",borderTopRightRadius:m.role==="user"?"2px":"12px",backgroundColor:m.role==="user"?"var(--primary)":"var(--input-bg)",color:m.role==="user"?"var(--primary-foreground)":"var(--input-text)",boxShadow:m.role==="assistant"?"0 1px 2px rgba(0,0,0,0.05)":"none",border:m.role==="assistant"?"1px solid var(--input-border)":"none",lineHeight:"1.6",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:m.role==="assistant"?p(m.content):m.content}),m.role==="user"&&n.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:"4px"},children:n.jsx(Ms,{size:18,strokeWidth:2.5,style:{color:"var(--muted-foreground)"}})})]},m.id)),o&&n.jsxs("div",{style:{display:"flex",gap:"12px"},children:[n.jsx("div",{style:{width:"32px",height:"32px",borderRadius:"50%",backgroundColor:"var(--secondary)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:n.jsx(En,{className:"animate-spin",size:18,strokeWidth:2.5,style:{color:"var(--primary)"}})}),n.jsx("div",{style:{padding:"12px 16px",borderRadius:"12px",borderTopLeftRadius:"2px",backgroundColor:"var(--input-bg)",border:"1px solid var(--input-border)",color:"var(--muted-foreground)",boxShadow:"0 1px 2px rgba(0,0,0,0.05)"},children:"  ..."})]}),n.jsx("div",{ref:a})]}),n.jsx("div",{style:{padding:"16px",backgroundColor:"var(--modal-bg)",borderTop:"1px solid var(--modal-border)",borderRadius:"0 0 16px 16px"},children:n.jsxs("div",{style:{display:"flex",gap:"10px",alignItems:"flex-end",backgroundColor:"var(--input-bg)",padding:"8px",borderRadius:"12px",border:"1px solid var(--input-border)"},children:[n.jsx("textarea",{value:l,onChange:m=>c(m.target.value),onKeyDown:f,placeholder:" ...",style:{flex:1,border:"none",background:"transparent",resize:"none",height:"auto",minHeight:"24px",maxHeight:"120px",padding:"8px",fontSize:"0.95rem",outline:"none",fontFamily:"inherit",overflowY:"auto",color:"var(--input-text)"},rows:1,onInput:m=>{m.currentTarget.style.height="auto",m.currentTarget.style.height=m.currentTarget.scrollHeight+"px"}}),n.jsx("button",{onClick:h,disabled:!l.trim()||o,style:{backgroundColor:l.trim()&&!o?"var(--primary)":"var(--muted)",color:l.trim()&&!o?"var(--primary-foreground)":"var(--muted-foreground)",border:"none",borderRadius:"8px",padding:"8px",display:"flex",alignItems:"center",justifyContent:"center",cursor:l.trim()&&!o?"pointer":"not-allowed",transition:"background-color 0.2s",width:"36px",height:"36px"},children:o?n.jsx(En,{size:18,strokeWidth:2.5,className:"animate-spin"}):n.jsx(sr,{size:18,strokeWidth:2.5})})]})}),n.jsx("style",{children:`
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                @keyframes slideUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-spin {
                    animation: spin 1s linear infinite;
                }
            `})]}):null}const zi=async(e,t)=>pe("/prediction/request",{method:"POST",body:JSON.stringify({novel_id:e,text:t})}),Ni=async e=>pe(`/prediction/task/${e}`),Ai=async e=>pe(`/prediction/history/${e}`),Ri=async e=>pe(`/prediction/history/${e}`,{method:"DELETE"}),Ti=()=>{const e=cr(),t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),t},Mi=async e=>pe("/images/generate",{method:"POST",headers:Ti(),body:JSON.stringify(e)}),Ei={fontSize:18,lineHeight:2,paragraphSpacing:40,contentWidth:80,fontFamily:"Noto Serif KR",theme:"light"};function Wi(e){const{theme:t,setTheme:r}=dr(),[s,o]=x.useState(()=>{const l=localStorage.getItem("reader-settings");return l?JSON.parse(l):Ei});x.useEffect(()=>{e==="reader"&&s.theme!==t&&o(l=>({...l,theme:t}))},[t,e]);const i=l=>{o(l),l.theme&&l.theme!==t&&r(l.theme)};return x.useEffect(()=>{localStorage.setItem("reader-settings",JSON.stringify(s)),e==="reader"?(document.documentElement.setAttribute("data-reader-theme",s.theme),document.documentElement.setAttribute("data-theme",s.theme)):document.documentElement.removeAttribute("data-reader-theme")},[s,e]),{readerSettings:s,handleReaderSettingsChange:i}}function Li(e,t){const[r,s]=x.useState(!1),[o,i]=x.useState([]),[l,c]=x.useState(!1),a=x.useRef();return x.useEffect(()=>()=>{a.current&&clearTimeout(a.current)},[]),{isPredictionSidebarOpen:r,setIsPredictionSidebarOpen:s,chatMessages:o,setChatMessages:i,isPredictionLoading:l,handlePredictionSidebarOpen:async()=>{if(s(!0),e&&o.length===0)try{const{history:f}=await Ai(e);if(f.length>0){const h=[];for(const m of f)h.push({id:`h-u-${m.id}`,role:"user",content:m.user_input}),h.push({id:`h-a-${m.id}`,role:"assistant",content:m.prediction});i(h)}}catch{}},handleSendMessage:async f=>{if(!e||!f.trim())return;const h={id:Date.now().toString(),role:"user",content:f};i(m=>[...m,h]),c(!0);try{const{task_id:m}=await zi(e,f);let g=2e3;const b=async()=>{try{const v=await Ni(m);if(v.status==="COMPLETED"){const w=v.result.prediction||v.result.text||(typeof v.result=="string"?v.result:JSON.stringify(v.result)),z={id:(Date.now()+1).toString(),role:"assistant",content:w};i(M=>[...M,z]),c(!1),document.hidden&&"Notification"in window&&(Notification.permission==="granted"?new Notification("StoryProof  ",{body:" .",icon:"/favicon.ico"}):Notification.permission==="default"&&Notification.requestPermission());return}else if(v.status==="FAILED"){c(!1),_.error("    .");return}}catch{}g=Math.min(g*1.5,15e3),a.current=setTimeout(b,g)};a.current=setTimeout(b,g)}catch{c(!1),_.error("  .")}}}}async function _i(e,t){return pe(`/analysis/consistency/${e}/${t}`)}async function Hi(e){return pe("/analysis/consistency",{method:"POST",body:JSON.stringify(e)})}async function Ii(e){return pe(`/analysis/task/${e}`)}async function $i(e){return pe("/analysis/chapter-analysis",{method:"POST",body:JSON.stringify(e)})}async function Di(e,t,r){return pe(`/analysis/chapter-analysis/${e}/${t}/${r}`)}function Bi(e,t,r,s){const[o,i]=x.useState(!1),[l,c]=x.useState(!1),[a,d]=x.useState(null),[p,f]=x.useState(!1),[h,m]=x.useState("consistency"),g=x.useRef();x.useEffect(()=>()=>{g.current&&clearTimeout(g.current)},[]);const b=async z=>{c(!0),d(null),f(!1),m(z);try{let M;if(z==="consistency"){const D=r?r():"";M=(await Hi({novel_id:e,chapter_id:t,text:D})).task_id}else M=(await $i({novel_id:e,chapter_id:t,analysis_type:z})).task_id;let W=2e3,V=0;const X=async()=>{if(V++,V>60){c(!1),d({status:"",message:"    .   ."});return}try{const D=await Ii(M);if(D.status==="COMPLETED"){d(D.result),c(!1),_.success(" .");return}else if(D.status==="FAILED"){c(!1),d({status:"",message:D.error||"  ."}),_.error("   .");return}}catch(D){console.error("Polling error:",D),c(!1),d({status:"",message:"      ."});return}W=Math.min(W*1.5,15e3),g.current=setTimeout(X,W)};g.current=setTimeout(X,W)}catch(M){console.error("Analysis error:",M),d({status:" ",message:"    ."}),c(!1)}};return{isAnalysisSidebarOpen:o,setIsAnalysisSidebarOpen:i,isAnalysisLoading:l,analysisResult:a,isCachedResult:p,currentAnalysisType:h,handleAnalyze:async(z="consistency")=>{if(i(!0),m(z),e&&t)try{c(!0);const W=await(z==="consistency"?_i(e,t):Di(e,t,z));if(W.cached&&W.result){d(W.result),f(!0),c(!1);return}}catch{}await b(z)},reanalyze:async()=>{await b(h)}}}function Vi({fileName:e,onBack:t,novelId:r,chapterId:s,mode:o="writer",onOpenCharacterChat:i,onCloseCharacterChat:l,onNavigateChapter:c,showCharacterChat:a}){const[d,p]=x.useState(!0),[f,h]=x.useState(!0),[m,g]=x.useState(!1),[b,v]=x.useState(!1),[w,z]=x.useState(!1),[M,W]=x.useState(!1),[V,X]=x.useState(!1),[D,le]=x.useState(!1),[ee,De]=x.useState(""),[Qe,Be]=x.useState(!1),[Te,Ze]=x.useState(!1),[Me,Ee]=x.useState(!1),[L,gt]=x.useState(null),[Pt,yt]=x.useState(!1),[J,te]=x.useState([]),[O,Pe]=x.useState(void 0),[We,bt]=x.useState(""),[vt,j]=x.useState(""),[y,S]=x.useState(!1),[N,H]=x.useState(!1),I=x.useRef(null),oe=x.useRef(),[T,E]=x.useState(!1),[B,xe]=x.useState(!1),et=x.useRef(null),[ae,tt]=x.useState(!1),[Z,nt]=x.useState(!1),[ce,Fe]=x.useState(null),[Ce,we]=x.useState(null),[ge,Se]=x.useState(!1),[rt,st]=x.useState(0),[ot,it]=x.useState(0),[ne,ke]=x.useState([]),Oe=x.useRef(!1),Ue=x.useRef(()=>Promise.resolve()),{readerSettings:ie,handleReaderSettingsChange:jt}=Wi(o),Le=Li(r),bn=Bi(r,s,()=>J.length>0?J.join(`

`):ee),{isPredictionSidebarOpen:Ft,setIsPredictionSidebarOpen:Ct,chatMessages:Ar,setChatMessages:Rr,isPredictionLoading:Tr,handleSendMessage:Mr}=Le,{isAnalysisSidebarOpen:Ot,setIsAnalysisSidebarOpen:wt,isAnalysisLoading:Er,analysisResult:Wr,isCachedResult:Lr,currentAnalysisType:_r,reanalyze:Hr}=bn,Ir=async()=>{wt(!1),l?.(),await Le.handlePredictionSidebarOpen()},$r=async u=>{Ct(!1),l?.(),await bn.handleAnalyze(u)};x.useEffect(()=>{if(ce){const u=setTimeout(()=>{Fe(null)},15e3);return()=>clearTimeout(u)}},[ce]),x.useEffect(()=>{r&&s?(vn(),jn()):Me||(De(`          .
               .
"     ?"  .

  (      )                .            .

    .    ", ! !"         . (     ,      .)            ,   .    ,           .       ,          .`),Ee(!0))},[r,s]),x.useEffect(()=>{let u,C=!1;if(O==="processing"||O==="pending"){let k=3e3;const R=async()=>{if(!(C||!r||!s)){try{const U=await Bs(r,s),F=U.status;if(F==="completed"||F==="failed"){Pe(F),tt(!1),F==="completed"?(_.success(" !  ."),vn(),jn()):_.error(` : ${U.message||"   "}`);return}}catch{_.error("   .")}C||(k=Math.min(k*1.5,2e4),u=setTimeout(R,k))}};R()}return()=>{C=!0,u&&clearTimeout(u)}},[O,r,s]);const vn=async()=>{if(!(!r||!s)){Be(!0);try{const u=await Hs(r,s);De(u.content),Pe(u.storyboard_status)}catch{_.error("   .")}finally{Be(!1),Ee(!0)}}},jn=async()=>{if(!(!r||!s)){yt(!0);try{const u=await Is(r,s);gt(u),u.scenes&&u.scenes.length>0&&te(u.scenes.map(C=>C.original_text.trim()))}catch{}finally{yt(!1)}}},Ut=async()=>{if(!(!r||!s)){Ze(!0);try{const u=J.length>0?J.map(C=>C.trim()).join(`

`):ee;await Ps(r,s,{content:u}),Se(!1),_.success(".")}catch{_.error(" .")}finally{Ze(!1)}}},[P,lt]=x.useState(null),[G,at]=x.useState(null),[Ke,St]=x.useState(null),[_e,kt]=x.useState(null),[q,ct]=x.useState(null),[Dr,Br]=x.useState({}),[zt,Cn]=x.useState(!1),[Nt,wn]=x.useState(!1),[At,Sn]=x.useState(!1),dt=x.useRef(),pt=x.useRef();x.useEffect(()=>{a&&(wt(!1),Ct(!1))},[a]),x.useEffect(()=>{Oe.current=ge},[ge]),x.useEffect(()=>{Ue.current=Ut}),x.useEffect(()=>{r&&$s(r).then(u=>{ke(u.sort((C,k)=>C.chapter_number-k.chapter_number))}).catch(()=>{})},[r]),x.useEffect(()=>{if(o==="reader"||!r||!s)return;const u=setInterval(()=>{Oe.current&&Ue.current()},3e4);return()=>clearInterval(u)},[r,s,o]),x.useEffect(()=>{const u=C=>{Oe.current&&(C.preventDefault(),C.returnValue="")};return window.addEventListener("beforeunload",u),()=>window.removeEventListener("beforeunload",u)},[]),x.useEffect(()=>{const u=C=>{(C.ctrlKey||C.metaKey)&&C.key==="s"&&(C.preventDefault(),o!=="reader"&&r&&s&&Ue.current()),C.key==="Escape"&&(Ot?wt(!1):Ft?Ct(!1):D&&le(!1))};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[o,r,s,Ot,Ft,D]);const ut=x.useRef();x.useEffect(()=>(ut.current&&clearTimeout(ut.current),ut.current=setTimeout(()=>{const C=(J.length>0?J.join(`

`):ee).replace(/<br\s*\/?>/gi,`
`).replace(/<[^>]+>/g,"");st(C.replace(/\s/g,"").length);const k=C.trim().split(/\s+/).filter(Boolean);it(k.length)},500),()=>{ut.current&&clearTimeout(ut.current)}),[ee,J]);const Rt=ne.findIndex(u=>u.id===s),kn=Rt>0?ne[Rt-1]:null,zn=Rt<ne.length-1?ne[Rt+1]:null,Nn=async u=>{ge&&r&&s&&await Ut(),c?.(u.id,u.title)},ye=(u,C)=>{lt(null),at(null),St(null),kt(null),ct(null),Cn(!1),wn(!1),Sn(!1),le(!1),C&&C.trim()&&Fe({sceneIndex:u,text:C.trim(),timestamp:Date.now()}),dt.current&&clearTimeout(dt.current),pt.current&&clearTimeout(pt.current),dt.current=setTimeout(()=>{const k=document.getElementById(`scene-block-${u}`);k&&(k.scrollIntoView({behavior:"smooth",block:"start"}),k.style.transition="background-color 0.5s",k.style.backgroundColor="rgba(79, 70, 229, 0.1)",pt.current=setTimeout(()=>{k.style.backgroundColor="transparent"},1e3))},100)},Pr=(u,C)=>{if(J.length>0){const k=J.map(R=>R.replace(u,C));te(k),Se(!0),_.success(" .")}else{const k=ee.replace(u,C);k!==ee?(De(k),Se(!0),_.success(" .")):_.error("     .")}},Fr=u=>{if(!u)return;const C=R=>R.replace(/[^a-zA-Z0-9-]/g,""),k=C(u);if(J.length>0){let R=-1;if(R=J.findIndex(U=>C(U).includes(k)),R===-1&&k.length>40){const U=k.substring(0,30),F=k.substring(k.length-30);R=J.findIndex(Y=>{const Je=C(Y);return Je.includes(U)&&Je.includes(F)})}R!==-1?ye(R,u):_.error("     . (       )")}else{const R=document.querySelector(".novel-text-editor");if(R&&ee)if(C(ee).indexOf(k)!==-1){const Y=ee.indexOf(u);if(Y!==-1){R.focus(),R.setSelectionRange(Y,Y+u.length);const Je=ee.substring(0,Y).split(`
`).length;R.scrollTop=(Je-1)*24}else _.warning(" ,      .")}else _.error("     .")}},Or=()=>{le(!0)},Kt=x.useMemo(()=>L?.characters&&L.characters.length>0?L.characters:[{name:"",first_appearance:0,appearance_count:5,appearances:[0,1,2,3,4],traits:[" "," "]},{name:" ",first_appearance:0,appearance_count:3,appearances:[0,1,3],traits:[""," "]},{name:"",first_appearance:0,appearance_count:1,appearances:[0]}],[L]),Vt=x.useMemo(()=>L?.items&&L.items.length>0?L.items:[{name:"",first_appearance:0},{name:"",first_appearance:0},{name:" ",first_appearance:0}],[L]),Yt=x.useMemo(()=>L?.key_events&&L.key_events.length>0?L.key_events:[{summary:"     ",scene_index:0,importance:""},{summary:"    ",scene_index:1,importance:""},{summary:"    ",scene_index:2,importance:""}],[L]),Ur=()=>{if(!(!r||!s)){if(O==="processing"){_.warning("   .  .");return}_(" ?",{description:"  (,  )   .",action:{label:"",onClick:async()=>{tt(!0),Pe("processing");try{await Fs(r,s),_.success("  .   .")}catch{_.error("  "),Pe("failed"),tt(!1)}}},cancel:{label:"",onClick:()=>{}}})}},Gt=x.useMemo(()=>L?.locations&&L.locations.length>0?L.locations:[{name:"",description:"   ",scenes:[0]},{name:" ",description:"   ",scenes:[2]}],[L]),A=vt.trim().toLowerCase(),Ve=x.useMemo(()=>A?Kt.filter(u=>u.name.toLowerCase().includes(A)||(u.description||"").toLowerCase().includes(A)||(u.traits||[]).some(C=>C.toLowerCase().includes(A))):Kt,[Kt,A]),Ye=x.useMemo(()=>A?Vt.filter(u=>u.name.toLowerCase().includes(A)||(u.description||"").toLowerCase().includes(A)):Vt,[Vt,A]),Ge=x.useMemo(()=>A?Gt.filter(u=>u.name.toLowerCase().includes(A)||(u.description||"").toLowerCase().includes(A)):Gt,[Gt,A]),Xe=x.useMemo(()=>A?Yt.filter(u=>(u.summary||"").toLowerCase().includes(A)):Yt,[Yt,A]),ft=x.useMemo(()=>(L?.relationships||[]).map(u=>({...u,source:u.source||u.character1||"",target:u.target||u.character2||""})),[L]),Xt=x.useMemo(()=>A?ft.filter(u=>(u.source||"").toLowerCase().includes(A)||(u.target||"").toLowerCase().includes(A)||(u.relation||"").toLowerCase().includes(A)||(u.description||"").toLowerCase().includes(A)):ft,[ft,A]),Tt=x.useMemo(()=>!A||!L?.scenes?[]:L.scenes.filter(u=>(u.original_text||"").toLowerCase().includes(A)||(u.summary||"").toLowerCase().includes(A)),[L,A]);x.useEffect(()=>(oe.current&&clearTimeout(oe.current),oe.current=setTimeout(()=>{j(We)},300),()=>{oe.current&&clearTimeout(oe.current)}),[We]),x.useEffect(()=>()=>{dt.current&&clearTimeout(dt.current),pt.current&&clearTimeout(pt.current)},[]),x.useEffect(()=>{A&&(Ve.length>0&&h(!0),Ye.length>0&&g(!0),Ge.length>0&&v(!0),Xe.length>0&&z(!0))},[A,Ve.length,Ye.length,Ge.length,Xe.length]),x.useEffect(()=>{const u=k=>{I.current&&!I.current.contains(k.target)&&S(!1)},C=k=>{k.key==="Escape"&&y&&S(!1)};return document.addEventListener("mousedown",u),document.addEventListener("keydown",C),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",C)}},[y]),x.useEffect(()=>{const u=k=>{et.current&&!et.current.contains(k.target)&&E(!1)},C=k=>{k.key==="Escape"&&T&&E(!1)};return document.addEventListener("mousedown",u),document.addEventListener("keydown",C),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",C)}},[T]);const Kr=(u,C,k=80)=>{if(!C)return n.jsx("span",{children:u.length>k?u.slice(0,k)+"...":u});const U=u.toLowerCase().indexOf(C.toLowerCase());if(U===-1)return n.jsx("span",{children:u.length>k?u.slice(0,k)+"...":u});const F=Math.max(0,U-20),Y=Math.min(u.length,U+C.length+40),Je=F>0?"...":"",Vr=Y<u.length?"...":"",Yr=u.slice(F,U),Gr=u.slice(U,U+C.length),Xr=u.slice(U+C.length,Y);return n.jsxs("span",{children:[Je,Yr,n.jsx("mark",{className:"bible-search-highlight",children:Gr}),Xr,Vr]})},Jt=async u=>{if(!(!r||!s)){H(!0),S(!1);try{await Us(r,s,u,vt||void 0),_.success(`${u.toUpperCase()}  .`)}catch{_.error(" .")}finally{H(!1)}}},qt=async u=>{if(!(!r||!s)){xe(!0),E(!1);try{await Os(r,s,u),_.success(`${u.toUpperCase()}  .`)}catch{_.error(" .")}finally{xe(!1)}}};if(Qe&&!Me)return n.jsx("div",{className:`chapter-detail-container loading ${d?"sidebar-open":""}`,children:n.jsx("div",{className:"loading-spinner"})});const Qt=async(u,C)=>{if(!r||!s){_.error("/  .");return}nt(!0);try{const R=(await Mi({novel_id:r,chapter_id:s,entity_type:u,entity_name:C.name,description:C.description||C.name})).image_url,U=F=>F.map(Y=>Y.name===C.name?{...Y,image:R}:Y);gt(F=>{if(!F)return null;const Y={...F};return u==="character"&&(Y.characters=U(Y.characters)),u==="item"&&(Y.items=U(Y.items)),u==="location"&&(Y.locations=U(Y.locations)),Y}),u==="character"&&P?.name===C.name&&lt(F=>F?{...F,image:R}:null),u==="item"&&G?.name===C.name&&at(F=>F?{...F,image:R}:null),u==="location"&&q?.name===C.name&&ct(F=>F?{...F,image:R}:null),_.success(" !")}catch(k){console.error("Image generation failed:",k),_.error("  .")}finally{nt(!1)}};return n.jsxs("div",{className:`chapter-detail-container ${d?"sidebar-open":""}`,children:[n.jsx("style",{children:`
                @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                .spin-animation { animation: spin 1s linear infinite; }
            `}),n.jsxs("div",{className:"chapter-detail-header",style:{display:"flex",alignItems:"center",padding:"16px 24px",borderBottom:"1px solid var(--border)",backgroundColor:"var(--card)",position:"sticky",top:0,zIndex:51},children:[n.jsx("button",{className:"back-button",onClick:t,style:{marginRight:"16px",padding:"8px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx(Es,{size:24,color:"var(--muted-foreground)"})}),n.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:"4px"},children:[ne.length>1&&kn&&n.jsx("button",{onClick:()=>Nn(kn),title:" ",style:{padding:"4px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",color:"var(--muted-foreground)"},children:n.jsx(ln,{size:20})}),n.jsx("h1",{className:"chapter-detail-title",style:{fontSize:"1.25rem",fontWeight:600,color:"var(--foreground)",margin:0},children:e}),ne.length>1&&zn&&n.jsx("button",{onClick:()=>Nn(zn),title:" ",style:{padding:"4px",borderRadius:"50%",border:"none",backgroundColor:"transparent",cursor:"pointer",display:"flex",alignItems:"center",color:"var(--muted-foreground)"},children:n.jsx(Zt,{size:20})})]}),r&&s&&o!=="reader"&&n.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[n.jsxs("span",{style:{fontSize:"0.8rem",color:"var(--muted-foreground)",whiteSpace:"nowrap"},children:[rt.toLocaleString(),"  ",ot.toLocaleString(),""]}),n.jsx("span",{style:{fontSize:"0.75rem",color:ge?"#D97706":"var(--muted-foreground)",whiteSpace:"nowrap",padding:"2px 8px",borderRadius:"4px",backgroundColor:ge?"rgba(217, 119, 6, 0.1)":"transparent"},children:Te?" ...":ge?" ":""}),n.jsxs("button",{className:"reanalyze-button",onClick:Ur,disabled:O==="processing"||O==="pending"||ae,title:O==="processing"||O==="pending"?"  ...":"AI ",style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 16px",backgroundColor:O==="processing"||O==="pending"||ae?"var(--muted)":"transparent",color:O==="processing"||O==="pending"||ae?"var(--muted-foreground)":"var(--primary)",border:O==="processing"||O==="pending"||ae?"1px solid var(--border)":"1px solid var(--primary)",borderRadius:"6px",cursor:O==="processing"||O==="pending"||ae?"not-allowed":"pointer",fontSize:"0.9rem",fontWeight:500},children:[n.jsx(Mt,{size:16,className:O==="processing"||O==="pending"||ae?"spin-animation":""}),O==="processing"||O==="pending"||ae?" ...":""]}),n.jsxs("button",{className:"save-button",onClick:Ut,disabled:Te,style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 16px",backgroundColor:"var(--primary)",color:"var(--primary-foreground)",border:"none",borderRadius:"6px",cursor:Te?"wait":"pointer",fontSize:"0.9rem",fontWeight:500},children:[n.jsx(Ws,{size:18}),Te?" ...":""]}),n.jsxs("div",{className:"chapter-export-wrapper",ref:et,children:[n.jsx("button",{className:"chapter-export-btn",onClick:()=>E(!T),disabled:B,title:" ",children:n.jsx(Wn,{size:16})}),T&&n.jsxs("div",{className:"chapter-export-dropdown",children:[n.jsxs("button",{onClick:()=>qt("txt"),className:"export-dropdown-item",children:[n.jsx(en,{size:14})," TXT ()"]}),n.jsxs("button",{onClick:()=>qt("pdf"),className:"export-dropdown-item",children:[n.jsx(tn,{size:14})," PDF"]}),n.jsxs("button",{onClick:()=>qt("docx"),className:"export-dropdown-item",children:[n.jsx(tn,{size:14})," DOCX ()"]})]})]})]})]}),o==="reader"?n.jsx(ui,{editor:Ce,readerSettings:ie,onSettingsChange:jt}):n.jsx(pi,{editor:Ce}),n.jsxs("div",{className:"chapter-detail-layout",children:[n.jsxs("div",{className:`dictionary-sidebar ${d?"open":"closed"}`,children:[n.jsxs("div",{className:"bible-toolbar",children:[n.jsxs("div",{className:"bible-search-wrapper",children:[n.jsx(Ln,{size:14,className:"bible-search-icon"}),n.jsx("input",{type:"text",className:"bible-search-input",placeholder:" ...",value:We,maxLength:100,onChange:u=>bt(u.target.value)}),We&&n.jsx("button",{className:"bible-search-clear",onClick:()=>{bt(""),j("")},children:n.jsx(qe,{size:12})})]}),n.jsxs("div",{className:"export-dropdown-wrapper",ref:I,children:[n.jsx("button",{className:"bible-export-btn",onClick:()=>S(!y),disabled:N,title:We?" ":" ",children:N?n.jsx(Mt,{size:14,className:"spin-animation"}):n.jsx(Wn,{size:14})}),y&&n.jsxs("div",{className:"export-dropdown",children:[n.jsxs("button",{onClick:()=>Jt("txt"),className:"export-dropdown-item",children:[n.jsx(en,{size:14}),n.jsx("span",{children:"TXT ()"})]}),n.jsxs("button",{onClick:()=>Jt("pdf"),className:"export-dropdown-item",children:[n.jsx(tn,{size:14}),n.jsx("span",{children:"PDF"})]}),n.jsxs("button",{onClick:()=>Jt("docx"),className:"export-dropdown-item",children:[n.jsx(en,{size:14}),n.jsx("span",{children:"DOCX ()"})]})]})]})]}),A&&Tt.length>0&&n.jsxs("div",{className:"sidebar-section",children:[n.jsx("div",{className:"section-header active",style:{cursor:"default"},children:n.jsxs("div",{className:"section-header-content",children:[n.jsx(Ln,{size:18}),n.jsxs("h3",{className:"section-title",children:["  (",Tt.length,")"]})]})}),n.jsx("div",{className:"section-content",children:Tt.map((u,C)=>n.jsxs("div",{className:"section-item bible-scene-result interactable",onClick:()=>ye(u.scene_index),style:{cursor:"pointer"},children:[n.jsxs("div",{className:"item-name",style:{fontSize:"0.85rem"},children:["Scene ",u.scene_index+1]}),n.jsx("div",{className:"item-description",style:{fontSize:"0.8rem"},children:Kr(u.original_text,A,100)})]},C))})]}),A&&Tt.length===0&&Ve.length===0&&Ye.length===0&&Ge.length===0&&Xe.length===0&&n.jsx("div",{style:{padding:"16px",textAlign:"center",color:"var(--muted-foreground)",fontSize:"0.875rem"},children:"  ."}),n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${f?"active":""}`,onClick:()=>h(!f),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(Dt,{size:18}),n.jsxs("h3",{className:"section-title",children:[" ",A&&`(${Ve.length})`]})]}),f?n.jsx(de,{size:18}):n.jsx(re,{size:18})]}),f&&n.jsx("div",{className:"section-content",children:Pt?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:" ..."}):Ve.length===0&&A?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Ve.map((u,C)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>lt(u),style:{cursor:"pointer"},children:[n.jsx("div",{className:"item-name",children:u.name}),n.jsx("div",{className:"item-description",children:u.traits&&u.traits.length>0?n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",marginTop:"4px"},children:u.traits.slice(0,3).map((k,R)=>n.jsx("span",{className:"trait-tag",children:k},R))}):typeof u.description=="string"&&u.description?u.description.slice(0,30)+"...":`: ${u.appearance_count}`})]},C))})]}),n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${m?"active":""}`,onClick:()=>g(!m),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(Et,{size:18}),n.jsxs("h3",{className:"section-title",children:[" ",A&&`(${Ye.length})`]})]}),m?n.jsx(de,{size:18}):n.jsx(re,{size:18})]}),m&&n.jsx("div",{className:"section-content",children:Ye.length===0&&A?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Ye.map((u,C)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>at(u),style:{cursor:"pointer",display:"flex",alignItems:"flex-start",gap:"8px"},children:[n.jsx("span",{style:{minWidth:"22px",height:"22px",borderRadius:"50%",backgroundColor:"var(--primary, #4F46E5)",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.7rem",fontWeight:"bold",flexShrink:0,marginTop:"2px"},children:C+1}),n.jsxs("div",{style:{flex:1},children:[n.jsx("div",{className:"item-name",children:u.name}),n.jsx("div",{className:"item-description",children:typeof u.significance=="string"&&u.significance?u.significance:typeof u.description=="string"&&u.description?u.description:` : ${u.first_appearance+1}`})]})]},C))})]}),n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${b?"active":""}`,onClick:()=>v(!b),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(_n,{size:18}),n.jsxs("h3",{className:"section-title",children:[" ",A&&`(${Ge.length})`]})]}),b?n.jsx(de,{size:18}):n.jsx(re,{size:18})]}),b&&n.jsx("div",{className:"section-content",children:Ge.length===0&&A?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Ge.map((u,C)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>ct(u),style:{cursor:"pointer"},children:[n.jsx("div",{className:"item-name",children:u.name}),n.jsx("div",{className:"item-description",children:typeof u.description=="string"&&u.description?u.description:`: ${u.scenes?.length||0}`})]},C))})]}),ft.length>0&&n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${M?"active":""}`,onClick:()=>W(!M),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(Ls,{size:18}),n.jsxs("h3",{className:"section-title",children:["  ",A&&`(${Xt.length})`]})]}),M?n.jsx(de,{size:18}):n.jsx(re,{size:18})]}),M&&n.jsx("div",{className:"section-content",children:Xt.length===0&&A?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Xt.map((u,C)=>n.jsxs("div",{className:"section-item",children:[n.jsxs("div",{className:"item-name",style:{fontSize:"0.9rem"},children:[u.source,"  ",u.target]}),n.jsxs("div",{className:"item-description",children:[n.jsx("span",{className:"trait-tag",children:u.relation||""}),u.description&&n.jsx("span",{style:{marginLeft:"6px"},children:u.description.length>40?u.description.slice(0,40)+"...":u.description})]})]},C))})]}),n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${w?"active":""}`,onClick:()=>z(!w),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(Mt,{size:18}),n.jsxs("h3",{className:"section-title",children:["  ",A&&`(${Xe.length})`]})]}),w?n.jsx(de,{size:18}):n.jsx(re,{size:18})]}),w&&n.jsx("div",{className:"section-content",children:Xe.length===0&&A?n.jsx("div",{style:{padding:"10px",fontSize:"12px",color:"#999"},children:"  "}):Xe.map((u,C)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>St(u),style:{cursor:"pointer"},children:[n.jsx("div",{className:"item-name",style:{fontSize:"0.95rem"},children:u.summary&&u.summary.length>20?u.summary.substring(0,20)+"...":u.summary}),n.jsxs("div",{className:"item-description",children:[u.scene_index!==void 0?`${u.scene_index+1}`:"",u.importance&&`  : ${u.importance}`]})]},C))})]}),L&&Object.keys(L).filter(u=>!["characters","items","timeline","locations","key_events","scenes","relationships","chapter_id"].includes(u)).map(u=>{const C=L[u];if(!Array.isArray(C))return null;const k=Dr[u]??!1;return n.jsxs("div",{className:"sidebar-section",children:[n.jsxs("button",{className:`section-header ${k?"active":""}`,onClick:()=>Br(R=>({...R,[u]:!R[u]})),children:[n.jsxs("div",{className:"section-header-content",children:[n.jsx(Et,{size:18})," ",n.jsx("h3",{className:"section-title",children:u.toUpperCase()})]}),k?n.jsx(de,{size:18}):n.jsx(re,{size:18})]}),k&&n.jsx("div",{className:"section-content",children:C.map((R,U)=>n.jsxs("div",{className:"section-item interactable",onClick:()=>kt({title:u,item:R}),style:{cursor:"pointer"},children:[n.jsx("div",{className:"item-name",children:R.name||R.title||`Item ${U+1}`}),n.jsx("div",{className:"item-description",children:R.description||R.summary||(typeof R=="string"?R:JSON.stringify(R).slice(0,50))})]},U))})]},u)})]}),n.jsx("button",{className:"dictionary-toggle",onClick:()=>p(!d),children:d?n.jsx(ln,{size:20}):n.jsx(Zt,{size:20})}),n.jsx("div",{className:"text-area",style:{overflow:"hidden",display:"flex",flexDirection:"column"},children:n.jsx("div",{className:"text-content",style:{flex:1,padding:0,height:"100%"},children:Qe?n.jsx("div",{style:{padding:"20px",textAlign:"center"},children:" ..."}):J.length>0?n.jsx("div",{className:"scenes-container",style:{height:"100%",overflowY:"auto",padding:"20px",backgroundColor:o==="reader"?"var(--reader-bg)":"var(--background)"},children:J.map((u,C)=>n.jsxs("div",{id:`scene-block-${C}`,className:"scene-block",style:{position:"relative",marginBottom:"60px"},children:[n.jsxs("div",{style:{position:"absolute",top:"-12px",left:"10px",fontSize:"12px",fontWeight:"bold",color:"var(--primary)",backgroundColor:"var(--card)",padding:"2px 10px",borderRadius:"12px",border:"1px solid var(--border)",zIndex:5,boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},children:["Scene ",C+1]}),n.jsx("div",{className:"scene-content-wrapper",style:{maxWidth:o==="reader"?`${ie.contentWidth}%`:"100%",margin:o==="reader"?"0 auto":"0"},children:n.jsx(Jn,{content:u.replace(/\n/g,"<br>"),onUpdate:k=>{const R=[...J];R[C]=k,te(R),Se(!0)},onFocus:k=>we(k),onCreated:k=>{C===0&&!Ce&&we(k)},editable:o!=="reader",placeholder:` ${C+1}  ...`,className:"tiptap-editor-scene",style:o==="reader"?{fontSize:`${ie.fontSize}px`,lineHeight:ie.lineHeight,fontFamily:ie.fontFamily,color:"var(--text-primary)"}:void 0})})]},C))}):n.jsx("div",{style:{maxWidth:o==="reader"?`${ie.contentWidth}%`:"100%",margin:o==="reader"?"0 auto":"0",height:"100%"},children:n.jsx(Jn,{content:ee.replace(/\n/g,"<br>"),onUpdate:u=>{De(u),Se(!0)},onFocus:u=>we(u),onCreated:u=>{Ce||we(u)},editable:o!=="reader",placeholder:"  ...",className:"tiptap-editor-full",style:o==="reader"?{fontSize:`${ie.fontSize}px`,lineHeight:ie.lineHeight,fontFamily:ie.fontFamily,color:"var(--text-primary)"}:void 0})})})})]}),P&&n.jsx("div",{className:"modal-overlay",onClick:()=>lt(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:P.name}),n.jsx("button",{onClick:()=>lt(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(Dt,{size:20})})]}),n.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[P.image?n.jsx("img",{src:P.image,alt:P.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):n.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),n.jsx("button",{onClick:()=>Qt("character",P),disabled:Z,style:{padding:"8px 16px",backgroundColor:Z?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:Z?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:Z?" ...":P.image?" ":" "})]}),P.aliases&&P.aliases.length>0&&n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:P.aliases.map((u,C)=>n.jsx("span",{style:{fontSize:"0.8rem",padding:"2px 8px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"12px",color:"var(--muted-foreground, #475569)",border:"1px solid var(--border)",opacity:.9},children:u},C))})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:P.description||"  ."})]}),P.traits&&P.traits.length>0&&n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:P.traits.map((u,C)=>n.jsx("span",{style:{fontSize:"0.8rem",padding:"4px 10px",backgroundColor:"var(--muted, rgba(79, 70, 229, 0.1))",color:"var(--primary, #4F46E5)",borderRadius:"6px",fontWeight:"500",border:"1px solid var(--border)"},children:u},C))})]}),n.jsxs("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"}),n.jsxs("button",{onClick:()=>ye(P.first_appearance,P.name),style:{background:"none",border:"none",color:"var(--primary, #4F46E5)",fontWeight:"bold",cursor:"pointer",textDecoration:"underline",padding:0,fontSize:"inherit"},children:[P.first_appearance+1,""]})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",P.appearance_count,"",P.appearances&&P.appearances.length>0&&n.jsxs("button",{onClick:()=>Cn(!zt),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[zt?n.jsx(de,{size:12}):n.jsx(re,{size:12}),zt?"":" "]})]}),zt&&P.appearances&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:P.appearances.map(u=>n.jsxs("button",{onClick:()=>ye(u,P.name),style:{background:"var(--muted, #f1f5f9)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--muted-foreground, #475569)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",u+1]},u))})]})]})]})}),G&&n.jsx("div",{className:"modal-overlay",onClick:()=>at(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:G.name}),n.jsx("button",{onClick:()=>at(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(Et,{size:20})})]}),n.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[G.image?n.jsx("img",{src:G.image,alt:G.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):n.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),n.jsx("button",{onClick:()=>Qt("item",G),disabled:Z,style:{padding:"8px 16px",backgroundColor:Z?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:Z?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:Z?" ...":G.image?" ":" "})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:G.description||"  ."})]}),n.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"}),n.jsxs("button",{onClick:()=>ye(G.first_appearance,G.name),style:{background:"none",border:"none",color:"var(--primary, #4F46E5)",fontWeight:"bold",cursor:"pointer",textDecoration:"underline",padding:0,fontSize:"inherit"},children:[G.first_appearance+1,""]})]}),G.appearance_count>0&&n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginTop:"4px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",G.appearance_count,"",G.appearances&&G.appearances.length>0&&n.jsxs("button",{onClick:()=>wn(!Nt),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[Nt?n.jsx(de,{size:12}):n.jsx(re,{size:12}),Nt?"":" "]})]}),Nt&&G.appearances&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:G.appearances.map(u=>n.jsxs("button",{onClick:()=>ye(u,G.name),style:{background:"var(--muted, #f1f5f9)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--muted-foreground, #475569)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",u+1]},u))})]})})]})}),q&&n.jsx("div",{className:"modal-overlay",onClick:()=>ct(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:q.name}),n.jsx("button",{onClick:()=>ct(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(_n,{size:20})})]}),n.jsxs("div",{style:{marginBottom:"16px",display:"flex",flexDirection:"column",alignItems:"center"},children:[q.image?n.jsx("img",{src:q.image,alt:q.name,style:{width:"100%",maxHeight:"300px",objectFit:"contain",borderRadius:"8px",marginBottom:"8px"}}):n.jsx("div",{style:{width:"100%",height:"200px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--muted-foreground, #94a3b8)",marginBottom:"8px"},children:" "}),n.jsx("button",{onClick:()=>Qt("location",q),disabled:Z,style:{padding:"8px 16px",backgroundColor:Z?"var(--muted, #cbd5e1)":"var(--primary, #4f46e5)",color:"var(--primary-foreground, white)",border:"none",borderRadius:"6px",cursor:Z?"not-allowed":"pointer",fontWeight:"500",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"8px"},children:Z?" ...":q.image?" ":" "})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:""}),n.jsx("p",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0},children:q.description||"  ."})]}),n.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"24px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("strong",{style:{color:"var(--modal-text)"},children:" :"})," ",q.appearance_count||(q.scenes?q.scenes.length:0),"",q.scenes&&q.scenes.length>0&&n.jsxs("button",{onClick:()=>Sn(!At),style:{background:"var(--modal-bg)",border:"1px solid var(--border, #e2e8f0)",borderRadius:"4px",cursor:"pointer",padding:"2px 6px",fontSize:"0.8rem",color:"var(--muted-foreground, #666)",display:"flex",alignItems:"center",gap:"4px"},children:[At?n.jsx(de,{size:12}):n.jsx(re,{size:12}),At?"":" "]})]}),At&&q.scenes&&n.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"10px",maxHeight:"150px",overflowY:"auto",width:"100%",padding:"4px"},children:q.scenes.map(u=>n.jsxs("button",{onClick:()=>ye(u),style:{background:"var(--secondary)",border:"1px solid var(--border)",borderRadius:"4px",padding:"4px 8px",fontSize:"0.8rem",color:"var(--primary)",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:["SCENE ",u+1]},u))})]})})]})}),Ke&&n.jsx("div",{className:"modal-overlay",onClick:()=>St(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.25rem",fontWeight:"bold",margin:0,lineHeight:1.4},children:Ke.summary}),n.jsx("button",{onClick:()=>St(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(Mt,{size:20})})]}),n.jsx("div",{style:{marginBottom:"24px"},children:Ke.importance&&n.jsxs("div",{style:{display:"inline-block",padding:"4px 8px",backgroundColor:"var(--muted, #f1f5f9)",borderRadius:"4px",fontSize:"0.875rem",fontWeight:"500",color:"var(--muted-foreground, #475569)",marginTop:"8px"},children:[": ",Ke.importance]})}),n.jsx("div",{style:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginTop:"16px",borderTop:"1px solid var(--border, #eee)",paddingTop:"16px"},children:n.jsx("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start",width:"100%"},children:n.jsxs("button",{onClick:()=>ye(Ke.scene_index),style:{width:"100%",background:"var(--primary, #4F46E5)",border:"none",borderRadius:"6px",padding:"10px 16px",fontSize:"0.95rem",fontWeight:"600",color:"var(--primary-foreground, #ffffff)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",transition:"background 0.2s"},children:[n.jsxs("span",{children:["   (",Ke.scene_index+1,")"]}),n.jsx(Zt,{size:16})]})})})]})}),_e&&n.jsx("div",{className:"modal-overlay",onClick:()=>kt(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsxs("div",{className:"modal-content",onClick:u=>u.stopPropagation(),style:{backgroundColor:"var(--modal-bg, #fff)",padding:"24px",borderRadius:"12px",width:"400px",maxWidth:"90%",boxShadow:"0 10px 25px rgba(0,0,0,0.2)",color:"var(--modal-text, #333)",border:"1px solid var(--modal-border, #e5e7eb)"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"16px"},children:[n.jsx("h2",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:0},children:_e.item.name||_e.item.title||"Detail"}),n.jsx("button",{onClick:()=>kt(null),style:{background:"none",border:"none",cursor:"pointer",padding:"4px"},children:n.jsx(Et,{size:20})})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("div",{style:{fontSize:"0.875rem",color:"var(--muted-foreground, #666)",marginBottom:"4px"},children:_e.title.toUpperCase()}),n.jsx("div",{style:{lineHeight:"1.6",fontSize:"1rem",margin:0,maxHeight:"300px",overflowY:"auto"},children:_e.item.description||_e.item.summary||n.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"0.8rem",backgroundColor:"var(--muted, #f1f5f9)",color:"var(--modal-text)",padding:"8px",borderRadius:"4px",border:"1px solid var(--border)"},children:JSON.stringify(_e.item,null,2)})})]})]})}),n.jsx(Ds,{}),D&&n.jsx("div",{style:{position:"fixed",bottom:"20px",right:"25px",width:"600px",height:"750px",zIndex:1002,animation:"slideUp 0.3s ease"},children:n.jsx(bi,{onClose:()=>le(!1)})}),n.jsx(Ci,{isOpen:Ot,onClose:()=>wt(!1),result:Wr,isLoading:Er,isCachedResult:Lr,onNavigateToQuote:Fr,onReanalyze:Hr,onApplySuggestion:Pr,analysisType:_r}),n.jsx(ki,{isOpen:Ft,onClose:()=>Ct(!1),messages:Ar,onSendMessage:Mr,isLoading:Tr,onClearChat:()=>{Rr([]),r&&Ri(r).catch(()=>{})}}),n.jsx(yi,{onNavigateToScene:ye,onAnalyze:$r,onPredictStory:Ir,onOpenCharacterChat:i,onOpenSettings:Or,onOpenRelGraph:()=>X(!0),novelId:r,chapterId:s,mode:o}),n.jsx(Si,{isOpen:V,onClose:()=>X(!1),relationships:ft.map(u=>({source:u.source||u.character1,target:u.target||u.character2,relation:u.relation,description:u.description})),characters:L?.characters?.map(u=>({name:u.name,description:u.description,traits:u.traits,appearance_count:u.appearance_count}))||[]})]})}export{Vi as ChapterDetail};
