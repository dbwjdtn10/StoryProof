# StoryProof-RR: 설정 오류 검사기 (Consistency Check System) 상세 안내

이 문서는 `StoryProof-RR` 프로젝트의 핵심 기능인 **'설정 오류 검사기(일관성 검증 시스템)'**의 구조와 동작 원리를 상세히 설명합니다.

---

## 1. 개요
작가가 소설을 집필할 때, 과거에 쓴 내용이나 미리 정해둔 설정(바이블)과 충돌하는 내용을 쓰는 것을 방지하기 위한 AI 기반 보조 도구입니다. 단순히 맞춤법을 검사하는 수준을 넘어, 이야기의 흐름과 설정의 일관성을 분석합니다.

---

## 2. 기술 스택 (Technical Stack)

시스템은 다음 세 가지 주요 구성 요소를 결합하여 분석을 수행합니다.

| 구성 요소 | 역할 | 비고 |
| :--- | :--- | :--- |
| **Pinecone (Vector DB)** | 과거 줄거리 및 장면 로드 | 시맨틱 검색(Semantic Search)을 통해 유사 맥락 파악 |
| **PostgreSQL (RDB)** | 고정 설정(바이블) 저장 및 조회 | 캐릭터 외양, 성격, 세계관 등 정형 데이터 관리 |
| **Gemini AI (LLM)** | 데이터 통합 분석 및 리포트 작성 | `gemini-1.5-pro` 또는 `flash` 모델 사용 |

---

## 3. 동작 프로세스 (Workflow)

분석은 백엔드(`/backend/api/v1/endpoints/consistency.py`)에서 다음의 3단계 과정을 거칩니다.

### [Step 1] 맥락 검색 (Context Retrieval)
*   사용자가 작성 중인 최신 문장을 기반으로 **Pinecone**에서 가장 관련 있는 과거의 장면들(Top-K)을 검색합니다.
*   이를 통해 AI는 소설 내에서 "어떤 일이 있었는지"에 대한 기억을 갖게 됩니다.

### [Step 2] 설정 바이블 대조 (Bible Fetching)
*   **PostgreSQL** DB에 저장된 해당 소설의 '캐릭터 설정' 및 '세계관 바이블'을 불러옵니다.
*   캐릭터의 눈동자 색, 키, 고유 능력, 말투 가이드 등을 확보합니다.

### [Step 3] 통합 분석 및 리포트 (LLM Analysis)
*   AI 편집자가 현재 문장, 과거 줄거리, 바이블 설정을 모두 비교하여 다음 세 가지 항목을 검사합니다.
    1.  **⚠️ 설정 충돌:** 바이블의 고유 설정(외양, 이름 등) 위반 여부
    2.  **⚙️ 개연성 경고:** 과거 사건의 상태(부상, 마나 등) 대비 어색한 동작 여부
    3.  **🗣️ 보이스 불일치:** 지정된 캐릭터 페르소나 및 말투 가이드 준수 여부

---

## 4. 리포트 구성 요소 (Output Format)

최종적으로 사용자에게 제공되는 리포트는 다음과 같이 구성됩니다.

*   **[현재 문장]:** AI가 오류가 있다고 판단한 실제 텍스트 내의 문장
*   **분석 항목별 의견:** 설정 충돌, 개연성, 보이스 불일치에 대한 핵심 요약
*   **[종합 의견]:** 전문 편집자 관점에서의 수정 방향 제안 및 해결책

---

## 5. 시스템의 특장점

1.  **실시간 정밀도:** 단순히 텍스트만 읽는 것이 아니라, DB에 저장된 '설정'과 '역사'를 동시 참조합니다.
2.  **문장 단위 네비게이션:** 리포트에서 문제가 된 문장을 정확히 `target_sentence`로 반환하여, 프론트엔드에서 즉시 해당 위치로 이동하거나 하이라이트할 수 있도록 지원합니다.
3.  **전문성:** "소설 전문 편집자"라는 페르소나를 사용하여 작가에게 실질적인 도움이 되는 조언 위주로 제공합니다.

---

## 6. 주요 관련 파일
*   `backend/api/v1/endpoints/consistency.py`: 메인 분석 API 로직
*   `backend/services/analysis/embedding_engine.py`: Pinecone 검색 엔진
*   `frontend/src/components/ChapterDetail.tsx`: 분석 요청 및 UI 표시
