# StoryProof-RR: 설정 오류 검사 기능 (Deep Dive)

본 문서는 소설의 일관성을 유지하기 위한 **'설정 오류 검사 시스템(설정파괴분석기)'**의 내부 동작 원리와 코드 수준의 구현 상세를 설명합니다. 이 시스템은 단순한 텍스트 매칭을 넘어, 소설의 **'역사(메모리)'**와 **'법칙(바이블)'**을 동시에 대조하는 전문 편집자 역할을 수행합니다.

---

## 1. 시스템 아키텍처 및 철학
이 기능은 작가의 집필 과정을 보조하기 위해 **"기억(Memory)"**과 **"규칙(Rule)"**이라는 두 가지 축을 기반으로 설계되었습니다.

*   **기억 (Past History):** Pinecone 벡터 DB를 통해 과거에 작성된 수만 줄의 문장 중 현재와 맥락상 연결된 부분을 실시간으로 소환합니다.
*   **규칙 (Bible Settings):** PostgreSQL에 저장된 캐릭터 시트와 세계관 설정을 참조하여 절대 깨져서는 안 될 설정을 고수합니다.
*   **지능 (AI Editor):** Gemini LLM이 위 두 데이터를 바탕으로 전문 편집자의 페르소나를 빌려 수정 의견을 제시합니다.

---

## 2. 코드 레벨 상세 분석

### A. 백엔드 분석 로직
**파일 위치:** `backend/api/v1/endpoints/consistency.py`

*   **`StoryValidator` 클래스:** 분석의 중추 역할을 합니다.
    *   **맥락 추출:** `self.engine.search()`를 통해 현재 문장과 가장 유사한 과거 장면 5개를 Pinecone에서 가져옵니다.
    *   **바이블 대조:** DB에서 `AnalysisType.CHARACTER` 데이터를 조회하여 캐릭터의 고유 속성을 파악합니다.
    *   **LLM 프롬프트 전략:** AI에게 "소설 전문 편집자" 역할을 부여하고, 수많은 오류 중 **가장 심각한 하나**에 집중하도록 유도하여 정보 과부하를 방지합니다. 또한, 수정이 필요한 구체적인 문장을 `[현재 문장]` 항목으로 강제 출력하게 함으로써 프론트엔드 네비게이션을 가능하게 합니다.

### B. 임베딩 검색 엔진 (Vector Search)
**파일 위치:** `backend/services/analysis/embedding_engine.py`

*   **모델:** 한국어와 다국어에 최적화된 `BAAI/bge-m3` 모델을 사용하여 문장의 의미적 유사도를 계산합니다.
*   **데이터 동기화:** Pinecone(검색용 가벼운 데이터)과 PostgreSQL(원본 텍스트 및 상세 메타데이터)을 동시에 관리합니다. 검색 시 Pinecone에서 ID를 찾은 후, DB의 `VectorDocument` 테이블에서 실제 원문을 가져오는 **하이브리드 방식**을 사용하여 데이터의 신뢰도를 높였습니다.

### C. 프론트엔드 UI 및 상호작용
**파일 위치:** `frontend/src/components/ChapterDetail.tsx`

*   **분석 요청 (`handleCheckConsistency`):** 현재 에디터에 작성된 내용을 백엔드로 전송하고 로딩 상태를 관리합니다.
*   **지능형 네비게이션 (`navigateToAnalyzedText`):** 
    *   AI가 리포트에서 언급한 `target_sentence`를 바탕으로, 전체 소설 내용 중 해당 문장이 포함된 **구체적인 씬(Scene) 위치**를 찾아냅니다.
    *   `scrollToScene` 함수를 호출하여 해당 위치로 부드럽게 스크롤하며, 사용자에게 문제 지점을 시각적으로 강조(Highlight)해 줍니다.

---

## 3. 핵심 분석 항목 (3대 요소)

시스템은 작가가 놓치기 쉬운 세 가지 관점에서 오류를 잡아냅니다.

1.  **⚠️ 설정 충돌 (Setting Conflict):** 
    *   *예: "창백한 피부"의 캐릭터가 갑자기 "구리빛 피부"로 묘사됨.*
    *   **코드 대응:** PostgreSQL 바이블 데이터와 대조.
2.  **⚙️ 개연성 경고 (Plausibility Warning):** 
    *   *예: 전 씬에서 다리를 다친 캐릭터가 갑자기 전력질주함.*
    *   **코드 대응:** Pinecone에서 검색된 직전/과거 장면의 요약문과 대조.
3.  **🗣️ 보이스 불일치 (Voice Inconsistency):** 
    *   *예: 냉소적인 캐릭터가 갑자기 지나치게 친절한 말투를 사용함.*
    *   **코드 대응:** 바이블의 페르소나 가이드라인 및 과거 대화문 맥락과 대조.

---

## 4. 결론: 작가의 강력한 사이드킥
이 기능은 단순한 오타 교정기가 아닙니다. 소설의 방대한 분량 속에서 작가가 미처 기억하지 못하는 **'설정의 실마리'**를 AI가 대신 기억하고 지적해 줌으로써, 독자들이 느끼는 "설정 파괴"라는 몰입도 저하 요소를 사전에 차단하는 **강력한 창작 보조 시스템**입니다.

---
> [!TIP]
> **개발자 참고사항:** 새로운 설정 항목(예: 마법 등급, 국가 정보)이 추가되면 `AnalysisType`을 확장하여 처리할 수 있도록 유연하게 설계되어 있습니다.
